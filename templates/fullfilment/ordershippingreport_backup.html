{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    :root {
        --primary-color: #667eea;
        --secondary-color: #764ba2;
        --success-color: #10b981;
        --info-color: #3b82f6;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --light-bg: #f8fafc;
        --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        --card-shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.12);
    }

    .page-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        padding: 1rem 0;
        margin-bottom: 1rem;
        border-radius: 6px;
        box-shadow: var(--card-shadow);
    }

    .page-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin: 0;
    }

    .page-subtitle {
        font-size: 0.8rem;
        opacity: 0.9;
        margin-top: 0.2rem;
    }

    .stats-summary {
        background: white;
        border-radius: 6px;
        padding: 0.75rem;
        box-shadow: var(--card-shadow);
        margin-bottom: 1rem;
    }

    .stats-summary .stat-item {
        text-align: center;
    }

    .stats-summary .stat-value {
        font-size: 1.4rem;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 0.2rem;
    }

    .stats-summary .stat-label {
        font-size: 0.7rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.2px;
    }

    .filter-section {
        background: white;
        border-radius: 6px;
        padding: 0.75rem;
        box-shadow: var(--card-shadow);
        margin-bottom: 1rem;
    }

    .filter-section .form-label {
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 0.2rem;
        font-size: 0.8rem;
    }

    .filter-section .form-control {
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        padding: 0.4rem 0.6rem;
        font-size: 0.8rem;
        transition: all 0.3s ease;
    }

    .filter-section .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }

    .filter-section .btn {
        padding: 0.4rem 1rem;
        border-radius: 4px;
        font-weight: 500;
        transition: all 0.3s ease;
        font-size: 0.8rem;
    }

    .filter-section .btn-primary {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        border: none;
    }

    .filter-section .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .filter-section .btn-group .btn {
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        font-weight: 500;
        transition: all 0.3s ease;
        font-size: 0.8rem;
    }
    
    .filter-section .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border: none;
    }
    
    .filter-section .btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        border: none;
    }
    
    .filter-section .btn-success:hover {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .filter-section .btn-danger:hover {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    
    .filter-section .btn-info {
        background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        border: none;
    }
    
    .filter-section .btn-info:hover {
        background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
    }
    
    /* Share Modal Styles */
    .share-btn {
        padding: 1rem;
        border-radius: 8px;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    .share-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .share-btn[data-method="email"]:hover {
        border-color: #dc2626;
        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    }
    
    .share-btn[data-method="whatsapp"]:hover {
        border-color: #16a34a;
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    }
    
    .share-btn i {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }
    
    /* File Type Selection Styles */
    .btn-check:checked + .btn-outline-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-color: #10b981;
        color: white;
    }
    
    .btn-check:checked + .btn-outline-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        border-color: #ef4444;
        color: white;
    }
    
    .btn-check + .btn {
        transition: all 0.3s ease;
    }
    
    .btn-check + .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .btn-check:checked + .btn-outline-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        border-color: #3b82f6;
        color: white;
    }
    
    .btn-check:checked + .btn-outline-info {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        border-color: #06b6d4;
        color: white;
    }
    
    /* Toast Notification Styles */
    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .toast-body {
        font-weight: 500;
    }

    .courier-card {
        background: white;
        border-radius: 6px;
        padding: 0.75rem;
        margin-bottom: 0.75rem;
        box-shadow: var(--card-shadow);
        transition: all 0.3s ease;
        border-left: 2px solid var(--primary-color);
    }

    .courier-card:hover {
        transform: translateY(-1px);
        box-shadow: var(--card-shadow-hover);
    }

    .courier-card .courier-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #f1f5f9;
    }

    .courier-card .courier-name {
        font-size: 0.95rem;
        font-weight: 600;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .courier-card .courier-name i {
        color: var(--primary-color);
        font-size: 1rem;
    }

    .courier-card .courier-count {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.95rem;
        font-weight: 600;
        box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        min-width: 50px;
        text-align: center;
    }


    .courier-card .toggle-btn {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        border: none;
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
        font-weight: 500;
        color: #475569;
        transition: all 0.3s ease;
        margin-top: 0.5rem;
        font-size: 0.8rem;
    }
    
    .courier-card .btn-group .btn {
        padding: 0.3rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        margin-top: 0.5rem;
    }
    
    .courier-card .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border: none;
    }
    
    .courier-card .btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        border: none;
    }
    
    .courier-card .btn-success:hover {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        transform: translateY(-1px);
    }
    
    .courier-card .btn-danger:hover {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        transform: translateY(-1px);
    }
    
    .courier-card .btn-info {
        background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        border: none;
    }
    
    .courier-card .btn-info:hover {
        background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
    }

    .courier-card .toggle-btn:hover {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        transform: translateY(-1px);
    }


    .order-table {
        width: 100%;
        margin-top: 1rem;
    }

    .order-table thead {
        background: #f8fafc;
    }

    .order-table th {
        padding: 0.4rem;
        font-weight: 600;
        color: #475569;
        border-bottom: 1px solid #e2e8f0;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.2px;
    }

    .order-table td {
        padding: 0.4rem;
        border-bottom: 1px solid #f1f5f9;
        color: #1e293b;
        font-size: 0.8rem;
    }

    .order-table tr:hover {
        background: #f8fafc;
    }

    .badge-user {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        padding: 0.15rem 0.4rem;
        border-radius: 8px;
        font-size: 0.7rem;
        font-weight: 500;
    }

    .empty-state {
        text-align: center;
        padding: 1.5rem 0.75rem;
        background: white;
        border-radius: 6px;
        box-shadow: var(--card-shadow);
    }

    .empty-state i {
        font-size: 2rem;
        color: #cbd5e1;
        margin-bottom: 0.5rem;
    }

    .empty-state h3 {
        color: #64748b;
        font-size: 1rem;
        margin-bottom: 0.2rem;
    }

    .empty-state p {
        color: #94a3b8;
        font-size: 0.8rem;
    }

    @media (max-width: 768px) {
        .page-title {
            font-size: 1.1rem;
        }

        .courier-card .courier-name {
            font-size: 0.9rem;
        }

        .courier-card .courier-count {
            font-size: 0.9rem;
            padding: 0.3rem 0.6rem;
            min-width: 45px;
        }

        .order-table {
            font-size: 0.75rem;
        }

        .order-table th,
        .order-table td {
            padding: 0.3rem;
        }
    }
</style>

<div class="container-fluid px-4">
    <!-- Page Header -->
    <div class="page-header">
        <div class="container">
            <h1 class="page-title">
                <i class="bi bi-truck me-1"></i>Laporan Shipping per Kurir
            </h1>
            <p class="page-subtitle">Monitoring pengiriman order berdasarkan kurir ekspedisi</p>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <form method="get" action="{% url 'order_shipping_report' %}" class="row align-items-end g-3">
            <div class="col-md-6">
                <label for="dateFilter" class="form-label">
                    <i class="bi bi-calendar-event me-1" style="font-size: 0.8rem;"></i>Pilih Tanggal
                </label>
                <input type="date" 
                       id="dateFilter" 
                       name="date" 
                       class="form-control" 
                       value="{{ selected_date_str }}"
                       max="{{ today|date:'Y-m-d' }}">
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search me-1" style="font-size: 0.8rem;"></i>Filter Data
                </button>
            </div>
            <div class="col-md-3">
                <div class="btn-group w-100" role="group">
                    <a href="{% url 'order_shipping_report_download_excel' %}?date={{ selected_date_str }}" 
                       class="btn btn-success btn-sm">
                        <i class="bi bi-file-excel me-1" style="font-size: 0.8rem;"></i>Excel
                    </a>
                    <a href="{% url 'order_shipping_report_download_pdf' %}?date={{ selected_date_str }}" 
                       class="btn btn-danger btn-sm">
                        <i class="bi bi-file-pdf me-1" style="font-size: 0.8rem;"></i>PDF
                    </a>
                </div>
            </div>
        </form>
    </div>

    <!-- Stats Summary -->
    <div class="stats-summary">
        <div class="row">
            <div class="col-md-4">
                <div class="stat-item">
                    <div class="stat-value">{{ total_shipped }}</div>
                    <div class="stat-label">Total Dikirim</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-item">
                    <div class="stat-value">{{ courier_stats|length }}</div>
                    <div class="stat-label">Jumlah Kurir</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-item">
                    <div class="stat-value">{{ selected_date|date:"d M Y" }}</div>
                    <div class="stat-label">Tanggal Dipilih</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Courier Cards -->
    {% if courier_stats %}
        <div class="row">
            {% for courier in courier_stats %}
            <div class="col-md-6 col-lg-4">
                <div class="courier-card" id="courier-{{ forloop.counter }}">
                    <div class="courier-header">
                        <div class="courier-name">
                            <i class="bi bi-box-seam"></i>
                            {{ courier.name }}
                        </div>
                        <div class="courier-count">
                            {{ courier.count }}
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <a href="{% url 'order_shipping_detail' %}?courier={{ courier.name|urlencode }}&date={{ selected_date_str }}" 
                           class="toggle-btn flex-grow-1 text-decoration-none">
                            <i class="bi bi-list-ul me-1" style="font-size: 0.8rem;"></i>
                            Lihat Detail ({{ courier.count }} order)
                        </a>
                        <div class="btn-group" role="group">
                            <a href="{% url 'order_shipping_report_download_excel' %}?date={{ selected_date_str }}&courier={{ courier.name|urlencode }}" 
                               class="btn btn-success btn-sm" title="Download Excel">
                                <i class="bi bi-file-excel" style="font-size: 0.8rem;"></i>
                            </a>
                            <a href="{% url 'order_shipping_report_download_pdf' %}?date={{ selected_date_str }}&courier={{ courier.name|urlencode }}" 
                               class="btn btn-danger btn-sm" title="Download PDF">
                                <i class="bi bi-file-pdf" style="font-size: 0.8rem;"></i>
                            </a>
                        </div>
                    </div>
                    
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <h3>Tidak Ada Data</h3>
            <p>Belum ada order yang dikirim pada tanggal {{ selected_date|date:"d M Y" }}</p>
        </div>
    {% endif %}
</div>

<script>

// Auto-select today's date if no date is selected
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('dateFilter');
    if (!dateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
    }
    
    // Update download links when date changes
    function updateDownloadLinks() {
        const selectedDate = dateInput.value;
        const excelLinks = document.querySelectorAll('a[href*="download-excel"]');
        const pdfLinks = document.querySelectorAll('a[href*="download-pdf"]');
        
        excelLinks.forEach(link => {
            const url = new URL(link.href);
            url.searchParams.set('date', selectedDate);
            link.href = url.toString();
        });
        
        pdfLinks.forEach(link => {
            const url = new URL(link.href);
            url.searchParams.set('date', selectedDate);
            link.href = url.toString();
        });
    }
    
    // Update links on date change
    dateInput.addEventListener('change', updateDownloadLinks);
    
    // Initial update
    updateDownloadLinks();
});

// Share functionality
document.addEventListener('DOMContentLoaded', function() {
    // Reset modal title when opened for global share
    document.getElementById('shareModal').addEventListener('show.bs.modal', function() {
        document.getElementById('shareModalLabel').innerHTML = 
            '<i class="bi bi-share text-info me-2"></i>Share Report';
    });
    
    const shareButtons = document.querySelectorAll('.share-btn');
    
    shareButtons.forEach(button => {
        button.addEventListener('click', function() {
            const method = this.getAttribute('data-method');
            const message = document.getElementById('shareMessage').value;
            const selectedDate = document.getElementById('dateFilter').value;
            const fileType = document.querySelector('input[name="fileType"]:checked').value;
            const shareMethod = document.querySelector('input[name="shareMethod"]:checked').value;
            
            // Get report data
            const reportData = {
                date: selectedDate,
                totalShipped: {{ total_shipped }},
                totalCouriers: {{ courier_stats|length }},
                message: message,
                fileType: fileType,
                shareMethod: shareMethod
            };
            
            if (shareMethod === 'copy') {
                if (method === 'email') {
                    copyToClipboardEmail(reportData);
                } else if (method === 'whatsapp') {
                    copyToClipboardWhatsApp(reportData);
                }
            } else {
                if (method === 'email') {
                    shareFileViaEmail(reportData);
                } else if (method === 'whatsapp') {
                    shareFileViaWhatsApp(reportData);
                }
            }
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('shareModal'));
            modal.hide();
        });
    });
});
    const fileExtension = data.fileType === 'excel' ? 'xlsx' : 'pdf';
    const subject = `Laporan Shipping - ${data.date}`;
    
    // Get detailed courier data
    let courierDetails = '';
    {% for courier in courier_stats %}
    courierDetails += `\n🚚 ${courier.name}: ${courier.count} order\n`;
    {% endfor %}
    
    const body = `Laporan Shipping per Kurir\n\n` +
                `📅 Tanggal: ${data.date}\n` +
                `📦 Total Dikirim: ${data.totalShipped}\n` +
                `🚚 Jumlah Kurir: ${data.totalCouriers}\n\n` +
                `📋 Detail per Kurir:${courierDetails}\n` +
                `${data.message ? '💬 Pesan: ' + data.message + '\n\n' : ''}` +
                `📎 File terlampir dalam format ${data.fileType.toUpperCase()} berisi detail lengkap.`;
    
    // Generate unique filename with random code
    const randomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
    const uniqueFilename = `shipping_report_${data.date}_${randomCode}.${fileExtension}`;
    
    // Download file with unique name (force download without confirmation)
    const downloadUrl = data.fileType === 'excel' 
        ? `/fullfilment/order-shipping-report/download-excel/?date=${data.date}`
        : `/fullfilment/order-shipping-report/download-pdf/?date=${data.date}`;
    
    // Force download with unique filename
    forceDownload(downloadUrl, uniqueFilename);
    
    // Open email after a short delay
    setTimeout(() => {
        const emailUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.open(emailUrl, '_blank');
    }, 500);
}

function shareFileViaWhatsApp(data) {
    const fileExtension = data.fileType === 'excel' ? 'xlsx' : 'pdf';
    
    // Get detailed courier data
    let courierDetails = '';
    {% for courier in courier_stats %}
    courierDetails += `\n🚚 *${courier.name}*: ${courier.count} order`;
    {% endfor %}
    
    const message = `📊 *Laporan Shipping per Kurir*\n\n` +
                   `📅 Tanggal: ${data.date}\n` +
                   `📦 Total Dikirim: ${data.totalShipped}\n` +
                   `🚚 Jumlah Kurir: ${data.totalCouriers}\n\n` +
                   `📋 *Detail per Kurir:*${courierDetails}\n\n` +
                   `${data.message ? '💬 Pesan: ' + data.message + '\n\n' : ''}` +
                   `📎 File terlampir dalam format ${data.fileType.toUpperCase()} berisi detail lengkap.`;
    
    // Generate unique filename with random code
    const randomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
    const uniqueFilename = `shipping_report_${data.date}_${randomCode}.${fileExtension}`;
    
    // Download file with unique name (force download without confirmation)
    const downloadUrl = data.fileType === 'excel' 
        ? `/fullfilment/order-shipping-report/download-excel/?date=${data.date}`
        : `/fullfilment/order-shipping-report/download-pdf/?date=${data.date}`;
    
    // Force download with unique filename
    forceDownload(downloadUrl, uniqueFilename);
    
    // Open WhatsApp directly without confirmation
    setTimeout(() => {
        openWhatsAppDirect(message);
    }, 500);
}

function shareCourierReport(courierName, courierCount, date) {
    // Show modal for courier-specific sharing
    const modal = new bootstrap.Modal(document.getElementById('shareModal'));
    
    // Update modal title
    document.getElementById('shareModalLabel').innerHTML = 
        `<i class="bi bi-share text-info me-2"></i>Share Report - ${courierName}`;
    
    // Update share buttons to include courier data
    const shareButtons = document.querySelectorAll('.share-btn');
    shareButtons.forEach(button => {
        button.onclick = function() {
            const method = this.getAttribute('data-method');
            const message = document.getElementById('shareMessage').value;
            const fileType = document.querySelector('input[name="fileType"]:checked').value;
            
            const reportData = {
                date: date,
                courierName: courierName,
                courierCount: courierCount,
                message: message,
                fileType: fileType
            };
            
            if (method === 'email') {
                shareCourierFileViaEmail(reportData);
            } else if (method === 'whatsapp') {
                shareCourierFileViaWhatsApp(reportData);
            }
            
            modal.hide();
        };
    });
    
    modal.show();
}

function shareCourierFileViaEmail(data) {
    const fileExtension = data.fileType === 'excel' ? 'xlsx' : 'pdf';
    const subject = `Laporan Shipping - ${data.courierName} - ${data.date}`;
    
    // Get detailed order data for this courier
    let orderDetails = '';
    {% for courier in courier_stats %}
    {% if courier.name == data.courierName %}
    {% for order in courier.orders %}
    orderDetails += `\n📦 ${order.id_pesanan} - ${order.nama_toko} (${order.user})`;
    {% endfor %}
    {% endif %}
    {% endfor %}
    
    const body = `Laporan Shipping untuk Kurir: ${data.courierName}\n\n` +
                `📅 Tanggal: ${data.date}\n` +
                `📦 Jumlah Order: ${data.courierCount}\n\n` +
                `📋 *Detail Order:*${orderDetails}\n\n` +
                `${data.message ? '💬 Pesan: ' + data.message + '\n\n' : ''}` +
                `📎 File terlampir dalam format ${data.fileType.toUpperCase()} berisi detail lengkap.`;
    
    // Generate unique filename with random code
    const randomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
    const uniqueFilename = `shipping_report_${data.courierName}_${data.date}_${randomCode}.${fileExtension}`;
    
    // Download file with unique name (force download without confirmation)
    const downloadUrl = data.fileType === 'excel' 
        ? `/fullfilment/order-shipping-report/download-excel/?date=${data.date}&courier=${encodeURIComponent(data.courierName)}`
        : `/fullfilment/order-shipping-report/download-pdf/?date=${data.date}&courier=${encodeURIComponent(data.courierName)}`;
    
    // Force download with unique filename
    forceDownload(downloadUrl, uniqueFilename);
    
    // Open email after a short delay
    setTimeout(() => {
        const emailUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.open(emailUrl, '_blank');
    }, 500);
}

function shareCourierFileViaWhatsApp(data) {
    const fileExtension = data.fileType === 'excel' ? 'xlsx' : 'pdf';
    
    // Get detailed order data for this courier
    let orderDetails = '';
    {% for courier in courier_stats %}
    {% if courier.name == data.courierName %}
    {% for order in courier.orders %}
    orderDetails += `\n📦 *${order.id_pesanan}* - ${order.nama_toko} (${order.user})`;
    {% endfor %}
    {% endif %}
    {% endfor %}
    
    const message = `📊 *Laporan Shipping - ${data.courierName}*\n\n` +
                   `📅 Tanggal: ${data.date}\n` +
                   `🚚 Kurir: ${data.courierName}\n` +
                   `📦 Jumlah Order: ${data.courierCount}\n\n` +
                   `📋 *Detail Order:*${orderDetails}\n\n` +
                   `${data.message ? '💬 Pesan: ' + data.message + '\n\n' : ''}` +
                   `📎 File terlampir dalam format ${data.fileType.toUpperCase()} berisi detail lengkap.`;
    
    // Generate unique filename with random code
    const randomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
    const uniqueFilename = `shipping_report_${data.courierName}_${data.date}_${randomCode}.${fileExtension}`;
    
    // Download file with unique name (force download without confirmation)
    const downloadUrl = data.fileType === 'excel' 
        ? `/fullfilment/order-shipping-report/download-excel/?date=${data.date}&courier=${encodeURIComponent(data.courierName)}`
        : `/fullfilment/order-shipping-report/download-pdf/?date=${data.date}&courier=${encodeURIComponent(data.courierName)}`;
    
    // Force download with unique filename
    forceDownload(downloadUrl, uniqueFilename);
    
    // Open WhatsApp directly without confirmation
    setTimeout(() => {
        openWhatsAppDirect(message);
    }, 500);
}

// Copy to Clipboard Functions (Perfect for Local Development)
function copyToClipboardEmail(data) {
    const subject = `Laporan Shipping - ${data.date}`;
    const body = `📊 Laporan Shipping per Kurir\n\n` +
                `📅 Tanggal: ${data.date}\n` +
                `📦 Total Dikirim: ${data.totalShipped}\n` +
                `🚚 Jumlah Kurir: ${data.totalCouriers}\n\n` +
                `${data.message ? '💬 Pesan: ' + data.message + '\n\n' : ''}` +
                `📎 File terlampir dalam format ${data.fileType.toUpperCase()}.`;
    
    const emailContent = `Subject: ${subject}\n\n${body}`;
    
    // Copy to clipboard
    navigator.clipboard.writeText(emailContent).then(() => {
        // Show success message
        showToast('Email content copied to clipboard!', 'success');
        
        // Open email client
        const emailUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.open(emailUrl, '_blank');
    }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = emailContent;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        showToast('Email content copied to clipboard!', 'success');
        
        const emailUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.open(emailUrl, '_blank');
    });
}

function copyToClipboardWhatsApp(data) {
    // Get detailed courier data
    let courierDetails = '';
    {% for courier in courier_stats %}
    courierDetails += `\n🚚 *${courier.name}*: ${courier.count} order`;
    {% endfor %}
    
    const message = `📊 *Laporan Shipping per Kurir*\n\n` +
                   `📅 Tanggal: ${data.date}\n` +
                   `📦 Total Dikirim: ${data.totalShipped}\n` +
                   `🚚 Jumlah Kurir: ${data.totalCouriers}\n\n` +
                   `📋 *Detail per Kurir:*${courierDetails}\n\n` +
                   `${data.message ? '💬 Pesan: ' + data.message + '\n\n' : ''}` +
                   `📎 File terlampir dalam format ${data.fileType.toUpperCase()} berisi detail lengkap.`;
    
    // Copy to clipboard
    navigator.clipboard.writeText(message).then(() => {
        // Show success message
        showToast('WhatsApp message copied to clipboard!', 'success');
        
        // Open WhatsApp
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
    }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = message;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        showToast('WhatsApp message copied to clipboard!', 'success');
        
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
    });
}

// Force download function (no confirmation)
function forceDownload(url, filename) {
    // Create hidden iframe for silent download
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.src = url;
    document.body.appendChild(iframe);
    
    // Also try direct download as fallback
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Remove iframe after download
    setTimeout(() => {
        if (document.body.contains(iframe)) {
            document.body.removeChild(iframe);
        }
    }, 2000);
}

// Open WhatsApp directly without confirmation
function openWhatsAppDirect(message) {
    // Try multiple methods to bypass confirmation
    
    // Method 1: Direct WhatsApp Web
    const whatsappWebUrl = `https://web.whatsapp.com/send?text=${encodeURIComponent(message)}`;
    
    // Method 2: WhatsApp API
    const whatsappApiUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
    
    // Method 3: Direct wa.me
    const whatsappDirectUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
    
    // Try to open in new tab first (less likely to trigger confirmation)
    const newWindow = window.open(whatsappDirectUrl, '_blank', 'noopener,noreferrer');
    
    // If new window is blocked, try direct navigation
    if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
        // Fallback: try to bypass popup blocker
        setTimeout(() => {
            window.location.href = whatsappDirectUrl;
        }, 100);
    }
}

// Toast notification function
function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'info'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    // Add to page
    document.body.appendChild(toast);
    
    // Show toast
    const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
    bsToast.show();
    
    // Remove from DOM after hide
    toast.addEventListener('hidden.bs.toast', () => {
        document.body.removeChild(toast);
    });
}
</script>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 12px;">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title" id="shareModalLabel">
                    <i class="bi bi-share text-info me-2"></i>Share Report
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-0">
                <p class="text-muted mb-3">Pilih format file dan cara untuk membagikan laporan shipping:</p>
                
                <!-- File Type Selection -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Format File:</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="fileType" id="excelType" value="excel" checked>
                        <label class="btn btn-outline-success" for="excelType">
                            <i class="bi bi-file-excel me-1"></i>Excel
                        </label>
                        
                        <input type="radio" class="btn-check" name="fileType" id="pdfType" value="pdf">
                        <label class="btn btn-outline-danger" for="pdfType">
                            <i class="bi bi-file-pdf me-1"></i>PDF
                        </label>
                    </div>
                </div>
                
                <!-- Share Method Selection -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Cara Kirim:</label>
                    <div class="row g-2">
                        <div class="col-6">
                            <button type="button" class="btn btn-outline-danger w-100 share-btn" data-method="email">
                                <i class="bi bi-envelope-fill me-2"></i>
                                <div class="d-flex flex-column align-items-center">
                                    <span class="fw-bold">Email</span>
                                    <small class="text-muted">Kirim ke Gmail</small>
                                </div>
                            </button>
                        </div>
                        <div class="col-6">
                            <button type="button" class="btn btn-outline-success w-100 share-btn" data-method="whatsapp">
                                <i class="bi bi-whatsapp me-2"></i>
                                <div class="d-flex flex-column align-items-center">
                                    <span class="fw-bold">WhatsApp</span>
                                    <small class="text-muted">Kirim ke WhatsApp</small>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <label for="shareMessage" class="form-label">Pesan Tambahan (Opsional):</label>
                    <textarea class="form-control" id="shareMessage" rows="3" placeholder="Tambahkan pesan untuk laporan ini..."></textarea>
                </div>
                
                <!-- Share Method Options -->
                <div class="mt-3">
                    <label class="form-label fw-bold">Metode Share:</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="shareMethod" id="downloadMethod" value="download" checked>
                        <label class="btn btn-outline-primary" for="downloadMethod">
                            <i class="bi bi-download me-1"></i>Download & Share
                        </label>
                        
                        <input type="radio" class="btn-check" name="shareMethod" id="copyMethod" value="copy">
                        <label class="btn btn-outline-info" for="copyMethod">
                            <i class="bi bi-clipboard me-1"></i>Copy to Clipboard
                        </label>
                    </div>
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        <strong>Download & Share:</strong> File download dulu, lalu attach manual<br>
                        <strong>Copy to Clipboard:</strong> Copy data ke clipboard, paste di chat
                    </small>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Batal
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

