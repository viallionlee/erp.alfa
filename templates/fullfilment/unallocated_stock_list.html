{% extends 'base.html' %}
{% load static %}

{% block title %}Stok Gantung - {{ nama_batch }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-0">Daftar Stok Gantung</h2>
            <p class="text-muted mb-0">Batch: <span class="text-primary fw-bold">{{ nama_batch }}</span></p>
        </div>
        <a href="{% url 'ready_to_print_list' %}?nama_batch={{ nama_batch }}" class="btn btn-outline-secondary">
            &larr; Kembali ke Ready to Print
        </a>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <i class="bi bi-box-seam me-2"></i>
            Menampilkan <strong>{{ total_unallocated_items }} item</strong> dari <strong>{{ total_unique_unallocated_products }} produk</strong> yang tidak teralokasi.
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="unallocatedStockTable" class="table table-striped table-bordered" style="width:100%">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Nama Produk</th>
                            <th>Variant</th>
                            <th>Barcode</th>
                            <th>Jumlah Butuh</th>
                            <th>Jumlah Ambil</th>
                            <th>Sisa Butuh</th>
                            <th>Jumlah Terpakai</th>
                            <th>Stok Gantung</th>
                            <th>Stok Fisik</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if unallocated_products %}
                            {% for item in unallocated_products %}
                            <tr>
                                <td>{{ item.sku }}</td>
                                <td>{{ item.nama_produk }}</td>
                                <td>{{ item.variant_produk }}</td>
                                <td>{{ item.barcode }}</td>
                                <td class="text-info fw-bold">{{ item.initial_batch_item_quantity }}</td>
                                <td class="text-info fw-bold">{{ item.total_picked_in_batch }}</td>
                                <td class="text-muted">{{ item.sisa_butuh }}</td>
                                <td class="text-muted">{{ item.total_needed_for_ready_orders }}</td>
                                <td class="text-center align-middle">
                                    <span class="badge bg-danger rounded-pill fs-4 px-2 py-1">
                                        {{ item.unallocated_quantity }}
                                    </span>
                                </td>
                                <td>{{ item.current_physical_stock }}</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-outline-danger"
                                        data-product-id="{{ item.product_id }}"
                                        data-unallocated-qty="{{ item.unallocated_quantity }}"
                                        data-bs-toggle="tooltip" data-bs-placement="top" title="Kembalikan ke Stok">
                                        <i class="bi bi-arrow-return-left"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="11" class="text-center text-muted">Tidak ada stok yang tidak teralokasi dalam batch ini.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
<script src=""></script>
<script>
    $(document).ready(function() {
        const table = $('#unallocatedStockTable');
        const tbody = table.find('tbody');
        const rowCount = tbody.find('tr').length;
        
        // Hanya inisialisasi DataTable jika ada data (bukan row kosong)
        if (rowCount > 0 && !tbody.find('tr td').text().includes('Tidak ada stok')) {
            table.DataTable({
                "pageLength": 25,
                "language": { 
                    "search": "Cari:", 
                    "info": "Menampilkan _START_ sampai _END_ dari _TOTAL_ entri", 
                    "infoEmpty": "Tidak ada data", 
                    "zeroRecords": "Tidak ditemukan data yang cocok" 
                },
                "columnDefs": [
                    {
                        "targets": -1, // Kolom terakhir (Aksi)
                        "orderable": false,
                        "searchable": false
                    }
                ]
            });
        } else {
            // Jika tidak ada data, sembunyikan elemen DataTable yang tidak diperlukan
            table.find('.dataTables_wrapper .dataTables_filter').hide();
            table.find('.dataTables_wrapper .dataTables_length').hide();
            table.find('.dataTables_wrapper .dataTables_info').hide();
            table.find('.dataTables_wrapper .dataTables_paginate').hide();
        }

        // Tambahkan fungsi untuk tombol "Kembalikan ke Stok"
        tbody.on('click', '.btn-outline-danger', function() {
            const productId = $(this).data('product-id');
            const unallocatedQty = $(this).data('unallocated-qty');
            const productName = $(this).closest('tr').find('td:eq(1)').text(); // Nama Produk

            Swal.fire({
                title: 'Konfirmasi Pengembalian Stok',
                text: `Anda yakin ingin mengembalikan ${unallocatedQty} unit '${productName}' ke stok umum?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, Kembalikan!',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    const namaBatch = "{{ nama_batch|escapejs }}";
                    const csrfToken = "{{ csrf_token }}";

                    fetch('/fullfilment/return_unallocated_stock/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            product_id: productId,
                            quantity: unallocatedQty,
                            nama_batch: namaBatch
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire(
                                'Berhasil!',
                                'Stok berhasil dikembalikan.',
                                'success'
                            ).then(() => {
                                window.location.reload();
                            });
                        } else {
                            Swal.fire(
                                'Gagal!',
                                data.error || 'Terjadi kesalahan saat mengembalikan stok.',
                                'error'
                            );
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire(
                            'Error Jaringan!',
                            'Tidak dapat menghubungi server.',
                            'error'
                        );
                    });
                }
            });
        });

        // Inisialisasi tooltip Bootstrap
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
    });
</script>
{% endblock %}
