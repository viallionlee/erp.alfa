{% extends 'base_mobile.html' %}
{% block content %}
<div class="container-fluid px-2 py-2" style="max-width:480px; margin:auto;">
    <h3 class="fw-bold mb-2 text-center" style="font-size:1.1rem; letter-spacing:0.5px;">ORDERS CHECKING MOBILE</h3>

    <!-- Step 1: Input Order ID -->
    <div id="orderIdSection" {% if show_tables %}style="display:none;"{% endif %}>
        <form method="post" id="orderIdForm">
            {% csrf_token %}
            <label for="orderidinput" class="form-label fw-bold" style="font-size:1em;">Input Order ID</label>
            <div class="input-group mb-2 flex-nowrap">
                <input type="text" id="orderidinput" name="order_id" class="form-control form-control-sm rounded-start" style="font-size:1em; min-width:0;" placeholder="Order ID..." autofocus autocomplete="off">
                <button type="submit" class="btn btn-primary btn-sm">Cari</button>
            </div>
        </form>
        {% if error %}
        <div class="alert alert-danger py-2">{{ error }}</div>
        {% endif %}
    </div>

    <!-- Step 2: Barcode Scan & Table, only if show_tables -->
    {% if show_tables %}
    <div id="barcodeSection"></div>
        <label for="barcodeInput" class="form-label fw-bold" style="font-size:1em;">Scan Barcode</label>
        <div class="input-group mb-2 flex-nowrap">
            <input type="text" id="barcodeInput" class="form-control form-control-sm rounded-start" style="font-size:1em; min-width:0;" placeholder="Scan barcode..." autofocus autocomplete="off">
        </div>
    </div>

    <!-- Pending Items -->
    <div class="mb-4">
        <h5 class="mb-2" style="font-size:1em;">Pending Items</h5>
        <ul class="list-group" id="pendingList">
            {% for item in pending_orders %}
            <li class="list-group-item d-flex justify-content-between align-items-center px-2 py-2 mb-2" style="border-radius:12px; box-shadow:0 1px 4px rgba(0,0,0,0.04); border:1px solid #f0f0f0; cursor:pointer;"
                data-product-id="{{ item.id }}">
                <div class="d-flex align-items-start gap-2">
                    <div>
                        <div class="fw-bold" style="font-size:1em;">{{ item.sku }}</div>
                        <div style="font-size:0.97em;">{{ item.nama_produk }}</div>
                        <div style="font-size:0.95em;" class="text-muted">{{ item.variant_produk }}</div>
                        <div style="font-size:0.93em;" class="text-secondary">{{ item.brand }}</div>
                    </div>
                    <div class="ms-auto text-end">
                        <span class="badge bg-primary" style="font-size:1em;">{{ item.jumlah_ambil }}/{{ item.jumlah }}</span><br>
                    </div>
                </div>
            </li>
            {% empty %}
            <li class="list-group-item text-center text-muted">Tidak ada data pending.</li>
            {% endfor %}
        </ul>
    </div>
    <!-- Completed Items -->
    <div class="mb-4">
        <h5 class="mb-2" style="font-size:1em;">Completed Items</h5>
        <ul class="list-group" id="completedList">
            {% for item in completed_orders %}
            <li class="list-group-item d-flex justify-content-between align-items-center px-2 py-2 mb-2" style="border-radius:12px; box-shadow:0 1px 4px rgba(0,0,0,0.04); border:1px solid #f0f0f0; cursor:pointer;"
                data-product-id="{{ item.id }}">
                <div class="d-flex align-items-start gap-2">
                    <div>
                        <div class="fw-bold" style="font-size:1em;">{{ item.sku }}</div>
                        <div style="font-size:0.97em;">{{ item.nama_produk }}</div>
                        <div style="font-size:0.95em;" class="text-muted">{{ item.variant_produk }}</div>
                        <div style="font-size:0.93em;" class="text-secondary">{{ item.brand }}</div>
                    </div>
                    <div class="ms-auto text-end">
                        <span class="badge bg-success" style="font-size:1em;">{{ item.jumlah_ambil }}/{{ item.jumlah }}</span><br>
                    </div>
                </div>
            </li>
            {% empty %}
            <li class="list-group-item text-center text-muted">Tidak ada data completed.</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_script %}
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script>
// --- Barcode scan & table logic sama seperti orderschecking.html ---

// Submit order ID form
const orderIdForm = document.getElementById('orderIdForm');
if (orderIdForm) {
    orderIdForm.addEventListener('submit', function(e) {
        // Biarkan form submit normal agar Django handle POST dan reload table
    });
}

// Barcode scan logic (hanya aktif jika show_tables)
{% if show_tables %}
document.getElementById('barcodeInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        const barcode = this.value.trim();
        if (barcode) {
            processScan(barcode);
            this.value = '';
        }
    }
});

function processScan(barcode) {
    fetch("/fullfilment/scanpicking/{{ order_id }}/scan-barcode/", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ barcode: barcode, order_id: '{{ order_id }}' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showFeedback('success', 'Item berhasil di-scan!');
            window.location.reload();
        } else {
            showFeedback('danger', data.error || 'Barcode tidak ditemukan');
        }
    })
    .catch(error => {
        showFeedback('danger', 'Terjadi kesalahan saat memproses barcode');
    });
}

function showFeedback(type, message) {
    const feedback = document.getElementById('barcodeFeedback');
    feedback.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show py-2" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>`;
    setTimeout(() => {
        const alert = feedback.querySelector('.alert');
        if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 3000);
}
// Barcode scanner button logic (copy dari mobilebatchpicking jika perlu)
// ...
{% endif %}
</script>
{% endblock %}