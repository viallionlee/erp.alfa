{% extends 'base.html' %}
{% load render_table from django_tables2 %}
{% block content %}
<div class="container-fluid mt-3">
    <h2 class="fw-bold mb-3">Ready to Print</h2>
    <div class="mb-3">
        <a href="/fullfilment/batchpicking/{{ nama_batch }}/" class="btn btn-secondary">&larr; Kembali ke Batch Picking</a>
    </div>
    <div class="mb-3">
        <button type="button" class="btn btn-primary" id="satButton">SAT</button>
        <button type="button" class="btn btn-secondary" id="mixButton">MIX</button>
    </div>
    <div id="brandSelection" class="mt-3" style="display:none;">
        <h4 class="fw-bold">Select Brand</h4>
        <div id="brandList"></div>
        <button type="button" class="btn btn-success" id="printAll">Print All</button>
    </div>
    <form id="printForm">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    {% render_table table %}
                </div>
                <div class="mt-3 d-flex justify-content-between align-items-center">
                    <div>
                        <input type="checkbox" id="selectAll"> <label for="selectAll">Select All</label>
                    </div>
                    <button type="button" class="btn btn-primary" id="printSelected">Print Selected</button>
                </div>
            </div>
        </div>
    </form>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Select all checkbox
    const selectAll = document.getElementById('selectAll');
    selectAll.addEventListener('change', function() {
        document.querySelectorAll('input[name="print_checkbox"]')
            .forEach(cb => cb.checked = selectAll.checked);
    });
    // Print button
    document.getElementById('printSelected').addEventListener('click', function() {
        const checked = Array.from(document.querySelectorAll('input[name="print_checkbox"]:checked'));
        if (checked.length === 0) {
            alert('Pilih minimal satu order untuk print!');
            return;
        }
        const ids = checked.map(cb => cb.value);
        fetch("/fullfilment/readytoprint/print/", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({ ids })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert('Gagal update status print!');
            }
        });
    });
    document.getElementById('satButton').addEventListener('click', function() {
        fetch('/fullfilment/readytoprint/sat/')
            .then(response => response.json())
            .then(data => {
                const brandList = document.getElementById('brandList');
                brandList.innerHTML = '';
                data.brands.forEach(brand => {
                    const button = document.createElement('button');
                    button.className = 'btn btn-outline-primary';
                    button.textContent = `${brand.name} (${brand.totalOrders})`;
                    button.addEventListener('click', () => printBrand(brand.id));
                    brandList.appendChild(button);
                });
                document.getElementById('brandSelection').style.display = 'block';
            });
    });
    document.getElementById('printAll').addEventListener('click', function() {
        fetch('/fullfilment/readytoprint/print_all/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Excel file downloaded and status updated!');
            } else {
                alert('Failed to print all brands!');
            }
        });
    });
    function printBrand(brandId) {
        fetch(`/fullfilment/readytoprint/print_brand/${brandId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Excel file downloaded and status updated!');
            } else {
                alert('Failed to print brand!');
            }
        });
    }
});
</script>
{% endblock %}
