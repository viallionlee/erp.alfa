{% extends 'base.html' %}
{% block content %}
<!-- Ini adalah salinan dari batchpicking.html, silakan bebas modifikasi untuk eksperimen -->
<div class="container-fluid mt-3 px-1 px-md-3">
    <div class="row align-items-center mb-4 g-2">
        <div class="col-12 col-md-6 mb-2 mb-md-0">
            <h2 class="fw-bold mb-0" style="font-size:1.5rem;">
                BATCHPICKING DEMO <span class="text-primary ms-2" style="font-size:1rem;">Picklist: {{ nama_picklist }}</span>
            </h2>
            <div class="mt-2">
                <span class="badge bg-info text-dark mb-1" style="font-size:1em;">
                    Total SKU Pending: {{ total_pending }}
                </span>
            </div>
            <div>
                <span class="badge bg-success text-light" style="font-size:1em;">
                    Total SKU Completed: {{ total_completed }}
                </span>
            </div>
        </div>
        <div class="col-12 col-md-6">
            <div class="card shadow-sm mb-0">
                <div class="card-body py-2 px-2 px-md-3">
                    <div class="table-responsive mb-0">
                        <table class="table table-bordered align-middle mb-0" id="pivotlistSummaryTable" style="font-size:0.95em;">
                            <thead class="table-primary">
                                <tr>
                                    <th>Total Order</th>
                                    <th>Ready to Pick</th>
                                    <th>Ready to Print</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td id="summary-total-order">{{ total_order }}</td>
                                    <td id="summary-ready-to-pick">
                                        <a href="#" id="showReadyToPickModal" style="text-decoration:none; font-weight:bold;">{{ ready_to_pick }}</a>
                                    </td>
                                    <td id="summary-ready-to-print">...</td>
                                    <td>
                                        <a href="#" class="btn btn-primary btn-sm w-100">Generate Order ID</a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <div class="row mb-3"> 
            </div> 
            <form class="row g-2 mb-3">
                <div class="col-12 col-md-6">
                    <label for="barcodeInput" class="form-label fw-bold">Scan Barcode</label>
                    <input type="text" id="barcodeInput" class="form-control" placeholder="Scan barcode here..." autofocus autocomplete="off">
                    <div id="barcodeFeedback" class="mt-2"></div>
                </div>
                <div class="col-12 col-md-6">
                    <label for="updateManualInput" class="form-label fw-bold">Manual Search (SKU/Barcode/Nama/Variant/Brand)</label>
                    <input type="text" id="updateManualInput" class="form-control" placeholder="Cari SKU, Barcode, Nama Produk, Variant, Brand..." autocomplete="off">
                    <div id="updateManualDropdown" class="list-group position-absolute w-100" style="z-index:10; display:none;"></div>
                    <div id="updateManualQtyControl" class="d-flex align-items-center mt-2" style="display:none;">
                        <button type="button" class="btn btn-outline-secondary btn-sm me-2" id="qtyMinus">-</button>
                        <input type="number" id="qtyInput" class="form-control form-control-sm text-center" style="width:70px;" value="0" min="0">
                        <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="qtyPlus">+</button>
                        <button type="button" class="btn btn-primary btn-sm ms-3" id="qtySubmit">Update</button>
                    </div>
                    <div id="updateManualFeedback" class="mt-2"></div>
                </div>
            </form>
            <div class="row mb-3">
                <div class="col-md-4">
                    <select id="brandDropdown" class="form-select form-select-sm" style="width:auto; min-width:120px; font-size:0.95em;">
                        <option value="">Filter Brand</option>
                    </select>
                </div>
            </div>
            <div class="table-responsive mb-3">
                <table class="table table-hover align-middle table-sm text-center" id="batchPickingTablePending">
                    <thead class="table-primary align-middle text-center">
                        <tr>
                            <th class="sortable" data-col="0">SKU</th>
                            <th class="sortable" data-col="1">Barcode</th>
                            <th class="sortable" data-col="2">Nama</th>
                            <th class="sortable" data-col="3">Variant</th>
                            <th class="sortable" data-col="4">Brand</th>
                            <th class="sortable" data-col="5">Rack</th>
                            <th class="sortable" data-col="6">Jumlah</th>
                            <th class="sortable" data-col="7">J.Ambil</th>
                            <th class="sortable" data-col="8">Status</th>
                            <th class="sortable" data-col="9">Single</th>
                            <th class="sortable" data-col="10">Mix</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in details %}
                        {% if item.status_ambil != 'completed' %}
                        <tr data-barcode="{{ item.barcode }}">
                            <td>{{ item.sku }}</td>
                            <td>{{ item.barcode }}</td>
                            <td>{{ item.nama_produk }}</td>
                            <td>{{ item.variant_produk }}</td>
                            <td>{{ item.brand }}</td>
                            <td>{{ item.rack }}</td>
                            <td class="jumlah">{{ item.jumlah }}</td>
                            <td class="jumlah-ambil"><span class="badge bg-warning text-dark rounded-pill px-3 py-2" style="font-size:1em; font-weight:600; letter-spacing:0.5px;">{{ item.jumlah_ambil }}</span></td>
                            <td class="status-ambil">{{ item.status_ambil }}</td>
                            <td class="satuan">{{ item.satuan }}</td>
                            <td class="gabungan">{{ item.gabungan }}</td>
                        </tr>
                        {% endif %}
                        {% empty %}
                        <tr><td colspan="11" class="text-center">Tidak ada data.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <h5 class="card-title mt-4">Item Selesai (Completed)</h5>
            <div class="table-responsive">
                <table class="table table-hover align-middle table-sm text-center" id="batchPickingTableCompleted">
                    <thead class="table-success align-middle text-center">
                        <tr>
                            <th class="sortable" data-col="0">SKU</th>
                            <th class="sortable" data-col="1">Barcode</th>
                            <th class="sortable" data-col="2">Nama</th>
                            <th class="sortable" data-col="3">Variant</th>
                            <th class="sortable" data-col="4">Brand</th>
                            <th class="sortable" data-col="5">Rack</th>
                            <th class="sortable" data-col="6">Jumlah</th>
                            <th class="sortable" data-col="7">J.Ambil</th>
                            <th class="sortable" data-col="8">Status</th>
                            <th class="sortable" data-col="9">Single</th>
                            <th class="sortable" data-col="10">Mix</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in details %}
                        {% if item.status_ambil == 'completed' %}
                        <tr data-barcode="{{ item.barcode }}">
                            <td>{{ item.sku }}</td>
                            <td>{{ item.barcode }}</td>
                            <td>{{ item.nama_produk }}</td>
                            <td>{{ item.variant_produk }}</td>
                            <td>{{ item.brand }}</td>
                            <td>{{ item.rack }}</td>
                            <td class="jumlah">{{ item.jumlah }}</td>
                            <td class="jumlah-ambil"><span class="badge bg-warning text-dark rounded-pill px-3 py-2" style="font-size:1em; font-weight:600; letter-spacing:0.5px;">{{ item.jumlah_ambil }}</span></td>
                            <td class="status-ambil">{{ item.status_ambil }}</td>
                            <td class="satuan">{{ item.satuan }}</td>
                            <td class="gabungan">{{ item.gabungan }}</td>
                        </tr>
                        {% endif %}
                        {% empty %}
                        <tr><td colspan="11" class="text-center">Tidak ada data.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Ready to Pick IDs -->
<div class="modal fade" id="readyToPickModal" tabindex="-1" aria-labelledby="readyToPickModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="readyToPickModalLabel">ID Pesanan Ready to Pick</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {% if ready_to_pick_ids %}
        <ul style="padding-left:18px; font-size:1em;">
            {% for idp in ready_to_pick_ids %}
                <li>{{ idp }}</li>
            {% endfor %}
        </ul>
        {% else %}
        <div class="text-muted">Belum ada order yang ready.</div>
        {% endif %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
      </div>
    </div>
  </div>
</div>

<script>
// --- Sort Table Header (Client-side) ---
function sortTable(tableId, colIdx, type, asc) {
    const table = document.getElementById(tableId);
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.sort((a, b) => {
        let v1 = a.children[colIdx].textContent.trim();
        let v2 = b.children[colIdx].textContent.trim();
        if (type === 'number') {
            v1 = parseFloat(v1) || 0;
            v2 = parseFloat(v2) || 0;
        } else {
            v1 = v1.toLowerCase();
            v2 = v2.toLowerCase();
        }
        if (v1 < v2) return asc ? -1 : 1;
        if (v1 > v2) return asc ? 1 : -1;
        return 0;
    });
    rows.forEach(row => tbody.appendChild(row));
}

document.addEventListener('DOMContentLoaded', function() {
    // Tambah event click ke semua th.sortable
    document.querySelectorAll('#batchPickingTablePending th.sortable, #batchPickingTableCompleted th.sortable').forEach(th => {
        let asc = true;
        th.style.cursor = 'pointer';
        th.addEventListener('click', function() {
            const tableId = th.closest('table').id;
            const colIdx = parseInt(th.getAttribute('data-col'));
            // Kolom angka: Jumlah, Jumlah Ambil, Satuan, Gabungan
            const type = ([6, 7, 9, 10].includes(colIdx)) ? 'number' : 'string';
            sortTable(tableId, colIdx, type, asc);
            asc = !asc;
        });
    });

    // --- Brand Dropdown di atas tabel pending ---
    const brandDropdown = document.getElementById('brandDropdown');
    if (brandDropdown) {
        const brands = Array.from(new Set(Array.from(document.querySelectorAll('#batchPickingTablePending tbody tr')).map(row => row.children[4].textContent.trim()))).filter(b => b);
        brands.sort();
        brands.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b;
            opt.textContent = b;
            brandDropdown.appendChild(opt);
        });
        brandDropdown.addEventListener('change', function() {
            const val = brandDropdown.value;
            document.querySelectorAll('#batchPickingTablePending tbody tr').forEach(row => {
                const brand = row.children[4].textContent.trim();
                row.style.display = (!val || brand === val) ? '' : 'none';
            });
        });
    }
});
</script>
{% endblock %}
