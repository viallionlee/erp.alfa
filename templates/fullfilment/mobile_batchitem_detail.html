{% extends 'base_mobile.html' %}
{% block content %}
<div class="container-fluid py-3" style="max-width:460px; margin:auto;">
  <div id="scanBarcodeFeedback" class="text-danger small mb-2"></div>
  <div class="card shadow-sm rounded-3 mb-3">
    <div class="card-body text-center px-3 py-3">
      {% if product.photo %}
        <img src="{{ product.photo.url }}" alt="Foto Produk" class="rounded mb-3" style="height:300px; width:auto; max-width:100%; object-fit:contain; background:#fafafa;">
      {% else %}
        <div class="rounded-circle d-flex align-items-center justify-content-center mb-3" style="width:120px; height:120px; background:#f0f0f0; font-size:3rem; color:#bbb;">ðŸ“¦</div>
      {% endif %}
      <div class="text-uppercase fw-bold mb-1" style="font-size:1.1rem;">{{ product.nama_produk }}</div>
      <div class="text-primary mb-3" style="font-size:1.05rem;">{{ product.variant_produk }}</div>
      <div class="mb-3">
        <div class="row mb-2">
          <div class="col-6 text-start small text-muted">SKU</div>
          <div class="col-6 text-end text-monospace fw-semibold">{{ product.sku }}</div>
        </div>
        <div class="row mb-2">
          <div class="col-6 text-start small text-muted">Barcode</div>
          <div class="col-6 text-end text-monospace fw-semibold" id="currentBarcode">{{ product.barcode }}</div>
        </div>
        <div class="row mb-2">
          <div class="col-6 text-start small text-muted">Brand</div>
          <div class="col-6 text-end fw-semibold">{{ product.brand }}</div>
        </div>
      </div>
      <div class="d-flex justify-content-center gap-4">
        <div class="border rounded px-3 py-2 bg-light">
          <div class="small text-muted">Jumlah</div>
          <div class="fs-5 fw-bold" id="jumlahTotal">{{ jumlah }}</div>
        </div>
        <div class="border rounded px-3 py-2 bg-light">
          <div class="small text-muted">Ambil</div>
          <div class="d-flex align-items-center justify-content-center gap-2">
            <button class="btn btn-outline-secondary btn-sm" id="btnMinus">-</button>
            <input type="number" id="jumlahAmbilInput" class="form-control form-control-sm text-center" style="width:60px;" value="{{ jumlah_ambil }}" min="0" max="{{ jumlah }}">
            <button class="btn btn-outline-secondary btn-sm" id="btnPlus">+</button>
            <button class="btn btn-outline-primary btn-sm" id="btnMax">Max</button>
          </div>
          <div id="scanLockMsg" class="text-danger small mt-1" style="display:none;">*scan barcode dahulu untuk edit</div>
        </div>
      </div>
    </div>
  </div>
  <div class="mb-3 d-flex align-items-center gap-2">
    <input type="text" id="scanBarcodeInput" class="form-control form-control-lg text-center" placeholder="Scan barcode..." autocomplete="off" autofocus>
  </div>
  <div class="modal fade" id="failModal" tabindex="-1" aria-labelledby="failModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-sm">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="failModalLabel">Barcode Tidak Sesuai</h5>
        </div>
        <div class="modal-body text-center">
          <p>Barcode yang discan tidak sesuai dengan produk ini.</p>
          <button type="button" class="btn btn-secondary mt-2" data-bs-dismiss="modal">Tutup</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="completedModal" tabindex="-1" aria-labelledby="completedModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-sm text-center p-4">
        <div class="modal-body">
          <div class="mb-3">
            <div class="d-inline-flex align-items-center justify-content-center bg-success bg-opacity-10 rounded-circle mb-2" style="width:64px; height:64px;">
              <i class="bi bi-check2" style="font-size:2.5rem; color:#198754;"></i>
            </div>
          </div>
          <h5 class="mb-2 text-success">Scan Completed</h5>
          <div class="mb-3">Barang sudah selesai diambil.</div>
          <div class="small text-muted">Anda akan kembali ke daftar dalam 1 detik...</div>
        </div>
      </div>
    </div>
  </div>
  <style>
  body, .container-fluid { padding-bottom: 0 !important; }
  .fab-reload {
  position: fixed;
  bottom: 80px;
  left: 24px;
  z-index: 1050;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: #1976d2;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.18);
  font-size: 2rem;
  border: none;
  outline: none;
  transition: background 0.2s;
}
.fab-reload:active {
  background: #1565c0;
}
  </style>
  <div style="position:fixed; left:0; right:0; bottom:0; width:100vw; z-index:1000; background:#fff; box-shadow:0 -2px 8px rgba(0,0,0,0.04); padding:10px 0 0 0;">
    <div class="container-fluid" style="max-width:460px; margin:auto;">
      <div class="mb-2 px-2 d-flex align-items-center gap-2">
        <button class="btn btn-outline-secondary btn-lg w-50 mb-1" id="backBtnBottom">ðŸ’¾ Save &amp; Back</button>
      </div>
    </div>
  </div>
  <button class="fab-reload" id="fabReloadBtn" title="Reload">
  <i class="bi bi-arrow-clockwise"></i>
</button>
</div>
<audio id="successSound" src="/static/sounds/completedsound.mp3"></audio>
<audio id="failSound" src="/static/sounds/wrong_barcode.mp3"></audio>
{% endblock %}
{% block extra_script %}
<script>
  const input = document.getElementById('jumlahAmbilInput');
  const btnMinus = document.getElementById('btnMinus');
  const btnPlus = document.getElementById('btnPlus');
  const btnMax = document.getElementById('btnMax');
  const scanBarcodeInput = document.getElementById('scanBarcodeInput');
  const scanBarcodeFeedback = document.getElementById('scanBarcodeFeedback');
  const reloadPageBtn = document.getElementById('reloadPageBtn');
  const currentBarcode = document.getElementById('currentBarcode').textContent.trim();
  const maxJumlah = parseInt(document.getElementById('jumlahTotal').textContent.trim());
  const pathParts = window.location.pathname.split('/');
  const batchitemId = pathParts[pathParts.indexOf('batchitem') + 1];
  const urlUpdate = `/fullfilment/batchitem/${batchitemId}/update_jumlah_ambil/`;
  function autoSaveJumlahAmbil(val, callback) {
    fetch(urlUpdate, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}',
      },
      body: JSON.stringify({ jumlah_ambil: val })
    })
    .then(r => r.json())
    .then(function(data) {
      if (data.success) {
        input.classList.add('border-success');
        setTimeout(() => input.classList.remove('border-success'), 300);
        if (data.completed) {
          const successSound = document.getElementById('successSound');
          if (successSound) successSound.play();
          // Tampilkan modal scan completed
          const completedModal = new bootstrap.Modal(document.getElementById('completedModal'));
          completedModal.show();
          setTimeout(() => {
            const namaBatch = "{{ batchitem.batchlist.nama_batch|urlencode }}";
            // Tambahkan query param agar batchpicking auto reload
            window.location.href = `/fullfilment/batchpicking/${namaBatch}/?reload=1`;
          }, 1000);
          return;
        }
      } else {
        input.classList.add('border-danger');
        setTimeout(() => input.classList.remove('border-danger'), 600);
      }
      if (typeof callback === 'function') callback();
    });
  }
  function reloadWithSave() {
  let val = parseInt(input.value) || 0;
  autoSaveJumlahAmbil(val, function() {
    window.location.reload();
    setTimeout(() => {
      scanBarcodeInput.focus();
    }, 200);
  });
}
  reloadPageBtn.onclick = reloadWithSave;
  document.addEventListener('DOMContentLoaded', function() {
    var fabReloadBtn = document.getElementById('fabReloadBtn');
    if (fabReloadBtn) {
      fabReloadBtn.onclick = reloadWithSave;
    }
  });
  document.getElementById('backBtnBottom').onclick = function() {
    const ref = document.referrer;
    let batchitemUrl = null;
    if (ref && ref.includes('/fullfilment/mobile/batchitem/')) {
      const match = ref.match(/\/fullfilment\/mobile\/batchitem\/([0-9]+)\/detail\//);
      if (match && match[1]) {
        batchitemUrl = `/fullfilment/mobile/batchitem/${match[1]}/detail/`;
      }
    }
    if (batchitemUrl) {
      window.location.href = batchitemUrl;
    } else {
      window.history.back(); // fallback ke halaman sebelumnya
    }
  }
  btnMinus.onclick = function() {
    let val = parseInt(input.value) || 0;
    if (val > 0) {
      input.value = val - 1;
      autoSaveJumlahAmbil(input.value);
    }
  }
  btnPlus.onclick = function() {
    let val = parseInt(input.value) || 0;
    if (val < maxJumlah) {
      input.value = val + 1;
      autoSaveJumlahAmbil(input.value);
    }
  }
  btnMax.onclick = function() {
    input.value = maxJumlah;
    autoSaveJumlahAmbil(input.value);
  }
  input.onchange = function() {
    let val = parseInt(input.value) || 0;
    if (val < 0) val = 0;
    if (val > maxJumlah) val = maxJumlah;
    input.value = val;
    autoSaveJumlahAmbil(val);
  }
  // Lock manual input sebelum scan barcode pertama kali
  let barcodeScanned = false;
  input.disabled = true;
  btnMinus.disabled = true;
  btnPlus.disabled = true;
  btnMax.disabled = true;
  document.getElementById('scanLockMsg').style.display = '';

  scanBarcodeInput.addEventListener('keydown', function(e) {
    if (!barcodeScanned && e.key === 'Enter' && scanBarcodeInput.value.trim() === currentBarcode) {
      barcodeScanned = true;
      input.disabled = false;
      btnMinus.disabled = false;
      btnPlus.disabled = false;
      btnMax.disabled = false;
      document.getElementById('scanLockMsg').style.display = 'none';
    }
    if (e.key === 'Enter') {
      if (scanBarcodeInput.value.trim() === currentBarcode) {
        scanBarcodeFeedback.textContent = '';
        btnPlus.click();
        scanBarcodeInput.value = '';
      } else {
        scanBarcodeFeedback.textContent = 'Barcode tidak sesuai produk ini!';
        const failSound = document.getElementById('failSound');
        if (failSound) failSound.play();
        scanBarcodeInput.value = '';
        setTimeout(() => scanBarcodeFeedback.textContent = '', 1200);
      }
    }
  });
  document.getElementById('goToListBtn').onclick = function() {
    // Redirect ke daftar mobile batchitem sesuai nama_batch
    const namaBatch = "{{ batchitem.batchlist.nama_batch|urlencode }}";
    window.location.href = `/fullfilment/mobile/batchpicking/${namaBatch}/`;
  }
  // Fitur drag untuk input jumlah
  let dragStartX = null;
  let dragStartVal = null;
  input.addEventListener('mousedown', function(e) {
    dragStartX = e.clientX;
    dragStartVal = parseInt(input.value) || 0;
    document.body.style.cursor = 'ew-resize';
  });
  document.addEventListener('mousemove', function(e) {
    if (dragStartX !== null) {
      let delta = Math.round((e.clientX - dragStartX) / 10); // 10px = 1 step
      let newVal = dragStartVal + delta;
      if (newVal < 0) newVal = 0;
      if (newVal > maxJumlah) newVal = maxJumlah;
      input.value = newVal;
      autoSaveJumlahAmbil(newVal);
    }
  });
  document.addEventListener('mouseup', function(e) {
    if (dragStartX !== null) {
      dragStartX = null;
      dragStartVal = null;
      document.body.style.cursor = '';
    }
  });
  // Untuk mobile/touch
  input.addEventListener('touchstart', function(e) {
    if (e.touches.length === 1) {
      dragStartX = e.touches[0].clientX;
      dragStartVal = parseInt(input.value) || 0;
    }
  });
  input.addEventListener('touchmove', function(e) {
    if (dragStartX !== null && e.touches.length === 1) {
      let delta = Math.round((e.touches[0].clientX - dragStartX) / 10);
      let newVal = dragStartVal + delta;
      if (newVal < 0) newVal = 0;
      if (newVal > maxJumlah) newVal = maxJumlah;
      input.value = newVal;
      autoSaveJumlahAmbil(newVal);
    }
  });
  input.addEventListener('touchend', function(e) {
    dragStartX = null;
    dragStartVal = null;
  });
</script>
{% endblock %}
