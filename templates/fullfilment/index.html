{% extends 'base.html' %}
{% load humanize %}

{% block title %}Daftar Batchlist Fulfillment{% endblock %}

{% block extra_head %}
{{ block.super }}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
{% endblock %}

{% block content %}
<form id="csrf-token-form" style="display:none;">{% csrf_token %}</form>

<style>
  /* ===== SIMPLE COLOR PALETTE ===== */
  :root {
    --primary: #2563eb;
    --success: #16a34a;
    --danger: #dc2626;
    --warning: #f59e0b;
    --gray-light: #f8fafc;
    --gray-border: #e2e8f0;
    --text-muted: #64748b;
  }

  /* ===== INFO CARDS ===== */
  .info-card {
    background: white;
    border-radius: 0.5rem;
    padding: 1rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--gray-border);
    transition: all 0.2s ease;
    min-height: 100px;
    max-height: 100px;
    display: flex;
    align-items: center;
  }

  .info-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }

  .info-card .icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    margin-right: 0.75rem;
    flex-shrink: 0;
  }

  .info-card .content {
    display: flex;
    flex-direction: column;
    flex: 1;
    min-width: 0;
  }

  .info-card .value {
    font-size: 1.8rem;
    font-weight: 700;
    line-height: 1.1;
    margin-bottom: 0.2rem;
  }

  .info-card .label {
    font-size: 0.9rem;
    color: var(--text-muted);
    line-height: 1.1;
    white-space: nowrap;
  }

  .info-card.primary .icon {
    background: var(--primary);
    color: white;
  }

  .info-card.success .icon {
    background: var(--success);
    color: white;
  }

  .info-card.warning .icon {
    background: var(--warning);
    color: white;
  }

  .info-card.info .icon {
    background: #0ea5e9;
    color: white;
  }

  .info-card.secondary .icon {
    background: var(--text-muted);
    color: white;
  }

  .info-card.danger .icon {
    background: var(--danger);
    color: white;
  }

  /* ===== GROUPED INFO CARD ===== */
  .grouped-info-card {
    background: white;
    border-radius: 0.5rem;
    padding: 1rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--gray-border);
    transition: all 0.2s ease;
    min-height: 120px;
    max-height: 120px; /* Increased height for better visibility */
    display: flex;
    align-items: center;
  }

  .grouped-info-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }

  .grouped-info-card .header {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  .grouped-info-card .header .icon {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    margin-right: 0.5rem;
    flex-shrink: 0;
  }

  .grouped-info-card .header .title {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .grouped-info-card .stats {
    display: flex;
    gap: 1rem;
    width: 100%;
    justify-content: space-between;
    align-items: center;
  }

  .grouped-info-card .stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    flex: 1;
  }

  .grouped-info-card .stat-value {
    font-size: 1.8rem;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 0.3rem;
  }

  .grouped-info-card .stat-label {
    font-size: 1rem;
    color: var(--text-muted);
    line-height: 1;
    white-space: nowrap;
  }

  .grouped-info-card.primary .header .icon {
    background: var(--primary);
    color: white;
  }

  .grouped-info-card.success .header .icon {
    background: var(--success);
    color: white;
  }

  .grouped-info-card.danger .header .icon {
    background: var(--danger);
    color: white;
  }

  /* ===== SMALL ICON AND TITLE ===== */
  .icon-small {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    flex-shrink: 0;
  }

  .grouped-info-card.primary .icon-small {
    background: var(--primary);
    color: white;
  }

  .grouped-info-card.success .icon-small {
    background: var(--success);
    color: white;
  }

  .title-small {
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
  }

  /* ===== INFO LABEL ===== */
  .info-label {
    background: var(--primary);
    color: white;
    padding: 0.5rem 0.75rem;
    border-radius: 0.5rem;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    white-space: nowrap;
    height: 100px;
  }



  /* ===== SIMPLE HEADER ===== */
  .page-header {
    background: var(--primary);
    color: white;
    padding: 1rem 1.5rem;
    margin-bottom: 1.5rem;
    border-radius: 0.5rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .page-header h1 {
    margin: 0;
    font-size: 1.375rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .page-header h1::before {
    content: "üìã";
    font-size: 1.125rem;
    opacity: 0.9;
  }

  .generate-btn {
    background: white;
    color: var(--primary);
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    font-weight: 600;
    font-size: 0.875rem;
    transition: all 0.2s ease;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }


  .generate-btn:hover {
    background: #f8fafc;
    color: var(--primary);
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    text-decoration: none;
  }

  /* ===== SIMPLE TABLE ===== */
  .table-container {
    background: white;
    border: 1px solid var(--gray-border);
    border-radius: 0.5rem;
    overflow: visible; /* Changed from hidden to visible to allow dropdowns to extend */
  }

  /* Add specific overflow handling for table content */
  .table-responsive {
    overflow-x: auto;
    overflow-y: visible; /* Allow vertical overflow for dropdowns */
  }

  /* Ensure dropdown menus can extend beyond table boundaries */
  .dropdown-menu {
    z-index: 1050; /* Higher z-index to ensure dropdown appears above other elements */
    position: absolute !important;
  }

  /* Ensure dropdown containers don't clip content */
  .dropdown {
    position: relative !important;
  }

  /* Override any parent overflow restrictions for dropdowns */
  .table-container,
  .table-responsive,
  .table,
  tbody,
  tr,
  td {
    overflow: visible !important;
  }

  /* Specific fix for action buttons column */
  .action-buttons {
    overflow: visible !important;
    position: relative;
  }

  /* Force all parent containers to allow overflow */
  .container-fluid,
  .row,
  .col {
    overflow: visible !important;
  }

  /* Ensure table cells don't clip dropdowns */
  .batch-row td {
    overflow: visible !important;
    position: relative;
  }

  /* Make sure dropdown menu can extend beyond any container */
  .dropdown-menu.show {
    position: absolute !important;
    z-index: 9999 !important;
    transform: translate3d(0px, 38px, 0px) !important; /* Bootstrap default positioning */
  }

  /* Ensure proper dropdown positioning */
  .dropdown-menu {
    top: 100% !important;
    left: 0 !important;
    right: auto !important;
    margin-top: 0.125rem !important;
  }

  .table thead th {
    background: #f1f5f9;
    color: var(--text-muted);
    font-weight: 600;
    font-size: 0.875rem;
    border: none;
    padding: 0.75rem;
    border-bottom: 2px solid var(--gray-border);
  }

  .table thead th[colspan] {
    background: #e2e8f0;
    font-weight: 700;
    font-size: 0.9rem;
  }

  /* ===== PARENT ROW (BATCH INFO) ===== */
  .batch-row {
    background: white;
    border-bottom: 1px solid var(--gray-border);
  }

  .batch-row td {
    padding: 1rem 0.75rem;
    vertical-align: middle;
    border: none;
    height: 100px;
    overflow: hidden;
  }
  
  .batch-row td.text-center {
    height: 100px;
    max-height: 100px;
    overflow: hidden;
    display: table-cell;
    vertical-align: middle;
  }

  .batch-row:hover {
    background: var(--gray-light);
  }

  /* ===== BATCH CLOSED ROW ===== */
  .batch-row.closed {
    background: #e3f2fd; /* Biru muda */
  }

  .batch-row.closed:hover {
    background: #bbdefb; /* Biru muda yang lebih gelap saat hover */
  }

  /* ===== BATCH FULFILLED ROW ===== */
  .batch-row.fulfilled {
    background: #f0fff4; /* Hijau sangat muda untuk fulfilled */
    border-left: 4px solid var(--success);
  }

  .batch-row.fulfilled:hover {
    background: #e6ffed; /* Hijau muda yang lebih gelap saat hover */
  }

  .batch-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .batch-name {
    color: var(--primary);
    font-weight: 600;
    text-decoration: none;
    font-size: 1rem;
  }

  .batch-name:hover {
    text-decoration: underline;
  }

  .batch-date {
    font-size: 0.8rem;
    color: var(--text-muted);
  }

  .fulfillment-check {
    font-size: 1.2rem;
    color: var(--success);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
  }

  .info-horizontal {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    align-items: flex-start;
    height: 80px;
    max-height: 80px;
    overflow: hidden;
  }

  .info-item {
    display: flex;
    flex-direction: column;
    gap: 0.1rem;
    text-align: left;
    min-width: 120px;
    height: 80px;
    max-height: 80px;
    overflow: hidden;
  }

  .sku-count {
    font-weight: 500;
    font-size: 0.9rem;
    text-align: left;
    margin-bottom: 0.1rem;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    line-height: 1.2;
  }

  .sku-count .stat-value {
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--text-muted);
    margin-left: 0.5rem;
  }

  .order-stat-item {
    font-size: 0.9rem;
    color: var(--text-muted);
    margin-top: 0.1rem;
    line-height: 1.2;
    font-weight: 500;
    text-align: left;
    display: flex;
    align-items: center;
  }

  .order-stat-item .stat-value {
    font-weight: 700;
    font-size: 1.1rem;
    margin-left: 0.5rem;
  }

  .overstock-note {
    margin-left: 0.25rem;
    font-size: 0.75rem;
    cursor: help;
    opacity: 0.8;
    transition: opacity 0.2s ease;
  }

  .overstock-note:hover {
    opacity: 1;
  }

  .return-stock-link {
    margin-left: 0.5rem;
    font-size: 0.7rem;
    color: var(--warning);
    text-decoration: none;
    font-weight: 500;
    padding: 0.125rem 0.375rem;
    border: 1px solid var(--warning);
    border-radius: 0.25rem;
    background-color: rgba(255, 193, 7, 0.1);
    transition: all 0.2s ease;
  }

  .return-stock-link:hover {
    background-color: var(--warning);
    color: white;
    text-decoration: none;
  }



  .sku-completed {
    color: var(--success);
  }

  .sku-pending {
    color: var(--danger);
  }

  .status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.85rem;
    font-weight: 500;
  }

  .status-open {
    background: var(--success);
    color: white;
  }

  .status-closed {
    background: var(--text-muted);
    color: white;
  }

  /* ===== CHILD ROW (ORDER INFO + ACTIONS) ===== */
  .order-row {
    background: var(--gray-light);
    border-bottom: 2px solid var(--gray-border);
  }

  .order-row td {
    padding: 0.75rem;
    border: none;
  }

  /* ===== COMPACT CHILD ROW ===== */
  .order-row-compact {
    background: var(--gray-light);
    border-top: 1px solid var(--gray-border);
    margin-top: 0.75rem;
    padding: 0.75rem;
    border-radius: 0.375rem;
  }

  .order-stats {
    display: flex;
    gap: 1.5rem;
    align-items: center;
    flex-wrap: wrap;
  }

  .stat-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .stat-label {
    color: var(--text-muted);
    font-size: 0.875rem;
    font-weight: 500;
  }

  .stat-value {
    font-weight: 600;
    font-size: 0.875rem;
  }

  .stat-value.primary { color: var(--primary); }
  .stat-value.success { color: var(--success); }
  .stat-value.danger { color: var(--danger); }

  /* ===== ACTION BUTTONS ===== */
  .action-buttons {
    display: flex;
    gap: 0.375rem;
    flex-wrap: wrap;
    margin-bottom: 0.75rem;
  }

  .btn-main {
    padding: 0.5rem 0.875rem;
    font-size: 0.8rem;
    border-radius: 0.375rem;
    border: 1px solid var(--gray-border);
    background: white;
    color: var(--text-muted);
    text-decoration: none;
    transition: all 0.2s;
    font-weight: 500;
    min-width: 80px;
    text-align: center;
  }

  .btn-main:hover {
    background: var(--gray-light);
    color: var(--primary);
    border-color: var(--primary);
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .btn-main.primary {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }

  .btn-main.primary:hover {
    background: #1d4ed8;
  }

  .btn-main.success {
    background: var(--success);
    color: white;
    border-color: var(--success);
  }

  .btn-main.success:hover {
    background: #15803d;
  }

  .btn-main.info {
    background: #0ea5e9;
    color: white;
    border-color: #0ea5e9;
  }

  .btn-main.info:hover {
    background: #0284c7;
  }

  .btn-main.warning {
    background: var(--warning);
    color: white;
    border-color: var(--warning);
  }

  .btn-main.warning:hover {
    background: #d97706;
  }

  .btn-main.danger {
    background: var(--danger);
    color: white;
    border-color: var(--danger);
  }

  .btn-main.danger:hover {
    background: #b91c1c;
  }

  .btn-main.secondary {
    background: var(--text-muted);
    color: white;
    border-color: var(--text-muted);
  }

  .btn-main.secondary:hover {
    background: #475569;
  }

  /* ===== BATCH ACTIONS ===== */
  .batch-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  /* ===== CHILD ACTIONS ===== */
  .child-actions {
    display: flex;
    gap: 0.375rem;
    flex-wrap: wrap;
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--gray-border);
  }

  .child-actions .btn-main {
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
    min-width: 70px;
  }

  /* ===== PAGINATION ===== */
  .pagination {
    margin: 0;
    padding: 1rem;
    background: var(--gray-light);
    border-top: 1px solid var(--gray-border);
  }

  .page-link {
    color: var(--primary);
    border: 1px solid var(--gray-border);
    padding: 0.5rem 0.75rem;
  }

  .page-link:hover {
    background: var(--gray-light);
    border-color: var(--primary);
  }

  .page-item.active .page-link {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
  }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 768px) {
    .order-stats {
      gap: 1rem;
    }
    
    .action-buttons {
      gap: 0.25rem;
    }
    
    .btn-main {
      padding: 0.25rem 0.5rem;
      font-size: 0.8rem;
    }
  }
</style>

<div class="container-fluid mt-4">
    <!-- Simple Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <h1>Daftar Batch</h1>
            <div class="d-flex gap-2">
                <button type="button" class="btn generate-btn" data-bs-toggle="modal" data-bs-target="#infoModal">
                    <i class="bi bi-hand-index me-1"></i>Informasi
                </button>
                <a href="{% url 'fullfilment-generatebatch' %}" class="btn generate-btn">
                    Generate Batch
                </a>
            </div>
        </div>
    </div>
    
    <!-- Summary Info Cards for Open Batches -->
    <div class="row g-2 mb-3 align-items-center">
        <!-- Batch Open -->
        <div class="col">
            <div class="grouped-info-card primary">
                <div class="d-flex flex-column w-100">
                    <div class="header">
                        <div class="icon primary">
                            <i class="bi bi-box"></i>
                        </div>
                        <div class="title">Batch Open</div>
                    </div>
                    <div class="stats justify-content-center">
                        <div class="stat-item">
                            <div class="stat-value" style="color: var(--primary);">{{ summary_open_batches.total_batches }}</div>
                            <div class="stat-label">Total Batches</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Grouped Info SKU Card -->
        <div class="col">
            <div class="grouped-info-card primary">
                <div class="d-flex flex-column w-100">
                    <div class="header">
                        <div class="icon primary">
                            <i class="bi bi-tag"></i>
                        </div>
                        <div class="title">INFO SKU</div>
                    </div>
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value" style="color: var(--primary);">{{ summary_open_batches.total_sku }}</div>
                            <div class="stat-label">Total SKU</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: var(--success);">{{ summary_open_batches.total_sku_completed }}</div>
                            <div class="stat-label">SKU Selesai</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: var(--danger);">{{ summary_open_batches.total_unallocated_sku }}</div>
                            <div class="stat-label">SKU Gantung</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: var(--danger);">{{ summary_open_batches.total_over_stock }}</div>
                            <div class="stat-label">SKU Overstock</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Grouped Info Order Card -->
        <div class="col">
            <div class="grouped-info-card success">
                <div class="d-flex flex-column w-100">
                    <div class="header">
                        <div class="icon success">
                            <i class="bi bi-cart"></i>
                        </div>
                        <div class="title">INFO ORDER</div>
                    </div>
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value" style="color: var(--primary);">{{ summary_open_batches.total_orders }}</div>
                            <div class="stat-label">Total Order</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: var(--success);">{{ summary_open_batches.total_orders_to_pick }}</div>
                            <div class="stat-label">Order to Pick</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: var(--success);">{{ summary_open_batches.total_orders_printed }}</div>
                            <div class="stat-label">Order Printed</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: var(--danger);">{{ summary_open_batches.total_orders_gantung }}</div>
                            <div class="stat-label">Order Gantung</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Simple Table -->
    <div class="table-container">
        <div class="table-responsive">
            <table class="table mb-0">
                <thead>
                    <tr>
                        <th>Nama Batch</th>
                        <th class="text-center">Informasi</th>
                        <th class="text-center">Status</th>
                        <th class="text-center">Pengambilan</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for b in page_obj %}
                        <!-- Parent Row: Batch Info -->
                        <tr class="batch-row {% if b.status_batch == 'closed' %}closed{% elif b.sku_completed == b.total_sku and b.unallocated_sku == 0 and b.over_stock_count == 0 and b.orders_to_pick == b.total_orders_in_batch and b.orders_printed == b.total_orders_in_batch and b.orders_gantung == 0 %}fulfilled{% endif %}">
                            <td>
                                <div class="batch-info">
                                    <div class="d-flex align-items-center gap-2">
                                        <a href="{% url 'batchpicking' b.nama_batch %}" class="batch-name">{{ b.nama_batch }}</a>
                                        {% if b.sku_completed == b.total_sku and b.unallocated_sku == 0 and b.over_stock_count == 0 and b.orders_to_pick == b.total_orders_in_batch and b.orders_printed == b.total_orders_in_batch and b.orders_gantung == 0 %}
                                            <span class="fulfillment-check" title="Batch sudah fulfill semua kriteria">‚úÖ</span>
                                        {% endif %}
                                    </div>
                                    <div class="batch-date">{{ b.created_at|date:"d M Y, H:i" }}</div>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="info-horizontal">
                                    <div class="info-item">
                                        <div class="sku-count">Total SKU: <span class="stat-value primary">{{ b.total_sku }}</span></div>
                                        <div class="order-stat-item">Total Order: <span class="stat-value primary">{{ b.total_orders_in_batch }}</span></div>
                                    </div>
                                    <div class="info-item">
                                        <div class="sku-count">SKU Selesai: <span class="stat-value success">{{ b.sku_completed }}</span>{% if b.sku_completed == b.total_sku %} ‚úÖ{% endif %}</div>
                                        <div class="order-stat-item">Order to Pick: <span class="stat-value success">{{ b.orders_to_pick }}</span>{% if b.orders_to_pick == b.total_orders_in_batch %} ‚úÖ{% endif %}</div>
                                    </div>
                                    <div class="info-item">
                                        <a href="{% url 'unallocated_stock_list' b.nama_batch %}" class="sku-count" title="Lihat SKU Gantung">
                                            SKU Gantung: <span class="stat-value danger">{{ b.unallocated_sku }}</span>{% if b.unallocated_sku == 0 %} ‚úÖ{% endif %}
                                        </a>
                                        <div class="order-stat-item">Order Printed: <span class="stat-value success">{{ b.orders_printed }}</span>{% if b.orders_printed == b.total_orders_in_batch %} ‚úÖ{% endif %}</div>
                                    </div>
                                    <div class="info-item">
                                        <div class="sku-count">
                                            Over Stock: <span class="stat-value danger">{{ b.over_stock_count }}</span>{% if b.over_stock_count == 0 %} ‚úÖ{% endif %}
                                            {% if b.over_stock_count > 0 %}
                                                <span class="overstock-note" title="Ada over stock tolong lakukan proses return">‚ö†Ô∏è</span>
                                                <a href="{% url 'returnlist_dashboard' %}" class="return-stock-link" title="Lihat daftar item yang perlu di-return">
                                                    Return Stock
                                                </a>
                                            {% endif %}
                                        </div>
                                        <div class="order-stat-item">Order Gantung: <span class="stat-value danger">{{ b.orders_gantung }}</span>{% if b.orders_gantung == 0 %} ‚úÖ{% endif %}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="text-center">
                                <span class="status-badge {% if b.status_batch == 'open' %}status-open{% else %}status-closed{% endif %}">
                                    {{ b.get_status_batch_display }}
                                </span>
                            </td>
                            <td class="text-center">
                                {% if 'No Items' in b.status_pengambilan_display %}
                                    <span class="status-badge status-closed">{{ b.status_pengambilan_display }}</span>
                                {% elif '100%' in b.status_pengambilan_display %}
                                    <span class="status-badge status-open">{{ b.status_pengambilan_display }}</span>
                                {% else %}
                                    <span class="status-badge status-closed">{{ b.status_pengambilan_display }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="action-buttons">
                                    {% if b.status_batch != 'closed' %}
                                        <a class="btn-main primary" href="{% url 'batchpicking' b.nama_batch %}">Start Batchpicking</a>
                                        <a class="btn-main warning" href="{% url 'ready_to_print_list' %}?nama_batch={{ b.nama_batch }}">Ready to Print</a>
                                    {% else %}
                                        <a class="btn-main info" href="{% url 'batchpicking' b.nama_batch %}">View</a>
                                    {% endif %}
                                    <div class="dropdown d-inline">
                                        <button class="btn-main dropdown-toggle" data-bs-toggle="dropdown">
                                            Menu
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="{% url 'batchorder_view' b.nama_batch %}">Orders</a></li>
                                            <li><a class="dropdown-item" href="{% url 'batchitem_table_view' %}?batch_name={{ b.nama_batch }}">Table</a></li>
                                            <li><a class="dropdown-item btn-detail-order-ids" href="#" data-batch-name="{{ b.nama_batch }}">Detail ID</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item" href="{% url 'download_batchitem_excel' b.nama_batch %}">Download Excel</a></li>
                                            <li><a class="dropdown-item" href="{% url 'download_batchitem_pdf' b.nama_batch %}">Download PDF</a></li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <!-- Child Actions -->
                                <div class="child-actions">
                                    {% if b.status_batch != 'closed' %}
                                        <button type="button" class="btn-main info btn-transfer-batch-child"
                                                data-batch-id="{{ b.id }}" data-batch-name="{{ b.nama_batch }}" data-batch-status="{{ b.status_batch }}">
                                            Transfer
                                        </button>
                                        <button type="button" class="btn-main warning btn-close-batch-child"
                                                data-batch-id="{{ b.id }}" data-batch-name="{{ b.nama_batch }}" data-batch-status="{{ b.status_batch }}">
                                            Close
                                        </button>
                                        <button type="button" class="btn-main secondary btn-clean-batch-child"
                                                data-batch-id="{{ b.id }}" data-batch-name="{{ b.nama_batch }}" data-batch-status="{{ b.status_batch }}">
                                            Bersihkan
                                        </button>
                                        <button type="button" class="btn-main danger btn-delete-batch-child"
                                                data-batch-id="{{ b.id }}" data-batch-name="{{ b.nama_batch }}" data-batch-status="{{ b.status_batch }}">
                                            Delete
                                        </button>
                                    {% else %}
                                        <span class="text-muted small">Batch sudah closed</span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="bi bi-inbox fs-1"></i>
                                    <p class="mt-2">Tidak ada batch yang tersedia.</p>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Simple Pagination -->
        {% if page_obj.has_other_pages %}
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1">Awal</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Sebelumnya</a>
                    </li>
                {% endif %}

                <li class="page-item active">
                    <a class="page-link" href="#">
                        {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
                    </a>
                </li>

                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}">Selanjutnya</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Akhir</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- Modal for SKU Not Found Detail -->
<div class="modal fade" id="skuNotFoundModal" tabindex="-1" aria-labelledby="skuNotFoundModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="skuNotFoundModalLabel">Detail SKU Tidak Ditemukan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="skuNotFoundModalBody" style="white-space:pre-line;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
      </div>
    </div>
  </div>
</div>
<!-- Modal for ID Pesanan in Batch -->
<div class="modal fade" id="idPesananModal" tabindex="-1" aria-labelledby="idPesananModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="idPesananModalLabel">Daftar ID Pesanan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="max-height:60vh; overflow-y:auto;">
        <ul id="idPesananList" class="list-group"></ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
      </div>
    </div>
  </div>
</div>
<!-- Modal for Order IDs in Batch -->
<div class="modal fade" id="batchOrderIdsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order IDs for Batch: <span id="modalBatchNameSimple"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul id="batchOrderIdsListSimple" class="list-group">
                    <!-- Loaded via JS -->
                </ul>
            </div>
            {# NEW: Tombol Copy All #}
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                <button type="button" class="btn btn-primary" id="copyAllBatchOrderIdsBtn">Salin Semua (Download TXT)</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal for Close Batch Confirmation -->
<div class="modal fade" id="closeBatchModal" tabindex="-1" aria-labelledby="closeBatchModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="closeBatchModalLabel">Konfirmasi Tutup Batch</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Yakin ingin menutup batch <b id="closeBatchName"></b>? Setelah di-close, batch tidak bisa diedit lagi.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-danger" id="confirmCloseBatchBtn">Yakin, Tutup Batch</button>
      </div>
    </div>
  </div>
</div>
<!-- Modal for Transfer Batch -->
<div class="modal fade" id="transferBatchModal" tabindex="-1" aria-labelledby="transferBatchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="transferBatchModalLabel">Transfer Semua yang Gantung</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <h6>Pilih Batch Tujuan:</h6>
            <div class="form-check mb-3">
              <input class="form-check-input" type="radio" name="transferOption" id="newBatchOption" value="new" checked>
              <label class="form-check-label" for="newBatchOption">
                Buat Batch Baru
              </label>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="radio" name="transferOption" id="existingBatchOption" value="existing">
              <label class="form-check-label" for="existingBatchOption">
                Gunakan Batch Existing
              </label>
            </div>
            
            <div id="newBatchSection">
              <div class="mb-3">
                <label for="newBatchName" class="form-label">Nama Batch Baru:</label>
                <input type="text" class="form-control" id="newBatchName" placeholder="Contoh: BATCH_001">
              </div>
            </div>
            
            <div id="existingBatchSection" style="display: none;">
              <div class="mb-3">
                <label for="existingBatchSelect" class="form-label">Pilih Batch:</label>
                <select class="form-control" id="existingBatchSelect">
                  <option value="">-- Pilih Batch --</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <h6>Yang Akan Ditransfer:</h6>
            <div id="transferSummary">
              <div class="alert alert-info">
                <strong>Order Gantung:</strong> <span id="pendingOrdersCount">0</span> order<br>
                <strong>Stock Gantung:</strong> <span id="unallocatedStockCount">0</span> SKU
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-info" id="confirmTransferBtn">Transfer</button>
      </div>
    </div>
  </div>
</div>
<!-- Modal for Download Options -->
<div class="modal fade" id="downloadModal" tabindex="-1" aria-labelledby="downloadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="downloadModalLabel">Download Batch</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3">Download batch <strong id="downloadBatchName"></strong> dalam format PDF:</p>
        <div class="d-grid gap-2">
          <button type="button" class="btn btn-outline-danger btn-download-pdf">
            <i class="bi bi-file-pdf me-2"></i>Download PDF
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
      </div>
    </div>
  </div>
</div>
<!-- Modal for Information -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="infoModalLabel">
          <i class="bi bi-info-circle me-2"></i>Informasi Status Batch
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs mb-3" id="infoTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active btn-outline-primary" id="status-tab" data-bs-toggle="tab" data-bs-target="#status-pane" type="button" role="tab" aria-controls="status-pane" aria-selected="true">
              <i class="bi bi-info-circle me-1"></i>Status Batch
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link btn-outline-success" id="hapus-order-tab" data-bs-toggle="tab" data-bs-target="#hapus-order-pane" type="button" role="tab" aria-controls="hapus-order-pane" aria-selected="false">
              <i class="bi bi-book me-1"></i>Panduan Hapus Order
            </button>
          </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="infoTabsContent">
          <!-- Status Batch Tab -->
          <div class="tab-pane fade show active" id="status-pane" role="tabpanel" aria-labelledby="status-tab">
            <div class="alert alert-primary">
              <h6 class="alert-heading">
                <i class="bi bi-info-circle me-2"></i>Informasi Status Batch
              </h6>
              <p class="mb-2">Berikut adalah penjelasan status SKU dan Order dalam sistem batch fulfillment:</p>
            </div>

            <!-- Status SKU Section -->
            <div class="card mb-3 border-primary">
              <div class="card-header bg-primary text-white">
                <h6 class="mb-0">
                  <i class="bi bi-tag me-2"></i>Status SKU
                </h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-4">
                    <div class="d-flex align-items-center mb-3">
                      <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                        <i class="bi bi-check-circle"></i>
                      </div>
                      <div>
                        <strong>SKU Selesai</strong>
                        <p class="text-muted small mb-0">Total SKU yang sudah selesai diambil sesuai dengan jumlah yang dibutuhkan dalam batch.</p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="d-flex align-items-center mb-3">
                      <div class="bg-danger text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                        <i class="bi bi-clock-history"></i>
                      </div>
                      <div>
                        <strong>SKU Gantung</strong>
                        <p class="text-muted small mb-0">SKU yang sudah diambil tetapi tidak dapat diproses karena masih kurang dari jumlah yang dibutuhkan untuk order.</p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="d-flex align-items-center mb-3">
                      <div class="bg-warning text-dark rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                        <i class="bi bi-exclamation-triangle"></i>
                      </div>
                      <div>
                        <strong>Over Stock</strong>
                        <p class="text-muted small mb-0">SKU yang diambil melebihi jumlah yang dibutuhkan, biasanya terjadi karena order dibatalkan atau ada kesalahan dalam proses picking.</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Status Order Section -->
            <div class="card mb-3 border-success">
              <div class="card-header bg-success text-white">
                <h6 class="mb-0">
                  <i class="bi bi-cart me-2"></i>Status Order
                </h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-4">
                    <div class="d-flex align-items-center mb-3">
                      <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                        <i class="bi bi-hand-index"></i>
                      </div>
                      <div>
                        <strong>Order to Pick</strong>
                        <p class="text-muted small mb-0">Order yang sudah siap untuk diproses dan dapat dilakukan picking.</p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="d-flex align-items-center mb-3">
                      <div class="bg-info text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                        <i class="bi bi-printer"></i>
                      </div>
                      <div>
                        <strong>Order Printed</strong>
                        <p class="text-muted small mb-0">Order yang sudah siap untuk dipick dan telah dicetak (ready to print).</p>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="d-flex align-items-center mb-3">
                      <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                        <i class="bi bi-hourglass-split"></i>
                      </div>
                      <div>
                        <strong>Order Gantung</strong>
                        <p class="text-muted small mb-0">Order yang belum siap untuk dipick karena masih menunggu persiapan atau ada masalah dengan stok.</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Kriteria Batch Fulfillment -->
            <div class="card border-info">
              <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                  <i class="bi bi-lightbulb me-2"></i>Kriteria Batch Fulfillment
                </h6>
              </div>
              <div class="card-body">
                <p class="mb-3">Batch dianggap sudah fulfill dan siap dibersihkan jika memenuhi semua kriteria berikut:</p>
                
                <!-- Criteria Grid -->
                <div class="row">
                  <div class="col-md-6">
                    <div class="d-flex align-items-center mb-2">
                      <span class="badge bg-success me-2">‚úì</span>
                      <span><strong>SKU Selesai = Total SKU</strong> - Semua SKU sudah selesai diambil</span>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                      <span class="badge bg-success me-2">‚úì</span>
                      <span><strong>SKU Gantung = 0</strong> - Tidak ada SKU yang tertunda</span>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                      <span class="badge bg-success me-2">‚úì</span>
                      <span><strong>Over Stock = 0</strong> - Tidak ada kelebihan stok</span>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="d-flex align-items-center mb-2">
                      <span class="badge bg-success me-2">‚úì</span>
                      <span><strong>Order to Pick = Total Order</strong> - Semua order siap dipick</span>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                      <span class="badge bg-success me-2">‚úì</span>
                      <span><strong>Order Printed = Total Order</strong> - Semua order sudah dicetak</span>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                      <span class="badge bg-success me-2">‚úì</span>
                      <span><strong>Order Gantung = 0</strong> - Tidak ada order yang tertunda</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Panduan Hapus Order Tab -->
          <div class="tab-pane fade" id="hapus-order-pane" role="tabpanel" aria-labelledby="hapus-order-tab">
            <div class="alert alert-primary">
              <h6 class="alert-heading">
                <i class="bi bi-book me-2"></i>Panduan Menghapus Order dari Batch
              </h6>
              <p class="mb-2">Berikut adalah cara menghapus order dari batch berdasarkan status order:</p>
            </div>

            <!-- Case 1: Order Belum Printed -->
            <div class="card mb-3 border-success">
              <div class="card-header bg-success text-white">
                <h6 class="mb-0">
                  <i class="bi bi-check-circle me-2"></i>Case 1: Order Belum Printed (Status Order = pending)
                </h6>
              </div>
              <div class="card-body">
                <p class="mb-2"><strong>Kondisi:</strong> Order masih dalam status <span class="badge bg-warning">pending</span> (belum dicetak)</p>
                <p class="mb-2"><strong>Lokasi:</strong> Halaman Batch Order (Orders)</p>
                <p class="mb-2"><strong>Cara:</strong> Klik tombol <span class="badge bg-danger">Hapus dari Batch</span> di kolom Aksi</p>
                <p class="mb-0"><strong>Hasil:</strong> Order langsung dihapus dari batch, stok dikembalikan</p>
              </div>
            </div>

            <!-- Case 2: Order Sudah Printed (tidak cancel) -->
            <div class="card mb-3 border-warning">
              <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">
                  <i class="bi bi-printer me-2"></i>Case 2: Order Sudah Printed (Status Order = printed, Status tidak cancel)
                </h6>
              </div>
              <div class="card-body">
                <p class="mb-2"><strong>Kondisi:</strong> Order status <span class="badge bg-info">printed</span> dan status order tidak mengandung kata "cancel"/"batal"</p>
                <p class="mb-2"><strong>Lokasi:</strong> Halaman Scan Return Cancelled Order</p>
                <p class="mb-2"><strong>Cara:</strong> Gunakan form <span class="badge bg-warning text-dark">Scan Hapus Order Printed</span> (warna kuning)</p>
                <p class="mb-2"><strong>Info:</strong> "Menghapus orderan yang sudah di printed saja dari Batch"</p>
                <p class="mb-0"><strong>Hasil:</strong> Order dihapus dari batch, stok dikembalikan, TIDAK update status return</p>
              </div>
            </div>

            <!-- Case 3: Order Sudah Printed & Cancelled -->
            <div class="card mb-3 border-danger">
              <div class="card-header bg-danger text-white">
                <h6 class="mb-0">
                  <i class="bi bi-x-circle me-2"></i>Case 3: Order Sudah Printed & Cancelled (Status Order = printed, Status = cancel/batal)
                </h6>
              </div>
              <div class="card-body">
                <p class="mb-2"><strong>Kondisi:</strong> Order status <span class="badge bg-info">printed</span> dan status order mengandung kata "cancel"/"batal"</p>
                <p class="mb-2"><strong>Lokasi:</strong> Halaman Scan Return Cancelled Order</p>
                <p class="mb-2"><strong>Cara:</strong> Gunakan form <span class="badge bg-primary">Scan Return Cancelled Order</span> (warna biru)</p>
                <p class="mb-0"><strong>Hasil:</strong> Order dihapus dari batch, stok dikembalikan, DAN update status return</p>
              </div>
            </div>

            <!-- Case 4: Order Sudah Diproses Lebih Lanjut -->
            <div class="card mb-3 border-secondary">
              <div class="card-header bg-secondary text-white">
                <h6 class="mb-0">
                  <i class="bi bi-exclamation-triangle me-2"></i>Case 4: Order Sudah Diproses Lebih Lanjut
                </h6>
              </div>
              <div class="card-body">
                <p class="mb-2"><strong>Kondisi:</strong> Order status <span class="badge bg-primary">picked</span>, <span class="badge bg-warning text-dark">packed</span>, atau <span class="badge bg-success">shipped</span></p>
                <p class="mb-2"><strong>Lokasi:</strong> Halaman Return List</p>
                <p class="mb-2"><strong>Cara:</strong> Wajib lewat <span class="badge bg-info">Return Session</span> di Return List</p>
                <p class="mb-0"><strong>Hasil:</strong> Proses return yang lebih kompleks dengan tracking lengkap</p>
              </div>
            </div>

            <!-- Summary Table -->
            <div class="table-responsive">
              <table class="table table-sm table-bordered">
                <thead class="table-dark">
                  <tr>
                    <th>Status Order</th>
                    <th>Status</th>
                    <th>Lokasi</th>
                    <th>Action</th>
                    <th>Keterangan</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><span class="badge bg-warning">pending</span></td>
                    <td>Bebas</td>
                    <td>Batch Order</td>
                    <td><span class="badge bg-danger">Hapus dari Batch</span></td>
                    <td>Langsung hapus</td>
                  </tr>
                  <tr>
                    <td><span class="badge bg-info">printed</span></td>
                    <td>Tidak cancel</td>
                    <td>Scan Return Cancelled Order</td>
                    <td><span class="badge bg-warning text-dark">Scan Hapus Order Printed</span></td>
                    <td>Tidak update return status</td>
                  </tr>
                  <tr>
                    <td><span class="badge bg-info">printed</span></td>
                    <td>Cancel/Batal</td>
                    <td>Scan Return Cancelled Order</td>
                    <td><span class="badge bg-primary">Scan Return Cancelled Order</span></td>
                    <td>Update return status</td>
                  </tr>
                  <tr>
                    <td><span class="badge bg-primary">picked</span> / <span class="badge bg-warning text-dark">packed</span> / <span class="badge bg-success">shipped</span></td>
                    <td>Bebas</td>
                    <td>Return List</td>
                    <td><span class="badge bg-info">Return Session</span></td>
                    <td>Wajib lewat return session</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for Batch Actions - Removed, now directly handling actions -->
<script>
document.addEventListener('DOMContentLoaded', function () {

  // Handle SKU Not Found Modal
  const skuDetailButtons = document.querySelectorAll('.sku-detail-btn');
  skuDetailButtons.forEach(button => {
    button.addEventListener('click', function () {
      const skuList = this.dataset.skuList;
      const batchName = this.dataset.batch;
      const modalLabel = document.getElementById('skuNotFoundModalLabel');
      const modalBody = document.getElementById('skuNotFoundModalBody');
      
      modalLabel.textContent = `Detail SKU Tidak Ditemukan - ${batchName}`;
      
      if (skuList && skuList.trim()) {
        const skus = skuList.split(',').map(s => s.trim()).filter(Boolean);
        modalBody.innerHTML = '<ul>' + skus.map(sku => `<li>${sku}</li>`).join('') + '</ul>';
      } else {
        modalBody.textContent = 'Tidak ada SKU yang bermasalah.';
      }

      const modal = new bootstrap.Modal(document.getElementById('skuNotFoundModal'));
      modal.show();
    });
  });

  // Handle ID Pesanan Modal (with pagination)
  const idPesananButtons = document.querySelectorAll('.show-idpesanan-btn');
  idPesananButtons.forEach(button => {
    button.addEventListener('click', function () {
      const batchName = this.dataset.batch;
      let currentPage = 1;

      const loadPage = (pageNum) => {
        fetch(`/fullfilment/api/idpesanan_in_batch/?nama_batch=${encodeURIComponent(batchName)}&page=${pageNum}&per_page=25`)
          .then(resp => resp.json())
          .then(data => {
            const idList = data.idpesanan_list || [];
            const ul = document.getElementById('idPesananList');
            ul.innerHTML = '';

            if (idList.length === 0) {
              ul.innerHTML = '<li class="list-group-item text-muted">Tidak ada ID Pesanan.</li>';
            } else {
              idList.forEach(idp => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = idp;
                ul.appendChild(li);
              });
            }

            // Handle Pagination Buttons
            const footer = document.querySelector('#idPesananModal .modal-footer');
            footer.querySelectorAll('.pagination-btn').forEach(el => el.remove());

            if (data.page > 1) {
              const prevBtn = createPaginationButton('Prev', () => loadPage(data.page - 1));
              footer.insertBefore(prevBtn, footer.firstChild);
            }
            if (data.has_next) {
              const nextBtn = createPaginationButton('Next', () => loadPage(data.page + 1));
              footer.appendChild(nextBtn);
            }
          });
      };

      const createPaginationButton = (text, onClick) => {
        const btn = document.createElement('button');
        btn.className = `btn btn-outline-${text === 'Prev' ? 'secondary' : 'primary'} pagination-btn me-2`;
        btn.textContent = text;
        btn.onclick = onClick;
        return btn;
      };

      loadPage(currentPage);
      const modal = new bootstrap.Modal(document.getElementById('idPesananModal'));
      modal.show();
    });
  });

  // NEW LOGIC FOR DETAIL ID MODAL
  const detailIdModal = new bootstrap.Modal(document.getElementById('batchOrderIdsModal'));
  document.querySelectorAll('.btn-detail-order-ids').forEach(button => {
      button.addEventListener('click', function() {
          const batchName = this.dataset.batchName;
          document.getElementById('modalBatchNameSimple').textContent = batchName;
          const listElement = document.getElementById('batchOrderIdsListSimple');
          listElement.innerHTML = '<li class="list-group-item text-center">Loading...</li>';
          
          fetch(`/fullfilment/api/batch/${encodeURIComponent(batchName)}/order-ids/`)
              .then(response => response.json())
              .then(data => {
                  listElement.innerHTML = '';
                  if (data.success && data.order_ids.length > 0) {
                      data.order_ids.forEach(orderId => {
                          const li = document.createElement('li');
                          li.className = 'list-group-item';
                          li.textContent = orderId;
                          listElement.appendChild(li);
                      });
                  } else {
                      listElement.innerHTML = '<li class="list-group-item text-center">No Order IDs found.</li>';
                  }
              })
              .catch(error => {
                  console.error('Error fetching order IDs:', error);
                  listElement.innerHTML = '<li class="list-group-item text-center text-danger">Failed to load data.</li>';
              });

          detailIdModal.show();
      });
  });

  // NEW: Event listener for "Salin Semua" button in Batch Order IDs modal
  $('#copyAllBatchOrderIdsBtn').on('click', function() {
    // Ambil batch name langsung dari modal title
    const batchNameForDownload = document.getElementById('modalBatchNameSimple').textContent;
    
    if (batchNameForDownload) {
        // Trigger download of a TXT file from the server
        window.location.href = `/fullfilment/download/batch/${encodeURIComponent(batchNameForDownload)}/order-ids.txt`;
    } else {
        Swal.fire('Error', 'Nama batch tidak ditemukan untuk diunduh.', 'error');
    }
  });

  // Handle Close Batch Modal
  let batchToCloseId = null;
  const closeBatchModal = new bootstrap.Modal(document.getElementById('closeBatchModal'));
  
  // Event handler untuk tombol close batch
  document.querySelectorAll('.btn-close-batch-child').forEach(btn => {
    btn.addEventListener('click', function() {
      const batchId = this.dataset.batchId;
      const batchName = this.dataset.batchName;
      
      batchToCloseId = batchId;
      document.getElementById('closeBatchName').textContent = batchName;
      closeBatchModal.show();
    });
  });
  document.getElementById('confirmCloseBatchBtn').addEventListener('click', function() {
    if (!batchToCloseId) return;
    
    // Non-aktifkan tombol untuk mencegah klik ganda
    const confirmBtn = this;
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Menutup...';

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch(`/fullfilment/batchlist/${batchToCloseId}/close/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
        'Accept': 'application/json',
      },
    })
    .then(resp => resp.json())
    .then(data => {
      if (data.success) {
        // Show success message
        Swal.fire({
          icon: 'success',
          title: 'Close Batch Berhasil!',
          text: data.message,
          confirmButtonText: 'OK'
        }).then(() => {
          location.reload();
        });
      } else {
        // Show detailed error message
        Swal.fire({
          icon: 'error',
          title: 'Close Batch Gagal!',
          text: data.error || 'Terjadi kesalahan saat menutup batch',
          confirmButtonText: 'OK'
        });
      }
    })
    .catch(error => {
      console.error('Error:', error);
      Swal.fire({
        icon: 'error',
        title: 'Close Batch Gagal!',
        text: 'Terjadi kesalahan pada server',
        confirmButtonText: 'OK'
      });
    })
    .finally(() => {
      // Re-enable button (not strictly needed here as page reloads)
    });
  });

  // Show/hide batch option sections (for transfer modal)
  document.querySelectorAll('input[name="transferOption"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
      const newBatchSection = document.getElementById('newBatchSection');
      const existingBatchSection = document.getElementById('existingBatchSection');
      const newBatchNameInput = document.getElementById('newBatchName');
      const existingBatchSelect = document.getElementById('existingBatchSelect');

      if (this.value === 'new') {
        newBatchSection.style.display = 'block';
        existingBatchSection.style.display = 'none';
        newBatchNameInput.value = ''; // Clear existing batch name
        existingBatchSelect.value = ''; // Clear existing batch select
      } else {
        newBatchSection.style.display = 'none';
        existingBatchSection.style.display = 'block';
        newBatchNameInput.value = ''; // Clear new batch name
        existingBatchSelect.value = ''; // Clear existing batch select
      }
    });
  });

  // Handle Transfer button click (on the main table row)
  let selectedBatchName = '';
  document.querySelectorAll('.btn-transfer-batch').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const batchName = this.getAttribute('data-batch-name');
      
      selectedBatchName = batchName;
      
      // Load existing batch options
      fetch('/fullfilment/batchlist/list_open/')
        .then(response => response.json())
        .then(data => {
          const select = document.getElementById('existingBatchSelect');
          select.innerHTML = '<option value="">-- Pilih Batch --</option>';
          data.batchlists.forEach(function(batch) {
            if (batch !== selectedBatchName) {
              const opt = document.createElement('option');
              opt.value = batch;
              opt.textContent = batch;
              select.appendChild(opt);
            }
          });
        });
      
      // Ambil data order gantung dan stock gantung
      fetch(`/fullfilment/transfer_summary/?batch_name=${encodeURIComponent(selectedBatchName)}`)
        .then(response => response.json())
        .then(data => {
          document.getElementById('pendingOrdersCount').textContent = data.pending_orders_count || 0;
          document.getElementById('unallocatedStockCount').textContent = data.unallocated_stock_count || 0;
        })
        .catch(error => {
          console.error('Error loading transfer summary:', error);
          document.getElementById('pendingOrdersCount').textContent = '0';
          document.getElementById('unallocatedStockCount').textContent = '0';
        });
    
      // Show modal
      const transferModal = new bootstrap.Modal(document.getElementById('transferBatchModal'));
      transferModal.show();
    });
  });

  // Handle Confirm Transfer
  document.getElementById('confirmTransferBtn').addEventListener('click', function() {
    const transferOption = document.querySelector('input[name="transferOption"]:checked').value;
    let targetBatchName = '';
    
    if (transferOption === 'new') {
      targetBatchName = document.getElementById('newBatchName').value.trim();
      if (!targetBatchName) {
        alert('Nama batch baru harus diisi!');
        return;
      }
    } else {
      targetBatchName = document.getElementById('existingBatchSelect').value;
      if (!targetBatchName) {
        alert('Pilih batch existing terlebih dahulu!');
        return;
      }
    }
    
    // Disable button to prevent double click
    const confirmBtn = document.getElementById('confirmTransferBtn');
    const originalText = confirmBtn.textContent;
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Memproses...';
    
    // Kirim AJAX ke endpoint transfer_batch
    fetch('/fullfilment/transfer_batch_pending/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({
        source_batch: selectedBatchName,
        target_batch: targetBatchName,
        transfer_type: transferOption
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Show success message
        Swal.fire({
          icon: 'success',
          title: 'Transfer Berhasil!',
          text: data.message,
          confirmButtonText: 'OK'
        }).then(() => {
          location.reload();
        });
      } else {
        // Show error message
        Swal.fire({
          icon: 'error',
          title: 'Transfer Gagal!',
          text: data.error || 'Terjadi kesalahan saat transfer',
          confirmButtonText: 'OK'
        });
      }
    })
    .catch(error => {
      console.error('Error:', error);
      Swal.fire({
        icon: 'error',
        title: 'Transfer Gagal!',
        text: 'Terjadi kesalahan pada server',
        confirmButtonText: 'OK'
      });
    })
    .finally(() => {
      // Re-enable button
      confirmBtn.disabled = false;
      confirmBtn.textContent = originalText;
      
      // Close modal
      const transferModal = bootstrap.Modal.getInstance(document.getElementById('transferBatchModal'));
      if (transferModal) {
        transferModal.hide();
      }
    });
  });

  // Handle Download Modal
  const downloadButtons = document.querySelectorAll('.btn-download-batch');
  downloadButtons.forEach(button => {
    button.addEventListener('click', function () {
      const batchName = this.dataset.batchName;
      document.getElementById('downloadBatchName').textContent = batchName;
      
      const modal = new bootstrap.Modal(document.getElementById('downloadModal'));
      modal.show();
    });
  });

  // Handle PDF Download
  document.querySelector('.btn-download-pdf').addEventListener('click', function() {
    const batchName = document.getElementById('downloadBatchName').textContent;
    window.open(`/fullfilment/download_batchitem_pdf/${batchName}/`, '_blank');
    bootstrap.Modal.getInstance(document.getElementById('downloadModal')).hide();
  });

  // --- LOGIKA AKSI BATCH BARU UNTUK 2 TAHAP DELETE ---

  // Fungsi helper untuk membuat form dan submit POST request
  function submitPostForm(actionUrl) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = actionUrl;
    
    const csrfTokenInput = document.createElement('input');
    csrfTokenInput.type = 'hidden';
    csrfTokenInput.name = 'csrfmiddlewaretoken';
    csrfTokenInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    form.appendChild(csrfTokenInput);
    document.body.appendChild(form);
    form.submit();
  }

  // Handle "Clean Batch" Action (Tahap 1)
  document.querySelectorAll('.btn-clean-batch').forEach(button => {
    button.addEventListener('click', function() {
      const batchId = this.dataset.batchId;
      const batchName = this.dataset.batchName;
      
      Swal.fire({
        title: `Bersihkan Batch '${batchName}'?`,
        text: "Aksi ini akan melepaskan semua order yang statusnya 'pending' atau 'printed' dari batch ini. Order yang sudah diproses lebih lanjut tidak akan terpengaruh. Lanjutkan?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Ya, Bersihkan!',
        cancelButtonText: 'Batal'
      }).then((result) => {
        if (result.isConfirmed) {
          submitPostForm(`/fullfilment/batchlist/${batchId}/clean/`);
        }
      });
    });
  });

  // Handle "Permanent Delete" Action (Tahap 2)
  document.querySelectorAll('.btn-delete-batch').forEach(button => {
    button.addEventListener('click', function() {
      const batchId = this.dataset.batchId;
      const batchName = this.dataset.batchName;

      Swal.fire({
        title: `Hapus Permanen Batch '${batchName}'?`,
        html: "<b>Aksi ini tidak bisa dibatalkan!</b><br>Batch ini akan dihapus secara permanen karena sudah tidak memiliki order. Pastikan Anda yakin.",
        icon: 'error',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Ya, Hapus Permanen!',
        cancelButtonText: 'Batal'
      }).then((result) => {
        if (result.isConfirmed) {
          submitPostForm(`/fullfilment/batchlist/${batchId}/delete/`);
        }
      });
    });
  });

  // --- CHILD ROW ACTION BUTTONS ---

  // Transfer (child)
  document.querySelectorAll('.btn-transfer-batch-child').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const batchId = this.dataset.batchId;
      const batchName = this.dataset.batchName;
      
      // Set selectedBatchName untuk transfer modal
      selectedBatchName = batchName;
      
      // Load existing batch options
      fetch('/fullfilment/batchlist/list_open/')
        .then(response => response.json())
        .then(data => {
          const select = document.getElementById('existingBatchSelect');
          select.innerHTML = '<option value="">-- Pilih Batch --</option>';
          data.batchlists.forEach(function(batch) {
            if (batch !== selectedBatchName) {
              const opt = document.createElement('option');
              opt.value = batch;
              opt.textContent = batch;
              select.appendChild(opt);
            }
          });
        });
      
      // Ambil data order gantung dan stock gantung
      fetch(`/fullfilment/transfer_summary/?batch_name=${encodeURIComponent(selectedBatchName)}`)
        .then(response => response.json())
        .then(data => {
          document.getElementById('pendingOrdersCount').textContent = data.pending_orders_count || 0;
          document.getElementById('unallocatedStockCount').textContent = data.unallocated_stock_count || 0;
        })
        .catch(error => {
          console.error('Error loading transfer summary:', error);
          document.getElementById('pendingOrdersCount').textContent = '0';
          document.getElementById('unallocatedStockCount').textContent = '0';
        });
    
      // Show modal
      const transferModal = new bootstrap.Modal(document.getElementById('transferBatchModal'));
      transferModal.show();
    });
  });

  // Close (child) - Event handler sudah dipindah ke atas untuk konsistensi

  // Clean (child)
  document.querySelectorAll('.btn-clean-batch-child').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const batchId = this.dataset.batchId;
      const batchName = this.dataset.batchName;
      
      Swal.fire({
        title: `Bersihkan Batch '${batchName}'?`,
        text: "Aksi ini akan melepaskan semua order yang statusnya 'pending' atau 'printed' dari batch ini. Lanjutkan?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Ya, Bersihkan!',
        cancelButtonText: 'Batal'
      }).then((result) => {
        if (result.isConfirmed) {
          submitPostForm(`/fullfilment/batchlist/${batchId}/clean/`);
        }
      });
    });
  });

  // Delete (child)
  document.querySelectorAll('.btn-delete-batch-child').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const batchId = this.dataset.batchId;
      const batchName = this.dataset.batchName;
      
      Swal.fire({
        title: `Hapus Permanen Batch '${batchName}'?`,
        html: "<b>Aksi ini tidak bisa dibatalkan!</b><br>Batch ini akan dihapus secara permanen.",
        icon: 'error',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Ya, Hapus Permanen!',
        cancelButtonText: 'Batal'
      }).then((result) => {
        if (result.isConfirmed) {
          submitPostForm(`/fullfilment/batchlist/${batchId}/delete/`);
        }
      });
    });
  });

}); // Penutup dari DOMContentLoaded
</script>
{% endblock %}

