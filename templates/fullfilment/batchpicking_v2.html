{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid mt-3 px-1 px-md-3">
  <h2 class="mb-4">Batch Picking V2 (Realtime)</h2>
  <div class="row">
    <!-- COLUMN 1: Scan History -->
    <div class="col-12 col-lg-3 mb-3 mb-lg-0">
      <div class="card h-100 shadow-sm">
        <div class="card-header fw-bold bg-light">
          Scan History (10 Terakhir)
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-striped table-sm mb-0">
              <thead>
                <tr>
                  <th scope="col" class="ps-3">Waktu</th>
                  <th scope="col">User</th>
                  <th scope="col">Barcode</th>
                  <th scope="col">Status</th>
                </tr>
              </thead>
              <tbody id="scanHistoryTableBody">
                <!-- Rows will be added by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- COLUMN 2: Scan Barcode -->
    <div class="col-12 col-lg-3 mb-3 mb-lg-0">
      <div class="mb-3">
        <label class="form-label fw-bold">Scan Barcode</label>
        <input type="text" id="barcodeInput" class="form-control" placeholder="Scan barcode..." autofocus autocomplete="off">
        <div id="barcodeFeedback" class="mt-2"></div>
        <div id="scanHistory" class="mt-2" style="max-height: 300px; overflow-y: auto; display:none;"></div>
      </div>
      <div class="mb-3">
        <label class="form-label fw-bold">Manual Search</label>
        <input type="text" id="updateManualInput" class="form-control" placeholder="Cari SKU / Barcode / Nama..." autocomplete="off">
        <div id="updateManualDropdown" class="list-group position-absolute w-100" style="z-index:10; display:none;"></div>
        <div id="updateManualQtyControl" class="d-flex align-items-center mt-2" style="display:none;">
          <button type="button" class="btn btn-outline-secondary btn-sm me-2" id="qtyMinus">-</button>
          <input type="number" id="qtyInput" class="form-control form-control-sm text-center" style="width:70px;" value="0" min="0">
          <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="qtyPlus">+</button>
          <button type="button" class="btn btn-primary btn-sm ms-3" id="qtySubmit">Update</button>
        </div>
        <div id="updateManualFeedback" class="mt-2"></div>
      </div>
    </div>

    <!-- COLUMN 3: Summary -->
    <div class="col-12 col-lg-3 mb-3 mb-lg-0">
      <table class="table table-borderless table-sm mb-0 h-100" style="font-size:0.97em;">
        <tbody>
          <tr>
            <td class="ps-0">SKU Pending</td>
            <td class="text-end pe-0"><b>{{ total_pending }}</b></td>
          </tr>
          <tr>
            <td class="ps-0">SKU Completed</td>
            <td class="text-end pe-0"><b>{{ total_completed }}</b></td>
          </tr>
          <tr>
            <td class="ps-0">SKU Not Found</td>
            <td class="text-end pe-0"><b>{{ sku_not_found_count }}</b></td>
          </tr>
          <tr>
            <td class="ps-0">NAMA BATCH</td>
            <td class="text-end pe-0"><b>{{ nama_picklist }}</b></td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- COLUMN 4: Actions -->
    <div class="col-12 col-lg-3">
      <div class="d-flex flex-column h-100 justify-content-between">
        <div class="d-grid gap-2">
          <a href="/fullfilment/readytoprint/?nama_batch={{ nama_picklist }}" class="btn btn-warning w-100" target="_blank">Ready to Print</a>
          <button id="downloadPendingPDF" class="btn btn-danger w-100">Download PDF</button>
        </div>
        <div class="d-grid gap-2 mt-2">
          <button id="showScanHistoryBtn" class="btn btn-info w-100">Show History</button>
          <a href="/fullfilment/" class="btn btn-outline-secondary w-100">&larr; Back to Batchlist</a>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12 mb-3">
      <div class="mb-2">
        <div class="fw-bold" style="font-size:1.1rem;">
          <span class="bg-white px-2 py-1 rounded shadow-sm border"
            style="position:relative; top:1.2em; left:1em; z-index:2;">
            Picklist: <b>{{ nama_picklist }}</b>
          </span>
        </div>
      </div>
      <div class="card shadow-sm mb-3 card-pending" style="background: #e3f0ff;">
        <div class="card-body pb-2 pt-3 px-2">
          <div class="d-flex justify-content-between align-items-center fw-bold text-white px-3 py-2 mb-0 rounded-top" style="background:#1769aa;">
            <span>PENDING ITEMS</span>
            <button type="button" class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#completedItemsModal">
              Lihat Item Selesai <span class="badge bg-secondary">{{ total_completed }}</span>
            </button>
          </div>
          <div class="table-responsive" id="pendingTableWrapper">
            <table id="pendingTable" class="table table-sm table-bordered align-middle mb-0 table-batch"
              style="background: #fff;">
              <thead class="align-middle text-center" style="background:#e3f0ff;">
                <tr>
                  <th class="sku-col sortable" data-col="0">SKU</th>
                  <th class="barcode-col sortable" data-col="1">Barcode</th>
                  <th class="nama-col-custom sortable" data-col="2">Nama</th>
                  <th class="variant-col sortable" data-col="3">Variant</th>
                  <th class="brand-col sortable" data-col="4">Brand</th>
                  <th class="rak-col sortable" data-col="5">Rak</th>
                  <th class="jumlah-col sortable" data-col="6">Jumlah</th>
                  <th class="ambil-col sortable" data-col="7">Ambil</th>
                  <th class="status-col sortable" data-col="8">Status</th>
                  <th class="sortable" data-col="9">I</th>
                  <th class="sortable" data-col="10">II</th>
                  <th class="sortable" data-col="11">III</th>
                </tr>
              </thead>
              <tbody>
                {% for item in details %}
                {% if item.status_ambil != 'completed' %}
                <tr data-barcode="{{ item.barcode }}">
                  <td class="text-center fw-semibold">{{ item.sku }}</td>
                  <td class="text-center text-primary">{{ item.barcode }}</td>
                  <td>
                    <a href="/fullfilment/batchpicking/{{ nama_picklist|urlencode }}/batchitem/{{ item.id }}/detail/"
                      class="text-decoration-underline text-primary" target="_blank">{{ item.nama_produk }}</a>
                  </td>
                  <td class="text-info">{{ item.variant_produk|default_if_none:'' }}</td>
                  <td class="text-secondary">{{ item.brand|default_if_none:'' }}</td>
                  <td>{% if item.rak %}<span class="badge bg-light text-dark border">{{ item.rak }}</span>{% else %}-{% endif %}</td>
                  <td class="jumlah text-end">{{ item.jumlah }}</td>
                  <td class="jumlah-ambil text-end">{{ item.jumlah_ambil }}</td>
                  <td class="status-ambil text-center">
                    {% if item.status_ambil == 'pending' %}
                    <span class="badge bg-warning text-dark">Pending</span>
                    {% elif item.status_ambil == 'completed' %}
                    <span class="badge bg-success">Completed</span>
                    {% else %}
                    <span class="badge bg-secondary">Unknown</span> {# Fallback for other statuses #}
                    {% endif %}
                  </td>
                  <td class="text-center">{% if item.count_one > 0 %}{{ item.count_one }}{% endif %}</td>
                  <td class="text-center">{% if item.count_duo > 0 %}{{ item.count_duo }}{% endif %}</td>
                  <td class="text-center">{% if item.count_tri > 0 %}{{ item.count_tri }}{% endif %}</td>
                </tr>
                {% endif %}
                {% empty %}
                <tr>
                  <td colspan="12" class="text-center text-muted">Tidak ada data.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Completed Items -->
  <div class="modal fade" id="completedItemsModal" tabindex="-1" aria-labelledby="completedItemsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="completedItemsModalLabel">Completed Items</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="card shadow-sm mb-3 card-completed" style="background: #d4f5dd;">
            <div class="card-body pb-2 pt-3 px-2">
              <div class="table-responsive">
                <table id="completedTable" class="table table-sm table-bordered align-middle mb-0 table-batch" style="background: #f8f9fa;">
                  <thead class="align-middle text-center" style="background:#d4f5dd;">
                    <tr>
                      <th class="sortable" data-col="0">SKU</th>
                      <th class="barcode-col sortable" data-col="1">Barcode</th>
                      <th class="sortable" data-col="2">Nama</th>
                      <th class="sortable" data-col="3">Variant</th>
                      <th class="sortable" data-col="4">Brand</th>
                      <th class="sortable" data-col="5">Rak</th>
                      <th class="sortable" data-col="6">Jumlah</th>
                      <th class="sortable" data-col="7">Ambil</th>
                      <th class="sortable" data-col="8">Status</th>
                      <th class="sortable" data-col="9">I</th>
                      <th class="sortable" data-col="10">II</th>
                      <th class="sortable" data-col="11">III</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for item in details %}
                    {% if item.status_ambil == 'completed' %}
                    <tr data-barcode="{{ item.barcode }}">
                      <td class="text-center fw-semibold">{{ item.sku }}</td>
                      <td class="text-center text-primary">{{ item.barcode }}</td>
                      <td>
                        <a href="/fullfilment/batchpicking/{{ nama_picklist|urlencode }}/batchitem/{{ item.id }}/detail/" class="text-decoration-underline text-primary" target="_blank">{{ item.nama_produk }}</a>
                      </td>
                      <td class="text-info">{{ item.variant_produk }}</td>
                      <td class="text-secondary">{{ item.brand }}</td>
                      <td>{% if item.rak %}<span class="badge bg-light text-dark border">{{ item.rak }}</span>{% endif %}</td>
                      <td class="jumlah text-end">{{ item.jumlah }}</td>
                      <td class="jumlah-ambil text-end">{{ item.jumlah_ambil }}</td>
                      <td class="status-ambil text-center">
                        <span class="badge bg-success">Completed</span>
                      </td>
                      <td class="text-center">{% if item.count_one > 0 %}{{ item.count_one }}{% endif %}</td>
                      <td class="text-center">{% if item.count_duo > 0 %}{{ item.count_duo }}{% endif %}</td>
                      <td class="text-center">{% if item.count_tri > 0 %}{{ item.count_tri }}{% endif %}</td>
                    </tr>
                    {% endif %}
                    {% empty %}
                    <tr>
                      <td colspan="12" class="text-center text-muted">Tidak ada data.</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
  window.NAMA_PICKLIST = "{{ nama_picklist }}";
  window.CSRF_TOKEN = "{{ csrf_token }}";
  window.CURRENT_USER = "{{ request.user.username }}";
</script>
<script src="{% static 'datatables/batchpickingv2.js' %}"></script>
{% endblock %}
