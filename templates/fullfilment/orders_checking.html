{% extends 'base.html' %}
{% block content %}

<div class="container mt-4">
    {% if not show_tables %}
    <div class="d-flex align-items-center mb-3">
        <h4 class="me-3 mb-0">Order Checking{% if nama_batch %} - Batch: <span class="text-primary">{{ nama_batch }}</span>{% endif %}</h4>
        </div>
   
    
    <form method="post" class="mb-4">
        {% csrf_token %}
        <label for="orderIdInput" class="form-label fw-bold">Scan Order ID</label>
        <input type="text" id="orderIdInput" name="order_id" class="form-control" placeholder="Scan Order ID..." autofocus autocomplete="off">
        <button type="submit" class="btn btn-primary mt-2">Cari</button>
        {% if error %}
            <div class="alert alert-danger mt-2">{{ error }}</div>
        {% endif %}
    </form>
    {% endif %}

    {% if show_tables %}
    <form id="barcodeForm" class="mb-3 d-flex align-items-end" autocomplete="off">
        <div class="flex-grow-1 me-2">
            <label for="barcodeInput" class="form-label fw-bold">Scan Barcode</label>
            <input type="text" id="barcodeInput" name="oc.barcodeinput" class="form-control" placeholder="Scan Barcode..." autocomplete="off">
        </div>
        <div class="d-flex flex-column align-items-center mb-2 position-relative">
            <button type="button" id="saveInputBtn" class="btn btn-primary px-4 py-2 fw-semibold" style="background:#1976d2;border:none;color:#fff;border-radius:0.6rem;box-shadow:0 2px 8px rgba(25,118,210,0.08);font-size:1rem;">SAVE</button>
            <span style="font-size:0.8em;color:#1976d2;position:absolute;top:100%;left:50%;transform:translateX(-50%);white-space:nowrap;">(alt+s)</span>
        </div>
        <button type="submit" class="btn btn-success ms-2 mb-2">Input</button>
    </form>
    <div id="barcodeError" class="alert alert-danger mt-2 d-none"></div>
    <h5>Order ID: <span class="text-success">{{ order_id }}</span></h5>
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10 col-12">
            <div class="card mb-4 shadow-sm">
                <div class="card-body p-2">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover table-sm align-middle mb-0" id="pendingTable">
                            <thead class="table-warning">
                                <tr>
                                    <th>SKU</th>
                                    <th>Barcode</th>
                                    <th>Nama Produk</th>
                                    <th>Variant</th>
                                    <th>Brand</th>
                                    <th>Jumlah</th>
                                    <th>J.Ambil</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="pendingTableBody">
                                {% for o in pending_orders %}
                                <tr data-sku="{{ o.sku }}">
                                    <td>{{ o.sku }}</td>
                                    <td>{{ o.barcode }}</td>
                                    <td>{{ o.nama_produk }}</td>
                                    <td>{{ o.variant_produk }}</td>
                                    <td>{{ o.brand }}</td>
                                    <td>{{ o.jumlah }}</td>
                                    <td class="jumlah-ambil">{{ o.jumlah_ambil }}</td>
                                    <td>{{ o.status_ambil }}</td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="8" class="text-center text-muted">Tidak ada data pending.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="card shadow-sm">
                <div class="card-header bg-success bg-opacity-25"><b>Completed</b></div>
                <div class="card-body p-2">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover table-sm align-middle mb-0" id="completedTable">
                            <thead class="table-success">
                                <tr>
                                    <th>SKU</th>
                                    <th>Barcode</th>
                                    <th>Nama Produk</th>
                                    <th>Variant</th>
                                    <th>Brand</th>
                                    <th>Jumlah</th>
                                    <th>J.Ambil</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="completedTableBody">
                                {% for o in completed_orders %}
                                <tr data-sku="{{ o.sku }}">
                                    <td>{{ o.sku }}</td>
                                    <td>{{ o.barcode }}</td>
                                    <td>{{ o.nama_produk }}</td>
                                    <td>{{ o.variant_produk }}</td>
                                    <td>{{ o.brand }}</td>
                                    <td>{{ o.jumlah }}</td>
                                    <td class="jumlah-ambil">{{ o.jumlah_ambil }}</td>
                                    <td>{{ o.status_ambil }}</td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="8" class="text-center text-muted">Tidak ada data completed.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var orderIdInput = document.getElementById('orderIdInput');
    var barcodeInput = document.getElementById('barcodeInput');
    var barcodeForm = document.getElementById('barcodeForm');
    var barcodeError = document.getElementById('barcodeError');
    var saveInputBtn = document.getElementById('saveInputBtn');
    var orderIdForm = document.querySelector('form[method="post"]');
    if (orderIdInput) orderIdInput.focus();
    // Jika form order id disubmit, setelah reload, fokus ke barcodeInput
    if (barcodeInput) barcodeInput.focus();
    if (barcodeForm) {
        barcodeForm.addEventListener('submit', function(e) {
            e.preventDefault();
            barcodeError.classList.add('d-none');
            barcodeError.textContent = '';
            var barcode = barcodeInput.value.trim();
            if (!barcode) return;
            fetch(window.location.pathname + 'scan-barcode/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({
                    barcode: barcode,
                    order_id: '{{ order_id }}',
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    updateTable('pendingTableBody', data.pending_orders);
                    updateTable('completedTableBody', data.completed_orders);
                    playCompletedSoundIfNeeded(data.pending_orders, data.completed_orders);
                    barcodeInput.value = '';
                } else {
                    // Jika error karena over input
                    if (data.error && data.error.toLowerCase().includes('over input')) {
                        barcodeError.textContent = '*Produk telah melewati batas input';
                        barcodeError.classList.remove('d-none');
                        overScanSound.play();
                    } else {
                        barcodeError.textContent = data.error || 'Barcode tidak valid.';
                        barcodeError.classList.remove('d-none');
                    }
                }
            })
            .catch(() => {
                barcodeError.textContent = 'Terjadi kesalahan.';
                barcodeError.classList.remove('d-none');
            });
        });
    }
    if (saveInputBtn) {
        saveInputBtn.addEventListener('click', function() {
            // Clear order id, reload page to reset
            window.location.href = window.location.pathname.split('/orders_checking')[0] + '/orders_checking/all';
        });
    }
    function updateTable(tableBodyId, rows) {
        var tbody = document.getElementById(tableBodyId);
        if (!tbody) return;
        tbody.innerHTML = '';
        if (rows.length === 0) {
            var tr = document.createElement('tr');
            var td = document.createElement('td');
            td.colSpan = 8;
            td.className = 'text-center text-muted';
            td.textContent = tableBodyId === 'pendingTableBody' ? 'Tidak ada data pending.' : 'Tidak ada data completed.';
            tr.appendChild(td);
            tbody.appendChild(tr);
            return;
        }
        rows.forEach(function(o) {
            var tr = document.createElement('tr');
            tr.innerHTML = `<td>${o.sku}</td><td>${o.barcode}</td><td>${o.nama_produk}</td><td>${o.variant_produk}</td><td>${o.brand}</td><td>${o.jumlah}</td><td class='jumlah-ambil'>${o.jumlah_ambil}</td><td>${o.status_ambil}</td>`;
            tbody.appendChild(tr);
        });
    }

    // Audio elements
    var completedSound = new Audio('/static/sounds/completedsound.mp3');
    var overScanSound = new Audio('/static/sounds/over_scan.mp3');

    // Play sound if any row in completedTableBody is new or if all orders are completed
    function playCompletedSoundIfNeeded(pendingOrders, completedOrders) {
        // If ada completed baru (minimal 1 completed, dan sebelumnya ada pending)
        if (completedOrders.length > 0 && pendingOrders.length > 0) {
            completedSound.play();
        }
        // Jika semua sudah completed (pending kosong, completed > 0)
        if (pendingOrders.length === 0 && completedOrders.length > 0) {
            overScanSound.play();
            showCompletedModal();
        }
    }

    // Modal selesai semua order
    function showCompletedModal() {
        // Cek jika modal sudah ada
        if (document.getElementById('completedModal')) return;
        var modal = document.createElement('div');
        modal.id = 'completedModal';
        modal.innerHTML = `
        <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:9999;display:flex;align-items:center;justify-content:center;">
            <div style="background:#fff;padding:2.5rem 2rem 2rem 2rem;border-radius:1rem;box-shadow:0 4px 32px rgba(0,0,0,0.15);text-align:center;min-width:320px;max-width:90vw;">
                <div style="font-size:3rem;color:#28a745;margin-bottom:0.5rem;">
                    <svg width="60" height="60" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="12" fill="#e6f9ed"/><path d="M7 13.5l3 3 7-7" stroke="#28a745" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </div>
                <div style="font-size:1.2rem;font-weight:600;margin-bottom:0.5rem;">Semua Order ID <span class="text-primary">${document.querySelector('.text-success')?.textContent || ''}</span> Sudah Selesai di Check</div>
            </div>
        </div>`;
        document.body.appendChild(modal);
        setTimeout(function(){
            if (saveInputBtn) {
                saveInputBtn.click();
            } else {
                window.location.reload();
            }
        }, 300);
    }

    // Keyboard shortcut: Alt+S untuk SAVE INPUT
    document.addEventListener('keydown', function(e) {
        // Alt+S (case-insensitive)
        if (e.altKey && (e.key === 's' || e.key === 'S')) {
            if (saveInputBtn) {
                e.preventDefault();
                saveInputBtn.click();
            }
        }
    });
});
</script>
{% endblock %}
