{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<!-- Banner Notifikasi -->
<div id="completion-banner" class="alert alert-success fw-bold text-center py-2" style="display: none; position: fixed; top: 0; width: 100%; left: 0; z-index: 2000; border-radius: 0;">
    <!-- Pesan akan diisi oleh JavaScript -->
</div>

<div class="container-fluid mt-3 px-1 px-md-3">
  <div class="row mb-3 align-items-center border-bottom pb-3">
    <!-- Kolom Kiri: Tombol Back -->
    <div class="col-md-3 d-flex justify-content-start">
      <a href="{% url 'fullfilment_index' %}" class="btn btn-outline-secondary">
        &larr; Back to Batchlist
      </a>
      <!-- Tombol Panduan Navigasi -->
      <button type="button" class="btn btn-outline-info ms-2" data-bs-toggle="modal" data-bs-target="#navigationGuideModal">
        <i class="bi bi-info-circle me-1"></i> Panduan Navigasi
      </button>
    </div>

    <!-- Kolom Tengah: Ringkasan Profesional -->
    <div class="col-md-6">
      <div class="d-flex justify-content-center align-items-center text-center">
        <div class="px-3">
          <span class="d-block text-muted" style="font-size: 0.8rem; text-transform: uppercase;">Batch</span>
          <strong style="font-size: 1.2rem;">{{ nama_picklist }}</strong>
        </div>
        <div class="vr mx-2"></div>
        <div class="px-3">
          <span class="d-block text-muted" style="font-size: 0.8rem; text-transform: uppercase;">Pending</span>
          <strong style="font-size: 1.2rem;">{{ total_pending }}</strong>
        </div>
        <div class="vr mx-2"></div>
        <div class="px-3">
          <span class="d-block text-muted" style="font-size: 0.8rem; text-transform: uppercase;">Completed</span>
          <strong style="font-size: 1.2rem;">{{ total_completed }}</strong>
        </div>
        <div class="vr mx-2"></div>
        <div class="px-3">
          <span class="d-block text-muted" style="font-size: 0.8rem; text-transform: uppercase;">Not Found</span>
          <strong style="font-size: 1.2rem;">{{ sku_not_found_count }}</strong>
        </div>
      </div>
    </div>

    <!-- Kolom Kanan: Tombol Print -->
    <div class="col-md-3 d-flex justify-content-end align-items-center">
      <!-- Tombol Navigasi Baru -->
      <div class="btn-group me-2" role="group">
        <a href="{% url 'batchorder_view' nama_batch=nama_batch %}" class="btn btn-primary">
          Order Detail
        </a>
        <a href="{% url 'batchitem_table_view' %}?nama_batch={{ nama_batch }}" class="btn btn-success">
          Table Item
        </a>
      </div>
      <a href="{% url 'ready_to_print_list' %}?nama_batch={{ nama_batch }}" target="_blank" class="btn btn-warning">
        Ready to Print
      </a>
    </div>
  </div>

  <div class="row">
    <!-- KOLOM 1: Scan, Manual, History -->
    <div class="col-md-3 mb-3">
      <!-- Scan Barcode -->
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">Scan Barcode</h5>
          <div class="mb-3">
            <input type="text" id="barcodeInput" class="form-control" placeholder="Scan barcode..." autofocus autocomplete="off">
            <div id="barcodeFeedback" class="mt-2"></div>
            <div id="scanHistory" class="mt-2" style="max-height: 300px; overflow-y: auto; display:none;"></div>
          </div>
        </div>
      </div>

      <!-- Manual Search -->
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">Manual Search</h5>
          <div class="mb-3">
            <input type="text" id="updateManualInput" class="form-control" placeholder="Cari SKU / Barcode / Nama..." autocomplete="off">
            <div id="updateManualDropdown" class="list-group position-absolute w-100" style="z-index:10; display:none;"></div>
            <div id="updateManualQtyControl" class="d-flex align-items-center mt-2" style="display:none;">
              <button type="button" class="btn btn-outline-secondary btn-sm me-2" id="qtyMinus">-</button>
              <input type="number" id="qtyInput" class="form-control form-control-sm text-center" style="width:70px;" value="0" min="0">
              <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="qtyPlus">+</button>
              <button type="button" class="btn btn-primary btn-sm ms-3" id="qtySubmit">Update</button>
            </div>
            <div id="updateManualFeedback" class="mt-2"></div>
          </div>
        </div>
      </div>

      <!-- Scan History -->
      <div class="card mb-3">
        <div class="card-body position-relative">
          <h5 class="card-title d-flex justify-content-between align-items-center">
            Scan History (10 Terakhir)
            <button id="showHistoryBtn" class="btn btn-outline-dark btn-sm ms-2" type="button">
              SHOW HISTORY
            </button>
          </h5>
          <div id="scanHistoryTableWrapper">
            <div class="table-responsive">
              <table class="table table-striped table-sm mb-0">
                <thead>
                  <tr>
                    <th scope="col" class="ps-3">Waktu</th>
                    <th scope="col">Tipe</th>
                    <th scope="col">Barcode</th>
                    <th scope="col">Status</th>
                  </tr>
                </thead>
                <tbody id="scanHistoryTableBody">
                  {% for entry in scan_history %}
                  <tr>
                    <td>{{ entry.waktu|date:"H:i:s" }}</td>
                    <td>{{ entry.user }}</td>
                    <td>{{ entry.product.barcode }}</td>
                    <td>
                      {% if entry.status == "completed" %}
                        <span class="badge bg-success">Completed</span>
                      {% elif entry.status == "ok" %}
                        <span class="badge bg-primary">OK</span>
                      {% else %}
                        <span class="badge bg-warning text-dark">{{ entry.status }}</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- KOLOM 2: Monitoring Item -->
    <div class="col-md-4 mb-3">
      <!-- Kartu Monitoring Item -->
      <div id="monitoring-card" class="card mb-3 shadow-sm text-center" style="background-color: #e3f2fd;">
        <div class="d-flex justify-content-center align-items-center p-3">
          <img id="monitor-photo" src="/static/icons/alfaicon.png" class="img-fluid rounded" style="max-height: 500px; width: auto; border: 1px solid #dee2e6;">
        </div>
        <div class="card-body py-3">
          <h5 id="monitor-nama" class="card-title mb-2" style="font-size: 1.4rem;">---</h5>
          <p class="card-text text-muted mb-3">
            <span id="monitor-brand">---</span> - <span id="monitor-variant">---</span>
          </p>
          <div class="mb-3">
            <span class="badge bg-secondary">SKU: <span id="monitor-sku">---</span></span>
            <br class="mb-1">
            <span class="badge bg-secondary mt-1">Barcode: <span id="monitor-barcode">---</span></span>
          </div>
          <div class="text-center">
            <p class="text-muted mb-1" style="font-size: 1rem;">Jumlah Ambil</p>
            <p class="fw-bold text-primary mb-0" style="font-size: 3rem; line-height: 1;" id="monitor-jumlah">- / -</p>
          </div>
        </div>
      </div>
    </div>

    <!-- KOLOM 3: Tabel Pending Items -->
    <div class="col-md-5 mb-3">
      <div class="card shadow-sm mb-3 card-pending" style="background: #e3f0ff;">
        <div class="card-body pb-2 pt-3 px-2">
          <div class="d-flex justify-content-between align-items-center fw-bold text-white px-3 py-2 mb-0 rounded-top" style="background:#1769aa;">
            
            <div class="d-flex align-items-center">
              <div class="btn-group btn-group-sm me-3" role="group" id="pendingFilterButtons">
                  <button type="button" class="btn btn-outline-light" data-filter="all">All <span class="badge bg-dark ms-1">{{ details|length }}</span></button>
                  <button type="button" class="btn btn-light" data-filter="pending">Pending <span class="badge bg-dark ms-1">{{ status_counts.pending|default:0 }}</span></button>
                  <button type="button" class="btn btn-outline-light" data-filter="partial">Partial <span class="badge bg-dark ms-1">{{ status_counts.partial|default:0 }}</span></button>
                  <button type="button" class="btn btn-outline-light" data-filter="over_stock">Over Stock <span class="badge bg-dark ms-1">{{ status_counts.over_stock|default:0 }}</span></button>
                  <button type="button" class="btn btn-outline-light" data-filter="completed">Completed <span class="badge bg-dark ms-1">{{ total_completed }}</span></button>
              </div>
            </div>
          </div>
          <!-- Search Bar for Pending Items -->
          <div class="p-3 bg-white border-bottom">
            <input type="text" id="pendingSearchInput" class="form-control" placeholder="Cari di Pending Items (SKU, Barcode, Nama, Variant, Brand...)">
          </div>
          <div id="pendingItemsContainer" class="list-group list-group-flush" style="max-height: 2000px; overflow-y: auto;">
            {% for item in details %}
            <div class="list-group-item px-3 py-2 d-flex align-items-center" data-barcode="{{ item.barcode }}" data-status="{{ item.status_ambil }}">
              <!-- Zona 1: Foto Produk -->
              <div class="me-3">
                <img src="{{ item.photo_url|default:'/static/icons/alfaicon.png' }}" class="rounded" style="width: 100px; height: 100px; object-fit: cover; border: 1px solid #dee2e6;">
              </div>
        
              <!-- Wrapper untuk Zona 2, 3, dan 4 -->
              <div class="flex-grow-1">
                <!-- Zona 2: Nama Produk -->
                <div class="mb-1">
                  <a href="/fullfilment/batchpicking/{{ nama_picklist|urlencode }}/batchitem/{{ item.id }}/detail/" class="product-name-link fw-bold text-dark text-decoration-none" target="_blank">{{ item.nama_produk }}</a>
                    </div>
        
                <!-- Zona 3 (diperbarui): Variant/Brand di kiri, Jumlah di kanan -->
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div>
                    <small class="text-primary fw-bold variant-produk">{{ item.variant_produk|default_if_none:'' }}</small>
                    {% if item.brand and item.variant_produk %} - {% endif %}
                    {% if item.brand %}
                      <span class="badge bg-light text-success border brand">{{ item.brand }}</span>
                    {% endif %}
                  </div>
                  <div class="me-3" style="min-width: 80px; text-align: center;">
                    {% if item.status_ambil == 'over_stock' %}
                      <span class="fw-bold text-danger fs-5 jumlah-ambil">{{ item.jumlah_ambil }}</span> / <span class="text-muted jumlah">{{ item.jumlah }}</span>
                      {% if item.over_qty_display is not None %}
                        <small class="d-block text-danger">(lebih {{ item.over_qty_display }})</small>
                      {% endif %}
                    {% else %}
                      <span class="fw-bold fs-5 jumlah-ambil">{{ item.jumlah_ambil }}</span> / <span class="text-muted jumlah">{{ item.jumlah }}</span>
                    {% endif %}
                  </div>
                </div>
          
                <!-- Zona 4 (diperbarui): SKU/Barcode di kiri, Status di kanan -->
                <div class="d-flex justify-content-between align-items-center">
                  <!-- Kiri: SKU & Barcode -->
                  <div>
                    <span class="badge bg-light text-dark border me-2 sku-badge">{{ item.sku }}</span>
                    <span class="badge bg-light text-dark border barcode-badge"><i class="bi bi-upc me-1"></i>{{ item.barcode }}</span>
                  </div>
                  <!-- Kanan: Status -->
                  <div style="min-width: 100px; text-align: center;">
                      {% if item.status_ambil == 'pending' %}
                        <span class="badge bg-light text-dark rounded-pill status-ambil">Pending</span>
                      {% elif item.status_ambil == 'partial' %}
                        <span class="badge bg-warning text-dark rounded-pill status-ambil">Partial</span>
                      {% elif item.status_ambil == 'over_stock' %}
                        <span class="badge bg-danger rounded-pill status-ambil">Over Stock</span>
                      {% else %}
                        <span class="badge bg-secondary rounded-pill status-ambil">Lainnya</span>
                      {% endif %}
                  </div>
                </div>
              </div>
          
            </div>
            {% empty %}
              <div class="list-group-item text-center text-muted">Tidak ada data.</div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Completed Items (kontennya akan dikosongkan karena sudah dipindah) -->
  <div class="modal fade" id="completedItemsModal" tabindex="-1" aria-labelledby="completedItemsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="completedItemsModalLabel">Completed Items</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Search Bar untuk Completed Items -->
          <div class="mb-3">
            <input type="text" id="completedSearchInput" class="form-control" placeholder="Cari di Completed Items (SKU, Barcode, Nama, Variant, Brand...)">
          </div>
          <p class="text-center text-muted">Daftar item yang sudah selesai sekarang ditampilkan di daftar utama. Gunakan filter untuk melihatnya.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Ready to Pick IDs -->
  <div class="modal fade" id="readyToPickModal" tabindex="-1" aria-labelledby="readyToPickModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="readyToPickModalLabel">ID Pesanan Ready to Pick</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <ul id="readyToPickList" class="list-group">
            {% for order_id in ready_to_pick_ids %}
            <li class="list-group-item">{{ order_id }}</li>
            {% empty %}
            <li class="list-group-item">Tidak ada pesanan yang siap untuk di-pick.</li>
            {% endfor %}
          </ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal SKU Not Found -->
  <div class="modal fade" id="skuNotFoundModal" tabindex="-1" aria-labelledby="skuNotFoundModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="skuNotFoundModalLabel">Detail SKU Tidak Ditemukan</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <ul id="skuNotFoundList" class="mb-0"></ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Panduan Navigasi -->
<div class="modal fade" id="navigationGuideModal" tabindex="-1" aria-labelledby="navigationGuideModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="navigationGuideModalLabel">Panduan Navigasi & Shortcut</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <h6>Shortcut Umum:</h6>
        <ul class="list-group list-group-flush mb-3">
          <li class="list-group-item"><strong><code>Ctrl + R</code></strong>: Mengembalikan fokus ke kotak SCAN BARCODE (saat tidak ada input lain yang aktif).</li>
        </ul>

        <h6>Manual Input:</h6>
        <ul class="list-group list-group-flush mb-3">
          <li class="list-group-item"><strong>Pilih barang</strong>: Ketik SKU/Barcode/Nama Produk di kolom 'Cari SKU / Barcode / Nama...'.</li>
          <li class="list-group-item"><strong>Pilih item dari dropdown</strong>:
            <ul>
              <li>Gunakan <strong><code>Tombol Panah Bawah</code></strong> untuk navigasi.</li>
              <li>Gunakan <strong><code>Enter</code></strong> atau <strong><code>Tombol Panah Kanan</code></strong> untuk memilih.</li>
            </ul>
          </li>
          <li class="list-group-item"><strong>Mengatur Jumlah Ambil (setelah item terpilih)</strong>:
            <ul>
              <li><strong><code>Tombol Panah Atas</code></strong>: Menambah jumlah.</li>
              <li><strong><code>Tombol Panah Bawah</code></strong>: Mengurangi jumlah.</li>
              <li><strong><code>Tombol Panah Kanan</code></strong>: Menyetel ke jumlah maksimal (sesuai 'Jumlah' yang dibutuhkan).</li>
              <li><strong><code>Tombol Panah Kiri</code></strong>: Menyetel jumlah ke 0 (reset).</li>
              <li><strong><code>Enter</code></strong>: Melakukan Update (menyimpan perubahan).</li>
            </ul>
          </li>
        </ul>

        <h6>Edit Data di 'Completed Items':</h6>
        <ul class="list-group list-group-flush mb-3">
          <li class="list-group-item">Buka modal <strong><code>Lihat Item Selesai</code></strong> (tombol di pojok kanan atas tabel pending).</li>
          <li class="list-group-item">Klik <strong><code>Nama Produk</code></strong> pada baris item yang ingin diubah.</li>
          <li class="list-group-item">Input Barcode di <strong><code>Scan Barcode</code></strong> untuk membuka lock.</li>
          <li class="list-group-item">Edit <strong><code>Jumlah Ambil</code></strong> ,akhiri dengan <strong><code>Tutup Tab</code></strong>.</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Variabel-variabel ini HARUS tetap di sini karena menggunakan Django Template Tags
  window.NAMA_PICKLIST = "{{ nama_picklist }}";
  window.CSRF_TOKEN = "{{ csrf_token }}";
  window.CURRENT_USER = "{{ request.user.username }}";
</script>

<style>
  .card-body {
    width: 100%;
    height: 100%;
  }

  .table-batch {
    width: 100%;
    margin: auto;
  }

  .table-summary-order {
    width: 100% !important;
    /* diperkecil lagi 20% dari sebelumnya (80% -> 60%) */
    margin-left: auto;
    margin-right: auto;
  }

  /* @media (max-width: 991px) {
    .table-summary-order {
      width: 100% !important;
      margin-left: 0;
    }
  } */

  #pendingTableWrapper {
    max-height: 2000px;
    /* Atur tinggi area tabel, bisa diubah sesuai kebutuhan */
    overflow-y: auto;
    overflow-x: auto;
    display: block;
  }

  #pendingTable th,
  #pendingTable td {
    font-size: 100%;
  }

#idcolnama {
  max-width: 500px !important;
  width: 500px !important;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.product-name-link {
  font-weight: 500;
  color: inherit;
  text-decoration: none;
}
.product-name-link:hover {
  color: var(--bs-primary);
  text-decoration: underline;
}

.item-hidden {
  display: none !important;
}

/* PERBAIKAN: Memperbesar font untuk SKU, Barcode, dan Status */
.sku-badge,
.barcode-badge {
  font-size: 0.9rem;    /* Ukuran font diperbesar */
  padding: 0.4em 0.6em; /* Sedikit padding tambahan */
  vertical-align: middle;
}

.status-ambil {
  font-size: 0.9rem;    /* Ukuran font diperbesar */
  font-weight: 500;     /* Membuat tulisan sedikit lebih tebal */
  padding: 0.5em 0.8em; /* Padding agar badge lebih besar */
  min-width: 90px;      /* Lebar minimum agar konsisten */
}

/* PERBAIKAN: Melebarkan container utama */
.container-fluid {
    max-width: none !important; /* Menghapus batasan lebar maksimum */
    padding-left: 30px !important;  /* Menambah padding kiri */
    padding-right: 30px !important; /* Menambah padding kanan */
}

/* PERBAIKAN: Memberi warna pada tombol filter */
#pendingFilterButtons .btn[data-filter="pending"],
#pendingFilterButtons .btn[data-filter="partial"],
#pendingFilterButtons .btn[data-filter="over_stock"],
#pendingFilterButtons .btn[data-filter="completed"] {
    color: #fff; /* Teks putih untuk kontras */
}

#pendingFilterButtons .btn[data-filter="pending"] { background-color: #6c757d; } /* Abu-abu */
#pendingFilterButtons .btn[data-filter="partial"] { background-color: #ffc107; } /* Kuning */
#pendingFilterButtons .btn[data-filter="over_stock"] { background-color: #dc3545; } /* Merah */
#pendingFilterButtons .btn[data-filter="completed"] { background-color: #198754; } /* Hijau */

/* Style untuk tombol yang aktif */
#pendingFilterButtons .btn.btn-light[data-filter="pending"] { background-color: #5c636a; border-color: #5c636a;}
#pendingFilterButtons .btn.btn-light[data-filter="partial"] { background-color: #e0a800; border-color: #e0a800;}
#pendingFilterButtons .btn.btn-light[data-filter="over_stock"] { background-color: #bb2d3b; border-color: #bb2d3b;}
#pendingFilterButtons .btn.btn-light[data-filter="completed"] { background-color: #157347; border-color: #157347;}

</style>

<!-- Debug info removed to avoid JSON parsing errors -->

{% block extra_script %}
<!-- jsPDF & autotable untuk download PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<script src="{% static 'datatables/batchpicking.js' %}"></script>
{% endblock %}

{% endblock %}