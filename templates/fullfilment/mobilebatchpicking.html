{% extends 'base_mobile.html' %}
{% block content %}
<div class="container-fluid px-2 py-2" style="max-width:480px; margin:auto;">
    <h3 class="fw-bold mb-2 text-center" style="font-size:1.1rem; letter-spacing:0.5px;">
      BATCHPICKING : <span class="text-primary">{{ nama_picklist }}</span>
    </h3>
    
    <!-- Scan Barcode Input -->
    <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center">
            <label for="barcodeInput" class="form-label fw-bold mb-0" style="font-size:1em;">Scan Barcode</label>
            <button type="button" id="barcodeInputBtn" class="btn btn-primary btn-sm ms-2">Input</button>
        </div>
        <div class="input-group mb-2 flex-nowrap">
            <input type="text" id="barcodeInput" class="form-control form-control-sm rounded-start" style="font-size:1em; min-width:0;" placeholder="Scan barcode..." autofocus autocomplete="off">
            <button type="button" id="openCameraScan" class="btn btn-success btn-sm rounded-end ms-2"><i class="bi bi-upc-scan"></i> Scan with Camera</button>
        </div>
    </div>

    <!-- Camera Scanner Modal -->
    <div class="modal fade" id="cameraScanModal" tabindex="-1" aria-labelledby="cameraScanModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="cameraScanModalLabel">Scan Barcode/QR</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="closeCameraScan"></button>
          </div>
          <div class="modal-body">
            <div id="qr-reader" style="width:100%"></div>
            <div id="qr-reader-results" class="mt-3"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Manual Search Input -->
    <div class="mb-3 position-relative">
        <div class="d-flex justify-content-between align-items-center">
            <label for="manualInput" class="form-label fw-bold mb-0" style="font-size:1em;">Cari Produk</label>
            <button type="button" id="manualInputBtn" class="btn btn-primary btn-sm ms-2">Input</button>
        </div>
        <input type="text" id="manualInput" class="form-control form-control-sm" style="font-size:1em;" placeholder="Cari nama produk, variant, brand..." autocomplete="off">
        <div id="manualDropdown" class="list-group position-absolute w-100" style="z-index:10; display:none;"></div>
    </div>

    <div id="barcodeFeedback"></div>

    <!-- Pending Items -->
    <div class="mb-4">
        <h5 class="mb-2" style="font-size:1em;">Pending Items</h5>
        <ul class="list-group" id="pendingList">
            {% for item in details %}
            {% if item.status_ambil != 'completed' %}
            <li class="list-group-item d-flex justify-content-between align-items-center px-2 py-2" style="font-size:0.98em; border-radius:10px; margin-bottom:6px; box-shadow:0 1px 4px rgba(0,0,0,0.04); border:1px solid #f0f0f0;"
                data-product-id="{{ item.id }}"
                data-sku="{{ item.sku }}"
                data-nama="{{ item.nama_produk }}"
                data-barcode="{{ item.barcode }}"
                data-variant="{{ item.variant_produk }}"
                data-brand="{{ item.brand }}"
                data-rak="{{ item.rak }}">
                <div class="d-flex align-items-start gap-2">
                    {% if item.product.photo %}
                        <img src="{{ item.product.photo.url }}" alt="Photo" style="width:34px; height:34px; object-fit:contain; border-radius:6px; background:#f8f9fa;" class="me-2">
                    {% else %}
                        <div style="width:34px; height:34px; background:#f0f0f0; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:1.1em; color:#bbb;" class="me-2">ðŸ“¦</div>
                    {% endif %}
                    <div>
                        <div class="fw-bold" style="font-size:0.98em;">sku  :  {{ item.sku }}</div>
                        <div style="font-size:0.9em;" class="text-secondary">bar  :  {{ item.barcode }}</div>
                        <div style="font-size:0.6em;">{{ item.nama_produk }}<br><span class="text-muted">{{ item.variant_produk }}</span></div>
                        <div style="font-size:0.9em;" class="text-secondary">{{ item.brand }}</div>
                        
                    </div>
                </div>
                <div class="text-end">
                    <span class="badge bg-primary" style="font-size:0.95em;">{{ item.jumlah_ambil }}/{{ item.jumlah }}</span><br>
                    <span class="badge bg-light text-dark border mt-1" style="font-size:0.92em;">{{ item.rak }}</span>
                </div>
            </li>
            {% endif %}
            {% endfor %}
        </ul>
    </div>

    <!-- Completed Items -->
    <div class="mb-4">
        <h5 class="mb-2" style="font-size:1em;">Completed Items</h5>
        <ul class="list-group" id="completedList">
            {% for item in details %}
            {% if item.status_ambil == 'completed' %}
            <li class="list-group-item d-flex justify-content-between align-items-center px-2 py-2" style="font-size:0.98em; border-radius:10px; margin-bottom:6px; box-shadow:0 1px 4px rgba(0,0,0,0.04); border:1px solid #f0f0f0;"
                data-product-id="{{ item.id }}"
                data-sku="{{ item.sku }}"
                data-nama="{{ item.nama_produk }}"
                data-barcode="{{ item.barcode }}"
                data-variant="{{ item.variant_produk }}"
                data-brand="{{ item.brand }}"
                data-rak="{{ item.rak }}">
                <div>
                    <div class="fw-bold" style="font-size:0.98em;">{{ item.sku }}</div>
                    <div style="font-size:0.93em;">{{ item.nama_produk }}<br><span class="text-muted">{{ item.variant_produk }}</span></div>
                    <div style="font-size:0.9em;" class="text-secondary">{{ item.brand }}</div>
                </div>
                <div class="text-end">
                    <span class="badge bg-success" style="font-size:0.95em;">{{ item.jumlah_ambil }}/{{ item.jumlah }}</span><br>
                    <span class="badge bg-light text-dark border mt-1" style="font-size:0.92em;">{{ item.rak }}</span>
                </div>
            </li>
            {% endif %}
            {% endfor %}
        </ul>
    </div>
</div>

{% endblock %}
{% block extra_script %}
<script>
window.NAMA_PICKLIST = "{{ nama_picklist }}";
window.CSRF_TOKEN = "{{ csrf_token }}";
</script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
function playSound(type) {
    if (type === 'completed') {
        const audio = new Audio('/static/sounds/completedsound.mp3');
        audio.play();
    } else {
        const audio = new Audio(type === 'success' ? 'https://cdn.jsdelivr.net/gh/ttskch/audio-sample/success.mp3' : 'https://cdn.jsdelivr.net/gh/ttskch/audio-sample/error.mp3');
        audio.play();
    }
}
function showFeedback(message, type, status_ambil) {
    const feedback = document.getElementById('barcodeFeedback');
    feedback.innerHTML = message;
    feedback.className = type === 'success' ? 'alert alert-success' : 'alert alert-danger';
    if (status_ambil === 'completed') {
        playSound('completed');
    } else {
        playSound(type);
    }
}
document.addEventListener('DOMContentLoaded', function() {
    const barcodeInput = document.getElementById('barcodeInput');
    barcodeInput.focus();
    barcodeInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            const barcode = barcodeInput.value.trim();
            if (!barcode) return;
            barcodeInput.value = '';
            fetch(`/fullfilment/batchpicking/${window.NAMA_PICKLIST}/update_barcode/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': window.CSRF_TOKEN,
                },
                body: JSON.stringify({ barcode })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showFeedback('Berhasil scan: ' + barcode, 'success', data.status_ambil);
                    // Optionally update UI here
                } else {
                    showFeedback(data.error || 'Barcode tidak valid.', 'error');
                }
            })
            .catch(() => {
                showFeedback('Terjadi kesalahan koneksi.', 'error');
            });
        }
    });
    document.getElementById('barcodeInputBtn').onclick = function() {
        barcodeInput.focus();
    };
    // Manual input logic
    const manualInput = document.getElementById('manualInput');
    const manualDropdown = document.getElementById('manualDropdown');
    manualInput.addEventListener('input', function(e) {
        const val = manualInput.value.trim().toLowerCase();
        if (!val) {
            manualDropdown.style.display = 'none';
            return;
        }
        // Filter pending items
        const pendingItems = Array.from(document.querySelectorAll('#pendingList .list-group-item')).map(item => ({
            id: item.getAttribute('data-product-id'),
            sku: item.getAttribute('data-sku'),
            barcode: item.getAttribute('data-barcode'),
            nama_produk: item.getAttribute('data-nama'),
            variant_produk: item.getAttribute('data-variant'),
            brand: item.getAttribute('data-brand'),
            rak: item.getAttribute('data-rak')
        }));
        const filtered = pendingItems.filter(item =>
            item.sku.toLowerCase().includes(val) ||
            item.barcode.toLowerCase().includes(val) ||
            item.nama_produk.toLowerCase().includes(val) ||
            item.variant_produk.toLowerCase().includes(val) ||
            item.brand.toLowerCase().includes(val)
        );
        if (filtered.length > 0) {
            manualDropdown.innerHTML = filtered.map(item => `
                <div class="list-group-item" style="cursor:pointer;" data-barcode="${item.barcode}">
                    <b>${item.sku}</b> | <span class='text-muted'>${item.barcode}</span> - ${item.nama_produk} <span class='text-info'>${item.variant_produk}</span> <span class='text-secondary'>${item.brand}</span>
                </div>
            `).join('');
            manualDropdown.style.display = 'block';
            manualDropdown.querySelectorAll('.list-group-item').forEach(el => {
                el.addEventListener('click', function() {
                    const barcode = this.getAttribute('data-barcode');
                    // Prompt for jumlah_ambil
                    const jumlah_ambil = prompt('Jumlah ambil:', '1');
                    if (barcode && jumlah_ambil !== null) {
                        fetch(`/fullfilment/batchpicking/${window.NAMA_PICKLIST}/update_manual/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': window.CSRF_TOKEN,
                            },
                            body: JSON.stringify({ barcode, jumlah_ambil: parseInt(jumlah_ambil) })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                showFeedback('Berhasil update jumlah ambil.', 'success', data.status_ambil);
                                manualInput.value = '';
                                manualDropdown.style.display = 'none';
                            } else {
                                showFeedback(data.error || 'Gagal update.', 'error');
                            }
                        })
                        .catch(() => {
                            showFeedback('Terjadi kesalahan koneksi.', 'error');
                        });
                    }
                });
            });
        } else {
            manualDropdown.style.display = 'none';
        }
    });
    document.getElementById('manualInputBtn').onclick = function() {
        manualInput.focus();
    };
    // Klik pada item pending langsung ke detail
    document.querySelectorAll('#pendingList li').forEach(function(li) {
        li.style.cursor = 'pointer';
        li.addEventListener('click', function() {
            const batchitemId = li.getAttribute('data-product-id');
            window.location.href = `/fullfilment/batchitem/${batchitemId}/detail/`;
        });
    });

    // Camera scan functionality
    const qrReader = document.getElementById('qr-reader');
    const qrResults = document.getElementById('qr-reader-results');
    let html5QrcodeScanner;
    document.getElementById('openCameraScan').addEventListener('click', function() {
        // Open modal
        const modal = new bootstrap.Modal(document.getElementById('cameraScanModal'));
        modal.show();

        // Initialize camera scanner
        html5QrcodeScanner = new Html5Qrcode("qr-reader");
        html5QrcodeScanner.start(
            { facingMode: "environment" }, // Use rear camera
            {
                fps: 10,    // Frames per second
                qrbox: 250  // Square size of QR code detection box
            },
            qrCodeMessage => {
                // Success callback
                handleBarcodeScan(qrCodeMessage);
                // Stop scanning after successful scan
                html5QrcodeScanner.stop().catch(err => {
                    console.error("Failed to stop scanning.", err);
                });
            },
            errorMessage => {
                // Optionally handle scan errors
            }
        ).catch(err => {
            console.error("Error starting camera scan:", err);
            // Custom alert for permission denied or camera not available
            document.getElementById('qr-reader-results').innerHTML = "<div class='alert alert-danger'>Camera access denied or not available.<br>Please allow camera access in your browser/app settings.<br><br><b>Tips:</b><ul><li>Pastikan browser sudah diizinkan akses kamera.</li><li>Jika tetap gagal, coba refresh halaman atau gunakan browser lain.</li></ul></div>";
            if (window.Swal) {
                Swal.fire({
                    icon: 'error',
                    title: 'Camera Permission Denied',
                    html: 'Akses kamera ditolak atau tidak tersedia.<br>Silakan izinkan akses kamera di pengaturan browser atau aplikasi Anda.',
                });
            } else {
                alert('Camera access denied or not available. Please allow camera access in your browser/app settings.');
            }
        });
    });
    document.getElementById('closeCameraScan').addEventListener('click', function() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().catch(err => {
                console.error("Failed to stop scanning.", err);
            });
        }
    });
    // Camera Barcode Scanner
    let html5QrCode;
    const openCameraBtn = document.getElementById('openCameraScan');
    openCameraBtn.addEventListener('click', function() {
        const modal = new bootstrap.Modal(document.getElementById('cameraScanModal'));
        modal.show();
        setTimeout(() => {
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("qr-reader");
            }
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250, formatsToSupport: [
                    Html5QrcodeSupportedFormats.CODE_128,
                    Html5QrcodeSupportedFormats.CODE_39,
                    Html5QrcodeSupportedFormats.EAN_13,
                    Html5QrcodeSupportedFormats.EAN_8,
                    Html5QrcodeSupportedFormats.UPC_A,
                    Html5QrcodeSupportedFormats.UPC_E,
                    Html5QrcodeSupportedFormats.ITF,
                    Html5QrcodeSupportedFormats.QR_CODE // allow QR as fallback
                ] },
                code => {
                    document.getElementById('qr-reader-results').innerHTML = `<div class='alert alert-success'>Scanned: <b>${code}</b></div>`;
                    barcodeInput.value = code;
                    barcodeInput.focus();
                    // Optionally trigger Enter event
                    const enterEvent = new KeyboardEvent('keydown', { key: 'Enter' });
                    barcodeInput.dispatchEvent(enterEvent);
                    html5QrCode.stop();
                },
                errorMessage => {
                    // Optionally show scan errors
                }
            );
        }, 500);
    });
    document.getElementById('closeCameraScan').addEventListener('click', function () {
        if (html5QrCode) {
            html5QrCode.stop().catch(() => {});
        }
        document.getElementById('qr-reader-results').innerHTML = '';
    });
});
// === GLOBAL BARCODE SCANNER LISTENER ===
let barcodeBuffer = '';
let barcodeTimer = null;
let lastKeyTime = Date.now();
window.addEventListener('keydown', function(e) {
    // Abaikan jika sedang fokus di input manual
    const active = document.activeElement;
    if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA') && active !== barcodeInput) return;
    const now = Date.now();
    if (now - lastKeyTime > 100) barcodeBuffer = '';
    lastKeyTime = now;
    if (e.key === 'Enter') {
        if (barcodeBuffer.length > 0) {
            handleBarcodeScan(barcodeBuffer);
            barcodeBuffer = '';
        }
    } else if (e.key.length === 1) {
        barcodeBuffer += e.key;
    }
});
function handleBarcodeScan(barcode) {
    fetch(`/fullfilment/batchpicking/${window.NAMA_PICKLIST}/update_barcode/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': window.CSRF_TOKEN,
        },
        body: JSON.stringify({ barcode })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showFeedback('Berhasil scan: ' + barcode, 'success', data.status_ambil);
            // Optionally update UI here
        } else {
            showFeedback(data.error || 'Barcode tidak valid.', 'error');
        }
    })
    .catch(() => {
        showFeedback('Terjadi kesalahan koneksi.', 'error');
    });
}
</script>
{% endblock %}