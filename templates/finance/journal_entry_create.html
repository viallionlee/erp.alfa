{% extends 'base.html' %}
{% load static %}

{% block title %}Buat Jurnal Umum - Keuangan{% endblock %}

{% block extra_head %}
<style>
    /* Modern gradient backgrounds */
    .gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .gradient-success {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    .gradient-danger {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    .gradient-warning {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
    }
    
    /* Modern card shadows */
    .card-modern {
        border: none;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
    }
    
    .card-modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }
    
    /* Modern button styles */
    .btn-modern {
        border-radius: 12px;
        padding: 12px 20px;
        font-weight: 500;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    .btn-modern:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    /* Icon backgrounds */
    .icon-bg {
        width: 60px;
        height: 60px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }
    
    /* Form styling */
    .form-control-modern {
        border: 2px solid #f1f3f4;
        border-radius: 12px;
        padding: 12px 16px;
        transition: all 0.3s ease;
    }
    
    .form-control-modern:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    /* Journal items */
    .journal-item {
        background: white;
        border: 2px solid #f1f3f4;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 16px;
        transition: all 0.3s ease;
    }
    
    .journal-item:hover {
        border-color: #667eea;
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.1);
    }
    
    /* Balance summary */
    .balance-summary {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border: none;
        border-radius: 16px;
        padding: 20px;
        margin-top: 20px;
    }
    
    .balance-balanced {
        color: #28a745;
        font-weight: bold;
    }
    
    .balance-unbalanced {
        color: #dc3545;
        font-weight: bold;
    }
    
    /* Add item button */
    .add-item-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        border-radius: 12px;
        padding: 12px 20px;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        margin-top: 20px;
        transition: all 0.3s ease;
    }
    
    .add-item-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(40, 167, 69, 0.3);
    }
    
    /* Remove item button */
    .remove-item {
        background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 0.8em;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .remove-item:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
    }
    
    /* Journal items container */
    .journal-items {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 16px;
        padding: 24px;
        margin-top: 24px;
    }
    
    /* Form group styling */
    .form-group label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
    }
    
    /* Amount input */
    .amount-input {
        text-align: right;
    }
    
    /* Validation error */
    .validation-error {
        color: #dc3545;
        font-size: 0.875em;
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-vh-100" style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
    <div class="container-fluid py-5">
        <!-- Header Section -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="display-6 fw-bold text-dark mb-2">Buat Jurnal Umum</h1>
                        <p class="text-muted fs-5 mb-0">Buat entri jurnal baru untuk transaksi akuntansi</p>
                    </div>
                    <div class="d-flex gap-3">
                        <a href="{% url 'finance:journal_entry_list' %}" class="btn btn-secondary btn-modern">
                            <i class="bi bi-arrow-left me-2"></i>Kembali ke Daftar
                        </a>
                        <a href="{% url 'finance:dashboard' %}" class="btn btn-outline-primary btn-modern">
                            <i class="bi bi-house me-2"></i>Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card card-modern">
                    <div class="card-header bg-white border-0 py-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h4 class="card-title mb-0 fw-bold">Informasi Jurnal Umum</h4>
                                <p class="text-muted mb-0 mt-2">Lengkapi informasi dasar untuk jurnal umum</p>
                            </div>
                            <div class="icon-bg bg-primary bg-opacity-10 text-primary">
                                <i class="bi bi-journal-text"></i>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <form method="post" id="journalEntryForm">
                            {% csrf_token %}
                            
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="entry_date">Tanggal Entri <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control form-control-modern" id="entry_date" name="entry_date" required
                                               value="{% now 'Y-m-d' %}">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="reference">Referensi</label>
                                        <input type="text" class="form-control form-control-modern" id="reference" name="reference"
                                               placeholder="PO, Invoice, dll." maxlength="100">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="status">Status</label>
                                        <select class="form-control form-control-modern" id="status" name="status">
                                            <option value="draft" selected>Draft</option>
                                            <option value="posted">Posted</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group mb-4">
                                <label for="description">Deskripsi <span class="text-danger">*</span></label>
                                <textarea class="form-control form-control-modern" id="description" name="description" rows="3" required
                                          placeholder="Deskripsikan transaksi..."></textarea>
                            </div>

                            <div class="form-group mb-4">
                                <label for="notes">Catatan</label>
                                <textarea class="form-control form-control-modern" id="notes" name="notes" rows="2"
                                          placeholder="Catatan tambahan..."></textarea>
                            </div>

                            <!-- Journal Items -->
                            <div class="journal-items">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <div>
                                        <h5 class="fw-bold mb-1">Item Jurnal Umum</h5>
                                        <p class="text-muted mb-0">Tambahkan entri debit dan kredit. Total debit harus sama dengan total kredit.</p>
                                    </div>
                                    <div class="icon-bg bg-success bg-opacity-10 text-success">
                                        <i class="bi bi-list-check"></i>
                                    </div>
                                </div>
                                
                                <div id="journalItems">
                                    <!-- Items will be added dynamically -->
                                </div>
                                
                                <button type="button" class="add-item-btn" onclick="addJournalItem()">
                                    <i class="bi bi-plus-circle me-2"></i> Tambah Item Jurnal
                                </button>
                            </div>

                            <!-- Balance Summary -->
                            <div class="balance-summary">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="fw-bold mb-0 text-primary">
                                        <i class="bi bi-scale me-2"></i>Ringkasan Saldo
                                    </h6>
                                    <div class="icon-bg bg-primary bg-opacity-20 text-primary">
                                        <i class="bi bi-calculator"></i>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="text-center p-3 bg-white rounded-3">
                                            <h6 class="text-muted mb-1">Total Debit</h6>
                                            <h5 class="fw-bold text-danger mb-0" id="totalDebits">Rp 0</h5>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center p-3 bg-white rounded-3">
                                            <h6 class="text-muted mb-1">Total Kredit</h6>
                                            <h5 class="fw-bold text-success mb-0" id="totalCredits">Rp 0</h5>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center p-3 bg-white rounded-3">
                                            <h6 class="text-muted mb-1">Selisih</h6>
                                            <h5 class="fw-bold mb-0" id="difference">Rp 0</h5>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-center mt-3">
                                    <span class="badge bg-light text-dark px-3 py-2">
                                        Status: <span id="balanceStatus" class="balance-unbalanced">Tidak Seimbang</span>
                                    </span>
                                </div>
                            </div>

                            <div class="d-flex gap-3 mt-5">
                                <button type="submit" class="btn btn-primary btn-modern flex-grow-1" id="submitBtn" disabled>
                                    <i class="bi bi-check-circle me-2"></i> Buat Jurnal Umum
                                </button>
                                <a href="{% url 'finance:journal_entry_list' %}" class="btn btn-outline-secondary btn-modern">
                                    <i class="bi bi-x-circle me-2"></i> Batal
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
let itemCounter = 0;
const accounts = {{ accounts_json|safe }};

$(document).ready(function() {
    // Add initial items
    addJournalItem();
    addJournalItem();
    
    // Form validation
    $('#journalEntryForm').on('submit', function(e) {
        if (!isBalanced()) {
            e.preventDefault();
            alert('Jurnal umu harus seimbang (total debit = total kredit)');
            return false;
        }
        
        if (itemCounter < 2) {
            e.preventDefault();
            alert('Minimal diperlukan 2 item jurnal');
            return false;
        }
    });
});

function addJournalItem() {
    itemCounter++;
    const itemHtml = `
        <div class="journal-item" id="item-${itemCounter}">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="fw-bold text-primary">Item ${itemCounter}</span>
                <button type="button" class="remove-item" onclick="removeJournalItem(${itemCounter})">
                    <i class="bi bi-trash me-1"></i> Hapus
                </button>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Akun <span class="text-danger">*</span></label>
                        <select class="form-control form-control-modern account-select" name="account" required>
                            <option value="">Pilih Akun</option>
                            ${accounts.map(account => 
                                `<option value="${account.id}">${account.code} - ${account.name}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Jumlah Debit</label>
                        <input type="number" class="form-control form-control-modern amount-input" name="debit" 
                               step="0.01" min="0" placeholder="0.00" onchange="updateBalance()">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Jumlah Kredit</label>
                        <input type="number" class="form-control form-control-modern amount-input" name="credit" 
                               step="0.01" min="0" placeholder="0.00" onchange="updateBalance()">
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label>Deskripsi</label>
                        <input type="text" class="form-control form-control-modern" name="item_description" 
                               placeholder="Deskripsi item">
                    </div>
                </div>
            </div>
        </div>
    `;
    
    $('#journalItems').append(itemHtml);
    updateBalance();
}

function removeJournalItem(itemId) {
    if (itemCounter <= 2) {
        alert('Minimal diperlukan 2 item jurnal');
        return;
    }
    
    $(`#item-${itemId}`).remove();
    itemCounter--;
    updateBalance();
}

function updateBalance() {
    let totalDebits = 0;
    let totalCredits = 0;
    
    $('.journal-item').each(function() {
        const debit = parseFloat($(this).find('input[name="debit"]').val()) || 0;
        const credit = parseFloat($(this).find('input[name="credit"]').val()) || 0;
        
        totalDebits += debit;
        totalCredits += credit;
    });
    
    const difference = totalDebits - totalCredits;
    
    $('#totalDebits').text('Rp ' + totalDebits.toLocaleString('id-ID'));
    $('#totalCredits').text('Rp ' + totalCredits.toLocaleString('id-ID'));
    $('#difference').text('Rp ' + difference.toLocaleString('id-ID'));
    
    if (Math.abs(difference) < 0.01) {
        $('#balanceStatus').text('Seimbang').removeClass('balance-unbalanced').addClass('balance-balanced');
        $('#submitBtn').prop('disabled', false);
    } else {
        $('#balanceStatus').text('Tidak Seimbang').removeClass('balance-balanced').addClass('balance-unbalanced');
        $('#submitBtn').prop('disabled', true);
    }
}

function isBalanced() {
    let totalDebits = 0;
    let totalCredits = 0;
    
    $('.journal-item').each(function() {
        const debit = parseFloat($(this).find('input[name="debit"]').val()) || 0;
        const credit = parseFloat($(this).find('input[name="credit"]').val()) || 0;
        
        totalDebits += debit;
        totalCredits += credit;
    });
    
    return Math.abs(totalDebits - totalCredits) < 0.01;
}

// Prevent both debit and credit from being filled
$(document).on('input', 'input[name="debit"], input[name="credit"]', function() {
    const row = $(this).closest('.journal-item');
    const debitInput = row.find('input[name="debit"]');
    const creditInput = row.find('input[name="credit"]');
    
    if ($(this).attr('name') === 'debit' && $(this).val() > 0) {
        creditInput.val('');
    } else if ($(this).attr('name') === 'credit' && $(this).val() > 0) {
        debitInput.val('');
    }
    
    updateBalance();
});
</script>
{% endblock %}