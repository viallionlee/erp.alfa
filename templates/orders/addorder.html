{% extends 'base.html' %}
{% block title %}Tambah Order Baru{% endblock %}
{% block content %}
<style>
    .modern-form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 4px;
    }
    .modern-form-row {
        display: flex;
        gap: 1rem;
        align-items: flex-end;
        margin-bottom: 1.2rem;
        flex-wrap: wrap;
    }
    .modern-form-row > .form-group {
        flex: 1 1 0;
        min-width: 180px;
    }
    .modern-form-row .input-group {
        width: 100%;
    }
    .modern-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.07);
        padding: 2rem 2.5rem 1.5rem 2.5rem;
        max-width: 1200px;
        margin: 0 auto;
    }
    #search-result-box {
        min-width: 320px;
        font-size: 0.95em;
    }
    @media (max-width: 600px) {
        .modern-card { padding: 1rem; }
        .modern-form-row { flex-direction: column; gap: 0.5rem; }
    }
</style>
<div class="container mt-4">
    <h2 class="mb-4 text-center">Tambah Order Baru</h2>
    <div class="modern-card">
    <form method="post" id="add-order-form">
        {% csrf_token %}
        <!-- Row 1: Tanggal, Customer, ID Pesanan (inline) -->
        <div class="modern-form-row">
            <div class="form-group">
                <label class="modern-form-label" for="tanggal_pembuatan">Tanggal Pembuatan</label>
                <input type="text" name="tanggal_pembuatan" id="tanggal_pembuatan" class="form-control" readonly required>
            </div>
            <div class="form-group">
                <label class="modern-form-label" for="nama_customer">Nama Customer <span style="color:red">*</span></label>
                <div class="input-group">
                    <input type="text" name="nama_customer" id="nama_customer" class="form-control" required readonly aria-label="Nama Customer">
                    <button class="btn btn-outline-primary" type="button" id="pilih_customer_btn" aria-label="Pilih Customer" aria-haspopup="dialog">Pilih</button>
                </div>
            </div>
            <div class="form-group">
                <label class="modern-form-label" for="id_pesanan">ID Pesanan</label>
                <input type="text" name="id_pesanan" id="id_pesanan" class="form-control" readonly required>
            </div>
        </div>
        <!-- Row 2: Keterangan -->
        <div class="modern-form-row">
            <div class="form-group" style="flex:2;">
                <label class="modern-form-label" for="keterangan">Keterangan</label>
                <textarea name="keterangan" id="keterangan" class="form-control" rows="1" placeholder="Keterangan tambahan (opsional)"></textarea>
            </div>
        </div>
        <!-- Row 3: Cari Produk -->
        <div class="modern-form-row">
            <div class="form-group" style="flex:2; position:relative;">
                <label class="modern-form-label" for="produk_search">Cari Produk</label>
                <div class="input-group mb-1">
                    <input type="text" id="produk_search" class="form-control" placeholder="Cari SKU / Barcode / Nama / Brand / Variant" autocomplete="off" aria-label="Cari Produk">
                    <button class="btn btn-outline-secondary" type="button" id="produk_search_btn" aria-label="Cari Produk">Cari</button>
                </div>
                <div id="search-result-box" class="border rounded mt-1 bg-white shadow-sm" style="display:none; position:absolute; z-index:10; min-width:100%; max-width:100vw; overflow-x:auto; max-height:180px; overflow-y:auto;">
                  <!-- Kolom judul agar lebih jelas -->
                  <table class="table table-sm mb-0"><thead><tr style="background:#f8f9fa;"><th>SKU</th><th>Barcode</th><th>Nama</th><th>Variant</th><th>Brand</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </div>
        <!-- Produk Table -->
        <div class="table-responsive mt-3">
            <table class="table table-bordered align-middle" id="produk-table">
                <thead class="table-light">
                    <tr>
                        <th>SKU</th>
                        <th>Barcode</th>
                        <th>Nama Produk</th>
                        <th>Variant</th>
                        <th>Brand</th>
                        <th>Stok</th>
                        <th>Jumlah</th>
                        <th>Harga</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Baris produk akan muncul di sini -->
                </tbody>
            </table>
        </div>
        <div class="mt-3 text-center">
            <button type="submit" class="btn btn-primary px-4">Simpan Order</button>
            <a href="{% url 'orders_index' %}" class="btn btn-secondary ms-2">Batal</a>
        </div>
    </form>
    </div>
</div>
<!-- Modal Pilih Customer -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="customerModalLabel">Pilih Customer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="search_customer" class="form-control mb-2" placeholder="Cari nama/alamat customer...">
        <div id="customer-list" class="list-group" style="max-height:300px;overflow-y:auto;"></div>
        <div class="mt-2 text-end">
          <a href="#" id="addCustomerLink">+ Tambah Customer Baru</a>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Modal Tambah Customer Baru -->
<div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addCustomerModalLabel">Tambah Customer Baru</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label>Nama Customer</label>
          <input type="text" id="new_nama_customer" class="form-control" required>
        </div>
        <div class="mb-2">
          <label>Alamat</label>
          <textarea id="new_alamat_cust" class="form-control"></textarea>
        </div>
        <div class="mb-2">
          <label>Kota</label>
          <input type="text" id="new_kota" class="form-control">
        </div>
        <div class="mb-2">
          <label>Kode Pos</label>
          <input type="text" id="new_kode_pos" class="form-control">
        </div>
        <div class="mb-2">
          <label>Level</label>
          <select id="new_level" class="form-control">
            <option value="normal">Normal</option>
            <option value="vip">VIP</option>
            <option value="vvip">VVIP</option>
          </select>
        </div>
        <div class="text-end">
          <button type="button" class="btn btn-primary" id="saveCustomerBtn">Simpan</button>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
// ----- global state untuk navigasi -----
let selectedIdx = -1;
let currentRows = [];

function updateSearchResultHighlight() {
  // hapus highlight di semua baris
  currentRows.forEach(r => r.classList.remove('table-active'));
  // tambahkan highlight di baris terpilih
  if (selectedIdx >= 0 && selectedIdx < currentRows.length) {
    currentRows[selectedIdx].classList.add('table-active');
  }
}

// Set default tanggal hari ini
$(function() {
    let now = new Date();
    let pad = n => n < 10 ? '0'+n : n;
    // Format tanggal: dd-mm-yyyy hh:mm
    let tglStr = pad(now.getDate()) + '-' + pad(now.getMonth()+1) + '-' + now.getFullYear() + ' ' + pad(now.getHours()) + ':' + pad(now.getMinutes());
    $('#tanggal_pembuatan').val(tglStr);
    $.get('/orders/datatable/?draw=1&start=0&length=1', function(resp) {
        let nextId = (resp.recordsTotal || 0) + 1;
        let id = `ORD-${pad(now.getDate())}${pad(now.getMonth()+1)}${now.getFullYear().toString().slice(-2)}${String(nextId).padStart(3, '0')}`;
        $('#id_pesanan').val(id);
    });
});

// --- SEARCH PRODUK DENGAN SEARCH-RESULT-BOX (SAMA DENGAN INBOUND) ---
function searchProdukManual(keyword, callback) {
  $.getJSON('/inventory/produk-lookup', {q: keyword, mode: 'manual', page_size: 1000}, function(data) {
    callback(data);
  }).fail(function() {
    callback([]);
  });
}

function tambahAtauUpdateProduk(produk, stok) {
  let $row = $('#produk-table tbody tr[data-sku="' + produk.sku + '"]');
  if ($row.length) {
    let $qty = $row.find('.qty-input');
    $qty.val(parseInt($qty.val()) + 1);
  } else {
    $('#produk-table tbody').append(`
      <tr data-sku="${produk.sku}">
        <td><input type="hidden" name="produk_sku[]" value="${produk.sku}">${produk.sku}</td>
        <td>${produk.barcode}</td>
        <td>${produk.nama}</td>
        <td>${produk.variant}</td>
        <td>${produk.brand}</td>
        <td>${stok || 0}</td>
        <td><input type="number" name="produk_qty[]" class="form-control qty-input" value="1" min="1" style="width:70px;"></td>
        <td><input type="number" name="produk_harga[]" class="form-control harga-input" value="0" min="0" style="width:100px;"></td>
        <td><button type="button" class="btn btn-danger btn-sm hapus-row">Hapus</button></td>
      </tr>
    `);
  }
}

function renderSearchResultBox(list) {
  selectedIdx = -1;
  let html = '';
  if (Array.isArray(list) && list.length > 0) {
    html = '<table class="table table-sm mb-0"><tbody>';
    list.forEach(function(produk) {
      html += `<tr class="pilih-produk" style="cursor:pointer;"
        data-sku="${produk.sku}"
        data-barcode="${produk.barcode}"
        data-nama="${produk.nama}"
        data-variant="${produk.variant}"
        data-brand="${produk.brand}">
        <td>${produk.sku}</td>
        <td>${produk.barcode}</td>
        <td>${produk.nama}</td>
        <td>${produk.variant}</td>
        <td>${produk.brand}</td>
      </tr>`;
    });
    html += '</tbody></table>';
  } else {
    html = '<div class="p-2 text-danger">Produk tidak ditemukan!</div>';
  }
  $('#search-result-box').html(html).show();
  // ambil kembali semua baris untuk navigasi
  currentRows = Array.from(document.querySelectorAll('#search-result-box tr.pilih-produk'));
  updateSearchResultHighlight();
}

$('#search-result-box').on('mousedown', function(e) {
    e.stopPropagation();
});

$('#produk_search_btn').off('click').on('click', function() {
    let keyword = $('#produk_search').val().trim();
    if (!keyword) return;
    searchProdukManual(keyword, renderSearchResultBox);
});
$('#produk_search').off('input').on('input', function() {
    let keyword = $(this).val().trim();
    if (!keyword) {
        $('#search-result-box').hide();
        return;
    }
    searchProdukManual(keyword, renderSearchResultBox);
});
// Keyboard navigation and Enter for produk_search
$('#produk_search').off('keydown').on('keydown', function(e) {
  if (!$('#search-result-box').is(':visible')) return;
  if (currentRows.length === 0) return;
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    selectedIdx = (selectedIdx + 1) % currentRows.length;
    updateSearchResultHighlight();
    currentRows[selectedIdx].scrollIntoView({block:'nearest'});
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    selectedIdx = (selectedIdx - 1 + currentRows.length) % currentRows.length;
    updateSearchResultHighlight();
    currentRows[selectedIdx].scrollIntoView({block:'nearest'});
  } else if (e.key === 'Enter') {
    e.preventDefault();
    if (selectedIdx >= 0) {
      $(currentRows[selectedIdx]).trigger('click');
      $('#search-result-box').hide();
    }
  }
});
// Reset highlight on new search result
function resetSearchResultHighlight() {
  selectedIdx = -1;
  currentRows = $('#search-result-box tr.pilih-produk');
  updateSearchResultHighlight();
}
// Call reset after search result is shown
let oldShow = $.fn.show;
$.fn.show = function() {
  let result = oldShow.apply(this, arguments);
  if (this.attr('id') === 'search-result-box') {
    setTimeout(resetSearchResultHighlight, 10);
  }
  return result;
};
$('#search-result-box').on('click', '.pilih-produk', function() {
    let produk = {
        sku: $(this).data('sku'),
        barcode: $(this).data('barcode'),
        nama: $(this).data('nama'),
        variant: $(this).data('variant'),
        brand: $(this).data('brand')
    };
    // Fetch stok
    $.getJSON('/inventory/data/', {columns: JSON.stringify([{search:{value:produk.sku}}])}, function(resp) {
        let stok = 0;
        if (resp.data && resp.data.length > 0) {
            stok = resp.data[0][5] || 0;
        }
        tambahAtauUpdateProduk(produk, stok);
        $('#produk_search').val('');
        $('#search-result-box').hide();
        $('#produk_search').focus();
    });
});

// Hide search result box when clicking outside
$(document).on('click', function(e) {
    if (!$(e.target).closest('#search-result-box, #produk_search, #produk_search_btn').length) {
        $('#search-result-box').hide();
    }
});

// Hapus produk dari tabel
$('#produk-table').off('click', '.hapus-row').on('click', '.hapus-row', function() {
  $(this).closest('tr').remove();
});

// Customer modal logic
$('#pilih_customer_btn').on('click', function() {
    $('#customerModal').modal('show');
    loadCustomerList('');
});
$('#search_customer').on('input', function() {
    loadCustomerList($(this).val());
});
$('#addCustomerLink').on('click', function(e) {
    e.preventDefault();
    $('#customerModal').modal('hide');
    $('#addCustomerModal').modal('show');
});
$('#saveCustomerBtn').on('click', function() {
    let nama = $('#new_nama_customer').val().trim();
    if (!nama) { alert('Nama customer wajib diisi!'); return; }
    $.post('/orders/add_customer/', {
        nama_customer: nama,
        alamat_cust: $('#new_alamat_cust').val(),
        kota: $('#new_kota').val(),
        kode_pos: $('#new_kode_pos').val(),
        level: $('#new_level').val(),
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
    }, function(resp) {
        $('#addCustomerModal').modal('hide');
        $('#nama_customer').val(resp.nama_customer);
    });
});
function loadCustomerList(keyword) {
    $.getJSON('/orders/search_customer/', {q: keyword}, function(list) {
        let html = '';
        if (list.length === 0) html = '<div class="text-danger">Tidak ada customer ditemukan</div>';
        list.forEach(function(cust) {
            html += `<div class='list-group-item list-group-item-action pilih-cust' style='cursor:pointer;' data-nama='${cust.nama_customer}'>
                <b>${cust.nama_customer}</b><br><small>${cust.alamat_cust||''} ${cust.kota||''} ${cust.kode_pos||''} (${cust.level})</small>
            </div>`;
        });
        $('#customer-list').html(html);
    });
}
$('#customer-list').on('click', '.pilih-cust', function() {
    $('#nama_customer').val($(this).data('nama'));
    $('#customerModal').modal('hide');
});


</script>
{% endblock %}
