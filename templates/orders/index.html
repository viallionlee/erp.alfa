{% extends 'base.html' %}
{% block title %}Daftar Orders{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
<style>
    #ordersTable {
        width: 200%;
        max-width: 200vw;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex align-items-center mb-4">
    <h2 class="flex-grow-1 text-center mb-0">Daftar Orders</h2>
    <a href="/fullfilment/generatebatch/" class="btn btn-primary ms-3 d-flex align-items-center" style="font-weight:bold;">
        GENERATE BATCH <i class="bi bi-arrow-right-circle-fill ms-2"></i>
    </a>
</div>
<div class="d-flex justify-content-center justify-content-md-between align-items-center mb-4 gap-2 flex-wrap">
    <span class="badge bg-primary fs-5 order-0" style="min-width:160px;">Total order = {{ total_order }}</span>
    <span class="badge bg-danger fs-5 order-0" style="min-width:180px;">
      SKU Not Found = {{ sku_not_found_count }}
      {% if sku_not_found_count > 0 %}
        <a href="#" id="showSkuNotFound" class="ms-2 text-white text-decoration-underline" style="cursor:pointer;">detail</a>
      {% endif %}
    </span>
    <div class="d-flex gap-2 order-1 justify-content-center flex-wrap">
        <a href="{% url 'orders_list' %}" class="btn btn-success shadow-sm">Order List</a>
        <div class="dropdown">
            <button class="btn btn-success dropdown-toggle" type="button" id="downloadDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                Download Orders
            </button>
            <ul class="dropdown-menu" aria-labelledby="downloadDropdown">
                <li><a class="dropdown-item" href="/orders/download-orders/?limit=1000">Download 1000 Terbaru</a></li>
                <li><a class="dropdown-item" href="/orders/download-orders/?limit=5000">Download 5000 Terbaru</a></li>
                <li><a class="dropdown-item" href="/orders/download-orders/?limit=10000">Download 10000 Terbaru</a></li>
            </ul>
        </div>
        <button id="importBtn" class="btn btn-secondary shadow-sm">Import</button>
        <a href="{% url 'orderimport_history' %}" class="btn btn-info shadow-sm">History</a>
        <form method="post" action="/orders/extract-bundling/" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger shadow-sm">Extract Bundling</button>
        </form>
    </div>
</div>

<div style="padding:24px; border:1px solid #ddd; border-radius:12px; background:#fff; max-width: 2000px; margin:0 auto;">

<div class="table-responsive">
  <table id="ordersTable" class="display">
            <thead>
                <tr>
                    <th>Tanggal Pembuatan</th>
                    <th>Status</th>
                    <th>Jenis Pesanan</th>
                    <th>Channel</th>
                    <th>Nama Toko</th>
                    <th>ID Pesanan</th>
                    <th>SKU</th>
                    <th style="width:220px;">Nama Produk</th>
                    <th>Variant Produk</th>
                    <th>Brand</th>
                    <th>Product ID</th>
                    <th>Jumlah</th>
                    <th>Harga Promosi</th>
                    <th>Catatan Pembeli</th>
                    <th>Kurir</th>
                    <th>AWB/No. Tracking</th>
                    <th>Metode Pengiriman</th>
                    <th>Kirim Sebelum</th>
                    <th>Order Type</th>
                    <th>Nama Batch</th>
                    <th>Jumlah Ambil</th>
                    <th>Status Ambil</th>
                    <th>Status Order</th>
                    <th>Status Cancel</th>
                    <th>Status Retur</th>
                    <th>Status Bundle</th>
                </tr>
            </thead>
            <tbody>
                {% for row in data %}
                <tr>
                    {% for col in row %}
                    <td>{{ col }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Import Modal -->
<div id="importModal" class="modal fade" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="importForm" enctype="multipart/form-data" method="post">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="importModalLabel">Import Orders</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="fileInput" class="form-label">Pilih File Excel</label>
            <input type="file" id="fileInput" name="file" accept=".xls,.xlsx" class="form-control" required>
          </div>
          <div id="importLoading" class="d-none">
            <div class="progress">
              <div id="importProgressBar" class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="submit" class="btn btn-primary">Upload</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal SKU Not Found -->
<div class="modal fade" id="skuNotFoundModal" tabindex="-1" aria-labelledby="skuNotFoundModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="skuNotFoundModalLabel">SKU Not Found List</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul style="word-break:break-all;">
          {% for sku in sku_not_found_list %}
            <li>{{ sku }}</li>
          {% empty %}
            <li>Tidak ada SKU Not Found</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_script %}
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
$(document).ready(function() {
    // Inisialisasi DataTables1
    $('#ordersTable').DataTable({
        pageLength: 100,
        order: [[0, 'desc']],
        searching: true, // hilangkan search box
        info: true,      // hilangkan info jumlah data
        lengthChange: false, // hilangkan dropdown jumlah baris
        paging: false,    // hilangkan pagination (jika ingin tampil semua)
        // dom: 't' // hanya tampil tabel saja, tanpa elemen lain
    });

    // Tampilkan modal import
    $('#importBtn').on('click', function() {
        var modal = new bootstrap.Modal(document.getElementById('importModal'));
        modal.show();
    });

    // Handle submit import
    $('#importForm').on('submit', function(e) {
        e.preventDefault();
        var formData = new FormData(this);
        $('#importLoading').removeClass('d-none');
        $('#importProgressBar').css('width', '0%').text('0%');
        var importInterval = null;

        $.ajax({
            url: '/orders/import/',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            xhr: function() {
                var xhr = new XMLHttpRequest();
                xhr.upload.addEventListener('progress', function(evt) {
                    if (evt.lengthComputable) {
                        var percent = Math.round(evt.loaded / evt.total * 100);
                        $('#importProgressBar').css('width', percent + '%').text(percent + '%');
                    }
                });
                return xhr;
            },
            success: function() {
                $('#importProgressBar').css('width', '100%').text('100%');
                clearInterval(importInterval);
                $('#importLoading').addClass('d-none');
                bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
                Swal.fire({ icon: 'success', title: 'Import berhasil', timer: 1500, showConfirmButton: false })
                  .then(() => location.reload());
            },
            error: function() {
                $('#importLoading').addClass('d-none');
                Swal.fire({ icon: 'error', title: 'Import gagal', confirmButtonText: 'OK' });
            }
        });
    });

    // Notifikasi setelah extract-bundling
    const bundlingForm = $('form[action="/orders/extract-bundling/"]');
    bundlingForm.on('submit', function(e) {
        e.preventDefault();
        const btn = bundlingForm.find('button[type="submit"]');
        const txt = btn.html();
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Memproses...');
        fetch('/orders/extract-bundling/', {
            method: 'POST',
            headers: { 'X-CSRFToken': bundlingForm.find('[name=csrfmiddlewaretoken]').val() }
        })
        .then(async res => {
            btn.prop('disabled', false).html(txt);
            let data = {};
            try { data = await res.json(); } catch {}
            if (res.ok && data.success) {
                let html = `<b>${data.extracted_count}</b> SKU yang berhasil diextract!`;
                if (data.failed && data.failed.length > 0) {
                    html += `<br><br><b>SKU Not Found:</b><br><code style='word-break:break-all;'>${data.failed.join(', ')}</code>`;
                }
                Swal.fire({
                    icon: 'success',
                    title: 'Extract Bundling Berhasil',
                    html: html,
                    showConfirmButton: true
                }).then(() => location.reload());
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Extract Bundling Gagal',
                    text: data.error || 'Terjadi kesalahan',
                    confirmButtonText: 'OK'
                });
            }
        })
        .catch(() => {
            btn.prop('disabled', false).html(txt);
            Swal.fire({ icon: 'error', title: 'Extract Bundling gagal', confirmButtonText: 'OK' });
        });
    });

    // Modal detail SKU Not Found
    $('#showSkuNotFound').on('click', function(e) {
        e.preventDefault();
        var modal = new bootstrap.Modal(document.getElementById('skuNotFoundModal'));
        modal.show();
    });
});
</script>
{% endblock %}
