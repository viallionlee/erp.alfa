{% extends 'base.html' %}
{% block title %}Daftar Purchase{% endblock %}
{% block content %}
<script>
    // Pass permissions to JavaScript
    window.PERMISSIONS = {
        finance: {% if perms.purchasing.purchase_finance %}true{% else %}false{% endif %},
        warehouse: {% if perms.purchasing.purchase_warehouse %}true{% else %}false{% endif %}
    };
</script>
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0"><i class="bi bi-cart-check"></i> Daftar Purchase</h2>
    <div class="d-flex gap-2">
        {% if perms.purchasing.purchase_warehouse %}
        <a href="{% url 'purchasing:purchase_create' %}" class="btn btn-success"><i class="bi bi-plus-circle"></i> Buat Purchase</a>
        {% endif %}
        <a href="{% url 'purchasing:purchase_report' %}" class="btn btn-info"><i class="bi bi-file-earmark-bar-graph"></i> Report</a>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row g-2 mb-4">
    <div class="col-6 col-md-3 col-lg">
        <div class="card text-white bg-primary h-100">
            <div class="card-body p-2">
                <h6 class="card-title mb-1" style="font-size: 0.75rem;">Total Purchase</h6>
                <h4 class="mb-0" id="total-purchases" style="font-size: 1.5rem;">0</h4>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3 col-lg">
        <div class="card text-white bg-dark h-100">
            <div class="card-body p-2">
                <h6 class="card-title mb-1" style="font-size: 0.75rem;">Draft</h6>
                <h4 class="mb-0" id="draft-purchases" style="font-size: 1.5rem;">0</h4>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3 col-lg">
        <div class="card text-white bg-warning h-100">
            <div class="card-body p-2">
                <h6 class="card-title mb-1" style="font-size: 0.75rem;">Pending</h6>
                <h4 class="mb-0" id="pending-purchases" style="font-size: 1.5rem;">0</h4>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3 col-lg">
        <div class="card text-white bg-success h-100">
            <div class="card-body p-2">
                <h6 class="card-title mb-1" style="font-size: 0.75rem;">Received</h6>
                <h4 class="mb-0" id="received-purchases" style="font-size: 1.5rem;">0</h4>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3 col-lg">
        <div class="card text-white bg-info h-100">
            <div class="card-body p-2">
                <h6 class="card-title mb-1" style="font-size: 0.75rem;">Verified</h6>
                <h4 class="mb-0" id="verified-purchases" style="font-size: 1.5rem;">0</h4>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3 col-lg">
        <div class="card text-white bg-danger h-100">
            <div class="card-body p-2">
                <h6 class="card-title mb-1" style="font-size: 0.75rem;">Cancelled</h6>
                <h4 class="mb-0" id="cancelled-purchases" style="font-size: 1.5rem;">0</h4>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3 col-lg">
        <div class="card text-white h-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="card-body p-2">
                <h6 class="card-title mb-1" style="font-size: 0.75rem;">Total Amount</h6>
                <h4 class="mb-0" id="total-amount" style="font-size: 1.3rem;">Rp 0</h4>
            </div>
        </div>
    </div>
</div>

<!-- Filter -->
<div class="row g-2 mb-3">
    <div class="col-md-2">
        <input type="text" id="filter-purchase-number" class="form-control form-control-sm" placeholder="Cari Nomor Purchase">
    </div>
    <div class="col-md-2">
        <input type="date" id="filter-date-from" class="form-control form-control-sm" placeholder="Dari Tanggal">
    </div>
    <div class="col-md-2">
        <input type="date" id="filter-date-to" class="form-control form-control-sm" placeholder="Sampai Tanggal">
    </div>
    <div class="col-md-2">
        <select id="filter-status" class="form-select form-select-sm">
            <option value="">Semua Status</option>
            <option value="draft">Draft</option>
            <option value="pending">Pending</option>
            <option value="received">Received</option>
            <option value="verified">Verified</option>
            <option value="cancelled">Cancelled</option>
        </select>
    </div>
    <div class="col-md-2">
        <select id="filter-supplier" class="form-select form-select-sm">
            <option value="">Semua Supplier</option>
        </select>
    </div>
    <div class="col-md-2">
        <button class="btn btn-sm btn-primary" id="btn-filter">
            <i class="bi bi-search"></i> Filter
        </button>
        <button class="btn btn-sm btn-secondary" id="btn-reset">
            <i class="bi bi-x-circle"></i> Reset
        </button>
    </div>
</div>

<div class="card shadow-lg mb-4 border-0">
    <div class="card-body">
        <div class="table-responsive">
        <table id="purchase-table" class="table table-hover table-bordered align-middle w-100">
            <thead class="table-primary">
                <tr>
                    <th>ID</th>
                    <th>Nomor Purchase</th>
                    <th>Tanggal</th>
                    <th>Supplier</th>
                    <th>PO Reference</th>
                    <th>Status</th>
                    <th>Total Amount</th>
                    <th>Created By</th>
                    <th>Update</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        </div>
        
        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="d-flex align-items-center gap-3">
                <span id="total-count">Total: 0 records</span>
                <div class="d-flex align-items-center gap-2">
                    <label for="page-size-select" class="mb-0">Show:</label>
                    <select id="page-size-select" class="form-select form-select-sm" style="width:auto;">
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
            <nav>
                <ul class="pagination mb-0" id="pagination"></ul>
            </nav>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<style>
    .aksi-btn-group { 
        display: flex; 
        gap: 0.25rem; 
        flex-wrap: wrap;
        justify-content: center;
    }
    .aksi-btn-group .btn {
        white-space: nowrap;
    }
    #purchase-table th, #purchase-table td {
        font-size: 0.95rem;
        vertical-align: middle;
    }
    .dropdown-toggle::after {
        display: none;
    }
    .dropdown-menu {
        min-width: 150px;
    }
    
    /* Make date input clickable */
    input[type="date"] {
        cursor: pointer;
        position: relative;
    }
    
    /* Remove default date picker icon on some browsers */
    input[type="date"]::-webkit-calendar-picker-indicator {
        cursor: pointer;
        opacity: 1;
    }
    
    /* Ensure the entire input area is clickable */
    input[type="date"]::-webkit-inner-spin-button,
    input[type="date"]::-webkit-clear-button {
        cursor: pointer;
    }
</style>

<script>
let currentPage = 1;
let totalPages = 1;
let totalCount = 0;
let pageSize = 25;

$(document).ready(function() {
    loadSuppliers();
    loadData();
    
    // Page size selector
    $('#page-size-select').on('change', function() {
        pageSize = parseInt($(this).val());
        currentPage = 1; // Reset to first page
        loadData();
    });
    
    // Auto-filter on input change (with debounce for text inputs)
    let filterTimeout;
    $('#filter-purchase-number').on('input', function() {
        clearTimeout(filterTimeout);
        filterTimeout = setTimeout(function() {
            currentPage = 1;
            loadData();
        }, 500); // Wait 500ms after user stops typing
    });
    
    // Auto-filter on date/select change (immediate)
    $('#filter-date-from, #filter-date-to, #filter-status, #filter-supplier').on('change', function() {
        currentPage = 1;
        loadData();
    });
    
    // Filter button (kept for manual trigger if needed)
    $('#btn-filter').on('click', function() {
        currentPage = 1;
        loadData();
    });
    
    // Reset button
    $('#btn-reset').on('click', function() {
        $('#filter-purchase-number').val('');
        $('#filter-date-from').val('');
        $('#filter-date-to').val('');
        $('#filter-status').val('');
        $('#filter-supplier').val('');
        currentPage = 1;
        loadData();
    });
});

function loadSuppliers() {
    // Load suppliers from purchase list API
    $.ajax({
        url: '{% url "purchasing:purchase_list_api" %}?page=1&page_size=1000',
        type: 'GET',
        success: function(response) {
            if (response.success) {
                const select = $('#filter-supplier');
                const suppliers = new Set(); // Use Set to avoid duplicates
                
                // Extract unique suppliers from purchase data
                response.data.forEach(function(purchase) {
                    if (purchase.supplier && purchase.supplier !== '-') {
                        suppliers.add(purchase.supplier);
                    }
                });
                
                // Sort and add to dropdown
                Array.from(suppliers).sort().forEach(function(supplier) {
                    select.append('<option value="' + supplier + '">' + supplier + '</option>');
                });
            }
        },
        error: function(xhr) {
            console.error('Error loading suppliers:', xhr);
        }
    });
}

function loadData() {
    const purchaseNumber = $('#filter-purchase-number').val();
    const status = $('#filter-status').val();
    const supplier = $('#filter-supplier').val();
    const dateFrom = $('#filter-date-from').val();
    const dateTo = $('#filter-date-to').val();
    
    let url = '{% url "purchasing:purchase_list_api" %}?page=' + currentPage + '&page_size=' + pageSize;
    
    if (purchaseNumber) url += '&purchase_number=' + purchaseNumber;
    if (status) url += '&status=' + status;
    if (supplier) url += '&supplier=' + supplier;
    if (dateFrom) url += '&date_from=' + dateFrom;
    if (dateTo) url += '&date_to=' + dateTo;
    
    $.ajax({
        url: url,
        type: 'GET',
        success: function(response) {
            if (response.success) {
                renderTable(response.data);
                renderPagination(response.pagination);
                updateStatistics(response.stats);
                totalCount = response.pagination.total_count;
                $('#total-count').text('Total: ' + totalCount + ' records');
            }
        },
        error: function(xhr) {
            console.error('Error loading data:', xhr);
            alert('Error loading data');
        }
    });
}

function renderTable(data) {
    let html = '';
    
    data.forEach(function(purchase) {
        // Status badge
        let badgeClass = 'secondary';
        if (purchase.status_value === 'draft') badgeClass = 'dark';
        if (purchase.status_value === 'pending') badgeClass = 'warning';
        if (purchase.status_value === 'received') badgeClass = 'success';
        if (purchase.status_value === 'verified') badgeClass = 'info';
        if (purchase.status_value === 'cancelled') badgeClass = 'danger';
        
        // Update button - Combined Verify and Receive
        let updateBtn = '<span class="text-muted">-</span>';
        if (purchase.status_value === 'received' && window.PERMISSIONS.finance) {
            updateBtn = '<a href="/purchaseorder/purchase/' + purchase.id + '/verify/" class="btn btn-sm btn-info">Verify</a>';
        } else if (purchase.status_value === 'pending' && window.PERMISSIONS.warehouse) {
            updateBtn = '<a href="/purchaseorder/purchase/' + purchase.id + '/" class="btn btn-sm btn-success">Receive</a>';
        }
        
        // Action buttons - Dropdown with Detail, Edit, Hapus
        let actions = '';
        let hasActions = false;
        
        // Build dropdown items
        let dropdownItems = '';
        
        // Detail button (always available)
        dropdownItems += '<li><a class="dropdown-item" href="/purchaseorder/purchase/' + purchase.id + '/"><i class="bi bi-eye"></i> Detail</a></li>';
        hasActions = true;
        
        // Edit button (warehouse permission)
        if ((purchase.status_value === 'draft' || purchase.status_value === 'pending') && window.PERMISSIONS.warehouse) {
            dropdownItems += '<li><a class="dropdown-item" href="/purchaseorder/purchase/' + purchase.id + '/edit/"><i class="bi bi-pencil"></i> Edit</a></li>';
            hasActions = true;
        }
        
        // Hapus button (warehouse permission)
        if ((purchase.status_value === 'draft' || purchase.status_value === 'pending') && window.PERMISSIONS.warehouse) {
            dropdownItems += '<li><hr class="dropdown-divider"></li>';
            dropdownItems += '<li><button class="dropdown-item text-danger btn-delete-purchase" data-purchase-id="' + purchase.id + '" data-purchase-nomor="' + purchase.nomor_purchase + '" data-purchase-supplier="' + purchase.supplier + '" data-purchase-total="' + purchase.total_amount_formatted + '"><i class="bi bi-trash"></i> Hapus</button></li>';
            hasActions = true;
        }
        
        // Build dropdown
        if (hasActions) {
            actions = '<div class="dropdown">' +
                '<button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">' +
                '<i class="bi bi-three-dots-vertical"></i>' +
                '</button>' +
                '<ul class="dropdown-menu dropdown-menu-end">' +
                dropdownItems +
                '</ul>' +
                '</div>';
        } else {
            actions = '<span class="text-muted">-</span>';
        }
        
        html += '<tr>';
        html += '<td>' + purchase.id + '</td>';
        html += '<td>' + (purchase.nomor_purchase || '<span class="text-muted fst-italic">DRAFT</span>') + '</td>';
        html += '<td>' + purchase.tanggal_purchase + '</td>';
        html += '<td>' + purchase.supplier + '</td>';
        html += '<td>' + purchase.nomor_po + '</td>';
        html += '<td><span class="badge bg-' + badgeClass + '">' + purchase.status + '</span></td>';
        html += '<td>Rp ' + purchase.total_amount_formatted + '</td>';
        html += '<td>' + purchase.created_by + '</td>';
        html += '<td class="text-center">' + updateBtn + '</td>';
        html += '<td class="text-center">' + actions + '</td>';
        html += '</tr>';
    });
    
    $('#purchase-table tbody').html(html);
}

function renderPagination(pagination) {
    totalPages = pagination.total_pages;
    currentPage = pagination.page;
    
    let html = '';
    
    // Previous button
    html += '<li class="page-item ' + (currentPage === 1 ? 'disabled' : '') + '">';
    html += '<a class="page-link" href="#" onclick="changePage(' + (currentPage - 1) + '); return false;">Previous</a>';
    html += '</li>';
    
    // Page numbers
    let startPage = Math.max(1, currentPage - 2);
    let endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        html += '<li class="page-item ' + (i === currentPage ? 'active' : '') + '">';
        html += '<a class="page-link" href="#" onclick="changePage(' + i + '); return false;">' + i + '</a>';
        html += '</li>';
    }
    
    // Next button
    html += '<li class="page-item ' + (currentPage === totalPages ? 'disabled' : '') + '">';
    html += '<a class="page-link" href="#" onclick="changePage(' + (currentPage + 1) + '); return false;">Next</a>';
    html += '</li>';
    
    $('#pagination').html(html);
}

function updateStatistics(stats) {
    // Total Purchase = All purchases (include draft)
    $('#total-purchases').text(stats.total_purchases);
    $('#draft-purchases').text(stats.draft_purchases);
    $('#pending-purchases').text(stats.pending_purchases);
    $('#received-purchases').text(stats.received_purchases);
    $('#verified-purchases').text(stats.verified_purchases);
    $('#cancelled-purchases').text(stats.cancelled_purchases);
    $('#total-amount').text('Rp ' + stats.total_amount.toLocaleString('id-ID'));
}

function changePage(page) {
    currentPage = page;
    loadData();
    $('html, body').animate({ scrollTop: 0 }, 300);
}

// Handle Delete Purchase button click
$(document).on('click', '.btn-delete-purchase', function(e) {
    e.preventDefault();
    var purchaseId = $(this).data('purchase-id');
    var purchaseNomor = $(this).data('purchase-nomor');
    var purchaseSupplier = $(this).data('purchase-supplier');
    var purchaseTotal = $(this).data('purchase-total');
    
    // Update modal content
    $('#delete-purchase-nomor').text(purchaseNomor);
    $('#delete-purchase-supplier').text(purchaseSupplier);
    $('#delete-purchase-total').text(purchaseTotal);
    $('#delete-purchase-form').attr('action', '/purchaseorder/purchase/' + purchaseId + '/cancel/');
    
    // Show modal
    var modal = new bootstrap.Modal(document.getElementById('deletePurchaseModal'));
    modal.show();
});
</script>

<!-- Modal Confirm Delete Purchase -->
<div class="modal fade" id="deletePurchaseModal" tabindex="-1" aria-labelledby="deletePurchaseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deletePurchaseModalLabel">
                    <i class="bi bi-exclamation-triangle"></i> Konfirmasi Hapus Purchase
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <h6><i class="bi bi-info-circle"></i> Apakah Anda yakin ingin menghapus Purchase ini?</h6>
                    <p class="mb-0">Purchase yang dihapus tidak dapat dikembalikan lagi.</p>
                </div>
                <table class="table table-sm">
                    <tr>
                        <th width="40%">Nomor Purchase:</th>
                        <td id="delete-purchase-nomor"></td>
                    </tr>
                    <tr>
                        <th>Supplier:</th>
                        <td id="delete-purchase-supplier"></td>
                    </tr>
                    <tr>
                        <th>Total Amount:</th>
                        <td id="delete-purchase-total"></td>
                    </tr>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x"></i> Batal
                </button>
                <form id="delete-purchase-form" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Ya, Hapus Purchase
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

