{% extends 'base.html' %}
{% load l10n %}
{% block title %}Purchase Verification{% endblock %}
{% block content %}
<style>
    .modern-form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 4px;
    }
    .modern-form-row {
        display: flex;
        gap: 1rem;
        align-items: flex-end;
        margin-bottom: 1.2rem;
        flex-wrap: wrap;
    }
    .modern-form-row > .form-group {
        flex: 1 1 0;
        min-width: 180px;
    }
    .modern-form-row .input-group {
        width: 100%;
    }
    .modern-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.07);
        padding: 2rem 2.5rem 1.5rem 2.5rem;
        max-width: 1200px;
        margin: 0 auto;
    }
    #search-result-box {
        min-width: 320px;
        font-size: 0.8rem;
        min-height: 600px;
        max-height: 600px;
        overflow-y: auto;
    }
    #search-result-box tbody tr {
        height: 62px;
    }
    #search-result-box tbody tr td {
        vertical-align: middle;
        padding: 8px;
    }
    #search-result-box .product-photo-zoom img {
        width: 60px !important;
        height: 60px !important;
        max-width: 60px !important;
        max-height: 60px !important;
        object-fit: cover;
    }
    .product-photo-zoom {
        position: relative;
        cursor: pointer;
        display: inline-block;
    }
    .product-photo-zoom .magnifier-icon {
        position: absolute;
        top: 4px;
        right: 4px;
        background: rgba(0,0,0,0.7);
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.2s;
    }
    .product-photo-zoom:hover .magnifier-icon {
        opacity: 1;
    }
    .product-photo-zoom img {
        border: none !important;
        padding: 0 !important;
        background: none !important;
    }
    .table-active { background-color: #e3f2fd !important; }
    #search-result-box tbody tr {
        height: 90px;
        min-height: 90px;
    }
    #search-result-box .product-photo-zoom img {
        width: 90px !important;
        height: 90px !important;
    }
    /* Kode Produk - 2 rows */
    #search-result-box td:nth-child(2) {
        vertical-align: middle;
        padding: 8px;
        text-align: left;
    }
    #search-result-box td:nth-child(2) .sku-row {
        font-weight: 600;
        font-size: 0.85rem;
        color: #0d6efd;
        text-align: left;
    }
    #search-result-box td:nth-child(2) .barcode-row {
        font-size: 0.75rem;
        color: #6c757d;
        text-align: left;
    }
    /* Detail Produk - 2 rows */
    #search-result-box td:nth-child(3) {
        vertical-align: middle;
        padding: 8px;
        text-align: left;
    }
    #search-result-box td:nth-child(3) .nama-row {
        font-weight: 500;
        font-size: 0.85rem;
        margin-bottom: 4px;
        word-wrap: break-word;
        text-align: left;
    }
    #search-result-box td:nth-child(3) .variant-brand-row {
        font-size: 0.75rem;
        color: #6c757d;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    #search-result-box td:nth-child(3) .variant-text {
        text-align: left;
    }
    #search-result-box td:nth-child(3) .brand-text {
        font-weight: 500;
        color: #198754;
        margin-left: 8px;
        text-align: right;
    }
    /* Stock & Harga Beli - Center aligned */
    #search-result-box td:nth-child(4),
    #search-result-box td:nth-child(5) {
        vertical-align: middle;
        text-align: center;
    }
    /* Main table styling */
    #produk-table tbody tr {
        height: 90px;
        min-height: 90px;
    }
    #produk-table .product-photo-zoom img {
        width: 90px !important;
        height: 90px !important;
    }
    #produk-table .sku-row {
        font-weight: 600;
        font-size: 0.9rem;
        color: #0d6efd;
        text-align: left;
    }
    #produk-table .barcode-row {
        font-size: 0.8rem;
        color: #6c757d;
        text-align: left;
    }
    #produk-table .nama-row {
        font-weight: 500;
        font-size: 0.9rem;
        margin-bottom: 4px;
        text-align: left;
    }
    #produk-table .variant-brand-row {
        font-size: 0.8rem;
        color: #6c757d;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    #produk-table .variant-text {
        text-align: left;
    }
    #produk-table .brand-text {
        font-weight: 500;
        color: #198754;
        margin-left: 8px;
        text-align: right;
    }
    @media (max-width: 600px) {
        .modern-card { padding: 1rem; }
        .modern-form-row { flex-direction: column; gap: 0.5rem; }
    }
</style>
<div class="container mt-4">
    <div class="alert alert-primary text-center mb-4" role="alert" style="max-width: 1200px; margin: auto; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <h2 class="mb-2"><i class="bi bi-check2-circle"></i> PURCHASE VERIFICATION</h2>
        <p class="mb-0">Verifikasi harga beli dengan invoice fisik sebelum melanjutkan ke payment</p>
    </div>
    
    <div class="card shadow-sm" style="max-width: 1200px; margin: auto;">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-check2-circle"></i> Verification Purchase: {{ purchase.nomor_purchase }}
            </h5>
        </div>
        <div class="card-body" style="padding: 2rem 2.5rem 1.5rem 2.5rem;">
            <form method="post" id="add-purchase-form">
                {% csrf_token %}
                <input type="hidden" name="purchase_id" value="{{ purchase.id }}">
                <input type="hidden" name="supplier_id" id="supplier_id">
                <input type="hidden" name="po_id" id="po_id" value="{% if purchase.po %}{{ purchase.po.id }}{% endif %}">
                
                <!-- Panel: Informasi Tagihan & Pajak (collapsible, compact) -->
                <div class="card border-primary mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center"
                         data-bs-toggle="collapse" data-bs-target="#panel-info-billing" aria-expanded="true" style="cursor:pointer;">
                        <div class="fw-bold"><i class="bi bi-receipt"></i> Informasi Tagihan & Pajak</div>
                        <i class="bi bi-chevron-down"></i>
                    </div>
                    <div id="panel-info-billing" class="collapse">
                        <div class="card-body">
                            <div class="row g-3">
                                <!-- Row 1: Tanggal Purchase - Supplier - Nomor PO -->
                                <div class="col-md-4">
                                    <label class="modern-form-label">Tanggal Purchase</label>
                                    <input type="date" name="tanggal_purchase" id="tanggal_purchase" class="form-control" required readonly>
                                </div>
                                <div class="col-md-4">
                                    <label class="modern-form-label">Supplier</label>
                                    <input type="text" id="nama_supplier" class="form-control" required readonly value="{{ purchase.supplier.nama_supplier|default:'' }}">
                                </div>
                                <div class="col-md-4" id="po_wrapper" {% if not purchase.po %}style="display:none;"{% endif %}>
                                    <label class="modern-form-label" id="po_label">Nomor PO</label>
                                    <input type="text" id="nomor_po" class="form-control" value="{{ purchase.po.nomor_po|default:'' }}" readonly>
                                </div>
                                <!-- Row 2: Catatan -->
                                <div class="col-12">
                                    <label class="modern-form-label" for="notes">Catatan</label>
                                    <textarea name="notes" id="notes" class="form-control" rows="1" placeholder="Catatan tambahan (opsional)">{{ notes }}</textarea>
                                </div>
                                <!-- Row 3: Tanggal Jatuh Tempo - Tipe Transaksi - Dapat Faktur Pajak -->
                                <div class="col-md-4">
                                    <label class="modern-form-label" for="due_date">Tanggal Jatuh Tempo <span style="color:red">*</span></label>
                                    <input type="date" id="due_date" name="due_date" class="form-control" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="modern-form-label" for="transaction_type">Tipe Transaksi <span style="color:red">*</span></label>
                                    <select id="transaction_type" name="transaction_type" class="form-select" required>
                                        <option value="">-- Pilih Tipe --</option>
                                        <option value="COD">COD (Cash on Delivery)</option>
                                        <option value="CREDIT">Credit</option>
                                        <option value="PREPAID">Prepaid</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="modern-form-label">Dapat Faktur Pajak? <span style="color:red">*</span></label>
                                    <div class="d-flex align-items-center" style="gap:18px;">
                                        <div class="form-check mb-0">
                                            <input class="form-check-input" type="checkbox" id="has_fp_yes" name="has_fp" value="Y">
                                            <label class="form-check-label" for="has_fp_yes">YA</label>
                                        </div>
                                        <div class="form-check mb-0">
                                            <input class="form-check-input" type="checkbox" id="has_fp_no" value="N">
                                            <label class="form-check-label" for="has_fp_no">TIDAK</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <input type="hidden" name="po_id" id="po_id" value="{% if po %}{{ po.id }}{% endif %}">
                <input type="hidden" name="supplier_id" id="supplier_id" value="{% if po %}{{ po.supplier.id }}{% endif %}">
                
                <!-- Row 2: Keterangan -->
                <div class="modern-form-row">
                    <div class="form-group" style="flex:2;">
                        <label class="modern-form-label" for="notes">Catatan</label>
                        <textarea name="notes" id="notes" class="form-control" rows="1" placeholder="Catatan tambahan (opsional)">{{ notes }}</textarea>
                    </div>
                </div>
                
                
                <!-- Produk Table -->
                <div class="table-responsive mt-3">
                    <div class="alert alert-warning mb-2 py-2" role="alert" style="font-size: 0.875rem;">
                        <i class="bi bi-info-circle"></i> <strong>Catatan:</strong> Qty tidak bisa diubah (ranah warehouse). Hanya <strong>Harga Beli</strong> dan <strong>Notes</strong> yang dapat disesuaikan.
                    </div>
                    <table class="table table-bordered align-middle" id="produk-table">
                        <thead class="table-light">
                            <tr>
                                <th style="width:120px; text-align:center;">Photo</th>
                                <th style="width:180px; text-align:center;">Kode Produk</th>
                                <th style="width:auto; text-align:center;">Detail Produk</th>
                                <th style="width:80px; text-align:center;">Stok</th>
                                <th style="width:80px; text-align:center; background: #dc3545; color: white; font-weight: bold;">Qty</th>
                                <th style="width:120px; text-align:center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: bold;">Harga Beli</th>
                                <th style="width:120px; text-align:right;">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in items %}
                            <tr data-sku="{{ item.product.sku }}">
                                <td style="vertical-align:middle; text-align:center;">
                                    {% if item.product.photo and item.product.photo.name %}
                                        <div class="product-photo-zoom" data-photo-url="{{ item.product.photo.url }}">
                                            <img src="{{ item.product.photo.url }}" alt="{{ item.product.nama_produk }}" style="width:90px;height:90px;object-fit:cover;border-radius:4px;">
                                            <div class="magnifier-icon">
                                                <i class="bi bi-zoom-in"></i>
                                            </div>
                                        </div>
                                    {% else %}
                                    <div class="bg-light d-flex align-items-center justify-content-center" style="width:90px;height:90px;border-radius:4px;"><i class="bi bi-file-image text-secondary" style="font-size:32px;"></i></div>
                                    {% endif %}
                                </td>
                                <td style="vertical-align:middle;">
                                    <input type="hidden" name="produk_sku[]" value="{{ item.product.sku }}">
                                    <div class="sku-row">{{ item.product.sku }}</div>
                                    <div class="barcode-row">{{ item.product.barcode|default:"-" }}</div>
                                </td>
                                <td style="vertical-align:middle;">
                                    <div class="nama-row">{{ item.product.nama_produk }}</div>
                                    <div class="variant-brand-row">
                                        <span class="variant-text">{{ item.product.variant_produk|default:"" }}</span>
                                        <span class="brand-text">{{ item.product.brand|default:"" }}</span>
                                    </div>
                                </td>
                                <td style="vertical-align:middle; text-align:center;">{% if item.product.stock %}{{ item.product.stock.quantity_ready_virtual|default:0 }}{% else %}0{% endif %}</td>
                                <td style="vertical-align:middle; text-align:center;">
                                    <span style="font-weight:bold; font-size:1.1rem;">{{ item.quantity }}</span>
                                    <input type="hidden" name="produk_qty[]" value="{% localize off %}{{ item.quantity }}{% endlocalize %}">
                                </td>
                                <td style="vertical-align:middle; text-align:center;">
                                    <input type="text" name="produk_harga_beli[]" class="form-control harga-input" data-harga="{% localize off %}{{ item.harga_beli }}{% endlocalize %}" value="" style="width:110px; text-align:right;">
                                </td>
                                <td class="subtotal-display" style="vertical-align:middle; text-align:right;" data-subtotal="{{ item.subtotal }}">Rp 0</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <th colspan="6" class="text-end">TOTAL:</th>
                                <th id="grand-total-display" class="text-end">0</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <!-- TOTAL Invoice di Kertas & Payment Info -->
                <div class="row mt-4 mb-3">
                    <div class="col-md-12">
                        <div class="card border-primary">
                            <div class="card-body">
                                <!-- Row 1: Total Invoice di Kertas -->
                <div class="row align-items-center mb-3">
                                    <div class="col-md-3">
                                        <label class="form-label fw-bold mb-0" for="total_invoice_kertas">
                                            TOTAL Invoice di Kertas <span style="color:red">*</span>:
                                        </label>
                                    </div>
                                    <div class="col-md-9">
                                        <div class="input-group">
                                            <input type="text" 
                                                   id="total_invoice_kertas" 
                                                   class="form-control form-control-lg text-end" 
                                                   placeholder="0"
                                                   inputmode="numeric"
                                                   autocomplete="off"
                                                   style="font-weight: bold; font-size: 1.1rem;">
                                            <button type="button" 
                                                    class="btn btn-success btn-lg" 
                                                    id="btn-confirm-invoice">
                                                <i class="bi bi-check-circle"></i> Confirm
                                            </button>
                                        </div>
                                        <div class="mt-2">
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-secondary" 
                                                    id="btn-ubah-invoice" 
                                                    style="display:none;">
                                                <i class="bi bi-pencil"></i> Ubah
                                            </button>
                                            <small class="text-muted ms-2" id="invoice-status-text">Masukkan total dari invoice fisik</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Row 2 removed: Due Date & Transaction Type now moved to top panel -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Validation Message -->
                <div id="total-validation-message" class="alert alert-danger d-none mb-3" role="alert">
                    <i class="bi bi-exclamation-triangle"></i> <strong>Perhatian!</strong> 
                    TOTAL Sistem (<span id="total-display-value">0</span>) tidak sama dengan TOTAL Invoice di Kertas 
                    (<span id="invoice-kertas-value">0</span>). Silakan klik tombol "Ubah" untuk memperbaiki harga beli atau invoice kertas.
                </div>
                
                <!-- Success Message -->
                <div id="total-success-message" class="alert alert-success d-none mb-3" role="alert">
                    <i class="bi bi-check-circle"></i> <strong>Validasi Berhasil!</strong> 
                    TOTAL Sistem (<span id="total-success-value">0</span>) sudah sesuai dengan TOTAL Invoice di Kertas 
                    (<span id="invoice-success-value">0</span>). Silakan klik tombol "VERIFIED" untuk melanjutkan.
                </div>
                
                <div class="mt-3 d-flex justify-content-between align-items-center">
                    <div class="small text-muted"><span style="color:red">*</span> wajib diisi</div>
                    <div class="text-center">
                        <button type="button" class="btn btn-primary px-4" id="btn-verify-purchase" disabled><i class="bi bi-check2-circle"></i> VERIFIED</button>
                        <span id="verify-progress" class="ms-2 text-success" style="font-weight:600;">(0/4)</span>
                    </div>
                    <div>
                        <a href="{% url 'purchasing:purchase_list' %}" class="btn btn-secondary ms-2">Batal</a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Verification Confirmation Modal -->
<div class="modal fade" id="verificationModal" tabindex="-1" aria-labelledby="verificationModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="verificationModalLabel">
          <i class="bi bi-check2-circle"></i> Konfirmasi Verifikasi Purchase
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i> <strong>Perhatian!</strong>
          <p class="mb-0 mt-2">Apakah invoice fisik sudah diverifikasi dan sesuai dengan data di sistem?</p>
        </div>
        <div class="mb-3">
          <strong>Purchase Number:</strong> {{ purchase.nomor_purchase }}<br>
          <strong>Supplier:</strong> {{ purchase.supplier.nama_supplier }}<br>
          <strong>Total Amount:</strong> Rp {{ purchase.total_amount|floatformat:0 }}
        </div>
        
        <div class="alert alert-warning">
          <i class="bi bi-exclamation-triangle"></i> Setelah di-verify, purchase akan otomatis masuk ke <strong>Purchase Payment</strong> dan <strong>Tax Invoice</strong>.
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="confirmVerification" required>
          <label class="form-check-label" for="confirmVerification">
            Saya sudah memverifikasi invoice fisik dan data sudah sesuai
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-primary" id="confirmVerifyBtn" disabled>
          <i class="bi bi-check2-circle"></i> Ya, VERIFIED
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Pilih Supplier -->
<div class="modal fade" id="supplierModal" tabindex="-1" aria-labelledby="supplierModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="supplierModalLabel">Pilih Supplier</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="search_supplier" class="form-control mb-2" placeholder="Cari nama/alamat supplier...">
        <div id="supplier-list" class="list-group" style="max-height:300px;overflow-y:auto;"></div>
        <div class="mt-2 text-end">
          <a href="#" id="addSupplierLink">+ Tambah Supplier Baru</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Zoom Photo -->
<div class="modal fade" id="zoomImageModal" tabindex="-1" aria-labelledby="zoomImageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="zoomImageModalLabel">Photo Produk</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="zoomImage" src="" alt="Product Photo" class="img-fluid" style="max-height: 70vh; border-radius: 8px;">
      </div>
    </div>
  </div>
</div>

<!-- Modal Cari PO -->
<div class="modal fade" id="cariPoModal" tabindex="-1" aria-labelledby="cariPoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cariPoModalLabel">Cari Purchase Order</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <div class="row g-2">
            <div class="col-md-4">
              <input type="text" id="search_po" class="form-control" placeholder="Cari Nomor PO / Supplier...">
            </div>
            <div class="col-md-2">
              <select id="filter_status" class="form-select">
                <option value="">Semua Status</option>
                <option value="draft">Draft</option>
                <option value="received">Received</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>
            <div class="col-md-2">
              <button class="btn btn-primary w-100" id="search_po_btn">
                <i class="bi bi-search"></i> Cari
              </button>
            </div>
          </div>
        </div>
        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
          <table class="table table-hover table-sm">
            <thead class="table-light sticky-top">
              <tr>
                <th>Nomor PO</th>
                <th>Tanggal</th>
                <th>Supplier</th>
                <th>Status</th>
                <th>Total Amount</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="po_list_tbody">
              <tr>
                <td colspan="6" class="text-center text-muted">Pilih supplier terlebih dahulu</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Tambah Supplier Baru -->
<div class="modal fade" id="addSupplierModal" tabindex="-1" aria-labelledby="addSupplierModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addSupplierModalLabel">Tambah Supplier Baru</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label>Nama Supplier</label>
          <input type="text" id="new_nama_supplier" class="form-control" required>
        </div>
        <div class="mb-2">
          <label>Alamat</label>
          <textarea id="new_alamat_supplier" class="form-control"></textarea>
        </div>
        <div class="mb-2">
          <label>Kota</label>
          <input type="text" id="new_kota_supplier" class="form-control">
        </div>
        <div class="text-end">
          <button type="button" class="btn btn-primary" id="saveSupplierBtn">Simpan</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
(function() {
    'use strict';
    
    // ==========================================
    // ANCHOR: Purchase Edit Module
    // ==========================================
    
    // Namespace untuk event
    const EVENT_NS = '.purchaseEdit';
    
    // Mode flags
    const IS_VER = {{ is_verification_mode|yesno:"true,false" }};
    const IS_RECEIVED = {% if purchase.status == 'received' %}true{% else %}false{% endif %};
    
    console.log('[PurchaseEdit] Mode:', {
        is_verification: IS_VER,
        is_received: IS_RECEIVED,
        status: '{{ purchase.status }}'
    });
    
    // ==========================================
    // APP OBJECT
    // ==========================================
    window.App = window.App || {};
    window.App.PurchaseEdit = {
        // Selectors (scoped to form)
        $form: $('#add-purchase-form'),
        $table: $('#produk-table'),
        
        // Formatter: 1.000.000 (tanpa desimal)
        formatHarga: function(n) {
            return new Intl.NumberFormat('id-ID', { maximumFractionDigits: 0 }).format(Number(n) || 0);
        },
        
        // Parse harga dari formatted string
        parseHarga: function(str) {
            return parseFloat(String(str).replace(/[^\d]/g, '')) || 0;
        },
        
        // Update subtotal untuk 1 row
        updateSubtotal: function($row) {
            // Get qty from hidden input (verification mode)
            const qty = parseFloat($row.find('input[name="produk_qty[]"]').val()) || 0;
            
            const hargaInput = $row.find('.harga-input').val();
            const harga = this.parseHarga(hargaInput);
            const subtotal = qty * harga;
            
            $row.find('.subtotal-display').html('Rp ' + this.formatHarga(subtotal));
            this.calculateGrandTotal();
        },
        
        // Calculate grand total
        calculateGrandTotal: function() {
            const self = this;
            let total = 0;
            
            this.$table.find('tbody tr').each(function() {
                // Get qty from hidden input (verification mode)
                const qty = parseFloat($(this).find('input[name="produk_qty[]"]').val()) || 0;
                
                const hargaInput = $(this).find('.harga-input').val();
                const harga = self.parseHarga(hargaInput);
                total += qty * harga;
            });
            
            $('#grand-total-display').html('Rp ' + this.formatHarga(total));
            
            // Validate total dengan invoice kertas
            self.validateTotal();
        },
        
        // Validate total dengan invoice kertas + due date + transaction type
        validateTotal: function() {
            const totalSistem = parseFloat($('#grand-total-display').text().replace(/[^\d]/g, '')) || 0;
            const totalKertas = parseFloat($('#total_invoice_kertas').val().replace(/[^\d]/g, '')) || 0;
            const isConfirmed = $('#total_invoice_kertas').prop('readonly');
            const dueDate = $('#due_date').val();
            const transactionType = $('#transaction_type').val();
            let fpYes = $('#has_fp_yes').is(':checked');
            let fpNo = $('#has_fp_no').is(':checked');

            // Progress counter (0/4) — update FIRST so it reflects partial progress
            let done = 0;
            if (isConfirmed && totalSistem > 0 && totalKertas > 0 && totalSistem === totalKertas) done++;
            if (dueDate) done++;
            if (transactionType) done++;
            if (fpYes || fpNo) done++;
            $('#verify-progress').text(`(${done}/4)`);
            
            console.log('[PurchaseVerify] validateTotal:', {
                totalSistem: totalSistem,
                totalKertas: totalKertas,
                isConfirmed: isConfirmed,
                dueDate: dueDate,
                transactionType: transactionType,
                match: totalSistem === totalKertas
            });
            
            // Update validation message
            $('#total-display-value').text('Rp ' + this.formatHarga(totalSistem));
            $('#invoice-kertas-value').text('Rp ' + this.formatHarga(totalKertas));
            $('#total-success-value').text('Rp ' + this.formatHarga(totalSistem));
            $('#invoice-success-value').text('Rp ' + this.formatHarga(totalKertas));
            
            // Check if due date is filled
            if (!dueDate) {
                console.log('[PurchaseVerify] Due date not filled, disabling button');
                $('#btn-verify-purchase').prop('disabled', true);
                $('#btn-verify-purchase').removeClass('btn-success').addClass('btn-primary');
                $('#total-validation-message').addClass('d-none');
                $('#total-success-message').addClass('d-none');
                return;
            }
            
            // Check if transaction type is selected
            if (!transactionType) {
                console.log('[PurchaseVerify] Transaction type not selected, disabling button');
                $('#btn-verify-purchase').prop('disabled', true);
                $('#btn-verify-purchase').removeClass('btn-success').addClass('btn-primary');
                $('#total-validation-message').addClass('d-none');
                $('#total-success-message').addClass('d-none');
                return;
            }

            // Check if tax invoice decision selected
            fpYes = $('#has_fp_yes').is(':checked');
            fpNo = $('#has_fp_no').is(':checked');
            if (!fpYes && !fpNo) {
                console.log('[PurchaseVerify] Tax invoice decision not selected, disabling button');
                $('#btn-verify-purchase').prop('disabled', true);
                $('#btn-verify-purchase').removeClass('btn-success').addClass('btn-primary');
                $('#total-validation-message').addClass('d-none');
                $('#total-success-message').addClass('d-none');
                return;
            }
            
            // Only validate if invoice is confirmed
            if (!isConfirmed) {
                console.log('[PurchaseVerify] Invoice not confirmed, disabling button');
                $('#btn-verify-purchase').prop('disabled', true);
                $('#btn-verify-purchase').removeClass('btn-success').addClass('btn-primary');
                $('#total-validation-message').addClass('d-none');
                $('#total-success-message').addClass('d-none');
                return;
            }
            
            // Enable/disable button based on match
            if (totalSistem > 0 && totalKertas > 0 && totalSistem === totalKertas) {
                console.log('[PurchaseVerify] All validations passed! Enabling button');
                $('#btn-verify-purchase').prop('disabled', false);
                $('#btn-verify-purchase').removeClass('btn-primary').addClass('btn-success');
                $('#total-validation-message').addClass('d-none');
                $('#total-success-message').removeClass('d-none');
            } else {
                console.log('[PurchaseVerify] Totals do not match! Disabling button');
                $('#btn-verify-purchase').prop('disabled', true);
                $('#btn-verify-purchase').removeClass('btn-success').addClass('btn-primary');
                $('#total-validation-message').removeClass('d-none');
                $('#total-success-message').addClass('d-none');
            }

            // Progress already updated above
        },
        
        // Prefill purchase data
        prefillData: function() {
            // Supplier
            $('#supplier_id').val('{{ purchase.supplier.id }}');
            $('#nama_supplier').val('{{ purchase.supplier.nama_supplier }}');
            $('input[name="supplier_id"]').val('{{ purchase.supplier.id }}');
            
            // Tanggal purchase
            {% if purchase.tanggal_purchase %}
            let tglStr = '{{ purchase.tanggal_purchase|date:"Y-m-d" }}';
            $('#tanggal_purchase').val(tglStr);
    {% endif %}
    
            // Notes
            $('#notes').val('{{ purchase.notes|default:"" }}');
            
            // PO reference
            {% if purchase.po %}
            $('#po_id').val('{{ purchase.po.id }}');
            $('#nomor_po').val('{{ purchase.po.nomor_po }}');
            $('#po_wrapper').show();
            $('#po_label').text('Nomor PO');
            {% endif %}
        },
        
        // Prefill harga_beli dari data-harga
        prefillHarga: function() {
            const self = this;
            $('.harga-input').each(function(index) {
                const raw = $(this).attr('data-harga');
                console.log(`[Prefill ${index}] data-harga="${raw}"`);
                if (raw != null && raw !== '') {
                    const parsed = parseFloat(raw) || 0;
                    const formatted = self.formatHarga(parsed);
                    $(this).val(formatted);
                    console.log(`  → parsed=${parsed}, formatted="${formatted}"`);
                }
            });
        },
        
        // Initialize subtotals
        initializeSubtotals: function() {
            const self = this;
            this.$table.find('tbody tr').each(function() {
                self.updateSubtotal($(this));
            });
        },
        
        // Setup event listeners
        setupEvents: function() {
            const self = this;
            
        // Harga input change
            $(document).off('input' + EVENT_NS, '.harga-input');
            $(document).on('input' + EVENT_NS, '.harga-input', function() {
                let value = $(this).val();
                let numericValue = value.replace(/[^\d]/g, '');
                if (numericValue) {
                    $(this).val(self.formatHarga(numericValue));
                }
                self.updateSubtotal($(this).closest('tr'));
                autoSave(); // Trigger autosave
            });

        // Real-time listeners to refresh progress
        $('#total_invoice_kertas').on('input change', () => window.App.PurchaseEdit.validateTotal());
        $('#due_date, #transaction_type').on('change', () => window.App.PurchaseEdit.validateTotal());
        $('#has_fp_yes, #has_fp_no').on('change', () => window.App.PurchaseEdit.validateTotal());
        }
    };
    
    // ==========================================
    // INITIALIZATION
    // ==========================================
    $(document).ready(function() {
        console.log('[PurchaseVerify] Initializing...');
        
        // Prefill data
        window.App.PurchaseEdit.prefillData();
        
        // Prefill harga
        window.App.PurchaseEdit.prefillHarga();
        
        // Initialize subtotals
        window.App.PurchaseEdit.initializeSubtotals();
        
        // Setup events
        window.App.PurchaseEdit.setupEvents();
        
        // Leave due_date blank - user must fill manually
        $('#due_date').val('');
        console.log('[PurchaseVerify] Due date left blank - user must fill manually');
        
        // ==========================================
        // VERIFICATION HANDLERS
        // ==========================================
        console.log('[PurchaseVerify] Initializing verification handlers...');
        
        // Show verification modal when VERIFIED button is clicked
        $(document).off('click', '#btn-verify-purchase').on('click', '#btn-verify-purchase', function(e) {
            if ($(this).prop('disabled')) {
                e.preventDefault();
                return;
            }
            console.log('[PurchaseVerify] VERIFIED button clicked');
            $('#verificationModal').modal('show');
        });
        
        // Enable/disable confirm button based on checkbox
        $(document).off('change', '#confirmVerification').on('change', '#confirmVerification', function() {
            const isChecked = $(this).is(':checked');
            $('#confirmVerifyBtn').prop('disabled', !isChecked);
            console.log('[PurchaseVerify] Checkbox changed:', isChecked);
        });
        
        // Handle confirm verification
        $(document).off('click', '#confirmVerifyBtn').on('click', '#confirmVerifyBtn', function() {
            console.log('[PurchaseVerify] Confirm button clicked');
            const $btn = $(this);
            
            // Get values from form (validation already done in validateTotal)
            const dueDate = $('#due_date').val();
            const transactionType = $('#transaction_type').val();
            const hasFp = $('#has_fp_yes').is(':checked') ? 'Y' : ($('#has_fp_no').is(':checked') ? 'N' : '');
            
            // Double check validation (should not happen if button is enabled)
            if (!dueDate || !transactionType) {
                alert('Data pembayaran belum lengkap!');
                $('#verificationModal').modal('hide');
                return;
            }

            // Require tax invoice decision before verifying
            if (!hasFp) {
                alert('Pilih "Dapat Faktur Pajak?" (YA/TIDAK) terlebih dahulu.');
                $('#verificationModal').modal('hide');
                return;
            }
            
            $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Saving...');
            
            // Save purchase first (update harga beli)
            const formData = $('#add-purchase-form').serialize();
            
            $.ajax({
                url: '/purchaseorder/purchase/{{ purchase.id }}/auto-save/',
                type: 'POST',
                data: formData,
                success: function(response) {
                    if (response.success) {
                        console.log('[PurchaseVerify] ✅ Purchase saved, now verifying...');
                        console.log('[PurchaseVerify] Due Date:', dueDate);
                        console.log('[PurchaseVerify] Transaction Type:', transactionType);
                        
                        // Close modal
                        $('#verificationModal').modal('hide');
                        
                        // Now POST to verify endpoint with payment info
                        $.ajax({
                            url: '{% url "purchasing:purchase_verify" purchase.id %}',
                            type: 'POST',
                            data: {
                                csrfmiddlewaretoken: '{{ csrf_token }}',
                                due_date: dueDate,
                                transaction_type: transactionType,
                                has_fp: hasFp
                            },
                            success: function(response) {
                                console.log('[PurchaseVerify] ✅ Verification successful!');
                                window.location.href = '{% url "purchasing:purchase_list" %}';
                            },
                            error: function(xhr) {
                                console.error('[PurchaseVerify] ❌ Verification error:', xhr);
                                alert('Error verifying purchase: ' + (xhr.responseJSON?.error || 'Unknown error'));
                                $btn.prop('disabled', false).html('Ya, Verified');
                            }
                        });
                    } else {
                        alert('Error: ' + (response.error || 'Failed to save purchase'));
                        $btn.prop('disabled', false).html('Ya, Verified');
                    }
                },
                error: function(xhr) {
                    console.error('[PurchaseVerify] ❌ Error:', xhr);
                    alert('Error saving purchase');
                    $btn.prop('disabled', false).html('Ya, Verified');
                }
            });
        });
        
        console.log('[PurchaseVerify] Initialized successfully');
        
        // Validate total on initial load
        window.App.PurchaseEdit.validateTotal();
        
        // Add event listeners for due_date and transaction_type
        $('#due_date, #transaction_type').on('change', function() {
            console.log('[PurchaseVerify] Due date or transaction type changed');
            window.App.PurchaseEdit.validateTotal();
        });

        // Mutually exclusive checkboxes for "Dapat Faktur Pajak?"
        $(document).on('change', '#has_fp_yes', function() {
            if ($(this).is(':checked')) {
                $('#has_fp_no').prop('checked', false);
            } else {
                // Ensure at least one selected: default to YES
                $('#has_fp_yes').prop('checked', true);
            }
            if (window.App && window.App.PurchaseEdit && typeof window.App.PurchaseEdit.validateTotal === 'function') {
                window.App.PurchaseEdit.validateTotal();
            }
        });
        $(document).on('change', '#has_fp_no', function() {
            if ($(this).is(':checked')) {
                $('#has_fp_yes').prop('checked', false);
                // Create a hidden input "has_fp" with value N so backend receives it
                $('input[name="has_fp"][type="hidden"]').remove();
                $('<input>').attr({type:'hidden', name:'has_fp', value:'N'}).appendTo('#add-purchase-form');
            } else {
                $('#has_fp_yes').prop('checked', true);
                $('input[name="has_fp"][type="hidden"]').remove();
            }
            if (window.App && window.App.PurchaseEdit && typeof window.App.PurchaseEdit.validateTotal === 'function') {
                window.App.PurchaseEdit.validateTotal();
            }
        });
    });
    
    // ==========================================
    // GLOBAL FUNCTIONS (untuk kompatibilitas)
    // ==========================================
    
    // Add product to table
    window.tambahProdukKeTable = function(produk) {
        const $existing = window.App.PurchaseEdit.$table.find(`tbody tr[data-sku="${produk.sku}"]`);
        if ($existing.length > 0) {
            const $qtyInput = $existing.find('.qty-input');
            const currentQty = parseInt($qtyInput.val()) || 0;
            const addQty = produk.quantity || 1;
            $qtyInput.val(currentQty + addQty);
            window.App.PurchaseEdit.updateSubtotal($existing);
            return;
        }
        
        let photoHtml = '';
        if (produk.photo_url && produk.photo_url !== '') {
            photoHtml = `
                <div class="product-photo-zoom" data-photo-url="${produk.photo_url}">
                    <img src="${produk.photo_url}" alt="${produk.nama_produk || produk.sku}" style="width:90px;height:90px;object-fit:cover;border-radius:4px;">
                    <div class="magnifier-icon">
                        <i class="bi bi-zoom-in"></i>
                    </div>
                </div>
            `;
        } else {
            photoHtml = `<div class="bg-light d-flex align-items-center justify-content-center" style="width:90px;height:90px;border-radius:4px;"><i class="bi bi-file-image text-secondary" style="font-size:32px;"></i></div>`;
        }
        
        let rowHtml = `
            <tr data-sku="${produk.sku}">
                <td style="vertical-align:middle; text-align:center;">${photoHtml}</td>
                <td style="vertical-align:middle;">
                    <input type="hidden" name="produk_sku[]" value="${produk.sku}">
                    <div class="sku-row">${produk.sku}</div>
                    <div class="barcode-row">${produk.barcode || '-'}</div>
                            </td>
                <td style="vertical-align:middle;">
                    <div class="nama-row">${produk.nama_produk || ''}</div>
                    <div class="variant-brand-row">
                        <span class="variant-text">${produk.variant_produk || ''}</span>
                        <span class="brand-text">${produk.brand || ''}</span>
                    </div>
                </td>
                 <td style="vertical-align:middle; text-align:center;">${produk.stock_qty || 0}</td>
                 <td style="vertical-align:middle; text-align:center;"><input type="number" name="produk_qty[]" class="form-control qty-input" value="${produk.quantity || 1}" min="1" style="width:70px;"></td>
                 <td style="vertical-align:middle; text-align:center;"><input type="text" name="produk_harga_beli[]" class="form-control harga-input" value="${window.App.PurchaseEdit.formatHarga(produk.harga_beli || 0)}" style="width:100px; text-align:right;"></td>
                 <td class="subtotal-display" style="vertical-align:middle; text-align:right;">0</td>
                <td style="vertical-align:middle; text-align:center;"><button type="button" class="btn btn-danger btn-sm hapus-row">Hapus</button></td>
                        </tr>
                    `;
        window.App.PurchaseEdit.$table.find('tbody').append(rowHtml);
        window.App.PurchaseEdit.updateSubtotal(window.App.PurchaseEdit.$table.find('tbody tr:last'));
    }

    // Alias untuk kompatibilitas
    window.updateSubtotal = function($row) {
        window.App.PurchaseEdit.updateSubtotal($row);
    };
    
    window.calculateGrandTotal = function() {
        window.App.PurchaseEdit.calculateGrandTotal();
    };
    
    // ==========================================
    // PRODUCT TABLE EVENTS
    // ==========================================
    
    // Remove product
    $(document).off('click' + EVENT_NS, '.hapus-row');
    $(document).on('click' + EVENT_NS, '.hapus-row', function() {
        $(this).closest('tr').remove();
        window.App.PurchaseEdit.calculateGrandTotal();
        autoSave();
    });

    // Photo zoom
    $(document).on('click', '.product-photo-zoom', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const photoUrl = $(this).data('photo-url');
        if (photoUrl) {
            $('#zoomImage').attr('src', photoUrl);
            $('#zoomImageModal').modal('show');
        }
    });
    
    // ==========================================
    // 5. SUPPLIER MODAL
    // ==========================================
    
    let isCariPO = false;
    
    $('#pilih_supplier_btn').on('click', function() {
        $('#supplierModal').modal('show');
        loadSupplierList('');
    });

    $('#search_supplier').on('input', function() {
        loadSupplierList($(this).val());
    });

    function loadSupplierList(keyword) {
        fetch(`/purchaseorder/search-supplier/?q=${encodeURIComponent(keyword)}`)
            .then(response => response.json())
            .then(data => {
                let html = '';
                if (data.length === 0) html = '<div class="text-danger text-center py-3">Tidak ada supplier ditemukan</div>';
                data.forEach(function(sup) {
                    html += `<a href="#" class="list-group-item list-group-item-action pilih-sup" data-nama='${sup.nama_supplier}' data-id='${sup.id}'>
                        <b>${sup.nama_supplier}</b><br><small>${sup.alamat||''} ${sup.kota||''}</small>
                    </a>`;
                });
                $('#supplier-list').html(html);
            });
    }

    $('#supplier-list').on('click', '.pilih-sup', function() {
        $('#nama_supplier').val($(this).data('nama'));
        $('#supplier_id').val($(this).data('id'));
        $('input[name="supplier_id"]').val($(this).data('id'));
        $('#supplierModal').modal('hide');
        autoSave();
        
        // Jika sedang Cari PO, langsung buka modal PO
        if (isCariPO) {
            isCariPO = false;
            setTimeout(function() {
                $('#cariPoModal').modal('show');
                const supplierId = $('#supplier_id').val();
                loadPOList(supplierId, '', '');
            }, 300);
        }
    });

    // Add supplier
    $('#addSupplierLink').on('click', function(e) {
        e.preventDefault();
        $('#supplierModal').modal('hide');
        $('#addSupplierModal').modal('show');
    });

    $('#saveSupplierBtn').on('click', function() {
        let nama = $('#new_nama_supplier').val().trim();
        if (!nama) { alert('Nama supplier wajib diisi!'); return; }
        
        let formData = new FormData();
        formData.append('nama_supplier', nama);
        formData.append('alamat_supplier', $('#new_alamat_supplier').val());
        formData.append('kota_supplier', $('#new_kota_supplier').val());
        formData.append('csrfmiddlewaretoken', $('[name=csrfmiddlewaretoken]').val());
        
        fetch('/purchaseorder/add-supplier/', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            $('#addSupplierModal').modal('hide');
            $('#nama_supplier').val(data.nama_supplier);
            $('#supplier_id').val(data.id);
            autoSave();
        });
    });

    // ==========================================
    // 6. PO MODAL
    // ==========================================
    
    $('#cari_po_btn').on('click', function() {
        const supplierId = $('#supplier_id').val();
        if (!supplierId) {
            isCariPO = true;
            $('#supplierModal').modal('show');
            loadSupplierList('');
            return;
        }
        $('#cariPoModal').modal('show');
        loadPOList(supplierId, '', '');
    });
    
    $('#search_po_btn').on('click', function() {
        const supplierId = $('#supplier_id').val();
        const keyword = $('#search_po').val();
        const status = $('#filter_status').val();
        loadPOList(supplierId, keyword, status);
    });
    
    function loadPOList(supplierId, keyword, status) {
        $.getJSON('/purchaseorder/data/', {
            supplier_id: supplierId,
            search: keyword,
            status: status
        }, function(response) {
            let html = '';
            if (response.data && response.data.length > 0) {
                response.data.forEach(function(po) {
                    let statusBadge = '';
                    if (po.status === 'Draft') statusBadge = '<span class="badge bg-warning">Draft</span>';
                    else if (po.status === 'Received') statusBadge = '<span class="badge bg-success">Received</span>';
                    else if (po.status === 'Cancelled') statusBadge = '<span class="badge bg-danger">Cancelled</span>';
                    
                    html += `
                        <tr>
                            <td>${po.nomor_po}</td>
                            <td>${po.tanggal_po}</td>
                            <td>${po.supplier}</td>
                            <td>${statusBadge}</td>
                            <td>${po.total_amount}</td>
                            <td>
                                <button class="btn btn-sm btn-primary pilih-po-btn" data-po-id="${po.id}" data-po-nomor="${po.nomor_po}">
                                    <i class="bi bi-check-circle"></i> Pilih
                                </button>
                </td>
            </tr>
        `;
                });
            } else {
                html = '<tr><td colspan="6" class="text-center text-muted">Tidak ada data ditemukan</td></tr>';
            }
            $('#po_list_tbody').html(html);
        }).fail(function() {
            $('#po_list_tbody').html('<tr><td colspan="6" class="text-center text-danger">Gagal memuat data</td></tr>');
        });
    }
    
    $(document).on('click', '.pilih-po-btn', function() {
        const poId = $(this).data('po-id');
        const poNomor = $(this).data('po-nomor');

        $('#nomor_po').val(poNomor);
        $('#po_id').val(poId);
        $('#cariPoModal').modal('hide');

        $.getJSON('/purchaseorder/' + poId + '/json/', function(poData) {
            if (poData.tanggal_po) {
                const dt = poData.tanggal_po.slice(0,10);
                $('#tanggal_purchase').val(dt);
            }

            $('#produk-table tbody').empty();
            if (poData.items && poData.items.length) {
                poData.items.forEach(function(item) {
                    window.tambahProdukKeTable({
                        sku: item.product.sku,
                        barcode: item.product.barcode,
                        nama_produk: item.product.nama_produk,
                        variant_produk: item.product.variant_produk,
                        brand: item.product.brand,
                        stock_qty: (item.product.stock && item.product.stock.quantity_ready) ? item.product.stock.quantity_ready : 0,
                        quantity: item.quantity || 1,
                        harga_beli: item.harga_beli || 0,
                        photo_url: item.product.photo_url || ''
                    });
                });
            }
            autoSave();
        }).fail(function() {
            alert('Gagal memuat data PO!');
        });
    });

    // ==========================================
    // 7. AUTO-SAVE FUNCTIONALITY
    // ==========================================
    
    let autoSaveTimeout;
    let isAutoSaving = false;
    
    function autoSave() {
        if (isAutoSaving) return;
        
        // Skip autosave if purchase doesn't exist yet (create mode)
        const purchaseId = $('input[name="purchase_id"]').val();
        if (!purchaseId) {
            console.log('⏭️  Auto-save skipped: purchase not created yet');
            return;
        }
        
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(function() {
            isAutoSaving = true;
            
            const formData = $('#add-purchase-form').serialize();
            console.log('💾 Auto-save triggered');
            
            // Show "Saving..." indicator
            showAutoSaveIndicator('Menyimpan...', 'saving');
            
            $.ajax({
                url: '/purchaseorder/purchase/' + purchaseId + '/auto-save/',
                type: 'POST',
                data: formData,
                success: function(response) {
                    if (response.success) {
                        console.log('✅ Auto-saved');
                        showAutoSaveIndicator('Tersimpan', 'success');
                    } else {
                        console.error('❌ Auto-save failed:', response.error);
                        showAutoSaveIndicator('Gagal menyimpan', 'error');
                    }
                    isAutoSaving = false;
                },
                error: function(xhr, status, error) {
                    console.error('❌ Auto-save error:', error);
                    showAutoSaveIndicator('Error: ' + error, 'error');
                    isAutoSaving = false;
                },
                complete: function() {
                    isAutoSaving = false;
                }
            });
        }, 800);
    }
    
    function showAutoSaveIndicator(message, type = 'success') {
        // Remove existing indicator
        $('#auto-save-indicator').remove();
        
        // Determine icon and color based on type
        let icon, bgColor, textColor;
        if (type === 'success') {
            icon = '<i class="bi bi-check-circle-fill"></i>';
            bgColor = '#28a745';
            textColor = 'white';
        } else if (type === 'saving') {
            icon = '<i class="bi bi-arrow-clockwise spinner-border spinner-border-sm"></i>';
            bgColor = '#007bff';
            textColor = 'white';
        } else {
            icon = '<i class="bi bi-exclamation-circle-fill"></i>';
            bgColor = '#dc3545';
            textColor = 'white';
        }
        
        // Create indicator with icon
        const indicator = $(`
            <div id="auto-save-indicator" style="
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: ${textColor};
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 9999;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                display: flex;
                align-items: center;
                gap: 10px;
                font-weight: 500;
                animation: slideInRight 0.3s ease-out;
            ">
                ${icon}
                <span>${message}</span>
            </div>
        `);
        
        $('body').append(indicator);
        
        // Add animation CSS
        if ($('#auto-save-indicator-style').length === 0) {
            $('head').append(`
                <style id="auto-save-indicator-style">
                    @keyframes slideInRight {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    @keyframes slideOutRight {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                    }
                </style>
            `);
        }
        
        // Auto remove after 2 seconds
        setTimeout(function() {
            indicator.css('animation', 'slideOutRight 0.3s ease-out');
            setTimeout(function() {
                indicator.remove();
            }, 300);
        }, 2000);
    }
    
    // Trigger auto-save on form changes
    $('#add-purchase-form input, #add-purchase-form textarea, #add-purchase-form select').on('input change', function() {
        autoSave();
    });
    
    // ==========================================
    // 8. TOTAL INVOICE KERTAS VALIDATION
    // ==========================================
    
    // Format input dengan thousand separator + jaga posisi kursor
    $('#total_invoice_kertas').off('input').on('input', function() {
        const el = this;
        
        // Nilai dan posisi kursor saat ini
        const raw = el.value;
        const caret = el.selectionStart || 0;
        
        // Berapa digit (0-9) di kiri kursor sebelum diformat
        const digitsLeftOfCaret = raw.slice(0, caret).replace(/[^\d]/g, '').length;
        
        // Ambil hanya digit
        const digits = raw.replace(/[^\d]/g, '');
        
        // Set nilai terformat (atau kosong jika user hapus semua)
        el.value = digits ? new Intl.NumberFormat('id-ID').format(parseInt(digits, 10)) : '';
        
        // Hitung ulang posisi kursor: maju sampai ketemu jumlah digit yang sama
        let newCaret = 0, seen = 0;
        for (let i = 0; i < el.value.length; i++) {
            if (/\d/.test(el.value[i])) seen++;
            if (seen >= digitsLeftOfCaret) { 
                newCaret = i + 1; 
                break; 
            }
        }
        // Kalau tidak ada digit (semua dihapus)
        if (!digitsLeftOfCaret) newCaret = 0;
        
        // Terapkan posisi kursor baru
        try { 
            el.setSelectionRange(newCaret, newCaret); 
        } catch (e) {}
        
        // Jalankan validasi total
        if (window.App && window.App.PurchaseEdit && typeof window.App.PurchaseEdit.validateTotal === 'function') {
            window.App.PurchaseEdit.validateTotal();
        }
    });
    
    // Confirm Invoice Button
    $(document).on('click', '#btn-confirm-invoice', function() {
        console.log('[PurchaseVerify] Confirm button clicked');
        const totalKertas = parseFloat($('#total_invoice_kertas').val().replace(/[^\d]/g, '')) || 0;
        console.log('[PurchaseVerify] Total Kertas:', totalKertas);
        
        if (totalKertas === 0) {
            alert('Silakan masukkan total invoice di kertas terlebih dahulu!');
            return;
        }
        
        // Lock input
        $('#total_invoice_kertas').prop('readonly', true);
        $('#total_invoice_kertas').css('background-color', '#e9ecef');
        
        // Hide confirm button, show ubah button
        $('#btn-confirm-invoice').hide();
        $('#btn-ubah-invoice').show();
        
        // Update status text
        $('#invoice-status-text').html('<i class="bi bi-check-circle text-success"></i> Total invoice sudah dikonfirmasi');
        
        // Validate total
        window.App.PurchaseEdit.validateTotal();
    });
    
    // Ubah Invoice Button
    $(document).on('click', '#btn-ubah-invoice', function() {
        console.log('[PurchaseVerify] Ubah button clicked');
        
        // Unlock input
        $('#total_invoice_kertas').prop('readonly', false);
        $('#total_invoice_kertas').css('background-color', '');
        
        // Show confirm button, hide ubah button
        $('#btn-confirm-invoice').show();
        $('#btn-ubah-invoice').hide();
        
        // Update status text
        $('#invoice-status-text').text('Masukkan total dari invoice fisik');
        
        // Validate total (will disable button if invoice not confirmed)
        window.App.PurchaseEdit.validateTotal();
    });
    
    // ==========================================
    // 9. FORM SUBMISSION
    // ==========================================
    
    $('#add-purchase-form').on('submit', function(e) {
        const supplierId = $('#supplier_id').val();
        if (!supplierId) {
            alert('Supplier wajib diisi. Silakan pilih supplier terlebih dahulu.');
            e.preventDefault();
            return;
        }

        const $submitButton = $(this).find('button[type="submit"]');
        if ($submitButton.prop('disabled')) {
            e.preventDefault();
            return false;
        }

        $submitButton.prop('disabled', true);
        $submitButton.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Menyimpan...');
        
        // If this is a create (no purchase_id), we'll handle the response
        const purchaseId = $('input[name="purchase_id"]').val();
        if (!purchaseId) {
            e.preventDefault();
            
            // Submit via AJAX to get the purchase_id
            const formData = $(this).serialize();
            $.ajax({
                url: $(this).attr('action'),
                type: 'POST',
                data: formData,
                success: function(response) {
                    if (response.success) {
                        // Update purchase_id in form
                        $('input[name="purchase_id"]').val(response.purchase_id);
                        // Now autosave will work
                        console.log('✅ Purchase created, ID:', response.purchase_id);
                        // Redirect to edit page
                        window.location.href = '/purchaseorder/purchase/' + response.purchase_id + '/edit/';
                    } else {
                        alert('Error: ' + (response.error || 'Failed to save'));
                        $submitButton.prop('disabled', false);
                        $submitButton.html('Simpan Purchase');
                    }
                },
                error: function(xhr) {
                    console.error('Error:', xhr);
                    alert('Error saving purchase');
                    $submitButton.prop('disabled', false);
                    $submitButton.html('Simpan Purchase');
                }
            });
            return false;
        }
    });
    
})(); // End IIFE
</script>
{% endblock %}
