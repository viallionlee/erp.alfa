{% extends 'base.html' %}
{% block title %}Tambah Transfer Antar Gudang{% endblock %}
{% block content %}
<style>
    .modern-form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 4px;
    }
    .modern-form-row {
        display: flex;
        gap: 1rem;
        align-items: flex-end;
        margin-bottom: 1.2rem;
        flex-wrap: wrap;
    }
    .modern-form-row > .form-group {
        flex: 1 1 0;
        min-width: 180px;
    }
    .modern-form-row .input-group {
        width: 100%;
    }
    .modern-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.07);
        padding: 2rem 2.5rem 1.5rem 2.5rem;
        max-width: 1200px;
        margin: 0 auto;
    }
    #search-result-box {
        min-width: 320px;
        max-width: 1065px;
        font-size: 0.8rem;
        min-height: 600px;
        max-height: 600px;
        overflow-y: auto;
    }
    #search-result-box table {
        width: 100%;
        table-layout: fixed;
    }
    #search-result-box tbody tr {
        height: 90px;
        min-height: 90px;
    }
    #search-result-box tbody tr td {
        vertical-align: middle;
        padding: 8px;
    }
    #search-result-box .product-photo-zoom img {
        width: 90px !important;
        height: 90px !important;
        max-width: 90px !important;
        max-height: 90px !important;
        object-fit: cover;
    }
    #search-result-box th {
        text-align: center;
    }
    /* Kode Produk - 2 rows */
    #search-result-box td:nth-child(2) {
        vertical-align: middle;
        padding: 8px;
        text-align: left;
    }
    #search-result-box td:nth-child(2) .sku-row {
        font-weight: 600;
        font-size: 0.85rem;
        color: #0d6efd;
        text-align: left;
    }
    #search-result-box td:nth-child(2) .barcode-row {
        font-size: 0.75rem;
        color: #6c757d;
        text-align: left;
    }
    /* Detail Produk - 2 rows */
    #search-result-box td:nth-child(3) {
        vertical-align: middle;
        padding: 8px;
        text-align: left;
    }
    #search-result-box td:nth-child(3) .nama-row {
        font-weight: 500;
        font-size: 0.85rem;
        margin-bottom: 4px;
        word-wrap: break-word;
        text-align: left;
    }
    #search-result-box td:nth-child(3) .variant-brand-row {
        font-size: 0.75rem;
        color: #6c757d;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    #search-result-box td:nth-child(3) .variant-text {
        text-align: left;
    }
    #search-result-box td:nth-child(3) .brand-text {
        font-weight: 500;
        color: #198754;
        margin-left: 8px;
        text-align: right;
    }
    /* Main table styling */
    #produk-table tbody tr {
        height: 90px;
        min-height: 90px;
    }
    #produk-table .product-photo-zoom img {
        width: 90px !important;
        height: 90px !important;
    }
    #produk-table .sku-row {
        font-weight: 600;
        font-size: 0.9rem;
        color: #0d6efd;
        text-align: left;
    }
    #produk-table .barcode-row {
        font-size: 0.8rem;
        color: #6c757d;
        text-align: left;
    }
    #produk-table .nama-row {
        font-weight: 500;
        font-size: 0.9rem;
        margin-bottom: 4px;
        text-align: left;
    }
    #produk-table .variant-brand-row {
        font-size: 0.8rem;
        color: #6c757d;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    #produk-table .variant-text {
        text-align: left;
    }
    #produk-table .brand-text {
        font-weight: 500;
        color: #198754;
        margin-left: 8px;
        text-align: right;
    }
    .product-photo-zoom {
        position: relative;
        cursor: pointer;
        display: inline-block;
    }
    .product-photo-zoom .magnifier-icon {
        position: absolute;
        top: 2px;
        right: 2px;
        background: rgba(0,0,0,0.7);
        color: white;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        opacity: 0;
        transition: opacity 0.2s;
    }
    .product-photo-zoom:hover .magnifier-icon {
        opacity: 1;
    }
    @media (max-width: 600px) {
        .modern-card { padding: 1rem; }
        .modern-form-row { flex-direction: column; gap: 0.5rem; }
    }
</style>
<div class="container mt-4">
    <div class="card shadow-sm" style="max-width: 1200px; margin: auto;">
        <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#inboundFormBody" aria-expanded="true" aria-controls="inboundFormBody">
            <h5 class="mb-0">Tambah Inbound</h5>
            <i class="bi bi-chevron-down"></i>
        </div>
        <div class="collapse show" id="inboundFormBody">
            <div class="card-body" style="padding: 2rem 2.5rem 1.5rem 2.5rem;">
                <form method="post" action="{% url 'inventory:inbound_tambah' %}" id="add-inbound-form">
                    {% csrf_token %}
                    <!-- Row 1: Tanggal, Dari Gudang, Ke Gudang, Nomor Inbound (inline) -->
                    <div class="modern-form-row">
                        <div class="form-group">
                            <label class="modern-form-label" for="tanggal">Tanggal</label>
                            <input type="datetime-local" name="tanggal" id="tanggal" class="form-control" required value="{{ default_tanggal }}">
                        </div>
                        <div class="form-group">
                            <label class="modern-form-label" for="from_warehouse">Dari Gudang <span style="color:red">*</span></label>
                            <input type="text" name="from_warehouse" id="from_warehouse" class="form-control" required 
                                   placeholder="Contoh: Gudang Pusat" value="{{ from_warehouse }}">
                        </div>
                        <div class="form-group">
                            <label class="modern-form-label" for="to_warehouse">Ke Gudang <span style="color:red">*</span></label>
                            <input type="text" name="to_warehouse" id="to_warehouse" class="form-control" required 
                                   placeholder="Contoh: Gudang Cabang" value="{{ to_warehouse }}">
                        </div>
                        <div class="form-group">
                            <label class="modern-form-label" for="nomor_inbound">Nomor Inbound</label>
                            <input type="text" name="nomor_inbound" id="nomor_inbound" class="form-control" required value="{{ default_nomor_inbound }}">
                        </div>
                    </div>
                    <!-- Row 2: Keterangan -->
                    <div class="modern-form-row">
                        <div class="form-group" style="flex:2;">
                            <label class="modern-form-label" for="keterangan">Keterangan</label>
                            <textarea name="keterangan" id="keterangan" class="form-control" rows="1" placeholder="Keterangan tambahan (opsional)"></textarea>
                        </div>
                    </div>
                    <!-- Row 3: Cari Produk -->
                    <div class="modern-form-row">
                        <div class="form-group" style="flex:2; position:relative;">
                            <label class="modern-form-label" for="produk_search">Cari Produk</label>
                            <div class="input-group mb-1">
                                <input type="text" id="produk_search" class="form-control" placeholder="Cari SKU / Barcode / Nama / Brand / Variant (↑↓ Enter untuk navigasi)" autocomplete="off" aria-label="Cari Produk">
                                <button class="btn btn-outline-primary" type="button" id="produk_search_btn" aria-label="Cari Produk">Cari</button>
                            </div>
                            <div id="search-result-box" class="border rounded mt-1 bg-white shadow-sm" style="display:none; position:absolute; z-index:10; min-width:100%; max-width:1065px; overflow-x:auto; max-height:600px; overflow-y:auto;">
                              <table class="table table-sm mb-0" style="font-size:0.8rem; width:100%; table-layout:fixed;">
                                <thead>
                                  <tr style="background:#f8f9fa;">
                                    <th style="width:120px; text-align:center;">Photo</th>
                                    <th style="width:180px; text-align:center;">Kode Produk</th>
                                    <th style="width:auto; text-align:center;">Detail Produk</th>
                                    <th style="width:120px; text-align:center;">Stock</th>
                                  </tr>
                                </thead>
                                <tbody></tbody>
                              </table>
                            </div>
                        </div>
                    </div>
                    <!-- Produk Table -->
                    <div class="table-responsive mt-3">
                        <table class="table table-bordered align-middle" id="produk-table">
                            <thead class="table-light">
                                <tr>
                                    <th style="width:120px; text-align:center;">Photo</th>
                                    <th style="width:180px; text-align:center;">Kode Produk</th>
                                    <th style="width:auto; text-align:center;">Detail Produk</th>
                                    <th style="width:80px; text-align:center;">Stok</th>
                                    <th style="width:80px; text-align:center;">Jumlah</th>
                                    <th style="width:80px; text-align:center;">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Baris produk akan muncul di sini -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3 text-center">
                        <button type="submit" class="btn btn-primary px-4">Simpan Inbound</button>
                        <a href="{% url 'inventory:inbound' %}" class="btn btn-secondary ms-2">Batal</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Modal Zoom Photo -->
<div class="modal fade" id="zoomImageModal" tabindex="-1" aria-labelledby="zoomImageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="zoomImageModalLabel">Photo Produk</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="zoomImage" src="" alt="Product Photo" class="img-fluid" style="max-height: 70vh; border-radius: 8px;">
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
// INBOUND TAMBAH SCRIPT - Loaded after jQuery and Bootstrap
$(document).ready(function() {
    // Set default tanggal
    let now = new Date();
    let pad = n => n < 10 ? '0' + n : n;
    let tglStr = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
    $('#tanggal').val(tglStr);

    // Fungsi untuk menambah produk ke table
    function tambahProdukKeTable(produk) {
        let existing = $(`#produk-table tbody tr[data-sku="${produk.sku}"]`);
        if (existing.length > 0) {
            let qtyInput = existing.find('.qty-input');
            qtyInput.val(parseInt(qtyInput.val()) + 1);
            return;
        }
        
        let photoHtml = '';
        if (produk.photo_url && produk.photo_url !== '') {
            photoHtml = `
                <div class="product-photo-zoom" data-photo-url="${produk.photo_url}">
                    <img src="${produk.photo_url}" alt="${produk.nama || produk.sku}" class="img-thumbnail" style="width:90px;height:90px;object-fit:cover;">
                    <div class="magnifier-icon">
                        <i class="bi bi-zoom-in"></i>
                    </div>
                </div>
            `;
        } else {
            photoHtml = `<div class="bg-light d-flex align-items-center justify-content-center" style="width:90px;height:90px;border-radius:4px;"><i class="bi bi-file-image text-secondary" style="font-size:32px;"></i></div>`;
        }
        
        let rowHtml = `
            <tr data-sku="${produk.sku}">
                <td style="vertical-align:middle; text-align:center;">${photoHtml}</td>
                <td style="vertical-align:middle;">
                    <input type="hidden" name="produk_sku[]" value="${produk.sku}">
                    <div class="sku-row">${produk.sku}</div>
                    <div class="barcode-row">${produk.barcode || '-'}</div>
                </td>
                <td style="vertical-align:middle;">
                    <div class="nama-row">${produk.nama || ''}</div>
                    <div class="variant-brand-row">
                        <span class="variant-text">${produk.variant || ''}</span>
                        <span class="brand-text">${produk.brand || ''}</span>
                    </div>
                </td>
                <td style="vertical-align:middle; text-align:center;">${produk.qty_fisik || 0}</td>
                <td style="vertical-align:middle; text-align:center;"><input type="number" name="produk_qty[]" class="form-control qty-input" value="1" min="1" style="width:70px;"></td>
                <td style="vertical-align:middle; text-align:center;"><button type="button" class="btn btn-danger btn-sm hapus-row">Hapus</button></td>
            </tr>
        `;
        $('#produk-table tbody').append(rowHtml);
    }


    // Hapus produk dari table
    $(document).on('click', '.hapus-row', function() {
        $(this).closest('tr').remove();
    });

    // Click outside to hide search results
    $(document).on('click', function(e) {
        if (!$(e.target).closest('#produk_search, #search-result-box, #produk_search_btn').length) {
            $('#search-result-box').hide();
        }
    });

    // Photo zoom functionality
    $(document).on('click', '.product-photo-zoom', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const photoUrl = $(this).data('photo-url');
        if (photoUrl) {
            $('#zoomImage').attr('src', photoUrl);
            $('#zoomImageModal').modal('show');
        }
    });

    // Form submission handler
    $(document).on('submit', '#add-inbound-form', function(e) {
        const fromWarehouse = $('#from_warehouse').val();
        const toWarehouse = $('#to_warehouse').val();
        
        if (!fromWarehouse || !toWarehouse) {
            alert('Dari Gudang dan Ke Gudang wajib diisi.');
            e.preventDefault();
            return;
        }

        const $submitButton = $(this).find('button[type="submit"]');
        if ($submitButton.prop('disabled')) {
            e.preventDefault();
            return false;
        }

        $submitButton.prop('disabled', true);
        $submitButton.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Menyimpan...');
    });

    // ==========================================
    // VANILLA JAVASCRIPT - Product Lookup with Advanced Features
    // ==========================================
    
    let searchTimeout;
    let selectedIdx = -1;
    let currentRows = [];
    let searchPage = 1;
    let searchHasMore = false;
    let searchLoading = false;
    let searchQuery = '';

    const produkSearch = document.getElementById('produk_search');
    const produkSearchBtn = document.getElementById('produk_search_btn');
    const searchResultBox = document.getElementById('search-result-box');
    const searchResultTbody = searchResultBox.querySelector('tbody');

    // Render search results
    function renderSearchResults(products, append = false) {
        if (!append) {
            searchResultTbody.innerHTML = '';
        }

        if (products.length === 0 && !append) {
            searchResultTbody.innerHTML = '<tr><td colspan="4" class="text-center py-3 text-muted">Produk tidak ditemukan</td></tr>';
            searchResultBox.style.display = 'block';
            return;
        }

        products.forEach(p => {
            let photoHtml = '';
            if (p.photo_url && p.photo_url !== '') {
                photoHtml = `
                    <div class="product-photo-zoom" data-photo-url="${p.photo_url}">
                        <img src="${p.photo_url}" alt="${p.nama || p.sku}" class="img-thumbnail" style="width:90px;height:90px;object-fit:cover;">
                        <div class="magnifier-icon">
                            <i class="bi bi-zoom-in"></i>
                        </div>
                    </div>
                `;
            } else {
                photoHtml = `<div class="bg-light d-flex align-items-center justify-content-center" style="width:90px;height:90px;border-radius:4px;"><i class="bi bi-file-image text-secondary" style="font-size:32px;"></i></div>`;
            }

            const tr = document.createElement('tr');
            tr.className = 'pilih-produk';
            tr.style.cursor = 'pointer';
            tr.dataset.produk = JSON.stringify(p);
            tr.innerHTML = `
                <td style="vertical-align:middle; text-align:center;">${photoHtml}</td>
                <td>
                    <div class="sku-row">${p.sku}</div>
                    <div class="barcode-row">${p.barcode || '-'}</div>
                </td>
                <td>
                    <div class="nama-row">${p.nama || ''}</div>
                    <div class="variant-brand-row">
                        <span class="variant-text">${p.variant || ''}</span>
                        <span class="brand-text">${p.brand || ''}</span>
                    </div>
                </td>
                <td style="vertical-align:middle; text-align:center;">${p.qty_fisik || 0}</td>
            `;
            searchResultTbody.appendChild(tr);
        });

        searchResultBox.style.display = 'block';
        currentRows = Array.from(searchResultTbody.querySelectorAll('tr.pilih-produk'));
        selectedIdx = -1;
        updateHighlight();
    }

    // Fetch products
    function fetchProducts(keyword, page = 1, append = false) {
        searchLoading = true;
        const url = "{% url 'inventory:produk_lookup' %}";
        
        fetch(`${url}?q=${encodeURIComponent(keyword)}&mode=manual&page=${page}`)
            .then(response => response.json())
            .then(data => {
                // Handle both array and object response
                let products = Array.isArray(data) ? data : (data.results || []);
                searchHasMore = data.has_more || (products.length === 20);
                
                renderSearchResults(products, append);
                searchLoading = false;
            })
            .catch(error => {
                searchResultTbody.innerHTML = '<tr><td colspan="4" class="text-center py-3 text-danger">Gagal memuat data</td></tr>';
                searchResultBox.style.display = 'block';
                searchLoading = false;
            });
    }

    // Input event with debouncing
    produkSearch.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const keyword = this.value.trim();
        
        if (keyword.length < 2) {
            searchResultBox.style.display = 'none';
            return;
        }

        searchQuery = keyword;
        searchPage = 1;
        
        searchTimeout = setTimeout(() => {
            fetchProducts(keyword, 1, false);
        }, 300);
    });

    // Button click
    produkSearchBtn.addEventListener('click', function() {
        const keyword = produkSearch.value.trim();
        if (!keyword) return;
        
        searchQuery = keyword;
        searchPage = 1;
        fetchProducts(keyword, 1, false);
    });

    // Infinite scroll
    searchResultBox.addEventListener('scroll', function() {
        if (searchLoading || !searchHasMore) return;
        
        const box = this;
        if (box.scrollTop + box.clientHeight >= box.scrollHeight - 10) {
            searchPage += 1;
            fetchProducts(searchQuery, searchPage, true);
        }
    });

    // Keyboard navigation
    produkSearch.addEventListener('keydown', function(e) {
        if (searchResultBox.style.display === 'none') return;
        if (currentRows.length === 0) return;

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIdx = (selectedIdx + 1) % currentRows.length;
            updateHighlight();
            currentRows[selectedIdx].scrollIntoView({ block: 'nearest' });
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIdx = (selectedIdx - 1 + currentRows.length) % currentRows.length;
            updateHighlight();
            currentRows[selectedIdx].scrollIntoView({ block: 'nearest' });
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (selectedIdx >= 0) {
                currentRows[selectedIdx].click();
            }
        } else if (e.key === 'Escape') {
            searchResultBox.style.display = 'none';
        }
    });

    // Update highlight
    function updateHighlight() {
        currentRows.forEach(r => r.classList.remove('table-active'));
        if (selectedIdx >= 0 && selectedIdx < currentRows.length) {
            currentRows[selectedIdx].classList.add('table-active');
        }
    }

    // Click on product
    searchResultBox.addEventListener('click', function(e) {
        const tr = e.target.closest('tr.pilih-produk');
        if (!tr) return;

        e.preventDefault();
        const produk = JSON.parse(tr.dataset.produk);
        tambahProdukKeTable(produk);
        produkSearch.value = '';
        searchResultBox.style.display = 'none';
        produkSearch.focus();
    });

    // Click outside to hide
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#produk_search') && 
            !e.target.closest('#search-result-box') && 
            !e.target.closest('#produk_search_btn')) {
            searchResultBox.style.display = 'none';
        }
    });

    // Prevent dropdown close on internal clicks
    searchResultBox.addEventListener('mousedown', function(e) {
        e.stopPropagation();
    });
});
</script>
{% endblock %}
