{% extends 'base.html' %}
{% block title %}Tambah Inbound{% endblock %}
{% block content %}
<h2 class="text-center mb-4">Tambah Inbound</h2>
<div class="row justify-content-center">
  <div class="col-md-10 col-lg-8">
    <form method="post" id="inbound-form">
      {% csrf_token %}
      <div class="mb-3 d-flex gap-2">
        <div>
          <label for="nomor_inbound" class="form-label">Nomor Inbound</label>
          <input type="text" class="form-control" id="nomor_inbound" name="nomor_inbound" required value="{{ default_nomor_inbound }}">
        </div>
        <div>
          <label for="tanggal" class="form-label">Tanggal</label>
          <input type="datetime-local" class="form-control" id="tanggal" name="tanggal" required value="{{ default_tanggal }}">
        </div>
        <div class="flex-grow-1">
          <label for="keterangan" class="form-label">Keterangan</label>
          <textarea class="form-control" id="keterangan" name="keterangan" rows="1"></textarea>
        </div>
      </div>
        <div class="mb-3">
          <label for="barcode_search" class="form-label">Scan/Manual Search Produk</label>
          <div class="input-group">
            <input type="text" class="form-control" id="barcode_search" placeholder="Scan barcode / cari produk..." autocomplete="off">
            <button class="btn btn-outline-secondary" type="button" id="manual_search_btn">Cari</button>
          </div>
          <div id="search-result-box" class="border rounded mt-1 bg-white shadow-sm" style="display:none; position:absolute; z-index:10; max-height:180px; overflow-y:auto; width:50%; font-size:0.80em;"></div>
        </div>
      </div>
      <div class="table-responsive mb-3">
        <table class="table table-bordered align-middle" id="produk-table">
          <thead class="table-light">
            <tr>
              <th>SKU</th>
              <th>Barcode</th>
              <th>Nama Produk</th>
              <th>Variant</th>
              <th>Brand</th>
              <th style="width:50px;">Jumlah</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody>
            <!-- Baris produk akan muncul di sini -->
          </tbody>
        </table>
      </div>
      <div class="d-flex justify-content-between">
        <a href="{% url 'inventory:inbound' %}" class="btn btn-secondary">Batal</a>
        <button type="submit" class="btn btn-success">Simpan</button>
      </div>
    </form>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
function findProdukByBarcode(barcode, callback) {
  $.getJSON("{% url 'inventory:produk_lookup' %}", {q: barcode, page_size: 1000}, function(data) {
    callback(data);
  }).fail(function() {
    callback(null);
  });
}

function searchProdukManual(keyword, callback) {
  $.getJSON("{% url 'inventory:produk_lookup' %}", {q: keyword, mode: 'manual', page_size: 1000}, function(data) {
    callback(data);
  }).fail(function() {
    callback([]);
  });
}

function tambahAtauUpdateProduk(produk) {
  let $row = $('#produk-table tbody tr[data-sku="' + produk.sku + '"]');
  if ($row.length) {
    let $qty = $row.find('.qty-input');
    $qty.val(parseInt($qty.val()) + 1);
  } else {
    $('#produk-table tbody').append(`
      <tr data-sku="${produk.sku}">
        <td>
          <input type="hidden" name="produk_sku[]" value="${produk.sku}">
          ${produk.sku}
        </td>
        <td>${produk.barcode}</td>
        <td>${produk.nama}</td>
        <td>${produk.variant}</td>
        <td>${produk.brand}</td>
        <td>
          <input type="number" name="produk_qty[]" class="form-control qty-input" value="1" min="1" style="width:80px;">
        </td>
        <td>
          <button type="button" class="btn btn-danger btn-sm hapus-row">Hapus</button>
        </td>
      </tr>
    `);
  }
}

// Hapus produk dari tabel
$('#produk-table').off('click', '.hapus-row').on('click', '.hapus-row', function() {
  $(this).closest('tr').remove();
});

$('#barcode_search').on('keypress', function(e) {
  if (e.which === 13) {
    e.preventDefault();
    let kode = $(this).val().trim();
    if (!kode) return;
    // Manual search mode
    searchProdukManual(kode, function(list) {
      if (Array.isArray(list) && list.length > 0) {
        let html = '<table class="table table-sm mb-0"><tbody>';
        list.forEach(function(produk) {
          html += `<tr class='pilih-produk' style='cursor:pointer' data-sku='${produk.sku}' data-barcode='${produk.barcode}' data-nama='${produk.nama}' data-variant='${produk.variant}' data-brand='${produk.brand}'>`;
          html += `<td>${produk.sku}</td><td>${produk.barcode}</td><td>${produk.nama}</td><td>${produk.variant}</td><td>${produk.brand}</td></tr>`;
        });
        html += '</tbody></table>';
        $('#search-result-box').html(html).show();
      } else {
        // fallback ke scan barcode
        findProdukByBarcode(kode, function(produk) {
          if (produk && !produk.error) {
            tambahAtauUpdateProduk(produk);
            $('#barcode_search').val('');
            $('#search-result-box').hide();
          } else {
            $('#search-result-box').html('<div class="p-2 text-danger">Produk tidak ditemukan!</div>').show();
          }
        });
      }
    });
  }
});

$('#manual_search_btn').on('click', function() {
  let keyword = $('#barcode_search').val().trim();
  if (!keyword) return;
  searchProdukManual(keyword, function(list) {
    if (Array.isArray(list) && list.length > 0) {
      let html = '<table class="table table-sm mb-0"><tbody>';
      list.forEach(function(produk) {
        html += `<tr class='pilih-produk' style='cursor:pointer' data-sku='${produk.sku}' data-barcode='${produk.barcode}' data-nama='${produk.nama}' data-variant='${produk.variant}' data-brand='${produk.brand}'>`;
        html += `<td>${produk.sku}</td><td>${produk.barcode}</td><td>${produk.nama}</td><td>${produk.variant}</td><td>${produk.brand}</td></tr>`;
      });
      html += '</tbody></table>';
      $('#search-result-box').html(html).show();
    } else {
      $('#search-result-box').html('<div class="p-2 text-danger">Produk tidak ditemukan!</div>').show();
    }
  });
});

$('#search-result-box').on('click', '.pilih-produk', function() {
  let produk = {
    sku: $(this).data('sku'),
    barcode: $(this).data('barcode'),
    nama: $(this).data('nama'),
    variant: $(this).data('variant'),
    brand: $(this).data('brand')
  };
  tambahAtauUpdateProduk(produk);
  $('#barcode_search').val('');
  $('#search-result-box').hide();
});

$(document).on('click', function(e) {
  if (!$(e.target).closest('#search-result-box, #barcode_search, #manual_search_btn').length) {
    $('#search-result-box').hide();
  }
});

let selectedIdx = -1;
let currentRows = [];

function updateSearchResultHighlight() {
  $('#search-result-box tr').removeClass('table-primary');
  if (selectedIdx >= 0 && currentRows.length > 0) {
    $(currentRows[selectedIdx]).addClass('table-primary');
  }
}

$('#barcode_search').on('keydown', function(e) {
  if ($('#search-result-box').is(':visible')) {
    currentRows = $('#search-result-box tr.pilih-produk');
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      if (currentRows.length === 0) return;
      selectedIdx = (selectedIdx + 1) % currentRows.length;
      updateSearchResultHighlight();
      // Scroll into view
      let row = currentRows[selectedIdx];
      if (row) row.scrollIntoView({block:'nearest'});
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      if (currentRows.length === 0) return;
      selectedIdx = (selectedIdx - 1 + currentRows.length) % currentRows.length;
      updateSearchResultHighlight();
      let row = currentRows[selectedIdx];
      if (row) row.scrollIntoView({block:'nearest'});
    } else if (e.key === 'Enter') {
      if (selectedIdx >= 0 && currentRows.length > 0) {
        $(currentRows[selectedIdx]).trigger('click');
        selectedIdx = -1;
        currentRows = [];
      }
    } else {
      selectedIdx = -1;
      updateSearchResultHighlight();
    }
  }
});

// Reset highlight on new search result
function resetSearchResultHighlight() {
  selectedIdx = -1;
  currentRows = $('#search-result-box tr.pilih-produk');
  updateSearchResultHighlight();
}
// Call reset after search result is shown
let oldShow = $.fn.show;
$.fn.show = function() {
  let result = oldShow.apply(this, arguments);
  if (this.attr('id') === 'search-result-box') {
    setTimeout(resetSearchResultHighlight, 10);
  }
  return result;
};
</script>
{% endblock %}
