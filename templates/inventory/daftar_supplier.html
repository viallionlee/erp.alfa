{% extends 'base.html' %}
{% block title %}Database Supplier{% endblock %}
{% block content %}
{% csrf_token %}
<h2 class="text-center mb-4"><i class="bi bi-database"></i> Database Supplier</h2>
<div class="d-flex justify-content-center mb-4 gap-2">
    <button class="btn btn-success" id="addSupplierBtn" type="button"><i class="bi bi-plus-circle"></i> Tambah Supplier</button>
    <a href="{% url 'inventory:inbound' %}" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Kembali</a>
</div>
<div class="card shadow-lg mb-4 border-0">
    <div class="card-body">
        <div class="table-responsive">
        <table id="supplier-table" class="table table-hover table-bordered align-middle w-100">
            <thead class="table-primary">
                <tr>
                    <th style="width: 5%; min-width: 60px;">ID</th>
                    <th style="width: 25%; min-width: 200px;">Nama Supplier</th>
                    <th style="width: 15%; min-width: 150px;">Nomor Telepon</th>
                    <th style="width: 25%; min-width: 200px;">Alamat</th>
                    <th style="width: 15%; min-width: 120px;">Kota</th>
                    <th style="width: 10%; min-width: 100px;">Brand</th>
                    <th style="width: 15%; min-width: 120px;">Aksi</th>
                </tr>
                <tr id="filter-row">
                    <th><input type="text" class="form-control form-control-sm" placeholder="Cari ID" /></th>
                    <th><input type="text" class="form-control form-control-sm" placeholder="Cari Nama" /></th>
                    <th><input type="text" class="form-control form-control-sm" placeholder="Cari Telepon" /></th>
                    <th><input type="text" class="form-control form-control-sm" placeholder="Cari Alamat" /></th>
                    <th><input type="text" class="form-control form-control-sm" placeholder="Cari Kota" /></th>
                    <th><input type="text" class="form-control form-control-sm" placeholder="Cari Brand" /></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        </div>
    </div>
</div>

<!-- Modal Tambah/Edit Supplier -->
<div class="modal fade" id="supplierModal" tabindex="-1" aria-labelledby="supplierModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="supplierModalLabel">Tambah Supplier Baru</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="supplierForm">
          <input type="hidden" id="supplier_id" name="supplier_id">
          <div class="mb-3">
            <label for="nama_supplier" class="form-label">Nama Supplier <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="nama_supplier" name="nama_supplier" required>
          </div>
          <div class="mb-3">
            <label for="nomor_telepon" class="form-label">Nomor Telepon</label>
            <input type="text" class="form-control" id="nomor_telepon" name="nomor_telepon">
          </div>
          <div class="mb-3">
            <label for="alamat" class="form-label">Alamat</label>
            <textarea class="form-control" id="alamat" name="alamat" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label for="kota" class="form-label">Kota</label>
            <input type="text" class="form-control" id="kota" name="kota">
          </div>
          <div class="mb-3">
            <label for="brand" class="form-label">Brand</label>
            <input type="text" class="form-control" id="brand" name="brand">
          </div>
          <div class="text-end">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button type="submit" class="btn btn-primary">Simpan</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal Konfirmasi Hapus -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Konfirmasi Hapus</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Apakah Anda yakin ingin menghapus supplier <strong id="deleteSupplierName"></strong>?</p>
        <p class="text-danger"><small>Perhatian: Supplier yang sudah digunakan dalam inbound tidak dapat dihapus.</small></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Hapus</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_script %}
<link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
<style>
    .aksi-btn-group { display: flex; gap: 0.5rem; justify-content: center; }
    @media (max-width: 600px) {
        .aksi-btn-group { flex-direction: column; gap: 0.25rem; }
    }
    #supplier-table th, #supplier-table td {
        font-size: 0.95rem;
        vertical-align: middle;
    }
    #supplier-table {
        table-layout: fixed;
    }
    @media (max-width: 900px) {
        #supplier-table th, #supplier-table td {
            font-size: 0.90rem;
        }
    }
</style>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
<script>
$(document).ready(function() {
    var table = $('#supplier-table').DataTable({
        serverSide: true,
        processing: true,
        ajax: {
            url: '/inventory/supplier/data/',
            type: 'GET',
            data: function(d) {
                $('#filter-row th').each(function(i) {
                    var input = $(this).find('input');
                    if (input.length) {
                        d['columns['+i+'][search][value]'] = input.val();
                    }
                });
            }
        },
        columns: [
            { data: 'id' },
            { data: 'nama_supplier' },
            { data: 'nomor_telepon', defaultContent: '-' },
            { data: 'alamat', defaultContent: '-' },
            { data: 'kota', defaultContent: '-' },
            { data: 'brand', defaultContent: '-' },
            { 
                data: 'id', 
                orderable: false, 
                searchable: false,
                render: function(data, type, row) {
                    return '<div class="aksi-btn-group">' +
                           '<button class="btn btn-sm btn-warning edit-btn" data-id="' + data + '"><i class="bi bi-pencil"></i></button>' +
                           '<button class="btn btn-sm btn-danger delete-btn" data-id="' + data + '" data-nama="' + row.nama_supplier + '"><i class="bi bi-trash"></i></button>' +
                           '</div>';
                }
            }
        ],
        order: [[1, 'asc']], // sort by nama supplier
        pageLength: 25,
        language: {
            url: '/static/datatables/Indonesian.json'
        }
    });

    // Filter input events
    $('#filter-row input').on('keyup change', function() {
        table.draw();
    });

    // Add Supplier Button
    $('#addSupplierBtn').on('click', function() {
        $('#supplierModalLabel').text('Tambah Supplier Baru');
        $('#supplierForm')[0].reset();
        $('#supplier_id').val('');
        $('#supplierModal').modal('show');
    });

    // Edit Supplier
    $(document).on('click', '.edit-btn', function() {
        var supplierId = $(this).data('id');
        $.getJSON('/inventory/supplier/' + supplierId + '/', function(data) {
            $('#supplierModalLabel').text('Edit Supplier');
            $('#supplier_id').val(data.id);
            $('#nama_supplier').val(data.nama_supplier);
            $('#nomor_telepon').val(data.nomor_telepon || '');
            $('#alamat').val(data.alamat || '');
            $('#kota').val(data.kota || '');
            $('#brand').val(data.brand || '');
            $('#supplierModal').modal('show');
        });
    });

    // Delete Supplier
    $(document).on('click', '.delete-btn', function() {
        var supplierId = $(this).data('id');
        var supplierName = $(this).data('nama');
        $('#deleteSupplierName').text(supplierName);
        $('#confirmDeleteBtn').data('id', supplierId);
        $('#deleteModal').modal('show');
    });

    // Confirm Delete
    $('#confirmDeleteBtn').on('click', function() {
        var supplierId = $(this).data('id');
        $.ajax({
            url: '/inventory/supplier/' + supplierId + '/delete/',
            type: 'POST',
            data: {
                csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    $('#deleteModal').modal('hide');
                    table.ajax.reload();
                    alert('Supplier berhasil dihapus!');
                } else {
                    alert('Gagal menghapus supplier: ' + response.error);
                }
            },
            error: function() {
                alert('Terjadi kesalahan saat menghapus supplier!');
            }
        });
    });

    // Form Submit
    $('#supplierForm').on('submit', function(e) {
        e.preventDefault();
        var supplierId = $('#supplier_id').val();
        var url = supplierId ? '/inventory/supplier/' + supplierId + '/edit/' : '/inventory/supplier/add/';
        
        $.ajax({
            url: url,
            type: 'POST',
            data: {
                csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val(),
                nama_supplier: $('#nama_supplier').val(),
                nomor_telepon: $('#nomor_telepon').val(),
                alamat: $('#alamat').val(),
                kota: $('#kota').val(),
                brand: $('#brand').val()
            },
            success: function(response) {
                if (response.success) {
                    $('#supplierModal').modal('hide');
                    table.ajax.reload();
                    alert(supplierId ? 'Supplier berhasil diupdate!' : 'Supplier berhasil ditambahkan!');
                } else {
                    alert('Gagal menyimpan supplier: ' + response.error);
                }
            },
            error: function() {
                alert('Terjadi kesalahan saat menyimpan supplier!');
            }
        });
    });
});
</script>
{% endblock %} 