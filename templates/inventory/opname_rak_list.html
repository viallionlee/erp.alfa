{% extends 'base.html' %}
{% load static %}

{% block title %}Daftar Sesi Opname Rak{% endblock %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.bootstrap5.min.css"/>
<style>
    .status-badge {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    .summary-card {
        transition: transform 0.2s;
    }
    .summary-card:hover {
        transform: translateY(-2px);
    }
    
    /* Tab styling for modal */
    .nav-tabs .nav-link {
        border: none;
        border-bottom: 2px solid transparent;
        color: #6c757d;
        font-weight: 500;
    }
    
    .nav-tabs .nav-link:hover {
        border-color: transparent;
        color: #495057;
    }
    
    .nav-tabs .nav-link.active {
        border-bottom: 2px solid #0d6efd;
        color: #0d6efd;
        background-color: transparent;
    }
    
    .nav-tabs .nav-link:focus {
        box-shadow: none;
    }
    
    /* Action button styling */
    .btn-sm {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
    .btn-warning {
        color: #fff;
        background-color: #ffc107;
        border-color: #ffc107;
    }
    
    .btn-warning:hover {
        color: #fff;
        background-color: #ffca2c;
        border-color: #ffc720;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-1">
                <i class="bi bi-clipboard-check text-primary"></i>
                Daftar Sesi Opname Rak
            </h4>
            <p class="text-muted mb-0">Kelola semua sesi opname rak dalam sistem</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'inventory:rak_stock' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Kembali ke Stok Rak
            </a>
            <a href="{% url 'inventory:full_opname_list' %}" class="btn btn-info">
                <i class="bi bi-clipboard-data"></i> Full Opname Session
            </a>
            <button type="button" class="btn btn-warning text-dark" data-bs-toggle="modal" data-bs-target="#createPartialOpnameModal">
                <i class="bi bi-clipboard-data"></i> Partial Opname Session
            </button>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createSessionModal">
                <i class="bi bi-plus-circle"></i> Buat Sesi Baru
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card summary-card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Sesi Draft</h6>
                            <h3 id="sesiDraft">-</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-pencil-square fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card summary-card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Sesi Berlangsung</h6>
                            <h3 id="sesiBerlangsung">-</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-play-circle fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card summary-card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Sesi Selesai</h6>
                            <h3 id="sesiSelesai">-</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-check-circle fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card summary-card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Selisih</h6>
                            <h3 id="totalSelisih">-</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-exclamation-triangle fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-funnel"></i> Filter & Pencarian
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <label for="statusFilter" class="form-label">Status</label>
                    <select id="statusFilter" class="form-select">
                        <option value="">Semua Status</option>
                        <option value="draft">Draft</option>
                        <option value="in_progress">Sedang Berlangsung</option>
                        <option value="selesai">Selesai</option>
                        <option value="dibatalkan">Dibatalkan</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="rakFilter" class="form-label">Rak</label>
                    <select id="rakFilter" class="form-select">
                        <option value="">Semua Rak</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="dateFilter" class="form-label">Tanggal</label>
                    <input type="date" id="dateFilter" class="form-control">
                </div>
            </div>
        </div>
    </div>

    <!-- Sessions Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-list-ul"></i> Daftar Sesi Opname
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="opnameSessionsTable" class="table table-striped table-hover" style="width:100%">
                    <thead>
                        <tr>
                            <th>Kode Sesi</th>
                            <th>Rak</th>
                            <th>Tipe Session</th>
                            <th>Status</th>
                            <th>Total Items</th>
                            <th>Total Selisih</th>
                            <th>Dibuat Oleh</th>
                            <th>Tanggal Mulai</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data akan dimuat oleh DataTables -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Create Session Modal -->
    <div class="modal fade" id="createSessionModal" tabindex="-1" aria-labelledby="createSessionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="createSessionModalLabel">
                        <i class="bi bi-plus-circle me-2"></i>
                        Buat Sesi Opname Rak Baru
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs" id="opnameModalTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="opname-tab" data-bs-toggle="tab" data-bs-target="#opname-content" type="button" role="tab" aria-controls="opname-content" aria-selected="true">
                            <i class="bi bi-clipboard-check me-1"></i> Reguler Opname
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="rak-tab" data-bs-toggle="tab" data-bs-target="#rak-content" type="button" role="tab" aria-controls="rak-content" aria-selected="false">
                            <i class="bi bi-plus-circle me-1"></i> Buat Rak Baru
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="opnameModalTabContent">
                    <!-- Tab 1: Buat Sesi Opname -->
                    <div class="tab-pane fade show active" id="opname-content" role="tabpanel" aria-labelledby="opname-tab">
                        <form id="createSessionForm">
                            {% csrf_token %}
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="modal_rak_id" class="form-label">
                                        <strong>Pilih Rak <span class="text-danger">*</span></strong>
                                    </label>
                                    <select name="rak_id" id="modal_rak_id" class="form-select" required>
                                        <option value="">-- Pilih Rak --</option>
                                    </select>
                                    <div class="form-text">
                                        Pilih rak yang akan diopname. Pastikan tidak ada sesi draft yang sedang berlangsung untuk rak ini.
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="modal_full_opname_session" class="form-label">
                                        <strong>Full Opname Session (Opsional)</strong>
                                    </label>
                                    <select name="full_opname_session" id="modal_full_opname_session" class="form-select">
                                        <option value="">-- Pilih Full Opname Session --</option>
                                    </select>
                                    <div class="form-text">
                                        Pilih full opname session jika sesi ini adalah bagian dari opname yang lebih besar.
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="modal_catatan" class="form-label">
                                        <strong>Catatan (Opsional)</strong>
                                    </label>
                                    <textarea name="catatan" id="modal_catatan" class="form-control" rows="3" 
                                              placeholder="Catatan tambahan untuk sesi opname ini..."></textarea>
                                    <div class="form-text">
                                        Catatan akan membantu mengidentifikasi tujuan atau alasan opname.
                                    </div>
                                </div>
                                
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>Informasi:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li>Sesi opname akan dibuat dengan status "Draft"</li>
                                        <li>Sistem akan otomatis menambahkan semua produk yang ada stok di rak tersebut</li>
                                        <li>Anda dapat menambah/menghapus produk saat melakukan opname</li>
                                        <li>Setelah selesai, stok rak akan dikoreksi sesuai hasil opname</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x-circle me-1"></i>
                                    Batal
                                </button>
                                <button type="submit" class="btn btn-primary" id="createSessionBtn">
                                    <i class="bi bi-check-circle me-1"></i>
                                    Buat Sesi Opname
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Tab 2: Partial Opname -->
                    
                    <!-- Tab 3: Buat Rak Baru -->
                    <div class="tab-pane fade" id="rak-content" role="tabpanel" aria-labelledby="rak-tab">
                        <form id="createRakForm">
                            {% csrf_token %}
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="kodeRak" class="form-label">
                                        <strong>Kode Rak <span class="text-danger">*</span></strong>
                                    </label>
                                    <input type="text" class="form-control" id="kodeRak" name="kode_rak" required>
                                    <div class="form-text">
                                        Kode unik untuk identifikasi rak (contoh: RAK-001, A1-B2-C3)
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="namaRak" class="form-label">
                                        <strong>Nama Rak <span class="text-danger">*</span></strong>
                                    </label>
                                    <input type="text" class="form-control" id="namaRak" name="nama_rak" required>
                                    <div class="form-text">
                                        Nama deskriptif untuk rak (contoh: Rak Utama, Rak Pending, dll)
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="panjangCm" class="form-label">Panjang (cm)</label>
                                        <input type="number" step="0.01" class="form-control" id="panjangCm" name="panjang_cm" min="0">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="lebarCm" class="form-label">Lebar (cm)</label>
                                        <input type="number" step="0.01" class="form-control" id="lebarCm" name="lebar_cm" min="0">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="tinggiCm" class="form-label">Tinggi (cm)</label>
                                        <input type="number" step="0.01" class="form-control" id="tinggiCm" name="tinggi_cm" min="0">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="kapasitasRak" class="form-label">Kapasitas (kg)</label>
                                    <input type="number" step="0.001" class="form-control" id="kapasitasRak" name="kapasitas_kg" min="0">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="lokasiRak" class="form-label">Lokasi</label>
                                    <input type="text" class="form-control" id="lokasiRak" name="lokasi">
                                    <div class="form-text">
                                        Lokasi fisik rak (contoh: Lantai 1, Area A, dll)
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="deskripsiRak" class="form-label">Keterangan</label>
                                    <textarea class="form-control" id="deskripsiRak" name="keterangan" rows="3" 
                                              placeholder="Keterangan tambahan tentang rak..."></textarea>
                                </div>
                                
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>Informasi:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li>Kode rak dan nama rak wajib diisi</li>
                                        <li>Dimensi dan kapasitas bersifat opsional</li>
                                        <li>Setelah rak dibuat, Anda dapat langsung membuat sesi opname untuk rak tersebut</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x-circle me-1"></i>
                                    Batal
                                </button>
                                <button type="submit" class="btn btn-success" id="createRakBtn">
                                    <i class="bi bi-plus-circle me-1"></i>
                                    Buat Rak
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Partial Opname Modal -->
    <div class="modal fade" id="createPartialOpnameModal" tabindex="-1" aria-labelledby="createPartialOpnameModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="createPartialOpnameModalLabel">
                        <i class="bi bi-clipboard-data me-2"></i>
                        Buat Partial Opname Session
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="createPartialOpnameForm">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Partial Opname:</strong> Semua produk di rak akan otomatis terverifikasi dengan qty fisik = qty sistem. Anda hanya perlu menambah produk yang ingin diopname atau mengubah qty yang ada.
                        </div>
                        
                        <div class="mb-3">
                            <label for="partial_rak_id" class="form-label">
                                <strong>Pilih Rak <span class="text-danger">*</span></strong>
                            </label>
                            <select name="rak_id" id="partial_rak_id" class="form-select" required>
                                <option value="">-- Pilih Rak --</option>
                            </select>
                            <div class="form-text">
                                Pilih rak untuk partial opname. Semua produk akan otomatis terverifikasi dengan qty fisik = qty sistem.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="partial_catatan" class="form-label">
                                <strong>Catatan (Opsional)</strong>
                            </label>
                            <textarea name="catatan" id="partial_catatan" class="form-control" rows="3" 
                                      placeholder="Catatan untuk partial opname ini..."></textarea>
                            <div class="form-text">
                                Jelaskan tujuan atau alasan partial opname ini.
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Cara Kerja Partial Opname:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Semua produk di rak akan otomatis terverifikasi</li>
                                <li>Qty fisik akan diset sama dengan qty sistem (selisih = 0)</li>
                                <li>Anda dapat menambah produk baru untuk diopname</li>
                                <li>Anda dapat mengubah qty fisik produk yang sudah ada</li>
                                <li>Cocok untuk opname selektif atau koreksi stok tertentu</li>
                            </ul>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i>
                            Batal
                        </button>
                        <button type="submit" class="btn btn-warning" id="createPartialOpnameBtn">
                            <i class="bi bi-clipboard-data me-1"></i>
                            Buat Partial Opname
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script type="text/javascript" src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
<script type="text/javascript" src=""></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.bootstrap5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>

<script>
    let opnameSessionsTable;

    $(document).ready(function() {
        // Load summary data
        loadSummary();
        
        // Load rak options
        loadRakOptions();
        
        // Load full opname sessions for modal
        loadFullOpnameSessions();
        
        // Initialize DataTable
        initializeDataTable();
        
        // Handle filter changes
        $('#statusFilter, #rakFilter, #dateFilter').on('change', function() {
            opnameSessionsTable.ajax.reload();
        });

        // Handle create session form
        $('#createSessionForm').on('submit', function(e) {
            e.preventDefault();
            createNewSession();
        });

        // Handle create partial opname form
        $('#createPartialOpnameForm').on('submit', function(e) {
            e.preventDefault();
            createPartialOpname();
        });

        // Handle create rak form
        $('#createRakForm').on('submit', function(e) {
            e.preventDefault();
            createNewRak();
        });

        // Load rak options for modal
        loadModalRakOptions();
        
        // Handle tab switching to refresh rak options
        $('#opname-tab').on('shown.bs.tab', function() {
            loadModalRakOptions();
        });
        
        $('#createPartialOpnameModal').on('show.bs.modal', function() {
            loadPartialRakOptions();
        });
    });

    function loadModalRakOptions() {
        $.ajax({
            url: '{% url "inventory:rak_data" %}',
            method: 'GET',
            data: { get_rak_options: true },
            success: function(response) {
                if (response.rak_options) {
                    var select = $('#modal_rak_id');
                    select.empty();
                    select.append('<option value="">-- Pilih Rak --</option>');
                    
                    // Tambahkan optgroup sebagai header
                    var optgroup = $('<optgroup label="Rak Tersedia"></optgroup>');
                    
                    // Tambahkan baris header di dalam optgroup
                    optgroup.append('<option value="" disabled><strong>Kode Rak</strong> - <strong>Nama Rak</strong> - <strong>Lokasi Rak</strong></option>');
                    
                    // Urutkan opsi rak berdasarkan kode_rak
                    response.rak_options.sort(function(a, b) {
                        var kodeA = a.kode_rak.toUpperCase();
                        var kodeB = b.kode_rak.toUpperCase();
                        if (kodeA < kodeB) { return -1; }
                        if (kodeA > kodeB) { return 1; }
                        return 0;
                    });
                    
                    response.rak_options.forEach(function(rak) {
                        const lokasiPart = (rak.lokasi && rak.lokasi !== '-') ? `Lokasi <span style="color: blue;">${rak.lokasi}</span>` : 'Lokasi <span style="color: grey;">Belum Ditentukan</span>';
                        const displayText = `<strong>Kode</strong> <span style="color: blue;">${rak.kode_rak}</span> - <strong>Nama</strong> <span style="color: blue;">${rak.nama_rak}</span> - ${lokasiPart}`;
                        optgroup.append('<option value="' + rak.id + '">' + displayText + '</option>');
                    });
                    select.append(optgroup); // Tambahkan optgroup ke select
                }
            },
            error: function() {
                console.log('Gagal memuat opsi rak untuk modal');
            }
        });
    }

    function loadPartialRakOptions() {
        $.ajax({
            url: '{% url "inventory:rak_data" %}',
            method: 'GET',
            data: { get_rak_options: true },
            success: function(response) {
                if (response.rak_options) {
                    var select = $('#partial_rak_id');
                    select.empty();
                    select.append('<option value="">-- Pilih Rak --</option>');
                    
                    // Tambahkan optgroup sebagai header
                    var optgroup = $('<optgroup label="Rak Tersedia"></optgroup>');
                    
                    // Tambahkan baris header di dalam optgroup
                    optgroup.append('<option value="" disabled><strong>Kode Rak</strong> - <strong>Nama Rak</strong> - <strong>Lokasi Rak</strong></option>');
                    
                    // Urutkan opsi rak berdasarkan kode_rak
                    response.rak_options.sort(function(a, b) {
                        var kodeA = a.kode_rak.toUpperCase();
                        var kodeB = b.kode_rak.toUpperCase();
                        if (kodeA < kodeB) { return -1; }
                        if (kodeA > kodeB) { return 1; }
                        return 0;
                    });
                    
                    response.rak_options.forEach(function(rak) {
                        const lokasiPart = (rak.lokasi && rak.lokasi !== '-') ? `Lokasi <span style="color: blue;">${rak.lokasi}</span>` : 'Lokasi <span style="color: grey;">Belum Ditentukan</span>';
                        const displayText = `<strong>Kode</strong> <span style="color: blue;">${rak.kode_rak}</span> - <strong>Nama</strong> <span style="color: blue;">${rak.nama_rak}</span> - ${lokasiPart}`;
                        optgroup.append('<option value="' + rak.id + '">' + displayText + '</option>');
                    });
                    select.append(optgroup); // Tambahkan optgroup ke select
                }
            },
            error: function() {
                console.log('Gagal memuat opsi rak untuk partial opname');
            }
        });
    }

    function createPartialOpname() {
        var rakId = $('#partial_rak_id').val();
        var catatan = $('#partial_catatan').val();
        
        if (!rakId) {
            alert('Silakan pilih rak terlebih dahulu');
            $('#partial_rak_id').focus();
            return;
        }

        // Disable submit button
        $('#createPartialOpnameBtn').prop('disabled', true).html('<i class="bi bi-hourglass-split me-1"></i>Membuat Partial Opname...');

        $.ajax({
            url: '{% url "inventory:partial_opname_create" %}',
            method: 'POST',
            data: {
                rak_id: rakId,
                catatan: catatan,
                csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    // Show success message
                    showToast('success', 'Berhasil', response.message);
                    
                    // Close modal
                    $('#createPartialOpnameModal').modal('hide');
                    
                    // Reset form
                    $('#createPartialOpnameForm')[0].reset();
                    
                    // Reload table and summary
                    opnameSessionsTable.ajax.reload();
                    loadSummary();
                    
                    // Redirect to work page if needed
                    if (response.redirect_url) {
                        setTimeout(function() {
                            window.location.href = response.redirect_url;
                        }, 1500);
                    }
                } else {
                    showToast('error', 'Gagal', response.message);
                }
            },
            error: function(xhr) {
                var message = 'Terjadi kesalahan saat membuat partial opname';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    message = xhr.responseJSON.message;
                }
                showToast('error', 'Gagal', message);
            },
            complete: function() {
                // Re-enable submit button
                $('#createPartialOpnameBtn').prop('disabled', false).html('<i class="bi bi-clipboard-data me-1"></i>Buat Partial Opname');
            }
        });
    }

    function createNewSession() {
        var rakId = $('#modal_rak_id').val();
        var catatan = $('#modal_catatan').val();
        var fullOpnameSessionId = $('#modal_full_opname_session').val();
        
        if (!rakId) {
            alert('Silakan pilih rak terlebih dahulu');
            $('#modal_rak_id').focus();
            return;
        }

        // Disable submit button
        $('#createSessionBtn').prop('disabled', true).html('<i class="bi bi-hourglass-split me-1"></i>Membuat Sesi...');

        $.ajax({
            url: '{% url "inventory:opname_rak_create" %}',
            method: 'POST',
            data: {
                rak_id: rakId,
                catatan: catatan,
                full_opname_session_id: fullOpnameSessionId,
                csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    // Show success message
                    showToast('success', 'Berhasil', response.message);
                    
                    // Close modal
                    $('#createSessionModal').modal('hide');
                    
                    // Reset form
                    $('#createSessionForm')[0].reset();
                    
                    // Reload table and summary
                    opnameSessionsTable.ajax.reload();
                    loadSummary();
                    
                    // Redirect to work page if needed
                    if (response.redirect_url) {
                        setTimeout(function() {
                            window.location.href = response.redirect_url;
                        }, 1500);
                    }
                } else {
                    showToast('error', 'Gagal', response.message);
                }
            },
            error: function(xhr) {
                var message = 'Terjadi kesalahan saat membuat sesi opname';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    message = xhr.responseJSON.message;
                }
                showToast('error', 'Gagal', message);
            },
            complete: function() {
                // Re-enable submit button
                $('#createSessionBtn').prop('disabled', false).html('<i class="bi bi-check-circle me-1"></i>Buat Sesi Opname');
            }
        });
    }

    function createNewRak() {
        var kodeRak = $('#kodeRak').val();
        var namaRak = $('#namaRak').val();
        
        if (!kodeRak || !namaRak) {
            alert('Kode rak dan nama rak wajib diisi');
            return;
        }

        // Disable submit button
        $('#createRakBtn').prop('disabled', true).html('<i class="bi bi-hourglass-split me-1"></i>Membuat Rak...');

        $.ajax({
            url: '{% url "inventory:rak_add" %}',
            method: 'POST',
            data: {
                kode_rak: kodeRak,
                nama_rak: namaRak,
                panjang_cm: $('#panjangCm').val(),
                lebar_cm: $('#lebarCm').val(),
                tinggi_cm: $('#tinggiCm').val(),
                kapasitas_kg: $('#kapasitasRak').val(),
                lokasi: $('#lokasiRak').val(),
                keterangan: $('#deskripsiRak').val(),
                csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    // Show success message
                    showToast('success', 'Berhasil', response.message);
                    
                    // Reset form
                    $('#createRakForm')[0].reset();
                    
                    // Reload rak options in both dropdowns
                    loadModalRakOptions();
                    loadRakOptions();
                    
                    // Switch back to opname tab and select the newly created rak
                    $('#opname-tab').tab('show');
                    
                    // Wait a bit for the dropdown to be populated, then select the new rak
                    setTimeout(function() {
                        var select = $('#modal_rak_id');
                        var newRakOption = select.find('option').filter(function() {
                            return $(this).text().includes(kodeRak);
                        });
                        if (newRakOption.length > 0) {
                            newRakOption.prop('selected', true);
                        }
                    }, 500);
                    
                } else {
                    showToast('error', 'Gagal', response.error || 'Gagal membuat rak');
                }
            },
            error: function(xhr) {
                var message = 'Terjadi kesalahan saat membuat rak';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    message = xhr.responseJSON.error;
                }
                showToast('error', 'Gagal', message);
            },
            complete: function() {
                // Re-enable submit button
                $('#createRakBtn').prop('disabled', false).html('<i class="bi bi-plus-circle me-1"></i>Buat Rak');
            }
        });
    }

    function showToast(type, title, message) {
        // Simple toast implementation - you can replace with your preferred toast library
        var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        var icon = type === 'success' ? 'bi-check-circle' : 'bi-exclamation-triangle';
        
        var toastHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
                 style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">
                <i class="bi ${icon} me-2"></i>
                <strong>${title}:</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        
        $('body').append(toastHtml);
        
        // Auto remove after 5 seconds
        setTimeout(function() {
            $('.alert').fadeOut(function() {
                $(this).remove();
            });
        }, 5000);
    }

    function loadSummary() {
        $.ajax({
            url: '{% url "inventory:opname_rak_summary" %}',
            method: 'GET',
            success: function(data) {
                $('#sesiDraft').text(data.sesi_draft || 0);
                $('#sesiBerlangsung').text(data.sesi_berlangsung || 0);
                $('#sesiSelesai').text(data.sesi_selesai || 0);
                $('#totalSelisih').text(data.total_selisih || 0);
            },
            error: function() {
                console.log('Gagal memuat summary data');
            }
        });
    }

    function loadRakOptions() {
        $.ajax({
            url: '{% url "inventory:rak_data" %}',
            method: 'GET',
            data: { get_rak_options: true },
            success: function(response) {
                if (response.rak_options) {
                    var select = $('#rakFilter');
                    select.empty();
                    select.append('<option value="">Semua Rak</option>');
                    
                    response.rak_options.forEach(function(rak) {
                        select.append('<option value="' + rak.id + '">' + rak.kode_rak + ' - ' + rak.nama_rak + '</option>');
                    });
                }
            },
            error: function() {
                console.log('Gagal memuat opsi rak');
            }
        });
    }

    function loadFullOpnameSessions() {
        $.ajax({
            url: '{% url "inventory:full_opname_sessions_api" %}',
            method: 'GET',
            success: function(response) {
                if (response.success && response.full_sessions) {
                    var select = $('#modal_full_opname_session');
                    select.empty();
                    select.append('<option value="">-- Pilih Full Opname Session --</option>');
                    
                    response.full_sessions.forEach(function(session) {
                        select.append('<option value="' + session.id + '">' + session.display_text + '</option>');
                    });
                }
            },
            error: function() {
                console.log('Gagal memuat full opname sessions');
            }
        });
    }

    function initializeDataTable() {
        opnameSessionsTable = $('#opnameSessionsTable').DataTable({
            "processing": true,
            "serverSide": true,
            "ajax": {
                "url": "{% url 'inventory:opname_rak_list' %}",
                "type": "GET",
                "data": function(d) {
                    var statusFilter = $('#statusFilter').val();
                    var rakFilter = $('#rakFilter').val();
                    var dateFilter = $('#dateFilter').val();
                    
                    if (statusFilter) {
                        d.status = statusFilter;
                    }
                    if (rakFilter) {
                        d.rak = rakFilter;
                    }
                    if (dateFilter) {
                        d.date = dateFilter;
                    }
                    return d;
                },
                "error": function(xhr, error, thrown) {
                    console.log('DataTables error:', error, thrown);
                    alert('Terjadi kesalahan saat memuat data. Silakan refresh halaman.');
                }
            },
            "dom": "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
                   "<'row'<'col-sm-12'tr>>" +
                   "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>" +
                   "<'d-none'B>",
            "buttons": [
                {
                    extend: 'excelHtml5',
                    title: 'Daftar Sesi Opname Rak - ' + new Date().toLocaleDateString('id-ID'),
                    exportOptions: {
                        columns: [0, 1, 2, 3, 4, 5, 6, 7]
                    }
                }
            ],
            "columns": [
                { "data": "session_code" },
                { "data": "rak_lokasi" },
                { 
                    "data": "tipe_session",
                    "render": function(data, type, row) {
                        if (type === 'display') {
                            var badgeClass = '';
                            var text = '';
                            switch(data) {
                                case 'full_opname':
                                    badgeClass = 'bg-primary';
                                    text = 'Full Opname';
                                    break;
                                case 'reguler_opname':
                                    badgeClass = 'bg-info';
                                    text = 'Reguler Opname';
                                    break;
                                case 'partial_opname':
                                    badgeClass = 'bg-warning';
                                    text = 'Partial Opname';
                                    break;
                                default:
                                    badgeClass = 'bg-secondary';
                                    text = data || 'Reguler Opname';
                            }
                            return '<span class="badge ' + badgeClass + ' status-badge">' + text + '</span>';
                        }
                        return data;
                    }
                },
                { 
                    "data": "status",
                    "render": function(data, type, row) {
                        if (type === 'display') {
                            var statusClass = '';
                            var statusText = '';
                            switch(data) {
                                case 'draft':
                                    statusClass = 'bg-warning';
                                    statusText = 'Draft';
                                    break;
                                case 'in_progress':
                                    statusClass = 'bg-info';
                                    statusText = 'Sedang Berlangsung';
                                    break;
                                case 'selesai':
                                    statusClass = 'bg-success';
                                    statusText = 'Selesai';
                                    break;
                                case 'dibatalkan':
                                    statusClass = 'bg-danger';
                                    statusText = 'Dibatalkan';
                                    break;
                                default:
                                    statusClass = 'bg-secondary';
                                    statusText = data;
                            }
                            return '<span class="badge ' + statusClass + ' status-badge">' + statusText + '</span>';
                        }
                        return data;
                    }
                },
                { "data": "total_items" },
                { 
                    "data": "total_selisih",
                    "render": function(data, type, row) {
                        if (type === 'display') {
                            var selisih = parseInt(data);
                            var badgeClass = selisih > 0 ? 'bg-danger' : selisih < 0 ? 'bg-warning' : 'bg-success';
                            var sign = selisih > 0 ? '+' : '';
                            return '<span class="badge ' + badgeClass + '">' + sign + data + '</span>';
                        }
                        return data;
                    }
                },
                { "data": "created_by_username" },
                { "data": "tanggal_mulai" },
                { 
                    "data": null,
                    "render": function(data, type, row) {
                        if (type === 'display') {
                            var buttons = '<div class="d-flex gap-1 flex-nowrap">';
                            
                            if (row.status === 'draft') {
                                buttons += '<a href="/inventory/opname-rak/' + row.id + '/work/" class="btn btn-sm btn-primary" title="Kerja">';
                                buttons += '<i class="bi bi-pencil"></i></a>';
                                buttons += '<a href="/inventory/opname-rak/' + row.id + '/cancel/" class="btn btn-sm btn-danger" title="Batal">';
                                buttons += '<i class="bi bi-x-circle"></i></a>';
                            } else if (row.status === 'in_progress') {
                                buttons += '<a href="/inventory/opname-rak/' + row.id + '/work/" class="btn btn-sm btn-warning" title="Lanjutkan Kerja">';
                                buttons += '<i class="bi bi-play-circle"></i></a>';
                                buttons += '<a href="/inventory/opname-rak/' + row.id + '/cancel/" class="btn btn-sm btn-danger" title="Batal">';
                                buttons += '<i class="bi bi-x-circle"></i></a>';
                            } else if (row.status === 'selesai') {
                                buttons += '<a href="/inventory/opname-rak/' + row.id + '/detail/" class="btn btn-sm btn-info" title="Detail">';
                                buttons += '<i class="bi bi-eye"></i></a>';
                            } else if (row.status === 'dibatalkan') {
                                buttons += '<span class="text-muted"><i class="bi bi-x-circle"></i> Dibatalkan</span>';
                            }
                            
                            buttons += '</div>';
                            return buttons;
                        }
                        return '';
                    }
                }
            ],
            "language": {
                "lengthMenu": "Tampilkan _MENU_ entri",
                "zeroRecords": "Tidak ada data yang ditemukan",
                "info": "Menampilkan _START_ sampai _END_ dari _TOTAL_ entri",
                "infoEmpty": "Menampilkan 0 sampai 0 dari 0 entri",
                "infoFiltered": "(difilter dari _MAX_ total entri)",
                "search": "Cari:",
                "paginate": {
                    "first": "Pertama",
                    "last": "Terakhir",
                    "next": "Selanjutnya",
                    "previous": "Sebelumnya"
                },
                "processing": "Memproses...",
                "searchPlaceholder": "Cari kode sesi, rak, atau user..."
            },
            "order": [[7, "desc"]], // Sort by tanggal_mulai descending
            "pageLength": 25,
            "searching": true,
            "ordering": true,
            "info": true,
            "responsive": true,
            "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Semua"]]
        });
    }
</script>
{% endblock %}
