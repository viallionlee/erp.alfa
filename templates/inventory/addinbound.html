{% extends 'base.html' %}
{% block title %}Tambah Inbound Baru{% endblock %}
{% block content %}
<style>
    .modern-form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 4px;
    }
    .modern-form-row {
        display: flex;
        gap: 1rem;
        align-items: flex-end;
        margin-bottom: 1.2rem;
        flex-wrap: wrap;
    }
    .modern-form-row > .form-group {
        flex: 1 1 0;
        min-width: 180px;
    }
    .modern-form-row .input-group {
        width: 100%;
    }
    .modern-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.07);
        padding: 2rem 2.5rem 1.5rem 2.5rem;
        max-width: 1200px;
        margin: 0 auto;
    }
    #search-result-box {
        min-width: 320px;
        font-size: 0.95em;
    }
    @media (max-width: 600px) {
        .modern-card { padding: 1rem; }
        .modern-form-row { flex-direction: column; gap: 0.5rem; }
    }
</style>
<div class="container mt-4">
    <div class="card shadow-sm" style="max-width: 1200px; margin: auto;">
        <div class="card-header" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#inboundFormBody" aria-expanded="true" aria-controls="inboundFormBody">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Tambah Inbound</h5>
                <button class="btn btn-sm btn-outline-secondary p-1" type="button" style="line-height: 1; border-radius: 0.5rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-dash-lg" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M2 8a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11A.5.5 0 0 1 2 8z"/>
                    </svg>
                </button>
            </div>
        </div>
        <div class="collapse show" id="inboundFormBody">
            <div class="card-body" style="padding: 2rem 2.5rem 1.5rem 2.5rem;">
                <form method="post" id="add-inbound-form">
                    {% csrf_token %}
                    <!-- Row 1: Tanggal, Supplier, Nomor Inbound (inline) -->
                    <div class="modern-form-row">
                        <div class="form-group">
                            <label class="modern-form-label" for="tanggal">Tanggal</label>
                            <input type="datetime-local" name="tanggal" id="tanggal" class="form-control" required value="{{ default_tanggal }}">
                        </div>
                        <div class="form-group">
                            <label class="modern-form-label" for="nama_supplier">Nama Supplier <span style="color:red">*</span></label>
                            <div class="input-group">
                                <input type="text" name="nama_supplier" id="nama_supplier" class="form-control" required readonly aria-label="Nama Supplier">
                                <button class="btn btn-outline-primary" type="button" id="pilih_supplier_btn" aria-label="Pilih Supplier" aria-haspopup="dialog">Pilih</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="modern-form-label" for="nomor_inbound">Nomor Inbound</label>
                            <input type="text" name="nomor_inbound" id="nomor_inbound" class="form-control" required value="{{ default_nomor_inbound }}">
                        </div>
                    </div>
                    <!-- Row 2: Keterangan -->
                    <div class="modern-form-row">
                        <div class="form-group" style="flex:2;">
                            <label class="modern-form-label" for="keterangan">Keterangan</label>
                            <textarea name="keterangan" id="keterangan" class="form-control" rows="1" placeholder="Keterangan tambahan (opsional)"></textarea>
                        </div>
                    </div>
                    <!-- Row 3: Cari Produk -->
                    <div class="modern-form-row">
                        <div class="form-group" style="flex:2; position:relative;">
                            <label class="modern-form-label" for="produk_search">Cari Produk</label>
                            <div class="input-group mb-1">
                                <input type="text" id="produk_search" class="form-control" placeholder="Cari SKU / Barcode / Nama / Brand / Variant" autocomplete="off" aria-label="Cari Produk">
                                <button class="btn btn-outline-secondary" type="button" id="produk_search_btn" aria-label="Cari Produk">Cari</button>
                            </div>
                            <div id="search-result-box" class="border rounded mt-1 bg-white shadow-sm" style="display:none; position:absolute; z-index:10; min-width:100%; max-width:100vw; overflow-x:auto; max-height:180px; overflow-y:auto;">
                              <table class="table table-sm mb-0"><thead><tr style="background:#f8f9fa;"><th>SKU</th><th>Barcode</th><th>Nama</th><th>Variant</th><th>Brand</th></tr></thead><tbody></tbody></table>
                            </div>
                        </div>
                    </div>
                    <!-- Produk Table -->
                    <div class="table-responsive mt-3">
                        <table class="table table-bordered align-middle" id="produk-table">
                            <thead class="table-light">
                                <tr>
                                    <th>SKU</th>
                                    <th>Barcode</th>
                                    <th>Nama Produk</th>
                                    <th>Variant</th>
                                    <th>Brand</th>
                                    <th>Stok</th>
                                    <th>Jumlah</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Baris produk akan muncul di sini -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3 text-center">
                        <button type="submit" class="btn btn-primary px-4">Simpan Inbound</button>
                        <a href="{% url 'inventory:inbound' %}" class="btn btn-secondary ms-2">Batal</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Modal Pilih Supplier -->
<div class="modal fade" id="supplierModal" tabindex="-1" aria-labelledby="supplierModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="supplierModalLabel">Pilih Supplier</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="search_supplier" class="form-control mb-2" placeholder="Cari nama/alamat supplier...">
        <div id="supplier-list" class="list-group" style="max-height:300px;overflow-y:auto;"></div>
        <div class="mt-2 text-end">
          <a href="#" id="addSupplierLink">+ Tambah Supplier Baru</a>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Modal Tambah Supplier Baru -->
<div class="modal fade" id="addSupplierModal" tabindex="-1" aria-labelledby="addSupplierModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addSupplierModalLabel">Tambah Supplier Baru</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label>Nama Supplier</label>
          <input type="text" id="new_nama_supplier" class="form-control" required>
        </div>
        <div class="mb-2">
          <label>Alamat</label>
          <textarea id="new_alamat_supplier" class="form-control"></textarea>
        </div>
        <div class="mb-2">
          <label>Kota</label>
          <input type="text" id="new_kota_supplier" class="form-control">
        </div>
        <div class="mb-2">
          <label>Kode Pos</label>
          <input type="text" id="new_kode_pos_supplier" class="form-control">
        </div>
        <div class="text-end">
          <button type="button" class="btn btn-primary" id="saveSupplierBtn">Simpan</button>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
// ----- global state untuk navigasi -----
let selectedIdx = -1;
let currentRows = [];

function updateSearchResultHighlight() {
  currentRows.forEach(r => r.classList.remove('table-active'));
  if (selectedIdx >= 0 && selectedIdx < currentRows.length) {
    currentRows[selectedIdx].classList.add('table-active');
  }
}

// Set default tanggal hari ini
$(function() {
    let now = new Date();
    let pad = n => n < 10 ? '0'+n : n;
    let tglStr = now.getFullYear() + '-' + pad(now.getMonth()+1) + '-' + pad(now.getDate()) + 'T' + pad(now.getHours()) + ':' + pad(now.getMinutes());
    $('#tanggal').val(tglStr);
});

// --- SEARCH PRODUK DENGAN SEARCH-RESULT-BOX (SAMA DENGAN INBOUND/ORDER) ---
function searchProdukManual(keyword, callback) {
  $.getJSON('/inventory/produk-lookup', {q: keyword, mode: 'manual', page_size: 1000}, function(data) {
    callback(data);
  }).fail(function() {
    callback([]);
  });
}

function tambahAtauUpdateProduk(produk, stok) {
  let $row = $('#produk-table tbody tr[data-sku="' + produk.sku + '"]');
  if ($row.length) {
    let $qty = $row.find('.qty-input');
    $qty.val(parseInt($qty.val()) + 1);
  } else {
    $('#produk-table tbody').append(`
      <tr data-sku="${produk.sku}">
        <td><input type="hidden" name="produk_sku[]" value="${produk.sku}">${produk.sku}</td>
        <td>${produk.barcode}</td>
        <td>${produk.nama}</td>
        <td>${produk.variant}</td>
        <td>${produk.brand}</td>
        <td>${stok || 0}</td>
        <td><input type="number" name="produk_qty[]" class="form-control qty-input" value="1" min="1" style="width:70px;"></td>
        <td><button type="button" class="btn btn-danger btn-sm hapus-row">Hapus</button></td>
      </tr>
    `);
  }
}

function renderSearchResultBox(list) {
  selectedIdx = -1;
  let html = '';
  if (Array.isArray(list) && list.length > 0) {
    html = '<table class="table table-sm mb-0"><tbody>';
    list.forEach(function(produk) {
      html += `<tr class="pilih-produk" style="cursor:pointer;"
        data-sku="${produk.sku}"
        data-barcode="${produk.barcode}"
        data-nama="${produk.nama}"
        data-variant="${produk.variant}"
        data-brand="${produk.brand}">
        <td>${produk.sku}</td>
        <td>${produk.barcode}</td>
        <td>${produk.nama}</td>
        <td>${produk.variant}</td>
        <td>${produk.brand}</td>
      </tr>`;
    });
    html += '</tbody></table>';
  } else {
    html = '<div class="p-2 text-danger">Produk tidak ditemukan!</div>';
  }
  $('#search-result-box').html(html).show();
  currentRows = Array.from(document.querySelectorAll('#search-result-box tr.pilih-produk'));
  updateSearchResultHighlight();
}

$('#search-result-box').on('mousedown', function(e) {
    e.stopPropagation();
});

$('#produk_search_btn').off('click').on('click', function() {
    let keyword = $('#produk_search').val().trim();
    if (!keyword) return;
    searchProdukManual(keyword, renderSearchResultBox);
});
$('#produk_search').off('input').on('input', function() {
    let keyword = $(this).val().trim();
    if (!keyword) {
        $('#search-result-box').hide();
        return;
    }
    searchProdukManual(keyword, renderSearchResultBox);
});
$('#produk_search').off('keydown').on('keydown', function(e) {
  if (!$('#search-result-box').is(':visible')) return;
  if (currentRows.length === 0) return;
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    selectedIdx = (selectedIdx + 1) % currentRows.length;
    updateSearchResultHighlight();
    currentRows[selectedIdx].scrollIntoView({block:'nearest'});
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    selectedIdx = (selectedIdx - 1 + currentRows.length) % currentRows.length;
    updateSearchResultHighlight();
    currentRows[selectedIdx].scrollIntoView({block:'nearest'});
  } else if (e.key === 'Enter') {
    e.preventDefault();
    if (selectedIdx >= 0) {
      $(currentRows[selectedIdx]).trigger('click');
      $('#search-result-box').hide();
    }
  }
});
function resetSearchResultHighlight() {
  selectedIdx = -1;
  currentRows = $('#search-result-box tr.pilih-produk');
  updateSearchResultHighlight();
}
let oldShow = $.fn.show;
$.fn.show = function() {
  let result = oldShow.apply(this, arguments);
  if (this.attr('id') === 'search-result-box') {
    setTimeout(resetSearchResultHighlight, 10);
  }
  return result;
};
$('#search-result-box').on('click', '.pilih-produk', function() {
    let produk = {
        sku: $(this).data('sku'),
        barcode: $(this).data('barcode'),
        nama: $(this).data('nama'),
        variant: $(this).data('variant'),
        brand: $(this).data('brand')
    };
    $.getJSON('/inventory/data/', {columns: JSON.stringify([{search:{value:produk.sku}}])}, function(resp) {
        let stok = 0;
        if (resp.data && resp.data.length > 0) {
            stok = resp.data[0][5] || 0;
        }
        tambahAtauUpdateProduk(produk, stok);
        $('#produk_search').val('');
        $('#search-result-box').hide();
        $('#produk_search').focus();
    });
});
$(document).on('click', function(e) {
    if (!$(e.target).closest('#search-result-box, #produk_search, #produk_search_btn').length) {
        $('#search-result-box').hide();
    }
});
$('#produk-table').off('click', '.hapus-row').on('click', '.hapus-row', function() {
  $(this).closest('tr').remove();
});
$('#pilih_supplier_btn').on('click', function() {
    $('#supplierModal').modal('show');
    loadSupplierList('');
});
$('#search_supplier').on('input', function() {
    loadSupplierList($(this).val());
});
$('#addSupplierLink').on('click', function(e) {
    e.preventDefault();
    $('#supplierModal').modal('hide');
    $('#addSupplierModal').modal('show');
});
$('#saveSupplierBtn').on('click', function() {
    let nama = $('#new_nama_supplier').val().trim();
    if (!nama) { alert('Nama supplier wajib diisi!'); return; }
    $.post('/inventory/add_supplier/', {
        nama_supplier: nama,
        alamat_supplier: $('#new_alamat_supplier').val(),
        kota_supplier: $('#new_kota_supplier').val(),
        kode_pos_supplier: $('#new_kode_pos_supplier').val(),
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
    }, function(resp) {
        $('#addSupplierModal').modal('hide');
        $('#nama_supplier').val(resp.nama_supplier);
    });
});
function loadSupplierList(keyword) {
    $.getJSON('/inventory/search_supplier/', {q: keyword}, function(list) {
        let html = '';
        if (list.length === 0) html = '<div class="text-danger">Tidak ada supplier ditemukan</div>';
        list.forEach(function(sup) {
            html += `<div class='list-group-item list-group-item-action pilih-sup' style='cursor:pointer;' data-nama='${sup.nama_supplier}'>
                <b>${sup.nama_supplier}</b><br><small>${sup.alamat_supplier||''} ${sup.kota_supplier||''} ${sup.kode_pos_supplier||''}</small>
            </div>`;
        });
        $('#supplier-list').html(html);
    });
}
$('#supplier-list').on('click', '.pilih-sup', function() {
    $('#nama_supplier').val($(this).data('nama'));
    $('#supplierModal').modal('hide');
});
</script>
{% endblock %}
