{% extends 'base_mobile.html' %}
{% block title %}Daftar Inbound{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0"><i class="bi bi-box-arrow-in-down me-2"></i>Daftar Inbound</h4>
        <a href="{% url 'inventory:inbound' %}" class="btn btn-sm btn-outline-secondary" title="Mode Desktop">
            <i class="bi bi-display"></i>
        </a>
    </div>

    <div class="d-grid gap-2 mb-3">
        <a href="{% url 'inventory:inbound_tambah' %}" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Tambah Inbound</a>
    </div>

    <div class="mb-3">
        <input type="text" id="search-input" class="form-control" placeholder="Cari nomor inbound atau supplier...">
    </div>

    <div id="inbound-list" class="list-container">
        {% include 'inventory/partials/inbound_cards.html' %}
    </div>
    
    <div id="loading-indicator" style="display: none;" class="text-center my-3">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div id="load-more-container" class="d-grid gap-2 my-3">
        {% if inbound_list.has_next %}
        <button id="load-more-btn" class="btn btn-outline-primary">Muat Lebih Banyak</button>
        {% endif %}
    </div>
</div>

<!-- Floating Add Button -->
<a href="{% url 'inventory:inbound_tambah' %}" class="btn btn-primary rounded-circle shadow-lg d-flex align-items-center justify-content-center" title="Tambah Inbound Baru" style="position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; z-index: 1050;">
    <i class="bi bi-plus-lg fs-4"></i>
</a>
{% endblock %}

{% block extra_script %}
<style>
    .inbound-card-link { text-decoration: none; color: inherit; }
    .inbound-card {
        background-color: #fff; border: 1px solid #e9ecef; border-radius: 0.5rem;
        padding: 0.75rem 1rem; margin-bottom: 0.75rem; box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        display: flex; flex-direction: column;
    }
    .inbound-card-header { display: flex; justify-content-between; align-items: flex-start; margin-bottom: 0.5rem; }
    .inbound-card-header h6 { font-size: 0.95rem; font-weight: 600; color: var(--bs-primary); margin: 0; }
    .inbound-card-meta { font-size: 0.8rem; color: #6c757d; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const inboundList = document.getElementById('inbound-list');
    const loadMoreContainer = document.getElementById('load-more-container');
    const loadingIndicator = document.getElementById('loading-indicator');
    let loadMoreBtn = document.getElementById('load-more-btn');
    let page = 2;
    let isLoading = false;

    function fetchInbounds() {
        if (isLoading) return;
        isLoading = true;
        loadingIndicator.style.display = 'block';
        if(loadMoreBtn) loadMoreBtn.style.display = 'none';

        const query = searchInput.value;
        const url = `{% url 'inventory:inbound_list_api' %}?page=${page}&query=${encodeURIComponent(query)}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                inboundList.insertAdjacentHTML('beforeend', data.html);
                if (data.has_more) {
                    page++;
                    if(loadMoreBtn) loadMoreBtn.style.display = 'block';
                } else {
                    loadMoreContainer.innerHTML = '<p class="text-center text-muted">Sudah mencapai akhir.</p>';
                }
            })
            .catch(error => console.error('Error fetching inbounds:', error))
            .finally(() => {
                isLoading = false;
                loadingIndicator.style.display = 'none';
            });
    }

    if(loadMoreBtn) {
        loadMoreBtn.addEventListener('click', fetchInbounds);
    }
    
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            page = 1; // Reset page
            isLoading = true;
            loadingIndicator.style.display = 'block';
            loadMoreContainer.innerHTML = ''; // Clear load more button
            
            const query = searchInput.value;
            const url = `{% url 'inventory:inbound_list_api' %}?page=${page}&query=${encodeURIComponent(query)}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    inboundList.innerHTML = data.html;
                    if (data.has_more) {
                        page = 2; // Set next page
                        loadMoreContainer.innerHTML = '<button id="load-more-btn" class="btn btn-outline-primary">Muat Lebih Banyak</button>';
                        loadMoreBtn = document.getElementById('load-more-btn');
                        loadMoreBtn.addEventListener('click', fetchInbounds);
                    } else {
                        if (!inboundList.innerHTML.trim()){
                            inboundList.innerHTML = '<p class="text-center text-muted mt-4">Tidak ada data inbound ditemukan.</p>';
                        }
                    }
                })
                .catch(error => console.error('Error during search:', error))
                .finally(() => {
                    isLoading = false;
                    loadingIndicator.style.display = 'none';
                });

        }, 500); // Debounce
    });
});
</script>
{% endblock %}
