{% extends 'base.html' %}
{% load static %}

{% block title %}Stok Rak - Semua Produk{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.bootstrap5.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.2/dist/sweetalert2.min.css">
    <style>
        .stock-high {
            background-color: #d4edda !important;
            color: #155724 !important;
        }
        .stock-medium {
            background-color: #fff3cd !important;
            color: #856404 !important;
        }
        .stock-low {
            background-color: #f8d7da !important;
            color: #721c24 !important;
        }
        .stock-zero {
            background-color: #f8f9fa !important;
            color: #6c757d !important;
        }
        
        .clickable-card {
            transition: all 0.3s ease;
        }
        
        .clickable-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .clickable-card:active {
            transform: translateY(-1px);
        }
        
        .filter-active {
            border: 3px solid #fff !important;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.3) !important;
        }
        
        .clickable-card {
            position: relative;
        }
        
        .clickable-card::after {
            content: "Klik untuk filter";
            position: absolute;
            bottom: 5px;
            right: 10px;
            font-size: 0.7rem;
            opacity: 0.8;
            font-style: italic;
        }

        /* Custom table styling */
        .table-container {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter {
            padding: 1rem;
            background-color: #fff;
            border-bottom: 1px solid #dee2e6;
        }

        .dataTables_wrapper .dataTables_filter {
            text-align: right;
        }
        
        /* Styling untuk filter rak */
        .dataTables_wrapper .rak-filter-container {
            margin-bottom: 1rem;
        }
        
        .rak-filter-content {
            padding: 1rem !important;
            background-color: #f8f9fa !important;
            border-radius: 8px !important;
            border: 1px solid #dee2e6 !important;
            margin-bottom: 1rem !important;
        }
        
        /* Memperbaiki tampilan filter rak dan search box */
        .rak-filter-content .form-select,
        .rak-filter-content .form-control {
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            font-size: 0.9rem;
        }
        
        .rak-filter-content .form-select:focus,
        .rak-filter-content .form-control:focus {
            border-color: #86b7fe;
            outline: 0;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        
        /* Menghilangkan duplikasi search box */
        .dataTables_wrapper .dataTables_filter {
            display: none !important;
        }
        
        /* Memperbaiki tampilan label */
        .rak-filter-content .form-label {
            font-size: 0.9rem !important;
            font-weight: 500 !important;
            color: #495057 !important;
            margin-bottom: 0 !important;
        }
        
        /* Responsive design untuk mobile */
        @media (max-width: 768px) {
            .rak-filter-content .row {
                flex-direction: column;
            }
            
            .rak-filter-content .col-md-6 {
                margin-bottom: 0.5rem;
            }
            
            .rak-filter-content .form-select,
            .rak-filter-content .form-control {
                width: 100% !important;
                min-width: auto !important;
            }
        }
        
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_paginate {
            padding: 1rem;
            background-color: #fff;
            border-top: 1px solid #dee2e6;
        }
        
        .table thead th {
            background-color: #f8f9fa;
            color: #495057;
            border-top: none;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            padding: 1rem;
            text-align: left;
        }
        
        .table tbody tr {
            border-bottom: 1px solid #dee2e6;
            transition: background-color 0.2s ease;
        }

        .table tbody tr:hover {
            background-color: #f1f3f5;
        }
        
        .table tbody tr:last-of-type {
            border-bottom: none;
        }
        
        .table tbody td {
            vertical-align: middle;
            border-top: none;
            padding: 0.75rem 1rem;
        }
        
        /* Product image styling */
        .product-image {
            border: 1px solid #e9ecef;
            border-radius: 0.25rem;
            transition: transform 0.2s ease, border-color 0.2s ease;
        }
        
        .product-image:hover {
            transform: scale(1.05);
            border-color: #007bff;
        }
        
        /* Badge styling */
        .badge {
            font-weight: 600;
            padding: 0.5em 0.8em;
            font-size: 0.8rem;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .d-flex.align-items-center {
                flex-direction: column;
                align-items: flex-start !important;
                text-align: left;
            }
            
            .product-image {
                margin-bottom: 10px;
            }
        }

        /* Fix pagination dropdown styling */
        .dataTables_length select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: none !important;
            padding-right: 8px !important;
        }
        
        .dataTables_length select::-ms-expand {
            display: none;
        }
        
        /* Remove DataTables default styling for length select */
        .dataTables_wrapper .dataTables_length .form-select {
            background-image: none !important;
            padding-right: 8px !important;
        }
        
        /* Ensure no arrows appear on any select elements in DataTables */
        .dataTables_wrapper select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: none !important;
        }

        /* Sorting Arrows */
        .table thead th.sorting::before,
        .table thead th.sorting::after,
        .table thead th.sorting_asc::before,
        .table thead th.sorting_asc::after,
        .table thead th.sorting_desc::before,
        .table thead th.sorting_desc::after {
            display: inline-block;
            opacity: 0.5;
        }
        
        .table thead th.sorting_asc::before,
        .table thead th.sorting_desc::before {
            opacity: 1;
        }
        
        /* Remove blue overlay on sorted headers */
        .table thead th.sorting_asc,
        .table thead th.sorting_desc {
            background-color: #f8f9fa !important;
            color: #495057 !important;
        }
        
        /* Remove any arrows from pagination and filter elements */
        .dataTables_length,
        .dataTables_filter,
        .dataTables_info,
        .dataTables_paginate {
            position: relative;
        }
        
        .dataTables_length::after,
        .dataTables_filter::after,
        .dataTables_info::after,
        .dataTables_paginate::after {
            display: none !important;
        }
        
        /* Box icon fallback styling */
        .photo-fallback {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            color: #6c757d;
            transition: all 0.3s ease;
        }
        
        .photo-fallback:hover {
            background: #e9ecef;
            border-color: #adb5bd;
            color: #495057;
        }
        
        .photo-fallback i {
            font-size: 24px;
            margin-bottom: 2px;
        }
        
        .photo-fallback .small {
            font-size: 8px;
            line-height: 1;
        }
        
        /* Ensure modal appears above everything */
        .modal {
            z-index: 1055 !important;
        }
        
        .modal-backdrop {
            z-index: 1050 !important;
        }

        /* Custom styling untuk error modal yang cantik */
        .swal-error-popup {
            border-radius: 16px !important;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2) !important;
            overflow: hidden !important;
        }
        
        .swal-error-title {
            color: #dc3545 !important;
            font-weight: 700 !important;
            font-size: 1.5rem !important;
            line-height: 1.4 !important;
            margin-bottom: 1.5rem !important;
        }
        
        .swal-error-content {
            text-align: left !important;
            padding: 0 !important;
        }
        
        .error-modal-content .alert {
            border-radius: 12px !important;
            border: none !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
        }
        
        .error-modal-content .alert-danger {
            border-left: 4px solid #dc3545 !important;
        }
        
        .error-modal-content .alert-info {
            border-left: 4px solid #0dcaf0 !important;
        }
        
        .swal2-confirm.btn-primary {
            background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%) !important;
            border: none !important;
            border-radius: 8px !important;
            padding: 12px 24px !important;
            font-weight: 600 !important;
            text-transform: none !important;
            letter-spacing: 0.5px !important;
            transition: all 0.3s ease !important;
        }
        
        .swal2-confirm.btn-primary:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 8px 20px rgba(13, 110, 253, 0.3) !important;
        }
        
        .swal2-popup.swal-error-popup::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #dc3545 0%, #fd7e14 50%, #ffc107 100%);
            z-index: 1;
        }
    </style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
        <i class="bi bi-box-seam"></i> Stok Rak - Semua Produk
    </h2>
    <div class="d-flex gap-2">
        <a href="{% url 'inventory:stock_position_view' %}" class="btn btn-info">
            <i class="bi bi-bar-chart"></i> Posisi Stock
        </a>
        <a href="{% url 'inventory:opname_rak_list' %}" class="btn btn-warning">
            <i class="bi bi-clipboard-check"></i> Opname Rak
        </a>
        <button type="button" class="btn btn-info" id="resetFilterBtn" onclick="resetFilter()" style="display: none;">
            <i class="bi bi-arrow-clockwise"></i> Reset Filter
        </button>
        <button type="button" class="btn btn-success" onclick="exportToExcel()">
            <i class="bi bi-file-earmark-excel"></i> Export Excel
        </button>
    </div>
</div>

<!-- Navigation Tabs -->
<ul class="nav nav-tabs mb-4" id="rakTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="stock-tab" data-bs-toggle="tab" data-bs-target="#stock-content" type="button" role="tab">
            <i class="bi bi-box-seam"></i> Stok Rak
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="management-tab" data-bs-toggle="tab" data-bs-target="#management-content" type="button" role="tab">
            <i class="bi bi-gear"></i> Manajemen Rak
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="transfer-tab" data-bs-toggle="tab" data-bs-target="#transfer-content" type="button" role="tab">
            <i class="bi bi-arrow-left-right"></i> Transfer Rak
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="log-tab" data-bs-toggle="tab" data-bs-target="#log-content" type="button" role="tab">
            <i class="bi bi-clock-history"></i> Log Aktivitas
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="rakTabContent">
    <!-- Tab 1: Stok Rak -->
    <div class="tab-pane fade show active" id="stock-content" role="tabpanel">
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Total Rak</h6>
                                <h3 id="totalRak">-</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-boxes fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Total Produk</h6>
                                <h3 id="totalProduk">-</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-box-seam fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Total Stok</h6>
                                <h3 id="totalStok">-</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-bar-chart fs-1"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-primary text-white clickable-card" onclick="filterLowStock()" style="cursor: pointer;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title" id="filterCardTitle">Stok Rendah</h6>
                                <h3 id="stokRendah">-</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-exclamation-triangle fs-1 card-icon text-white"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->

        <div class="card">
            <div class="card-body">
                <div class="table-container">
                    <table id="rakStockTable" class="table mb-0">
                        <thead>
                            <tr>
                                <th>Rak</th>
                                <th>Photo</th>
                                <th>Produk</th>
                                <th>Detail Produk</th>
                                <th>Stok</th>
                                <th>Used Front</th>
                                <th>Terakhir Update</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data akan diisi oleh DataTables -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab 2: Manajemen Rak -->
    <div class="tab-pane fade" id="management-content" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">
                <i class="bi bi-gear"></i> Manajemen Rak
            </h4>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRakModal">
                <i class="bi bi-plus-circle"></i> Tambah Rak Baru
            </button>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="rakManagementTable" class="table table-striped table-hover" style="width:100%">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Kode Rak</th>
                                <th>Nama Rak</th>
                                <th>Lokasi</th>
                                <th>Dimensi</th>
                                <th>Kapasitas</th>
                                <th>Total Stok</th>
                                <th>Dibuat</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data akan dimuat oleh DataTables dari AJAX -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab 3: Transfer Rak -->
    <div class="tab-pane fade" id="transfer-content" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0"><i class="bi bi-arrow-left-right"></i> Daftar Sesi Transfer</h4>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTransferModalInline">
                <i class="bi bi-plus-circle"></i> Buat Sesi Transfer
            </button>
        </div>

        <div class="table-responsive">
            <table id="transferSessionsInline" class="table table-striped table-hover" style="width:100%">
                <thead>
                    <tr>
                        <th>Kode Sesi</th>
                        <th>Rak Asal</th>
                        <th>Rak Tujuan</th>
                        <th>Status</th>
                        <th>Total Items</th>
                        <th>Total Qty</th>
                        <th>Dibuat Oleh</th>
                        <th>Tanggal Transfer</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Reuse modal create transfer (inline) -->
        <div class="modal fade" id="createTransferModalInline" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title"><i class="bi bi-arrow-left-right"></i> Buat Sesi Transfer Rak</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label">Rak Asal</label>
                            <select id="inline_rak_asal" class="form-select"></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Rak Tujuan</label>
                            <select id="inline_rak_tujuan" class="form-select"></select>
                        </div>
                        <div class="form-check mb-2">
                            <input type="checkbox" class="form-check-input" id="inline_transfer_putaway">
                            <label class="form-check-label" for="inline_transfer_putaway">Transfer Putaway</label>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Catatan</label>
                            <textarea id="inline_catatan" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="button" class="btn btn-primary" onclick="createInlineTransfer()">Buat</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab 4: Log Aktivitas -->
    <div class="tab-pane fade" id="log-content" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">
                <i class="bi bi-clock-history"></i> Log Aktivitas Rak
            </h4>
            <div class="d-flex gap-2">
                <select id="logRakFilter" class="form-select" style="width: auto;">
                    <option value="">Semua Rak</option>
                </select>
                <button type="button" class="btn btn-success" onclick="exportLogToExcel()">
                    <i class="bi bi-file-earmark-excel"></i> Export Log
                </button>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="rakLogTable" class="table table-striped table-hover" style="width:100%">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Kode Rak</th>
                                <th>SKU</th>
                                <th>Nama Produk</th>
                                <th>Barcode</th>
                                <th>Variant Produk</th>
                                <th>Tipe Aktivitas</th>
                                <th>Jumlah Sebelum</th>
                                <th>Jumlah Sesudah</th>
                                <th>Selisih</th>
                                <th>User</th>
                                <th>Waktu</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data akan dimuat oleh DataTables dari AJAX -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Tambah Rak -->
<div class="modal fade" id="addRakModal" tabindex="-1" aria-labelledby="addRakModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addRakModalLabel">
                    <i class="bi bi-plus-circle"></i> Tambah Rak Baru
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addRakForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="kodeRak" class="form-label">Kode Rak *</label>
                        <input type="text" class="form-control" id="kodeRak" name="kode_rak" required>
                    </div>
                    <div class="mb-3">
                        <label for="namaRak" class="form-label">Nama Rak *</label>
                        <input type="text" class="form-control" id="namaRak" name="nama_rak" required>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="panjangCm" class="form-label">Panjang (cm)</label>
                            <input type="number" step="0.01" class="form-control" id="panjangCm" name="panjang_cm" min="0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="lebarCm" class="form-label">Lebar (cm)</label>
                            <input type="number" step="0.01" class="form-control" id="lebarCm" name="lebar_cm" min="0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="tinggiCm" class="form-label">Tinggi (cm)</label>
                            <input type="number" step="0.01" class="form-control" id="tinggiCm" name="tinggi_cm" min="0">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="kapasitasRak" class="form-label">Kapasitas (kg)</label>
                        <input type="number" step="0.001" class="form-control" id="kapasitasRak" name="kapasitas_kg" min="0">
                    </div>
                    <div class="mb-3">
                        <label for="lokasiRak" class="form-label">Lokasi</label>
                        <input type="text" class="form-control" id="lokasiRak" name="lokasi">
                    </div>
                    <div class="mb-3">
                        <label for="deskripsiRak" class="form-label">Deskripsi</label>
                        <textarea class="form-control" id="deskripsiRak" name="keterangan" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Tambah Rak
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Edit Rak -->
<div class="modal fade" id="editRakModal" tabindex="-1" aria-labelledby="editRakModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editRakModalLabel">
                    <i class="bi bi-pencil"></i> Edit Rak
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editRakForm">
                {% csrf_token %}
                <input type="hidden" id="editRakId" name="rak_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editKodeRak" class="form-label">Kode Rak *</label>
                        <input type="text" class="form-control" id="editKodeRak" name="kode_rak" required>
                    </div>
                    <div class="mb-3">
                        <label for="editNamaRak" class="form-label">Nama Rak *</label>
                        <input type="text" class="form-control" id="editNamaRak" name="nama_rak" required>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="editPanjangCm" class="form-label">Panjang (cm)</label>
                            <input type="number" step="0.01" class="form-control" id="editPanjangCm" name="panjang_cm" min="0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="editLebarCm" class="form-label">Lebar (cm)</label>
                            <input type="number" step="0.01" class="form-control" id="editLebarCm" name="lebar_cm" min="0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="editTinggiCm" class="form-label">Tinggi (cm)</label>
                            <input type="number" step="0.01" class="form-control" id="editTinggiCm" name="tinggi_cm" min="0">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editKapasitasRak" class="form-label">Kapasitas (kg)</label>
                        <input type="number" step="0.001" class="form-control" id="editKapasitasRak" name="kapasitas_kg" min="0">
                    </div>
                    <div class="mb-3">
                        <label for="editLokasiRak" class="form-label">Lokasi</label>
                        <input type="text" class="form-control" id="editLokasiRak" name="lokasi">
                    </div>
                    <div class="mb-3">
                        <label for="editDeskripsiRak" class="form-label">Deskripsi</label>
                        <textarea class="form-control" id="editDeskripsiRak" name="keterangan" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Simpan Perubahan
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_script %}
    <script type="text/javascript" src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
    <script type="text/javascript" src=""></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.bootstrap5.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
    <script>
        var rakStockTable, rakManagementTable, rakLogTable;

        $(document).ready(function() {
            console.log('Document ready, initializing rak stock table...');
            
            // Update summary cards
            updateSummaryCards();
            
            console.log('Initializing DataTable for rak stock...');
            
            // Inisialisasi DataTables untuk Stok Rak
            rakStockTable = $('#rakStockTable').DataTable({
                "processing": true,
                "serverSide": true,
                "ajax": {
                    "url": "{% url 'inventory:rak_stock_data' %}",
                    "type": "GET",
                    "data": function(d) {
                        // Tambahkan parameter filter rak dari DataTables filter
                        var rakFilter = $('#rakFilterSelect').val();
                        if (rakFilter) {
                            d.rak_filter = rakFilter;
                        }
                        
                        // Tambahkan parameter filter level stok
                        if (currentFilter !== 'none') {
                            d.filter = currentFilter;
                        }
                        
                        return d;
                    },
                    "error": function(xhr, error, thrown) {
                        console.log('DataTables error:', error, thrown);
                        alert('Terjadi kesalahan saat memuat data. Silakan refresh halaman.');
                    }
                },
                "dom": "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
                       "<'row'<'col-sm-12'<'rak-filter-container'>>>" +
                       "<'row'<'col-sm-12'tr>>" +
                       "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
                "initComplete": function() {
                    console.log('DataTable initialization complete, adding rak filter...');
                    // Tambahkan filter rak setelah DataTables selesai diinisialisasi
                    addRakFilterToDOM();
                },
                "drawCallback": function() {
                    // Fallback: pastikan filter rak ada setelah setiap draw
                    if ($('.rak-filter-container').length > 0 && $('#rakFilterSelect').length === 0) {
                        console.log('Rak filter missing, re-adding...');
                        addRakFilterToDOM();
                    }
                },
                "columns": [
                    {
                        "data": "kode_rak",
                        "title": "Rak",
                        "render": function(data, type, row) {
                            if (type === 'display') {
                                return `
                                    <div>
                                        <div class="fw-bold text-success">${data}</div>
                                        <div class="small text-muted">${row.nama_rak}</div>
                                        <div class="small text-muted">${row.lokasi_rak}</div>
                                    </div>
                                `;
                            }
                            return data;
                        }
                    },
                    {
                        "data": "photo_url",
                        "title": "Photo",
                        "orderable": false,
                        "render": function(data, type, row) {
                            if (type === 'display') {
                                if (data && data !== '/static/icons/box.png') {
                                    return `<img src="${data}" alt="Product Photo" class="rounded product-image" style="width: 50px; height: 50px; object-fit: cover;">`;
                                } else {
                                    return `<div class="photo-fallback"><i class="fas fa-box"></i><div class="small">No Photo</div></div>`;
                                }
                            }
                            return '';
                        }
                    },
                    {
                        "data": "sku",
                        "title": "Produk",
                        "render": function(data, type, row) {
                            if (type === 'display') {
                                return `
                                    <div>
                                        <div class="fw-bold text-primary">ID: ${row.product_id}</div>
                                        <div class="small text-muted">Barcode: ${row.barcode}</div>
                                        <div class="small text-muted">SKU: ${data}</div>
                                    </div>
                                `;
                            }
                            return data;
                        }
                    },
                    {
                        "data": "nama_produk",
                        "title": "Detail Produk",
                        "render": function(data, type, row) {
                            if (type === 'display') {
                                return `
                                    <div>
                                        <div class="fw-bold">${data}</div>
                                        <div class="small text-muted">Variant: ${row.variant_produk}</div>
                                        <div class="small text-muted">Brand: ${row.brand}</div>
                                    </div>
                                `;
                            }
                            return data;
                        }
                    },
                    {
                        "data": "quantity",
                        "title": "Stok",
                        "render": function(data, type, row) {
                            if (type === 'display') {
                                var badgeClass = 'bg-success';
                                if (data <= 10) {
                                    badgeClass = 'bg-danger';
                                } else if (data <= 50) {
                                    badgeClass = 'bg-warning';
                                }
                                return `<span class="badge ${badgeClass} fs-6">${data.toLocaleString()}</span>`;
                            }
                            return data;
                        }
                    },
                    {
                        "data": "used_front",
                        "title": "Used Front",
                        "render": function(data, type, row) {
                            if (type === 'display') {
                                if (data && data > 0) {
                                    return `<span class="badge bg-info fs-6">${data} cm</span>`;
                                } else {
                                    return `<span class="text-muted">-</span>`;
                                }
                            }
                            return data || 0;
                        }
                    },
                    {
                        "data": "last_updated",
                        "title": "Terakhir Update",
                        "render": function(data, type, row) {
                            if (type === 'display') {
                                return `<span class="text-muted">${data}</span>`;
                            }
                            return data;
                        }
                    }
                ],
                "order": [[0, "asc"], [2, "asc"]], // Sort by rak (col 0), then product (col 2)
                "pageLength": 25,
                "searching": true,
                "ordering": true,
                "info": true,
                "responsive": true,
                "language": {
                    "lengthMenu": "Tampilkan _MENU_ entri",
                    "zeroRecords": "Tidak ada data yang ditemukan",
                    "info": "Menampilkan _START_ sampai _END_ dari _TOTAL_ entri",
                    "infoEmpty": "Menampilkan 0 sampai 0 dari 0 entri",
                    "infoFiltered": "(difilter dari _MAX_ total entri)",
                    "search": "Cari:",
                    "paginate": {
                        "first": "Pertama",
                        "last": "Terakhir",
                        "next": "Selanjutnya",
                        "previous": "Sebelumnya"
                    },
                    "processing": "Memproses...",
                    "searchPlaceholder": "Cari data..."
                },
                "initComplete": function(settings, json) {
                    console.log('DataTable initialization complete, adding rak filter...');
                    // Tambahkan filter rak ke DOM
                    addRakFilterToDOM();
                    // updateSummaryCards(); // This is now handled by the call above
                }
            });
            
            // Fallback timeout untuk memastikan filter rak ditambahkan
            setTimeout(function() {
                if ($('.rak-filter-container').length > 0 && $('#rakFilterSelect').length === 0) {
                    console.log('Fallback: Adding rak filter after timeout...');
                    addRakFilterToDOM();
                } else if ($('.rak-filter-container').length === 0) {
                    console.error('❌ No rak-filter-container found after timeout!');
                    console.log('🔍 DataTable wrapper structure:', $('.dataTables_wrapper').html());
                }
            }, 3000);

            // Inisialisasi DataTables untuk Manajemen Rak
            rakManagementTable = $('#rakManagementTable').DataTable({
                "processing": true,
                "serverSide": true,
                "ajax": {
                    "url": "{% url 'inventory:rak_data' %}",
                    "type": "GET"
                },
                "dom": "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
                       "<'row'<'col-sm-12'tr>>" +
                       "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>" +
                       "<'d-none'B>", // Sembunyikan tombol default
                "buttons": [
                    {
                        extend: 'excelHtml5',
                        title: 'Daftar Rak - ' + new Date().toLocaleDateString('id-ID'),
                        exportOptions: {
                            columns: [1, 2, 3, 4, 5, 6, 7], // Exclude ID and Aksi columns
                            format: {
                                body: function ( data, row, column, node ) {
                                    // Hapus HTML tags jika ada
                                    return typeof data === 'string' ? 
                                        data.replace(/<.*?>/g, '') : data;
                                }
                            }
                        }
                    }
                ],
                "columns": [
                    { "data": "id" },
                    { "data": "kode_rak" },
                    { "data": "nama_rak" },
                    { "data": "lokasi" },
                    { "data": "dimensi" },
                    { "data": "kapasitas" },
                    { 
                        "data": "total_stok",
                        "render": function(data, type, row) {
                            if (type === 'display') {
                                return '<span class="badge bg-info">' + data + '</span>';
                            }
                            return data;
                        }
                    },
                    { "data": "created_at" },
                    { 
                        "data": "id",
                        "render": function(data, type, row) {
                            if (type === 'display') {
                                return '<div class="btn-group btn-group-sm" role="group">' +
                                    '<button type="button" class="btn btn-outline-primary" onclick="editRak(' + data + ')" style="cursor: pointer;">' +
                                    '<i class="bi bi-pencil"></i></button>' +
                                    '<button type="button" class="btn btn-outline-danger" onclick="deleteRak(' + data + ')" style="cursor: pointer;">' +
                                    '<i class="bi bi-trash"></i></button>' +
                                    '</div>';
                            }
                            return data;
                        }
                    }
                ],
                "language": {
                    "lengthMenu": "Tampilkan _MENU_ entri",
                    "zeroRecords": "Tidak ada data yang ditemukan",
                    "info": "Menampilkan _START_ sampai _END_ dari _TOTAL_ entri",
                    "infoEmpty": "Menampilkan 0 sampai 0 dari 0 entri",
                    "infoFiltered": "(difilter dari _MAX_ total entri)",
                    "search": "Cari:",
                    "paginate": {
                        "first": "Pertama",
                        "last": "Terakhir",
                        "next": "Selanjutnya",
                        "previous": "Sebelumnya"
                    },
                    "processing": "Memproses...",
                    "searchPlaceholder": "Cari data..."
                },
                "order": [[1, "asc"]],
                "pageLength": 25,
                "searching": true,
                "ordering": true,
                "info": true,
                "responsive": true,
                "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Semua"]]
            });

            // Inisialisasi DataTables untuk Log Aktivitas
            rakLogTable = $('#rakLogTable').DataTable({
                "processing": true,
                "serverSide": true,
                "ajax": {
                    "url": "{% url 'inventory:api_rak_stock_log_data_all' %}",
                    "type": "GET",
                    "data": function(d) {
                        var rakFilter = $('#logRakFilter').val();
                        if (rakFilter) {
                            d.rak_filter = rakFilter;
                        }
                        return d;
                    },
                    "error": function(xhr, error, thrown) {
                        console.log('Log DataTables error:', error, thrown);
                        alert('Terjadi kesalahan saat memuat log data. Silakan refresh halaman.');
                    }
                },
                "dom": "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
                       "<'row'<'col-sm-12'tr>>" +
                       "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>" +
                       "<'d-none'B>", // Sembunyikan tombol default
                "buttons": [
                    {
                        extend: 'excelHtml5',
                        title: 'Log Aktivitas Rak - ' + new Date().toLocaleDateString('id-ID'),
                        exportOptions: {
                            columns: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11], // Exclude ID column
                            format: {
                                body: function ( data, row, column, node ) {
                                    // Hapus HTML tags jika ada
                                    return typeof data === 'string' ? 
                                        data.replace(/<.*?>/g, '') : data;
                                }
                            }
                        }
                    }
                ],
                "columns": [
                    { "data": "id" },
                    { "data": "rak_kode_rak" },
                    { "data": "product_sku" },
                    { "data": "product_nama_produk" },
                    { "data": "product_barcode" },
                    { "data": "product_variant" },
                    { "data": "activity_type" },
                    { "data": "quantity_before" },
                    { "data": "quantity_after" },
                    { 
                        "data": "quantity_change",
                        "render": function(data, type, row) {
                            if (type === 'display') {
                                var change = parseInt(data);
                                var badgeClass = change > 0 ? 'bg-success' : change < 0 ? 'bg-danger' : 'bg-secondary';
                                var sign = change > 0 ? '+' : '';
                                return '<span class="badge ' + badgeClass + '">' + sign + data + '</span>';
                            }
                            return data;
                        }
                    },
                    { "data": "user_username" },
                    { "data": "created_at" }
                ],
                "language": {
                    "lengthMenu": "Tampilkan _MENU_ entri",
                    "zeroRecords": "Tidak ada data yang ditemukan",
                    "info": "Menampilkan _START_ sampai _END_ dari _TOTAL_ entri",
                    "infoEmpty": "Menampilkan 0 sampai 0 dari 0 entri",
                    "infoFiltered": "(difilter dari _MAX_ total entri)",
                    "search": "Cari:",
                    "paginate": {
                        "first": "Pertama",
                        "last": "Terakhir",
                        "next": "Selanjutnya",
                        "previous": "Sebelumnya"
                    },
                    "processing": "Memproses...",
                    "searchPlaceholder": "Cari data..."
                },
                "order": [[11, "desc"]], // Sort by waktu descending (column 11)
                "pageLength": 25,
                "searching": true,
                "ordering": true,
                "info": true,
                "responsive": true,
                "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Semua"]]
            });

            // Inisialisasi DataTables untuk Opname Rak
            opnameSessionTable = $('#opnameSessionTable').DataTable({
                "processing": true,
                "serverSide": true,
                "ajax": {
                    "url": "{% url 'inventory:opname_rak_list' %}",
                    "type": "GET",
                    "data": function(d) {
                        var statusFilter = $('#opnameStatusFilter').val();
                        var rakFilter = $('#opnameRakFilter').val();
                        if (statusFilter) {
                            d.status = statusFilter;
                        }
                        if (rakFilter) {
                            d.rak = rakFilter;
                        }
                        return d;
                    },
                    "error": function(xhr, error, thrown) {
                        console.log('Opname DataTables error:', error, thrown);
                        alert('Terjadi kesalahan saat memuat data opname. Silakan refresh halaman.');
                    }
                },
                "dom": "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
                       "<'row'<'col-sm-12'tr>>" +
                       "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>" +
                       "<'d-none'B>", // Sembunyikan tombol default
                "columns": [
                    { "data": "session_code" },
                    { "data": "rak_lokasi" },
                    { 
                        "data": "status",
                        "render": function(data, type, row) {
                            if (type === 'display') {
                                var statusClass = '';
                                var statusText = '';
                                switch(data) {
                                    case 'draft':
                                        statusClass = 'bg-warning';
                                        statusText = 'Draft';
                                        break;
                                    case 'in_progress':
                                        statusClass = 'bg-info';
                                        statusText = 'Sedang Berlangsung';
                                        break;
                                    case 'selesai':
                                        statusClass = 'bg-success';
                                        statusText = 'Selesai';
                                        break;
                                    case 'dibatalkan':
                                        statusClass = 'bg-danger';
                                        statusText = 'Dibatalkan';
                                        break;
                                    default:
                                        statusClass = 'bg-secondary';
                                        statusText = data;
                                }
                                return '<span class="badge ' + statusClass + '">' + statusText + '</span>';
                            }
                            return data;
                        }
                    },
                    { "data": "total_items" },
                    { 
                        "data": "total_selisih",
                        "render": function(data, type, row) {
                            if (type === 'display') {
                                var selisih = parseInt(data);
                                var badgeClass = selisih > 0 ? 'bg-danger' : selisih < 0 ? 'bg-warning' : 'bg-success';
                                var sign = selisih > 0 ? '+' : '';
                                return '<span class="badge ' + badgeClass + '">' + sign + data + '</span>';
                            }
                            return data;
                        }
                    },
                    { "data": "created_by_username" },
                    { "data": "tanggal_mulai" },
                    { 
                        "data": null,
                        "render": function(data, type, row) {
                            if (type === 'display') {
                                var buttons = '<div class="d-flex gap-1 flex-nowrap">';
                                
                                if (row.status === 'draft') {
                                    buttons += '<a href="/inventory/opname-rak/' + row.id + '/work/" class="btn btn-sm btn-primary">Kerja</a>';
                                    buttons += '<a href="/inventory/opname-rak/' + row.id + '/cancel/" class="btn btn-sm btn-danger">Batal</a>';
                                } else if (row.status === 'selesai') {
                                    buttons += '<a href="/inventory/opname-rak/' + row.id + '/detail/" class="btn btn-sm btn-info">Detail</a>';
                                }
                                
                                buttons += '</div>';
                                return buttons;
                            }
                            return '';
                        }
                    }
                ],
                "language": {
                    "lengthMenu": "Tampilkan _MENU_ entri",
                    "zeroRecords": "Tidak ada data yang ditemukan",
                    "info": "Menampilkan _START_ sampai _END_ dari _TOTAL_ entri",
                    "infoEmpty": "Menampilkan 0 sampai 0 dari 0 entri",
                    "infoFiltered": "(difilter dari _MAX_ total entri)",
                    "search": "Cari:",
                    "paginate": {
                        "first": "Pertama",
                        "last": "Terakhir",
                        "next": "Selanjutnya",
                        "previous": "Sebelumnya"
                    },
                    "processing": "Memproses...",
                    "searchPlaceholder": "Cari data..."
                },
                "order": [[6, "desc"]], // Sort by tanggal_mulai descending
                "pageLength": 25,
                "searching": true,
                "ordering": true,
                "info": true,
                "responsive": true,
                "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Semua"]]
            });

            // Handle tab switching untuk load data
            $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
                var target = $(e.target).attr("data-bs-target");
                if (target === '#management-content') {
                    rakManagementTable.ajax.reload();
                } else if (target === '#log-content') {
                    rakLogTable.ajax.reload();
                } else if (target === '#transfer-content') {
                    if (!window._transferInlineInit) {
                        initTransferInlineTable();
                        window._transferInlineInit = true;
                    }
                    loadTransferSummary();
                }
            });

            // Handle form submissions
            setupFormHandlers();

        });

        function updateSummaryCards() {
            // Fetch summary data from server with current filters
            var rakFilter = $('#rakFilter').val();
            var params = {};
            
            if (rakFilter) {
                params.rak_filter = rakFilter;
            }
            
            if (currentFilter !== 'none') {
                params.filter = currentFilter;
            }
            
            $.ajax({
                url: "{% url 'inventory:rak_stock_summary' %}",
                type: "GET",
                data: params,
                success: function(response) {
                    if (response.success && response.data) {
                        var data = response.data;
                        $('#totalRak').text(data.total_raks || '-');
                        $('#totalProduk').text(data.total_products || '-');
                        $('#totalStok').text((data.total_stock || 0).toLocaleString());
                        $('#stokRendah').text(data.low_stock || '-');
                    } else {
                        // Fallback jika response tidak sesuai format
                        $('#totalRak').text('-');
                        $('#totalProduk').text('-');
                        $('#totalStok').text('-');
                        $('#stokRendah').text('-');
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Error fetching summary:', status, error);
                    // Fallback jika request gagal
                    $('#totalRak').text('-');
                    $('#totalProduk').text('-');
                    $('#totalStok').text('-');
                    $('#stokRendah').text('-');
                }
            });
        }

        function loadRakFilterOptions(callback) {
            console.log('🔄 Loading rak filter options...');
            console.log('📍 URL:', "{% url 'inventory:rak_stock_data' %}");
            
            // Fetch rak options for filter dropdown
            $.ajax({
                url: "{% url 'inventory:rak_stock_data' %}",
                type: "GET",
                data: { get_rak_options: true },
                success: function(response) {
                    console.log('📦 Rak options response:', response);
                    
                    if (response.rak_options) {
                        var select = $('#rakFilter');
                        var logSelect = $('#logRakFilter');
                        var dataTableSelect = $('#rakFilterSelect'); // Filter baru di DataTables
                        
                        console.log('🔍 Found select elements:', {
                            'rakFilter': select.length,
                            'logRakFilter': logSelect.length,
                            'rakFilterSelect': dataTableSelect.length
                        });
                        
                        // Clear existing options
                        select.empty().append('<option value="">Semua Rak</option>');
                        logSelect.empty().append('<option value="">Semua Rak</option>');
                        dataTableSelect.empty().append('<option value="">Semua Rak</option>');
                        
                        // Add rak options to all filter dropdowns
                        response.rak_options.forEach(function(rak) {
                            var optionText = `${rak.kode_rak} - ${rak.nama_rak}`;
                            var optionValue = rak.kode_rak;
                            
                            select.append(`<option value="${optionValue}">${optionText}</option>`);
                            logSelect.append(`<option value="${optionValue}">${optionText}</option>`);
                            dataTableSelect.append(`<option value="${optionValue}">${optionText}</option>`);
                        });
                        
                        // Log success
                        console.log('✅ Rak filter options loaded successfully:', response.rak_options.length, 'options');
                        
                        // Execute callback if provided
                        if (typeof callback === 'function') {
                            callback();
                        }
                    } else {
                        console.error('❌ No rak_options in response');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('❌ Gagal memuat opsi filter rak:', error);
                    console.log('📄 Response:', xhr.responseText);
                }
            });
        }

        // Handle rak filter change
        $('#rakFilter').on('change', function() {
            rakStockTable.ajax.reload();
            updateSummaryCards();
        });

        // Handle log rak filter change
        $('#logRakFilter').on('change', function() {
            rakLogTable.ajax.reload();
        });

        function exportToExcel() {
            // Trigger DataTables export
            rakStockTable.button('.buttons-excel').trigger();
        }

        function exportLogToExcel() {
            // Trigger DataTables export untuk log
            rakLogTable.button('.buttons-excel').trigger();
        }

        function setupFormHandlers() {
            // Handle form tambah rak
            $(document).on('submit', '#addRakForm', function(e) {
                e.preventDefault();
                var formData = $(this).serialize();
                
                $.ajax({
                    url: "{% url 'inventory:rak_add' %}",
                    type: "POST",
                    data: formData,
                    headers: {
                        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            $('#addRakModal').modal('hide');
                            $('#addRakForm')[0].reset();
                            rakManagementTable.ajax.reload();
                            showToast('success', 'Rak berhasil ditambahkan!');
                        } else {
                            showToast('error', response.message || 'Gagal menambahkan rak');
                        }
                    },
                    error: function() {
                        showToast('error', 'Terjadi kesalahan saat menambahkan rak');
                    }
                });
            });

            // Handle form edit rak
            $(document).on('submit', '#editRakForm', function(e) {
                e.preventDefault();
                var formData = $(this).serialize();
                var rakId = $('#editRakId').val();
                
                $.ajax({
                    url: "/inventory/rak/" + rakId + "/edit/",
                    type: "POST",
                    data: formData,
                    headers: {
                        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            $('#editRakModal').modal('hide');
                            rakManagementTable.ajax.reload();
                            showToast('success', 'Rak berhasil diperbarui!');
                        } else {
                            showToast('error', response.message || 'Gagal memperbarui rak');
                        }
                    },
                    error: function() {
                        showToast('error', 'Terjadi kesalahan saat memperbarui rak');
                    }
                });
            });
        }

        function editRak(rakId) {
            // Load data rak untuk edit
            $.ajax({
                url: "/inventory/rak/" + rakId + "/edit/",
                type: "GET",
                success: function(response) {
                    if (response.success) {
                        var rak = response.data;
                        $('#editRakId').val(rak.id);
                        $('#editKodeRak').val(rak.kode_rak);
                        $('#editNamaRak').val(rak.nama_rak);
                        $('#editPanjangCm').val(rak.panjang_cm);
                        $('#editLebarCm').val(rak.lebar_cm);
                        $('#editTinggiCm').val(rak.tinggi_cm);
                        $('#editKapasitasRak').val(rak.kapasitas_kg);
                        $('#editLokasiRak').val(rak.lokasi);
                        $('#editDeskripsiRak').val(rak.keterangan);
                        $('#editRakModal').modal('show');
                    } else {
                        showToast('error', 'Gagal memuat data rak');
                    }
                },
                error: function() {
                    showToast('error', 'Terjadi kesalahan saat memuat data rak');
                }
            });
        }

        function deleteRak(rakId) {
            Swal.fire({
                title: 'Yakin ingin menghapus rak ini?',
                text: `Rak akan dihapus permanen dari sistem.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Ya, Hapus!',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: "/inventory/rak/" + rakId + "/delete/",
                        type: "POST",
                        dataType: 'json',
                        data: {
                            'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                        },
                        headers: {
                            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                        },
                        success: function(response) {
                            console.log('Delete response:', response);
                            if (response.success) {
                                rakManagementTable.ajax.reload();
                                showToast('success', 'Rak berhasil dihapus!');
                            } else {
                                showToast('error', response.error || 'Gagal menghapus rak');
                            }
                        },
                        error: function(xhr, status, error) {
                            console.log('Delete error:', xhr, status, error);
                            console.log('Response JSON:', xhr.responseJSON);
                            
                            // Cek apakah ini error validasi dengan responseJSON
                            if (xhr.responseJSON && xhr.responseJSON.error && !xhr.responseJSON.success) {
                                // Ini error validasi dari backend (400 status)
                                Swal.fire({
                                    icon: 'error',
                                    title: '<i class="bi bi-shield-exclamation text-danger"></i><br>Tidak Dapat Menghapus Rak!',
                                    html: `<div class="error-modal-content">
                                            <div class="alert alert-danger border-0 mb-3" style="background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-exclamation-triangle-fill text-danger me-3 fs-4"></i>
                                                    <div>
                                                        <strong class="text-danger">Alasan Penolakan:</strong><br>
                                                        <span class="text-dark">${xhr.responseJSON.error}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="alert alert-info border-0" style="background: linear-gradient(135deg, #e6f3ff 0%, #b3d9ff 100%);">
                                                <div class="d-flex align-items-start">
                                                    <i class="bi bi-info-circle-fill text-info me-3 fs-5 mt-1"></i>
                                                    <div class="text-info">
                                                        <strong>Kebijakan Sistem:</strong><br>
                                                        <small>Rak yang sudah memiliki riwayat transaksi atau stok tidak dapat dihapus untuk menjaga integritas data dan audit trail.</small>
                                                    </div>
                                                </div>
                                            </div>
                                           </div>`,
                                    confirmButtonColor: '#0d6efd',
                                    confirmButtonText: '<i class="bi bi-check-circle me-2"></i>Mengerti',
                                    width: '600px',
                                    padding: '2rem',
                                    backdrop: `rgba(0,0,0,0.6)`,
                                    customClass: {
                                        popup: 'swal-error-popup',
                                        title: 'swal-error-title',
                                        htmlContainer: 'swal-error-content',
                                        confirmButton: 'btn btn-primary'
                                    },
                                    showClass: {
                                        popup: 'animate__animated animate__fadeInDown'
                                    },
                                    hideClass: {
                                        popup: 'animate__animated animate__fadeOutUp'
                                    }
                                });
                            } else {
                                // Error server yang sebenarnya
                                var errorMsg = "Terjadi kesalahan saat menghapus rak.";
                                if (xhr.responseJSON && xhr.responseJSON.error) {
                                    errorMsg = xhr.responseJSON.error;
                                }
                                showToast('error', errorMsg);
                            }
                        }
                    });
                }
            });
        }

        function showToast(type, message) {
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });

            Toast.fire({
                icon: type,
                title: message
            });
        }

        var currentFilter = 'none'; // Track current filter state

        function filterLowStock() {
            var card = document.querySelector('.clickable-card');
            var resetBtn = document.getElementById('resetFilterBtn');
            var cardTitle = document.getElementById('filterCardTitle');
            
            // Check if elements exist before using them
            if (!card || !resetBtn || !cardTitle) {
                console.log('Required elements not found for filter function');
                return;
            }
            
            var cardIcon = card.querySelector('.card-icon');
            
            // Cycle through filters: none -> low -> medium -> high -> all -> none
            if (currentFilter === 'none') {
                // Apply low stock filter
                currentFilter = 'low_stock';
                card.classList.add('filter-active');
                resetBtn.style.display = 'inline-block';
                cardTitle.textContent = 'Stok Rendah (Aktif)';
                cardIcon.className = 'card-icon text-warning';
                // Change background color to indicate active state
                card.style.backgroundColor = '#fff3cd';
                card.style.borderColor = '#ffc107';
            } else if (currentFilter === 'low_stock') {
                // Apply medium stock filter
                currentFilter = 'medium_stock';
                cardTitle.textContent = 'Stok Sedang (Aktif)';
                cardIcon.className = 'card-icon text-info';
                card.style.backgroundColor = '#d1ecf1';
                card.style.borderColor = '#17a2b8';
            } else if (currentFilter === 'medium_stock') {
                // Apply high stock filter
                currentFilter = 'high_stock';
                cardTitle.textContent = 'Stok Tinggi (Aktif)';
                cardIcon.className = 'card-icon text-success';
                card.style.backgroundColor = '#d4edda';
                card.style.borderColor = '#28a745';
            } else if (currentFilter === 'high_stock') {
                // Apply all stock filter
                currentFilter = 'all';
                cardTitle.textContent = 'Semua Stok (Aktif)';
                cardIcon.className = 'card-icon text-dark';
                card.style.backgroundColor = '#ffffff';
                card.style.borderColor = '#6c757d';
            } else {
                // Reset to none
                currentFilter = 'none';
                card.classList.remove('filter-active');
                resetBtn.style.display = 'none';
                cardTitle.textContent = 'Stok Rendah';
                cardIcon.className = 'card-icon text-warning';
                card.style.backgroundColor = '';
                card.style.borderColor = '';
            }
            
            // Reload DataTables with new filter
            rakStockTable.ajax.reload();
            updateSummaryCards();
        }

        function resetFilter() {
            var card = document.querySelector('.clickable-card');
            var resetBtn = document.getElementById('resetFilterBtn');
            var cardTitle = document.getElementById('filterCardTitle');
            
            // Check if elements exist before using them
            if (!card || !resetBtn || !cardTitle) {
                console.log('Required elements not found for reset function');
                return;
            }
            
            var cardIcon = card.querySelector('.card-icon');
            
            // Reset filter state
            currentFilter = 'none';
            
            // Reset card appearance
            card.classList.remove('filter-active');
            resetBtn.style.display = 'none';
            cardTitle.textContent = 'Stok Rendah';
            cardIcon.className = 'card-icon text-warning';
            card.style.backgroundColor = '';
            card.style.borderColor = '';
            
            // Reload DataTables without filter
            rakStockTable.ajax.reload();
            updateSummaryCards();
        }

        function loadTransferSummary() {
            // Load summary data untuk transfer
            $.ajax({
                url: '{% url "inventory:transfer_rak_summary" %}',
                method: 'GET',
                success: function(data) {
                    $('#transferSesiDraft').text(data.sesi_draft || 0);
                    $('#transferSesiBerlangsung').text(data.sesi_berlangsung || 0);
                    $('#transferSesiSelesai').text(data.sesi_selesai || 0);
                    $('#transferTotal').text(data.total_transfer || 0);
                },
                error: function() {
                    console.log('Gagal memuat summary transfer');
                }
            });
        }

        function initTransferInlineTable() {
            // Load rak options for inline modal
            $.get('{% url "inventory:rak_data" %}', { get_rak_options: true }, function(resp){
                var asal = $('#inline_rak_asal');
                var tujuan = $('#inline_rak_tujuan');
                asal.empty(); tujuan.empty();
                asal.append('<option value="">-- Pilih Rak Asal --</option>');
                tujuan.append('<option value="">-- Pilih Rak Tujuan --</option>');
                (resp.rak_options || []).forEach(function(r){
                    var opt = '<option value="'+r.id+'">'+ r.kode_rak+' - '+r.nama_rak +'</option>';
                    asal.append(opt); tujuan.append(opt);
                });
            });

            // Table
            window.transferSessionsInline = $('#transferSessionsInline').DataTable({
                processing: true,
                serverSide: true,
                ajax: {
                    url: '{% url "inventory:transfer_rak_list" %}',
                    type: 'GET'
                },
                columns: [
                    { data: 'session_code' },
                    { data: 'rak_asal_lokasi' },
                    { data: 'rak_tujuan_lokasi' },
                    { data: 'status', render: function(d,t,row){
                        if(t==='display'){
                            var map={draft:'bg-warning',in_progress:'bg-info',selesai:'bg-success',dibatalkan:'bg-danger'};
                            var txt={draft:'Draft',in_progress:'Sedang Berlangsung',selesai:'Selesai',dibatalkan:'Dibatalkan'};
                            return '<span class="badge '+(map[d]||'bg-secondary')+'">'+(txt[d]||d)+'</span>';
                        }
                        return d;
                    }},
                    { data: 'total_items' },
                    { data: 'total_qty' },
                    { data: 'created_by_username' },
                    { data: 'tanggal_transfer' },
                    { data: null, render: function(d,t,row){
                        if(t==='display'){
                            var b='';
                            if(row.status==='draft'){
                                b += '<a class="btn btn-sm btn-primary" href="/inventory/transfer-rak/'+row.id+'/work/"><i class="bi bi-pencil"></i></a> ';
                                b += '<a class="btn btn-sm btn-danger" href="/inventory/transfer-rak/'+row.id+'/cancel/"><i class="bi bi-x-circle"></i></a>';
                            } else if(row.status==='selesai'){
                                b += '<a class="btn btn-sm btn-info" href="/inventory/transfer-rak/'+row.id+'/detail/"><i class="bi bi-eye"></i></a>';
                            }
                            return '<div class="d-flex gap-1">'+b+'</div>';
                        }
                        return '';
                    }}
                ],
                order: [[7,'desc']],
                pageLength: 25
            });
        }

        function createInlineTransfer(){
            var rak_asal = $('#inline_rak_asal').val();
            var rak_tujuan = $('#inline_rak_tujuan').val();
            var catatan = $('#inline_catatan').val();
            var mode = $('#inline_transfer_putaway').is(':checked') ? 'transfer_putaway' : 'direct';

            if(!rak_asal || !rak_tujuan){
                alert('Pilih rak asal dan rak tujuan');
                return;
            }

            $.post('{% url "inventory:transfer_rak_create" %}',{
                rak_asal_id: rak_asal,
                rak_tujuan_id: rak_tujuan,
                catatan: catatan,
                mode: mode,
                csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
            }).done(function(resp){
                if(resp.success){
                    $('#createTransferModalInline').modal('hide');
                    window.transferSessionsInline.ajax.reload();
                    if(resp.redirect_url){ window.location.href = resp.redirect_url; }
                } else {
                    alert(resp.message||'Gagal membuat sesi');
                }
            }).fail(function(){
                alert('Gagal membuat sesi');
            });
        }
    </script>

    <script>
        // Fungsi untuk menambahkan filter rak ke DOM DataTables
        function addRakFilterToDOM() {
            console.log('🔄 Adding rak filter to DOM...');
            
            // Cari elemen rak-filter-container yang sudah dibuat oleh DataTables
            var rakFilterContainer = $('.rak-filter-container');
            console.log('📍 Rak filter container found:', rakFilterContainer.length);
            console.log('📍 Container HTML:', rakFilterContainer.html());
            
            if (rakFilterContainer.length > 0) {
                // Cek apakah filter sudah ada untuk mencegah duplikasi
                if ($('#rakFilterSelect').length > 0) {
                    console.log('⚠️ Filter already exists, skipping...');
                    return;
                }
                
                console.log('🏗️ Creating filter HTML...');
                
                // Buat filter rak yang lebih baik dengan search box
                var filterHtml = `
                    <div class="rak-filter-content p-3 mb-3" style="background-color: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <label for="rakFilterSelect" class="form-label me-2 mb-0" style="font-size: 0.9rem; font-weight: 500; color: #495057; white-space: nowrap;">
                                        <i class="bi bi-funnel me-1"></i>Filter Rak:
                                    </label>
                                    <select id="rakFilterSelect" class="form-select form-select-sm" style="font-size: 0.9rem;">
                                        <option value="">Semua Rak</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <label for="tableSearch" class="form-label me-2 mb-0" style="font-size: 0.9rem; font-weight: 500; color: #495057; white-space: nowrap;">
                                        <i class="bi bi-search me-1"></i>Cari:
                                    </label>
                                    <input type="search" id="tableSearch" class="form-control form-control-sm" placeholder="Cari produk..." style="font-size: 0.9rem;">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Inject HTML ke container
                rakFilterContainer.html(filterHtml);
                console.log('✅ Filter HTML injected to DOM');
                
                // Verifikasi element berhasil dibuat
                var rakSelect = $('#rakFilterSelect');
                var searchInput = $('#tableSearch');
                
                console.log('🔍 Verifying elements after injection...');
                console.log('📍 rakFilterSelect found:', rakSelect.length);
                console.log('📍 tableSearch found:', searchInput.length);
                
                if (rakSelect.length === 0 || searchInput.length === 0) {
                    console.error('❌ Failed to create filter elements!');
                    console.log('📄 Container HTML after injection:', rakFilterContainer.html());
                    return;
                }
                
                console.log('✅ Filter elements verified successfully');
                
                // Load opsi rak dengan timeout untuk memastikan DOM ready
                console.log('🔄 Loading rak options...');
                setTimeout(function() {
                    loadRakFilterOptions(function() {
                        console.log('✅ Rak options loaded, attaching events...');
                        
                        // Event listener untuk filter rak
                        rakSelect.off('change').on('change', function() {
                            var selectedValue = $(this).val();
                            console.log('🔄 Rak filter changed to:', selectedValue);
                            if (rakStockTable) {
                                rakStockTable.ajax.reload();
                            }
                        });
                        
                        // Event listener untuk search box
                        searchInput.off('keyup').on('keyup', function() {
                            var searchValue = this.value;
                            console.log('🔍 Search value:', searchValue);
                            if (rakStockTable) {
                                rakStockTable.search(searchValue).draw();
                            }
                        });
                        
                        console.log('✅ Event listeners attached successfully');
                    });
                }, 200);
                
            } else {
                console.error('❌ Rak filter container (.rak-filter-container) not found!');
                console.log('🔍 Available containers:', $('.dataTables_wrapper').find('div').map(function() { return this.className; }).get());
                
                // Coba lagi setelah delay
                setTimeout(function() {
                    console.log('🔄 Retrying to find rak filter container...');
                    addRakFilterToDOM();
                }, 1000);
            }
        }

    </script>
{% endblock %} 