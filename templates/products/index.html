{% extends 'base.html' %}

{% block title %}Daftar Produk{% endblock %}

{% block content %}
  <div class="container-fluid mt-4">
    <div class="card mb-3" style="max-width: 128vw; margin: 0 auto;">
      <div class="card-body">
        <h2 class="fw-bold mb-3 text-center">Daftar Produk</h2>
        <div class="d-flex justify-content-center mb-2 gap-2">
          <button id="importBtn" class="btn btn-secondary shadow-sm icon-btn"><i class="bi bi-upload"></i> Import</button>
          <button id="exportBtn" class="btn btn-info shadow-sm icon-btn"><i class="bi bi-download"></i> Export</button>
          <button id="historyBtn" class="btn btn-primary shadow-sm icon-btn"><i class="bi bi-clock-history"></i> History</button>
          <a href="{% url 'products:products_viewall' %}" class="btn btn-success shadow-sm icon-btn"><i class="bi bi-list"></i> View All</a>
          <a href="/products/sku_bundling/" class="btn btn-warning shadow-sm icon-btn"><i class="bi bi-boxes"></i> SKU BUNDLING</a>
        </div>
        <div class="d-flex justify-content-start mb-3 gap-2 position-relative" style="max-width: 1200px; margin-left:0;">
          <div style="width: 600px; position:relative;">
            <input id="product-search" type="text" class="form-control" style="width: 100%; min-width: 400px; max-width: 600px;" placeholder="Cari produk (SKU / Barcode / Nama / Variant / Brand)...">
            <div id="autocomplete-list" class="list-group position-absolute" style="z-index:1000; width:100%; left:0; top:100%;"></div>
          </div>
          <button id="reset-filter" class="btn btn-outline-secondary ms-2" style="display:none;">Reset Filter</button>
        </div>
      </div>
    </div>
    <div class="card" style="max-width: 98vw; margin: 0 auto;">
      <div class="card-body table-responsive" style="overflow-x: auto;">
        <table id="products-table" class="table table-striped table-bordered" style="width:120%; min-width:1200px;">
          <thead>
            <tr>
              <th>ID</th>
              <th>Sku</th>
              <th>Barcode</th>
              <th>Nama produk</th>
              <th>Variant produk</th>
              <th>Brand</th>
              <th>Rak</th>
              <th>Photo</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>
    <a href="{% url 'products:download_template' %}" class="btn btn-success mb-3">
      Download Template
    </a>
  </div>
{% endblock %}

{% block extra_script %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bootstrap-4@5.0.15/bootstrap-4.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('importBtn').addEventListener('click', function() {
    var modalEl = document.getElementById('importModal');
    if (modalEl) {
      new bootstrap.Modal(modalEl).show();
    }
  });
  document.getElementById('exportBtn').addEventListener('click', function() {
    window.location.href = '{% url "products:products_export" %}';
  });
  document.getElementById('historyBtn').addEventListener('click', function() {
    window.location.href = '{% url "products:import_history" %}';
  });
  // Autocomplete hanya untuk search bar utama, bukan filter
  const searchInput = document.getElementById('product-search');
  const searchList = document.getElementById('autocomplete-list');
  let debounceTimeout = null;
  let autocompletePage = 1;
  let autocompleteQuery = '';
  let autocompleteHasMore = false;
  let autocompleteLoading = false;

  // Set vertical scroll and max height for dropdown
  searchList.style.maxHeight = '320px';
  searchList.style.overflowY = 'auto';

  function fetchAutocomplete(q, page = 1, append = false) {
    autocompleteLoading = true;
    fetch(`/products/autocomplete/?q=${encodeURIComponent(q)}&page=${page}`)
      .then(r => r.json())
      .then(resp => {
        let data = resp.results || resp;
        autocompleteHasMore = resp.has_more !== undefined ? resp.has_more : (Array.isArray(data) && data.length === 20);
        if (!append) searchList.innerHTML = '';
        if (!data.length && !append) {
          searchList.innerHTML = '<div class="list-group-item">Tidak ada hasil</div>';
          searchList.style.display = 'block';
          autocompleteLoading = false;
          return;
        }
        data.forEach(item => {
          const el = document.createElement('a');
          el.className = 'list-group-item list-group-item-action';
          el.innerHTML = `<b>${item.sku}</b> | <span class='text-muted'>${item.barcode || ''}</span> - ${item.nama_produk || ''} <small class='text-secondary'>${item.variant_produk || ''} ${item.brand || ''}</small>`;
          el.href = '#';
          el.onclick = function(e) {
            e.preventDefault();
            searchInput.value = item.sku + ' - ' + item.nama_produk;
            searchList.innerHTML = '';
            searchList.style.display = 'none';
            // Filter DataTable by SKU
            if (window.dt) {
              window.dt.column(1).search('^' + item.sku + '$', true, false).draw();
              document.getElementById('reset-filter').style.display = '';
            }
          };
          searchList.appendChild(el);
        });
        searchList.style.display = 'block';
        autocompleteLoading = false;
      });
  }
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      const q = this.value.trim();
      autocompleteQuery = q;
      autocompletePage = 1;
      if (debounceTimeout) clearTimeout(debounceTimeout);
      if (!q) { searchList.innerHTML = ''; searchList.style.display = 'none'; return; }
      debounceTimeout = setTimeout(() => {
        fetchAutocomplete(q, 1, false);
      }, 200);
    });
    // Infinite scroll on dropdown
    searchList.addEventListener('scroll', function() {
      if (autocompleteLoading || !autocompleteHasMore) return;
      if (searchList.scrollTop + searchList.clientHeight >= searchList.scrollHeight - 10) {
        autocompletePage += 1;
        fetchAutocomplete(autocompleteQuery, autocompletePage, true);
      }
    });
    document.addEventListener('click', function(e) {
      if (!searchInput.contains(e.target) && !searchList.contains(e.target)) {
        searchList.innerHTML = '';
        searchList.style.display = 'none';
      }
    });
  }
  // Inisialisasi DataTables pada tabel produk
  const tableEl = document.querySelector('table');
  if (tableEl) {
    const dt = $(tableEl).DataTable({
      language: {
        url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/id.json'
      },
      pageLength: 25,
      lengthMenu: [10, 25, 50, 100, 500],
      order: [],
      dom: 'lfrtip',
      scrollX: true,  
      scrollCollapse: true,
      fixedHeader: true,
      autoWidth: false,
      serverSide: true,
      processing: true,
      ajax: {
        url: '/products/data/',
        type: 'GET'
      },
      columns: [
        { data: 'id' },
        { data: 'sku' },
        { data: 'barcode' },
        { data: 'nama_produk' },
        { data: 'variant_produk' },
        { data: 'brand' },
        { data: 'rak' },
        { data: 'photo', orderable: false, searchable: false, render: function(data, type, row) {
            if (row.photo) {
              return `<img src="${row.photo}" alt="photo" style="max-width:40px;max-height:40px;">`;
            } else {
              return '—';
            }
          }
        },
        { data: null, orderable: false, searchable: false, render: function(data, type, row) {
            return `<div class="d-flex gap-1 flex-nowrap">
              <a href="/products/edit/${row.id}/" class="btn btn-sm btn-primary">Edit</a>
              <button class="btn btn-sm btn-danger btn-delete-product" data-id="${row.id}" data-nama="${row.nama_produk}">Delete</button>
            </div>`;
          }
        }
      ],
      initComplete: function() {
        // Ambil unique brand dari backend, lalu populate dropdown brand
        var api = this.api();
        $.getJSON('/products/unique_brands/', function(data) {
          var brandList = data.brands || [];
          $.getJSON('/products/unique_raks/', function(data2) {
            var rakList = data2.raks || [];
            api.columns().every(function() {
              var column = this;
              var header = $(column.header());
              var headerText = header.text().toLowerCase();
              if (headerText.includes('brand')) {
                if (header.find('.brand-filter').length === 0) {
                  var filterDiv = $('<div class="brand-filter mt-1"></div>');
                  var select = $('<select class="form-select form-select-sm"><option value="">Semua Brand</option></select>')
                    .on('change', function() {
                      var val = $.fn.dataTable.util.escapeRegex($(this).val().trim());
                      column.search(val ? '^' + val + '$' : '', true, false).draw();
                      document.getElementById('reset-filter').style.display = (val ? '' : 'none');
                    });
                  brandList.forEach(function(d) {
                    if (d && select.find('option[value="'+d+'"]' ).length === 0) {
                      select.append('<option value="'+d+'">'+d+'</option>');
                    }
                  });
                  filterDiv.append(select);
                  header.append(filterDiv);
                }
              } else if (headerText.includes('rak')) {
                if (header.find('.rak-filter').length === 0) {
                  var filterDiv = $('<div class="rak-filter mt-1"></div>');
                  var select = $('<select class="form-select form-select-sm"><option value="">Semua Rak</option></select>')
                    .on('change', function() {
                      var val = $.fn.dataTable.util.escapeRegex($(this).val().trim());
                      column.search(val ? '^' + val + '$' : '', true, false).draw();
                      document.getElementById('reset-filter').style.display = (val ? '' : 'none');
                    });
                  rakList.forEach(function(d) {
                    if (d && select.find('option[value="'+d+'"]' ).length === 0) {
                      select.append('<option value="'+d+'">'+d+'</option>');
                    }
                  });
                  filterDiv.append(select);
                  header.append(filterDiv);
                }
              }
            });
          });
        });
      }
    });
    window.dt = dt;
  }
  document.querySelectorAll('td').forEach(function(td) {
    if (td.textContent.trim() === 'nan' || td.textContent.trim() === '') {
      td.textContent = '—';
    }
  });
  // Modal konfirmasi hapus produk (Bootstrap 5, tanpa jQuery)
  let deleteProductId = null;
  let deleteProductNama = '';
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('btn-delete-product')) {
      e.preventDefault();
      deleteProductId = e.target.getAttribute('data-id');
      deleteProductNama = e.target.getAttribute('data-nama');
      document.getElementById('deleteProductModalLabel').textContent = 'Hapus Produk';
      document.getElementById('deleteProductModalBody').innerHTML = `Yakin ingin menghapus produk <b>${deleteProductNama}</b>?`;
      var modal = new bootstrap.Modal(document.getElementById('deleteProductModal'));
      modal.show();
      // Simpan modal instance agar bisa ditutup setelah hapus
      window._deleteProductModal = modal;
    }
  });
  document.getElementById('confirmDeleteProductBtn').addEventListener('click', function() {
    if (deleteProductId) {
      window.location.href = `/products/delete/${deleteProductId}/`;
      if (window._deleteProductModal) window._deleteProductModal.hide();
    }
  });
});
</script>
<!-- Modal Import Produk -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" enctype="multipart/form-data" action="{% url 'products:products_import' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="importModalLabel">Import Produk</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="file" name="file" class="form-control" required>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Import</button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- Modal Konfirmasi Hapus Produk -->
<div class="modal fade" id="deleteProductModal" tabindex="-1" aria-labelledby="deleteProductModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteProductModalLabel">Hapus Produk</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="deleteProductModalBody">
        Yakin ingin menghapus produk ini?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteProductBtn">Hapus</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}