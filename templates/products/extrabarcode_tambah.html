{% extends "base.html" %}
{% load static %}

{% block title %}Tambah Extra Barcode{% endblock %}

{% block content %}
<div class="container mt-4" style="max-width:900px;">
    <div class="card">
        <div class="card-header">
            <h3 class="fw-bold">Tambah Extra Barcode Baru</h3>
        </div>
        <div class="card-body">
            <form method="post" action="{% url 'products:extrabarcode_add' %}">
                {% csrf_token %}

                {# Bagian untuk memilih Produk #}
                <div class="mb-3" style="position:relative;">
                    <label class="form-label">Pilih Produk:</label>
                    <div class="input-group mb-1">
                        <input type="text" id="produk_search" class="form-control"
                            placeholder="Cari SKU / Barcode / Nama / Brand / Variant" autocomplete="off" aria-label="Cari Produk">
                        <button class="btn btn-outline-secondary" type="button" id="produk_search_btn"
                            aria-label="Cari Produk">Cari</button>
                    </div>
                    <div id="search-result-box" class="border rounded mt-1 bg-white shadow-sm"
                        style="display:none; position:absolute; z-index:10; min-width:100%; max-width:100vw; overflow-x:auto; max-height:70vh; overflow-y:auto;">
                        <table class="table table-sm mb-0">
                            <thead>
                                <tr style="background:#f8f9fa;">
                                    <th>SKU</th>
                                    <th>Barcode</th>
                                    <th>Nama</th>
                                    <th>Variant</th>
                                    <th>Brand</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    {# Input tersembunyi untuk menyimpan product_id yang dipilih #}
                    <input type="hidden" name="product_id" id="selected_product_id" value="{{ selected_product.id }}" required>
                    <div id="selected_product_display" class="alert alert-info mt-2" {% if not selected_product %}style="display:none;"{% endif %}>
                        <strong>Produk Terpilih:</strong> <span id="display_product_info">{% if selected_product %}{{ selected_product.sku }} - {{ selected_product.nama_produk }}{% endif %}</span>
                    </div>
                </div>

                {# Container untuk input barcode dinamis #}
                <div id="barcode_inputs_container" class="mb-3 border p-3 rounded">
                    <label class="form-label">Barcode Tambahan:</label>
                    {% if submitted_barcodes %}
                        {% for barcode in submitted_barcodes %}
                        <div class="input-group mb-2">
                            <input type="text" name="barcode_{{ forloop.counter }}" class="form-control" placeholder="Masukkan Barcode {{ forloop.counter }}" value="{{ barcode }}" required>
                            {% if forloop.last %}
                            <button type="button" class="btn btn-outline-secondary add-barcode-btn"><i class="bi bi-plus-lg"></i></button>
                            {% else %}
                            <button type="button" class="btn btn-outline-danger remove-barcode-btn"><i class="bi bi-dash-lg"></i></button>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="input-group mb-2">
                            <input type="text" name="barcode_1" class="form-control" placeholder="Masukkan Barcode 1" required>
                            <button type="button" class="btn btn-outline-secondary add-barcode-btn"><i class="bi bi-plus-lg"></i></button>
                        </div>
                    {% endif %}
                </div>

                <button type="submit" class="btn btn-primary mt-3">Simpan Barcode</button>
                <a href="{% url 'products:extrabarcode_view' %}" class="btn btn-secondary mt-3">Batal</a>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_script %}

<script>
$(document).ready(function() {
    // --- Autocomplete logic ---
    let selectedIdx = -1;
    let currentRows = [];
    
    function renderSearchResultBox(list) {
        const tbody = document.querySelector('#search-result-box tbody');
        tbody.innerHTML = '';
        if (!list.length) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Produk tidak ditemukan!</td></tr>';
        } else {
            tbody.innerHTML = list.map(p => `
                <tr class="pilih-produk" style="cursor:pointer;" data-product-id="${p.id}" data-display-text="${p.sku} - ${p.nama_produk}">
                    <td>${p.sku}</td><td>${p.barcode}</td><td>${p.nama_produk}</td><td>${p.variant_produk}</td><td>${p.brand}</td>
                </tr>`).join('');
        }
        $('#search-result-box').show();
        currentRows = Array.from(tbody.querySelectorAll('tr.pilih-produk'));
        selectedIdx = -1;
    }

    function fetchProdukSearch(q) {
        fetch(`{% url 'products:products_autocomplete' %}?q=${encodeURIComponent(q)}`)
            .then(r => r.json()).then(resp => renderSearchResultBox(resp.results || []));
    }

    $('#produk_search').on('input', function () {
        let keyword = this.value.trim();
        if (keyword.length < 2) {
            $('#search-result-box').hide();
            return;
        }
        fetchProdukSearch(keyword);
    });

    $('#search-result-box').on('click', 'tr.pilih-produk', function() {
        const productId = $(this).data('product-id');
        const displayText = $(this).data('display-text');
        
        $('#selected_product_id').val(productId);
        $('#display_product_info').text(displayText);
        $('#selected_product_display').show();
        
        $('#produk_search').val('');
        $('#search-result-box').hide();
    });
    
    $(document).on('click', function(e) {
        if (!$(e.target).closest('#produk_search, #search-result-box').length) {
            $('#search-result-box').hide();
        }
    });

    // --- Dynamic Barcode Input Logic ---
    let barcode_count = {{ submitted_barcodes|length|default:1 }};

    function addBarcodeInput() {
        barcode_count++;
        const new_input_group = `
            <div class="input-group mb-2">
                <input type="text" name="barcode_${barcode_count}" class="form-control" placeholder="Masukkan Barcode ${barcode_count}" required>
                <button type="button" class="btn btn-outline-secondary add-barcode-btn"><i class="bi bi-plus-lg"></i></button>
            </div>
        `;
        $('#barcode_inputs_container').append(new_input_group);
    }

    $(document).on('click', '.add-barcode-btn', function() {
        $(this).removeClass('add-barcode-btn btn-outline-secondary').addClass('remove-barcode-btn btn-outline-danger');
        $(this).html('<i class="bi bi-dash-lg"></i>');
        addBarcodeInput();
    });

    $(document).on('click', '.remove-barcode-btn', function() {
        $(this).closest('.input-group').remove();
    });

    // --- Frontend Validation ---
    $('form').on('submit', function(e) {
        if (!$('#selected_product_id').val()) {
            Swal.fire('Error', 'Produk belum dipilih. Silakan pilih produk terlebih dahulu.', 'error');
            e.preventDefault();
            return;
        }
        if ($('input[name^="barcode_"]').filter((_, el) => $(el).val().trim() !== '').length === 0) {
            Swal.fire('Error', 'Minimal satu barcode harus diisi.', 'error');
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}
